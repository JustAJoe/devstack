<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>functions</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>functions</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>functions - Common functions used by DevStack components</p>
<p>The following variables are assumed to be defined by certain functions:
<tt class="docutils literal">ENABLED_SERVICES</tt>
<tt class="docutils literal">EROR_ON_CLONE</tt>
<tt class="docutils literal">FILES</tt>
<tt class="docutils literal">GLANCE_HOSTPORT</tt>
<tt class="docutils literal">OFFLINE</tt>
<tt class="docutils literal">PIP_DOWNLOAD_CACHE</tt>
<tt class="docutils literal">PIP_USE_MIRRORS</tt>
<tt class="docutils literal">RECLONE</tt>
<tt class="docutils literal">TRACK_DEPENDS</tt>
<tt class="docutils literal">http_proxy</tt>, <tt class="docutils literal">https_proxy</tt>, <tt class="docutils literal">no_proxy</tt></p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
<p>Exit 0 if address is in network or 1 if address is not in
network or netaddr library is not installed.
address_in_net ip-address ip-range</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>address_in_net<span class="o">()</span> <span class="o">{</span>
    python -c <span class="s2">&quot;</span>
<span class="s2">import netaddr</span>
<span class="s2">import sys</span>
<span class="s2">sys.exit(netaddr.IPAddress(&#39;$1&#39;) not in netaddr.IPNetwork(&#39;$2&#39;))</span>
<span class="s2">&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Wrapper for <tt class="docutils literal"><span class="pre">apt-get</span></tt> to set cache and proxy environment variables
Uses globals <tt class="docutils literal">OFFLINE</tt>, <a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">*</span></a>_proxy`
apt_get operation package [package ...]</p>
<div class="system-message" id="id1">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 27); <em><a href="#id2">backlink</a></em></p>
Inline literal start-string without end-string.</div>
<div class="system-message" id="id3">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 27); <em><a href="#id4">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>apt_get<span class="o">()</span> <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">||</span> -z <span class="s2">&quot;$@&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="o">[[</span> <span class="s2">&quot;$(id -u)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="nv">$sudo</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive <span class="se">\</span>
        <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
        apt-get --option <span class="s2">&quot;Dpkg::Options::=--force-confold&quot;</span> --assume-yes <span class="s2">&quot;$@&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Gracefully cp only if source file/dir exists
cp_it source destination</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cp_it <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -e <span class="nv">$1</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> -d <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>cp -pRL <span class="nv">$1</span> <span class="nv">$2</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Prints &quot;message&quot; and exits
die &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>die<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">echo</span> <span class="nv">$@</span>
    <span class="nb">exit</span> <span class="nv">$exitcode</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Checks an environment variable is not set or has length 0 OR if the
exit code is non-zero and prints &quot;message&quot; and exits
NOTE: env-var is the variable name without a '$'
die_if_not_set env-var &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>die_if_not_set<span class="o">()</span> <span class="o">{</span>
    <span class="o">(</span>
        <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
        <span class="nb">set</span> +o xtrace
        <span class="nb">local </span><span class="nv">evar</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">        </span><span class="k">if</span> ! is_set <span class="nv">$evar</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$exitcode</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">set</span> +o xtrace
            <span class="nb">echo</span> <span class="nv">$@</span>
            <span class="nb">exit</span> -1
        <span class="k">fi</span>
    <span class="o">)</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Grab a numbered field from python prettytable output
Fields are numbered starting with 1
Reverse syntax is supported: -1 is the last field, -2 is second to last, etc.
get_field field-number</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_field<span class="o">()</span> <span class="o">{</span>
    <span class="k">while </span><span class="nb">read </span>data; <span class="k">do</span>
<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> -lt 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">field</span><span class="o">=</span><span class="s2">&quot;(\$(NF$1))&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">field</span><span class="o">=</span><span class="s2">&quot;\$$(($1 + 1))&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;$data&quot;</span> | awk -F<span class="s1">&#39;[ \t]*\\|[ \t]*&#39;</span> <span class="s2">&quot;{print $field}&quot;</span>
    <span class="k">done</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>get_packages() collects a list of package names of any type from the
prerequisite files in <tt class="docutils literal"><span class="pre">files/{apts|rpms}</span></tt>.  The list is intended
to be passed to a package installer such as apt or yum.</p>
<p>Only packages required for the services in <tt class="docutils literal">ENABLED_SERVICES</tt> will be
included.  Two bits of metadata are recognized in the prerequisite files:
- <tt class="docutils literal"># NOPRIME</tt> defers installation to be performed later in stack.sh
- <tt class="docutils literal"># dist:DISTRO</tt> or <tt class="docutils literal">dist:DISTRO1,DISTRO2</tt> limits the selection</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;stdin&gt;</tt>, line 65)</p>
Unexpected indentation.</div>
<blockquote>
of the package to the distros listed.  The distro names are case insensitive.</blockquote>
<p>Uses globals <tt class="docutils literal">ENABLED_SERVICES</tt>
get_packages dir</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_packages<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">package_dir</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span>file_to_parse
    <span class="nb">local </span>service

    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$package_dir&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;No package directory supplied&quot;</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$DISTRO&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetDistro
    <span class="k">fi</span>
<span class="k">    for </span>service in general <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Allow individual services to specify dependencies</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} $service&quot;</span>
        <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>NOTE(sdague) n-api needs glance for now because that's where
glance client is</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> n-api <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ nova <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} nova&quot;</span>
            <span class="k">fi</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ glance <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} glance&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> c-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ cinder <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} cinder&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> ceilometer-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ ceilometer <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} ceilometer&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> n-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ nova <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} nova&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> g-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ glance <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} glance&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> key* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ keystone <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} keystone&quot;</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    done</span>

<span class="k">    for </span>file in <span class="k">${</span><span class="nv">file_to_parse</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">fname</span><span class="o">=</span><span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">file</span><span class="k">}</span>
        <span class="nb">local </span>OIFS line package distros distro
        <span class="o">[[</span> -e <span class="nv">$fname</span> <span class="o">]]</span> <span class="o">||</span> <span class="k">continue</span>

<span class="k">        </span><span class="nv">OIFS</span><span class="o">=</span><span class="nv">$IFS</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
        <span class="k">for </span>line in <span class="k">$(</span>&lt;<span class="k">${</span><span class="nv">fname</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="s2">&quot;NOPRIME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                continue</span>
<span class="k">            fi</span>

<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="o">(</span>.*<span class="o">)</span><span class="c">#.*dist:([^ ]*) ]]; then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We are using BASH regexp matching feature.</p>
</td><td class=code><div class=highlight><pre>
                <span class="nv">package</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="k">}</span>
                <span class="nv">distros</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[2]</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>In bash ${VAR,,} will lowecase VAR</p>
</td><td class=code><div class=highlight><pre>
                <span class="o">[[</span> <span class="k">${</span><span class="nv">distros</span><span class="p">,,</span><span class="k">}</span> <span class="o">=</span>~ <span class="k">${</span><span class="nv">DISTRO</span><span class="p">,,</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$package</span>
                <span class="k">continue</span>
<span class="k">            fi</span>

<span class="k">            </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">line</span><span class="p">%#*</span><span class="k">}</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">IFS</span><span class="o">=</span><span class="nv">$OIFS</span>
    <span class="k">done</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Determine OS Vendor, Release and Update
Tested with OS/X, Ubuntu, RedHat, CentOS, Fedora
Returns results in global variables:
os_VENDOR - vendor name
os_RELEASE - release
os_UPDATE - update
os_PACKAGE - package type
os_CODENAME - vendor's codename for release
GetOSVersion</p>
</td><td class=code><div class=highlight><pre>
GetOSVersion<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Figure out which vendor we are</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`which sw_vers 2&gt;/dev/null`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>OS/X</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">os_VENDOR</span><span class="o">=</span><span class="sb">`</span>sw_vers -productName<span class="sb">`</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="sb">`</span>sw_vers -productVersion<span class="sb">`</span>
        <span class="nv">os_UPDATE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">##*.</span><span class="k">}</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">%.*</span><span class="k">}</span>
        <span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.7&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;lion&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.6&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;snow leopard&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.5&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;leopard&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.4&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;tiger&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.3&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;panther&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">fi</span>
<span class="k">    elif</span> <span class="o">[[</span> -x <span class="k">$(</span>which lsb_release 2&gt;/dev/null<span class="k">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="k">$(</span>lsb_release -i -s<span class="k">)</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">$(</span>lsb_release -r -s<span class="k">)</span>
        <span class="nv">os_UPDATE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;Debian,Ubuntu&quot;</span> <span class="o">=</span>~ <span class="nv">$os_VENDOR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;rpm&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="k">$(</span>lsb_release -c -s<span class="k">)</span>
    <span class="k">elif</span> <span class="o">[[</span> -r /etc/redhat-release <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Red Hat Enterprise Linux Server release 5.5 (Tikanga)
CentOS release 5.5 (Final)
CentOS Linux release 6.0 (Final)
Fedora release 16 (Verne)</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for </span>r in <span class="s2">&quot;Red Hat&quot;</span> CentOS Fedora; <span class="k">do</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="nv">$r</span>
            <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`grep \&quot;$r\&quot; /etc/redhat-release`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">ver</span><span class="o">=</span><span class="sb">`</span>sed -e <span class="s1">&#39;s/^.* \(.*\) (\(.*\)).*$/\1\|\2/&#39;</span> /etc/redhat-release<span class="sb">`</span>
                <span class="nv">os_CODENAME</span><span class="o">=</span><span class="k">${</span><span class="nv">ver</span><span class="p">#*|</span><span class="k">}</span>
                <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">ver</span><span class="p">%|*</span><span class="k">}</span>
                <span class="nv">os_UPDATE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">##*.</span><span class="k">}</span>
                <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">%.*</span><span class="k">}</span>
                <span class="nb">break</span>
<span class="nb">            </span><span class="k">fi</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;rpm&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">export </span>os_VENDOR os_RELEASE os_UPDATE os_PACKAGE os_CODENAME
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>git update using reference as a branch.
git_update_branch ref</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_update_branch<span class="o">()</span> <span class="o">{</span>

    <span class="nv">GIT_BRANCH</span><span class="o">=</span><span class="nv">$1</span>

    git checkout -f origin/<span class="nv">$GIT_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>a local branch might not exist</p>
</td><td class=code><div class=highlight><pre>
    git branch -D <span class="nv">$GIT_BRANCH</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>git checkout -b <span class="nv">$GIT_BRANCH</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>git update using reference as a tag. Be careful editing source at that repo
as working copy will be in a detached mode
git_update_tag ref</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_update_tag<span class="o">()</span> <span class="o">{</span>

    <span class="nv">GIT_TAG</span><span class="o">=</span><span class="nv">$1</span>

    git tag -d <span class="nv">$GIT_TAG</span>
</pre></div></td></tr><tr><td class=docs>
<p>fetching given tag only</p>
</td><td class=code><div class=highlight><pre>
    git fetch origin tag <span class="nv">$GIT_TAG</span>
    git checkout -f <span class="nv">$GIT_TAG</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>git update using reference as a branch.
git_update_remote_branch ref</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_update_remote_branch<span class="o">()</span> <span class="o">{</span>

    <span class="nv">GIT_BRANCH</span><span class="o">=</span><span class="nv">$1</span>

    git checkout -b <span class="nv">$GIT_BRANCH</span> -t origin/<span class="nv">$GIT_BRANCH</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Translate the OS version values into common nomenclature
Sets <tt class="docutils literal">DISTRO</tt> from the <tt class="docutils literal">os_*</tt> values</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>GetDistro<span class="o">()</span> <span class="o">{</span>
    GetOSVersion
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>Ubuntu<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>'Everyone' refers to Ubuntu releases by the code name adjective</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="nv">$os_CODENAME</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>Fedora<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>For Fedora, just use 'f' and the release</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;f$os_RELEASE&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Catch-all for now is Vendor + Release + Update</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;$os_VENDOR-$os_RELEASE.$os_UPDATE&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">export </span>DISTRO
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>git clone only if directory doesn't exist already.  Since <tt class="docutils literal">DEST</tt> might not
be owned by the installation user, we create the directory and change the
ownership to the proper user.
Set global RECLONE=yes to simulate a clone when dest-dir exists
Set global ERROR_ON_CLONE=True to abort execution with an error if the git repo
does not exist (default is False, meaning the repo will be cloned).
Uses global <tt class="docutils literal">OFFLINE</tt>
git_clone remote dest-dir branch</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_clone <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>

<span class="k">    </span><span class="nv">GIT_REMOTE</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">GIT_DEST</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">GIT_REF</span><span class="o">=</span><span class="nv">$3</span>

    <span class="k">if </span><span class="nb">echo</span> <span class="nv">$GIT_REF</span> | egrep -q <span class="s2">&quot;^refs&quot;</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If our branch name is a gerrit style refs/changes/...</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$GIT_DEST</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="o">[[</span> <span class="s2">&quot;$ERROR_ON_CLONE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>1
            git clone <span class="nv">$GIT_REMOTE</span> <span class="nv">$GIT_DEST</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">cd</span> <span class="nv">$GIT_DEST</span>
        git fetch <span class="nv">$GIT_REMOTE</span> <span class="nv">$GIT_REF</span> <span class="o">&amp;&amp;</span> git checkout FETCH_HEAD
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>do a full clone only if the directory doesn't exist</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$GIT_DEST</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="o">[[</span> <span class="s2">&quot;$ERROR_ON_CLONE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>1
            git clone <span class="nv">$GIT_REMOTE</span> <span class="nv">$GIT_DEST</span>
            <span class="nb">cd</span> <span class="nv">$GIT_DEST</span>
</pre></div></td></tr><tr><td class=docs>
<p>This checkout syntax works for both branches and tags</p>
</td><td class=code><div class=highlight><pre>
            git checkout <span class="nv">$GIT_REF</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$RECLONE&quot;</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>if it does exist then simulate what clone does if asked to RECLONE</p>
</td><td class=code><div class=highlight><pre>
            <span class="nb">cd</span> <span class="nv">$GIT_DEST</span>
</pre></div></td></tr><tr><td class=docs>
<p>set the url to pull from and fetch</p>
</td><td class=code><div class=highlight><pre>
            git remote <span class="nb">set</span>-url origin <span class="nv">$GIT_REMOTE</span>
            git fetch origin
</pre></div></td></tr><tr><td class=docs>
<p>remove the existing ignored files (like pyc) as they cause breakage
(due to the py files having older timestamps than our pyc, so python
thinks the pyc files are correct using them)</p>
</td><td class=code><div class=highlight><pre>
            find <span class="nv">$GIT_DEST</span> -name <span class="s1">&#39;*.pyc&#39;</span> -delete

</pre></div></td></tr><tr><td class=docs>
<p>handle GIT_REF accordingly to type (tag, branch)</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`git show-ref refs/tags/$GIT_REF`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>git_update_tag <span class="nv">$GIT_REF</span>
            <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;`git show-ref refs/heads/$GIT_REF`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>git_update_branch <span class="nv">$GIT_REF</span>
            <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;`git show-ref refs/remotes/origin/$GIT_REF`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>git_update_remote_branch <span class="nv">$GIT_REF</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nb">echo</span> <span class="nv">$GIT_REF</span> is neither branch nor tag
                <span class="nb">exit </span>1
            <span class="k">fi</span>

<span class="k">        fi</span>
<span class="k">    fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Comment an option in an INI file
inicomment config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>inicomment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    sed -i -e <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ s|^\($option[ \t]*=.*$\)|#\1|&quot;</span> <span class="nv">$file</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Uncomment an option in an INI file
iniuncomment config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniuncomment<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    sed -i -e <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ s|[^ \t]*#[ \t]*\($option[ \t]*=.*$\)|\1|&quot;</span> <span class="nv">$file</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Get an option from an INI file
iniget config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniget<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span>line
    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span>sed -ne <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ { /^$option[ \t]*=/ p; }&quot;</span> <span class="nv">$file</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="k">${</span><span class="nv">line</span><span class="p">#*=</span><span class="k">}</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Set an option in an INI file
iniset config-file section option value</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniset<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">value</span><span class="o">=</span><span class="nv">$4</span>
    <span class="k">if</span> ! grep -q <span class="s2">&quot;^\[$section\]&quot;</span> <span class="nv">$file</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add section at the end</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> -e <span class="s2">&quot;\n[$section]&quot;</span> &gt;&gt;<span class="nv">$file</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$(iniget $file $section $option)&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add it</p>
</td><td class=code><div class=highlight><pre>
        sed -i -e <span class="s2">&quot;/^\[$section\]/ a\\</span>
<span class="s2">$option = $value</span>
<span class="s2">&quot;</span> <span class="nv">$file</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Replace it</p>
</td><td class=code><div class=highlight><pre>
        sed -i -e <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ s|^\($option[ \t]*=[ \t]*\).*$|\1$value|&quot;</span> <span class="nv">$file</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>is_service_enabled() checks if the service(s) specified as arguments are
enabled by the user in <tt class="docutils literal">ENABLED_SERVICES</tt>.</p>
<p>Multiple services specified as arguments are <tt class="docutils literal">OR</tt>'ed together; the test
is a short-circuit boolean, i.e it returns on the first match.</p>
<dl class="docutils">
<dt>There are special cases for some 'catch-all' services::</dt>
<dd><strong>nova</strong> returns true if any service enabled start with <strong>n-</strong>
<strong>cinder</strong> returns true if any service enabled start with <strong>c-</strong>
<strong>ceilometer</strong> returns true if any service enabled start with <strong>ceilometer</strong>
<strong>glance</strong> returns true if any service enabled start with <strong>g-</strong>
<strong>quantum</strong> returns true if any service enabled start with <strong>q-</strong></dd>
</dl>
<p>Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
is_service_enabled service [service ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_service_enabled<span class="o">()</span> <span class="o">{</span>
    <span class="nv">services</span><span class="o">=</span><span class="nv">$@</span>
    <span class="k">for </span>service in <span class="k">${</span><span class="nv">services</span><span class="k">}</span>; <span class="k">do</span>
        <span class="o">[[</span> ,<span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span>, <span class="o">=</span>~ ,<span class="k">${</span><span class="nv">service</span><span class="k">}</span>, <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;nova&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;n-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;cinder&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;c-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;ceilometer&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;ceilometer-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;glance&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;g-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;quantum&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;q-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
    <span class="k">done</span>
<span class="k">    return </span>1
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>remove extra commas from the input string (i.e. <tt class="docutils literal">ENABLED_SERVICES</tt>)
_cleanup_service_list service-list</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_cleanup_service_list <span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> | sed -e <span class="s1">&#39;</span>
<span class="s1">        s/,,/,/g;</span>
<span class="s1">        s/^,//;</span>
<span class="s1">        s/,$//</span>
<span class="s1">    &#39;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>enable_service() adds the services passed as argument to the
<tt class="docutils literal">ENABLED_SERVICES</tt> list, if they are not already present.</p>
<dl class="docutils">
<dt>For example:</dt>
<dd>enable_service qpid</dd>
</dl>
<p>This function does not know about the special cases
for nova, glance, and quantum built into is_service_enabled().
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
enable_service service [service ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>enable_service<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="s2">&quot;${ENABLED_SERVICES}&quot;</span>
    <span class="k">for </span>service in <span class="nv">$@</span>; <span class="k">do</span>
<span class="k">        if</span> ! is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
<span class="k">            </span>tmpsvcs+<span class="o">=</span><span class="s2">&quot;,$service&quot;</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span>_cleanup_service_list <span class="s2">&quot;$tmpsvcs&quot;</span><span class="k">)</span>
    disable_negated_services
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>disable_service() removes the services passed as argument to the
<tt class="docutils literal">ENABLED_SERVICES</tt> list, if they are present.</p>
<dl class="docutils">
<dt>For example:</dt>
<dd>disable_service rabbit</dd>
</dl>
<p>This function does not know about the special cases
for nova, glance, and quantum built into is_service_enabled().
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
disable_service service [service ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>disable_service<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="s2">&quot;,${ENABLED_SERVICES},&quot;</span>
    <span class="nb">local </span>service
    <span class="k">for </span>service in <span class="nv">$@</span>; <span class="k">do</span>
<span class="k">        if </span>is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="k">${</span><span class="nv">tmpsvcs</span><span class="p">//,</span><span class="nv">$service</span><span class="p">,/,</span><span class="k">}</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span>_cleanup_service_list <span class="s2">&quot;$tmpsvcs&quot;</span><span class="k">)</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>disable_all_services() removes all current services
from <tt class="docutils literal">ENABLED_SERVICES</tt> to reset the configuration
before a minimal installation
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
disable_all_services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>disable_all_services<span class="o">()</span> <span class="o">{</span>
    <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Remove all services starting with '-'.  For example, to install all default
services except rabbit (rabbit) set in <tt class="docutils literal">localrc</tt>:
ENABLED_SERVICES+=&quot;,-rabbit&quot;
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
disable_negated_services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>disable_negated_services<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="s2">&quot;${ENABLED_SERVICES}&quot;</span>
    <span class="nb">local </span>service
    <span class="k">for </span>service in <span class="k">${</span><span class="nv">tmpsvcs</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> -* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">tmpsvcs</span><span class="k">}</span>|sed -r <span class="s2">&quot;s/(,)?(-)?${service#-}(,)?/,/g&quot;</span><span class="k">)</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span>_cleanup_service_list <span class="s2">&quot;$tmpsvcs&quot;</span><span class="k">)</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Distro-agnostic package installer
install_package package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_package<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
        <span class="o">[[</span> <span class="s2">&quot;$NO_UPDATE_REPOS&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">||</span> apt_get update
        <span class="nv">NO_UPDATE_REPOS</span><span class="o">=</span>True

        apt_get install <span class="s2">&quot;$@&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>yum_install <span class="s2">&quot;$@&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Distro-agnostic function to tell if a package is installed
is_package_installed package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_package_installed<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$@&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return </span>1
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>dpkg -l <span class="s2">&quot;$@&quot;</span> &gt; /dev/null
        <span class="k">return</span> <span class="nv">$?</span>
    <span class="k">else</span>
<span class="k">        </span>rpm --quiet -q <span class="s2">&quot;$@&quot;</span>
        <span class="k">return</span> <span class="nv">$?</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Test if the named environment variable is set and not zero length
is_set env-var</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_set<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">var</span><span class="o">=</span><span class="se">\$</span><span class="s2">&quot;$1&quot;</span>
    <span class="k">if </span><span class="nb">eval</span> <span class="s2">&quot;[ -z \&quot;$var\&quot; ]&quot;</span>; <span class="k">then</span>
<span class="k">        return </span>1
    <span class="k">fi</span>
<span class="k">    return </span>0
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Wrapper for <tt class="docutils literal">pip install</tt> to set cache and proxy environment variables
Uses globals <tt class="docutils literal">OFFLINE</tt>, <tt class="docutils literal">PIP_DOWNLOAD_CACHE</tt>, <tt class="docutils literal">PIP_USE_MIRRORS</tt>,</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;stdin&gt;</tt>, line 312)</p>
Unexpected indentation.</div>
<blockquote>
<p><tt class="docutils literal">TRACK_DEPENDS</tt>, <a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">*</span></a>_proxy`</p>
<div class="system-message" id="id5">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 312); <em><a href="#id6">backlink</a></em></p>
Inline literal start-string without end-string.</div>
<div class="system-message" id="id7">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 312); <em><a href="#id8">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 313)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p>pip_install package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>pip_install <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">||</span> -z <span class="s2">&quot;$@&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">        </span><span class="nb">source</span> <span class="nv">$DEST</span>/.venv/bin/activate
        <span class="nv">CMD_PIP</span><span class="o">=</span><span class="nv">$DEST</span>/.venv/bin/pip
        <span class="nv">SUDO_PIP</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">SUDO_PIP</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">CMD_PIP</span><span class="o">=</span>/usr/bin/pip
        <span class="k">else</span>
<span class="k">            </span><span class="nv">CMD_PIP</span><span class="o">=</span>/usr/bin/pip-python
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$PIP_USE_MIRRORS&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">PIP_MIRROR_OPT</span><span class="o">=</span><span class="s2">&quot;--use-mirrors&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$SUDO_PIP</span> <span class="nv">PIP_DOWNLOAD_CACHE</span><span class="o">=</span><span class="k">${</span><span class="nv">PIP_DOWNLOAD_CACHE</span><span class="k">:-</span><span class="p">/var/cache/pip</span><span class="k">}</span> <span class="se">\</span>
        <span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="se">\</span>
        <span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        <span class="nv">NO_PROXY</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
        <span class="nv">$CMD_PIP</span> install <span class="nv">$PIP_MIRROR_OPT</span> <span class="nv">$@</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Service wrapper to restart services
restart_service service-name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>restart_service<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo /usr/sbin/service <span class="nv">$1</span> restart
    <span class="k">else</span>
<span class="k">        </span>sudo /sbin/service <span class="nv">$1</span> restart
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Helper to launch a service in a named screen
screen_it service &quot;command-line&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_it <span class="o">{</span>
    <span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="k">if </span>is_service_enabled <span class="nv">$1</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Append the service to the screen rc file</p>
</td><td class=code><div class=highlight><pre>
        screen_rc <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span>

        screen -S <span class="nv">$SCREEN_NAME</span> -X screen -t <span class="nv">$1</span>
</pre></div></td></tr><tr><td class=docs>
<p>sleep to allow bash to be ready to be send the command - we are
creating a new window in screen and then sends characters, so if
bash isn't running by the time we send the command, nothing happens</p>
</td><td class=code><div class=highlight><pre>
        sleep 1.5

        <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$1</span> -X logfile <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log
            screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$1</span> -X log on
            ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.log
        <span class="k">fi</span>
<span class="k">        </span>screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$1</span> -X stuff <span class="s2">&quot;$2$NL&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Screen rc file builder
screen_rc service &quot;command-line&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_rc <span class="o">{</span>
    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/<span class="nv">$SCREEN_NAME</span>-screenrc
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Name the screen session</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;sessionname $SCREEN_NAME&quot;</span> &gt; <span class="nv">$SCREENRC</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set a reasonable statusbar</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;hardstatus alwayslastline &#39;$SCREEN_HARDSTATUS&#39;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t shell bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>If this service doesn't already exist in the screenrc file</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! grep <span class="nv">$1</span> <span class="nv">$SCREENRC</span> 2&gt;&amp;1 &gt; /dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t $1 bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;stuff \&quot;$2$NL\&quot;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">pip install</tt> the dependencies of the package before <tt class="docutils literal">setup.py develop</tt>
so pip and not distutils processes the dependency chain
Uses globals <tt class="docutils literal">TRACK_DEPENDES</tt>, <a href="#id9"><span class="problematic" id="id10">``</span></a><a href="#id11"><span class="problematic" id="id12">*</span></a>_proxy`
setup_develop directory</p>
<div class="system-message" id="id9">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 354); <em><a href="#id10">backlink</a></em></p>
Inline literal start-string without end-string.</div>
<div class="system-message" id="id11">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 354); <em><a href="#id12">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_develop<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">        </span><span class="nv">SUDO_CMD</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">SUDO_CMD</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="k">fi</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="nv">$1</span>; <span class="se">\</span>
        python setup.py egg_info; <span class="se">\</span>
        <span class="nv">raw_links</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;/^.+/ {print &quot;-f &quot; $1}&#39;</span> *.egg-info/dependency_links.txt<span class="k">)</span>; <span class="se">\</span>
        <span class="nv">depend_links</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$raw_links</span> | xargs<span class="k">)</span>; <span class="se">\</span>
        <span class="nv">require_file</span><span class="o">=</span><span class="k">$(</span><span class="o">[</span> ! -r *-info/requires.txt <span class="o">]</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;-r *-info/requires.txt&quot;</span><span class="k">)</span>; <span class="se">\</span>
        pip_install <span class="nv">$require_file</span> <span class="nv">$depend_links</span>; <span class="se">\</span>
        <span class="nv">$SUDO_CMD</span> <span class="se">\</span>
            <span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="se">\</span>
            <span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
            <span class="nv">NO_PROXY</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
            python setup.py develop <span class="se">\</span>
    <span class="o">)</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Service wrapper to start services
start_service service-name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_service<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo /usr/sbin/service <span class="nv">$1</span> start
    <span class="k">else</span>
<span class="k">        </span>sudo /sbin/service <span class="nv">$1</span> start
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Service wrapper to stop services
stop_service service-name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_service<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo /usr/sbin/service <span class="nv">$1</span> stop
    <span class="k">else</span>
<span class="k">        </span>sudo /sbin/service <span class="nv">$1</span> stop
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Normalize config values to True or False
Accepts as False: 0 no false False FALSE
Accepts as True: 1 yes true True TRUE
VAR=$(trueorfalse default-value test-value)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>trueorfalse<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">default</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">testval</span><span class="o">=</span><span class="nv">$2</span>

    <span class="o">[[</span> -z <span class="s2">&quot;$testval&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;$default&quot;</span>; <span class="k">return</span>; <span class="o">}</span>
    <span class="o">[[</span> <span class="s2">&quot;0 no false False FALSE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$testval&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;False&quot;</span>; <span class="k">return</span>; <span class="o">}</span>
    <span class="o">[[</span> <span class="s2">&quot;1 yes true True TRUE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$testval&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;True&quot;</span>; <span class="k">return</span>; <span class="o">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;$default&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Retrieve an image from a URL and upload into Glance
Uses the following variables:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;stdin&gt;</tt>, line 380)</p>
Unexpected indentation.</div>
<blockquote>
<tt class="docutils literal">FILES</tt> must be set to the cache dir
<tt class="docutils literal">GLANCE_HOSTPORT</tt></blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 382)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p>upload_image image-url glance-token</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>upload_image<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">image_url</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">token</span><span class="o">=</span><span class="nv">$2</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a directory for the downloaded image tarballs.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images

</pre></div></td></tr><tr><td class=docs>
<p>Downloads the image (uec ami+aki style), then extracts it.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">IMAGE_FNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$image_url&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> <span class="o">||</span> <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $FILES/$IMAGE_FNAME)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>wget -c <span class="nv">$image_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Not found: $image_url&quot;</span>
            <span class="k">return</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>OpenVZ-format images are provided as .tar.gz, but not decompressed prior to loading</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_url&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;openvz&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
        <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span>
        glance --os-auth-token <span class="nv">$token</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME&quot;</span> --is-public<span class="o">=</span>True --container-format ami --disk-format ami &lt; <span class="s2">&quot;${IMAGE}&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

<span class="k">    </span><span class="nv">KERNEL</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">RAMDISK</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">DISK_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">UNPACK</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">case</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> in
        *.tar.gz|*.tgz<span class="o">)</span>
</pre></div></td></tr><tr><td class=docs>
<p>Extract ami and aki files</p>
</td><td class=code><div class=highlight><pre>
            <span class="o">[</span> <span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> <span class="o">||</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tgz}&quot;</span>
            <span class="nv">xdir</span><span class="o">=</span><span class="s2">&quot;$FILES/images/$IMAGE_NAME&quot;</span>
            rm -Rf <span class="s2">&quot;$xdir&quot;</span>;
            mkdir <span class="s2">&quot;$xdir&quot;</span>
            tar -zxf <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> -C <span class="s2">&quot;$xdir&quot;</span>
            <span class="nv">KERNEL</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-vmlinuz* <span class="s2">&quot;$xdir/&quot;</span>aki-*/image; <span class="k">do</span>
                     <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="nv">RAMDISK</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-initrd* <span class="s2">&quot;$xdir/&quot;</span>ari-*/image; <span class="k">do</span>
                     <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="nv">IMAGE</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*.img <span class="s2">&quot;$xdir/&quot;</span>ami-*/image; <span class="k">do</span>
                     <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$IMAGE_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
            <span class="k">fi</span>
            ;;
        *.img<span class="o">)</span>
            <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/$IMAGE_FNAME&quot;</span>;
            <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
            <span class="nv">format</span><span class="o">=</span><span class="k">$(</span>qemu-img info <span class="k">${</span><span class="nv">IMAGE</span><span class="k">}</span> | awk <span class="s1">&#39;/^file format/ { print $3; exit }&#39;</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;,qcow2,raw,vdi,vmdk,vpc,&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;,$format,&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">DISK_FORMAT</span><span class="o">=</span><span class="nv">$format</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nv">DISK_FORMAT</span><span class="o">=</span>raw
            <span class="k">fi</span>
<span class="k">            </span><span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
            ;;
        *.img.gz<span class="o">)</span>
            <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
            <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img.gz&quot;</span><span class="k">)</span>
            <span class="nv">DISK_FORMAT</span><span class="o">=</span>raw
            <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
            <span class="nv">UNPACK</span><span class="o">=</span>zcat
            ;;
        *.qcow2<span class="o">)</span>
            <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
            <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.qcow2&quot;</span><span class="k">)</span>
            <span class="nv">DISK_FORMAT</span><span class="o">=</span>qcow2
            <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
            ;;
        *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Do not know what to do with $IMAGE_FNAME&quot;</span>; <span class="nb">false</span>;;
    <span class="k">esac</span>

<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$CONTAINER_FORMAT&quot;</span> <span class="o">=</span> <span class="s2">&quot;bare&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$UNPACK&quot;</span> <span class="o">=</span> <span class="s2">&quot;zcat&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>glance --os-auth-token <span class="nv">$token</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME&quot;</span> --public --container-format<span class="o">=</span><span class="nv">$CONTAINER_FORMAT</span> --disk-format <span class="nv">$DISK_FORMAT</span> &lt; &lt;<span class="o">(</span>zcat --force <span class="s2">&quot;${IMAGE}&quot;</span><span class="o">)</span>
        <span class="k">else</span>
<span class="k">            </span>glance --os-auth-token <span class="nv">$token</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME&quot;</span> --public --container-format<span class="o">=</span><span class="nv">$CONTAINER_FORMAT</span> --disk-format <span class="nv">$DISK_FORMAT</span> &lt; <span class="s2">&quot;${IMAGE}&quot;</span>
        <span class="k">fi</span>
<span class="k">    else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use glance client to add the kernel the root filesystem.
We parse the results of the first upload to get the glance ID of the
kernel for use when uploading the root filesystem.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>; <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>;
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$KERNEL&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">KERNEL_ID</span><span class="o">=</span><span class="k">$(</span>glance --os-auth-token <span class="nv">$token</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME-kernel&quot;</span> --public --container-format aki --disk-format aki &lt; <span class="s2">&quot;$KERNEL&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[</span> -n <span class="s2">&quot;$RAMDISK&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="k">$(</span>glance --os-auth-token <span class="nv">$token</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME-ramdisk&quot;</span> --public --container-format ari --disk-format ari &lt; <span class="s2">&quot;$RAMDISK&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        </span>glance --os-auth-token <span class="nv">$token</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;${IMAGE_NAME%.img}&quot;</span> --public --container-format ami --disk-format ami <span class="k">${</span><span class="nv">KERNEL_ID</span><span class="p">:+--property kernel_id=</span><span class="nv">$KERNEL_ID</span><span class="k">}</span> <span class="k">${</span><span class="nv">RAMDISK_ID</span><span class="p">:+--property ramdisk_id=</span><span class="nv">$RAMDISK_ID</span><span class="k">}</span> &lt; <span class="s2">&quot;${IMAGE}&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<dl class="docutils">
<dt>Toggle enable/disable_service for services that must run exclusive of each other</dt>
<dd>$1 The name of a variable containing a space-separated list of services
$2 The name of a variable in which to store the enabled service's name
$3 The name of the service to enable</dd>
</dl>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>use_exclusive_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">options</span><span class="o">=</span><span class="k">${</span><span class="p">!1</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">selection</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nv">out</span><span class="o">=</span><span class="nv">$2</span>
    <span class="o">[</span> -z <span class="nv">$selection</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[[</span> ! <span class="s2">&quot;$options&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$selection&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>1
    <span class="k">for </span>opt in <span class="nv">$options</span>;<span class="k">do</span>
        <span class="o">[[</span> <span class="s2">&quot;$opt&quot;</span> <span class="o">=</span> <span class="s2">&quot;$selection&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> enable_service <span class="nv">$opt</span> <span class="o">||</span> disable_service <span class="nv">$opt</span>
    <span class="k">done</span>
<span class="k">    </span><span class="nb">eval</span> <span class="s2">&quot;$out=$selection&quot;</span>
    <span class="k">return </span>0
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Wrapper for <tt class="docutils literal">yum</tt> to set proxy environment variables
Uses globals <tt class="docutils literal">OFFLINE</tt>, <a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">*</span></a>_proxy`
yum_install package [package ...]</p>
<div class="system-message" id="id13">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 415); <em><a href="#id14">backlink</a></em></p>
Inline literal start-string without end-string.</div>
<div class="system-message" id="id15">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 415); <em><a href="#id16">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>yum_install<span class="o">()</span> <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="o">[[</span> <span class="s2">&quot;$(id -u)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="nv">$sudo</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
        yum install -y <span class="s2">&quot;$@&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ping check
Uses globals <tt class="docutils literal">ENABLED_SERVICES</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>ping_check<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">        </span>_ping_check_quantum  <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span>
        <span class="k">return</span>
<span class="k">    fi</span>
<span class="k">    </span>_ping_check_novanet <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ping check for nova
Uses globals <tt class="docutils literal">MULTI_HOST</tt>, <tt class="docutils literal">PRIVATE_NETWORK</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_ping_check_novanet<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">boot_timeout</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">expected</span><span class="o">=</span><span class="k">${</span><span class="nv">4</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">MULTI_HOST</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$MULTI_HOST</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;$from_net&quot;</span> <span class="o">=</span> <span class="s2">&quot;$PRIVATE_NETWORK_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sleep <span class="nv">$boot_timeout</span>
        <span class="k">return</span>
<span class="k">    fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while ! ping -c1 -w1 $ip; do sleep 1; done&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while ping -c1 -w1 $ip; do sleep 1; done&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! timeout <span class="nv">$boot_timeout</span> sh -c <span class="s2">&quot;$check_command&quot;</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;[Fail] Couldn&#39;t ping server&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;[Fail] Could ping server&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ssh check</p>
</td><td class=code><div class=highlight><pre>

<span class="k">function </span>ssh_check<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">        </span>_ssh_check_quantum  <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span> <span class="nv">$5</span>
        <span class="k">return</span>
<span class="k">    fi</span>
<span class="k">    </span>_ssh_check_novanet <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span> <span class="nv">$5</span>
<span class="o">}</span>

<span class="k">function </span>_ssh_check_novanet<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">NET_NAME</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">KEY_FILE</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">FLOATING_IP</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">DEFAULT_INSTANCE_USER</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">ACTIVE_TIMEOUT</span><span class="o">=</span><span class="nv">$5</span>
    <span class="nb">local </span><span class="nv">probe_cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$ACTIVE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! ssh -o StrictHostKeyChecking=no -i $KEY_FILE ${DEFAULT_INSTANCE_USER}@$FLOATING_IP echo success ; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;server didn&#39;t become ssh-able!&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>


</pre></div></td></tr><tr><td class=docs>
<p>Local variables:
-<em>- mode: Shell-script -</em>-
End:</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
