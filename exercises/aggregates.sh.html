<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>aggregates.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>aggregates.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;**************************************************&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Begin DevStack Exercise: $0&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;**************************************************&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o errexit

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">EXERCISE_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$EXERCISE_DIR</span>/..; <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/functions

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/openrc

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/exerciserc

</td><td class=code><div class=highlight><pre>
<span class="nv">_OLD_USERNAME</span><span class="o">=</span><span class="nv">$OS_USERNAME</span>
<span class="nv">OS_USERNAME</span><span class="o">=</span>admin


</td><td class=code><div class=highlight><pre>

<span class="nv">AGGREGATE_NAME</span><span class="o">=</span>test_aggregate_<span class="nv">$RANDOM</span>
<span class="nv">AGGREGATE_A_ZONE</span><span class="o">=</span>nova

exit_if_aggregate_present<span class="o">()</span> <span class="o">{</span>
    <span class="nv">aggregate_name</span><span class="o">=</span><span class="nv">$1</span>

    <span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>nova aggregate-list | grep -c <span class="s2">&quot; $aggregate_name &quot;</span><span class="sb">`</span> <span class="o">==</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;SUCCESS $aggregate_name not present&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;ERROR found aggregate: $aggregate_name&quot;</span>
        <span class="nb">exit</span> -1
    <span class="k">fi</span>
<span class="o">}</span>

exit_if_aggregate_present <span class="nv">$AGGREGATE_NAME</span>

<span class="nv">AGGREGATE_ID</span><span class="o">=</span><span class="sb">`</span>nova aggregate-create <span class="nv">$AGGREGATE_NAME</span> <span class="nv">$AGGREGATE_A_ZONE</span> | grep <span class="s2">&quot; $AGGREGATE_NAME &quot;</span> | get_field 1<span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
nova aggregate-list | grep -q <span class="s2">&quot; $AGGREGATE_NAME &quot;</span> <span class="o">||</span> die <span class="s2">&quot;Aggregate $AGGREGATE_NAME not created&quot;</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>nova aggregate-create <span class="nv">$AGGREGATE_NAME</span> <span class="nv">$AGGREGATE_A_ZONE</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR could create duplicate aggregate&quot;</span>
    <span class="nb">exit</span> -1
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>
<span class="nv">AGGREGATE_NEW_NAME</span><span class="o">=</span>test_aggregate_<span class="nv">$RANDOM</span>

nova aggregate-update <span class="nv">$AGGREGATE_ID</span> <span class="nv">$AGGREGATE_NEW_NAME</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$AGGREGATE_NEW_NAME</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$AGGREGATE_A_ZONE</span>

nova aggregate-update <span class="nv">$AGGREGATE_ID</span> <span class="nv">$AGGREGATE_NAME</span> <span class="nv">$AGGREGATE_A_ZONE</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$AGGREGATE_NAME</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$AGGREGATE_A_ZONE</span>


</td><td class=code><div class=highlight><pre>
<span class="nv">META_DATA_1_KEY</span><span class="o">=</span>asdf
<span class="nv">META_DATA_2_KEY</span><span class="o">=</span>foo
<span class="nv">META_DATA_3_KEY</span><span class="o">=</span>bar

<span class="c">#ensure no metadata is set</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="o">{}</span>

nova aggregate-set-metadata <span class="nv">$AGGREGATE_ID</span> <span class="k">${</span><span class="nv">META_DATA_1_KEY</span><span class="k">}</span><span class="o">=</span>123
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$META_DATA_1_KEY</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep 123

nova aggregate-set-metadata <span class="nv">$AGGREGATE_ID</span> <span class="k">${</span><span class="nv">META_DATA_2_KEY</span><span class="k">}</span><span class="o">=</span>456
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$META_DATA_1_KEY</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$META_DATA_2_KEY</span>

nova aggregate-set-metadata <span class="nv">$AGGREGATE_ID</span> <span class="nv">$META_DATA_2_KEY</span> <span class="k">${</span><span class="nv">META_DATA_3_KEY</span><span class="k">}</span><span class="o">=</span>789
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$META_DATA_1_KEY</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$META_DATA_3_KEY</span>

nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="nv">$META_DATA_2_KEY</span> <span class="o">&amp;&amp;</span> die <span class="s2">&quot;ERROR metadata was not cleared&quot;</span>

nova aggregate-set-metadata <span class="nv">$AGGREGATE_ID</span> <span class="nv">$META_DATA_3_KEY</span> <span class="nv">$META_DATA_1_KEY</span>
nova aggregate-details <span class="nv">$AGGREGATE_ID</span> | grep <span class="o">{}</span>


</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">==</span> <span class="s2">&quot;xenserver&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;TODO(johngarbutt) add tests for add/remove host from aggregate&quot;</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>
nova aggregate-delete <span class="nv">$AGGREGATE_ID</span>
exit_if_aggregate_present <span class="nv">$AGGREGATE_NAME</span>


</td><td class=code><div class=highlight><pre>
<span class="nv">OS_USERNAME</span><span class="o">=</span><span class="nv">$_OLD_USERNAME</span>
<span class="nb">echo</span> <span class="s2">&quot;AGGREGATE TEST PASSED&quot;</span>

<span class="nb">set</span> +o xtrace
<span class="nb">echo</span> <span class="s2">&quot;**************************************************&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;End DevStack Exercise: $0&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;**************************************************&quot;</span>


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
