<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">DISTRO</span><span class="o">=</span><span class="k">$(</span>lsb_release -c -s<span class="k">)</span>

<span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">DISTRO</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">(</span>oneiric|precise<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has only been tested on oneiric&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
. <span class="nv">$TOP_DIR</span>/functions

</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/files - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="nb">source</span> ./stackrc

</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span><span class="nb">type</span> -p screen &gt;/dev/null <span class="o">&amp;&amp;</span> screen -ls | egrep -q <span class="s2">&quot;[0-9].stack&quot;</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are already running a stack.sh session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To rejoin this session type &#39;screen -x stack&#39;.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To destroy this session, kill the running screen.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">ROOTSLEEP</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOTSLEEP</span><span class="k">:-</span><span class="nv">10</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;In $ROOTSLEEP seconds, we will create a user &#39;stack&#39; and run as that user&quot;</span>
    sleep <span class="nv">$ROOTSLEEP</span>

</td><td class=code><div class=highlight><pre>
    dpkg -l sudo <span class="o">||</span> apt_get update <span class="o">&amp;&amp;</span> apt_get install sudo

    <span class="k">if</span> ! getent passwd stack &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a user called stack&quot;</span>
        useradd -U -G sudo -s /bin/bash -d <span class="nv">$DEST</span> -m stack
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Giving stack user passwordless sudo priviledges&quot;</span>
</td><td class=code><div class=highlight><pre>
    grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> &gt;&gt; /etc/sudoers
    <span class="o">(</span> <span class="nb">umask </span>226 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="se">\</span>
        &gt; /etc/sudoers.d/50_stack_sh <span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&quot;Copying files to stack user&quot;</span>
    <span class="nv">STACK_DIR</span><span class="o">=</span><span class="s2">&quot;$DEST/${PWD##*/}&quot;</span>
    cp -r -f -T <span class="s2">&quot;$PWD&quot;</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    chown -R stack <span class="s2">&quot;$STACK_DIR&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SHELL_AFTER_RUN&quot;</span> !<span class="o">=</span> <span class="s2">&quot;no&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh; bash&quot;</span> stack
    <span class="k">else</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh&quot;</span> stack
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>1
<span class="k">else</span>
</td><td class=code><div class=highlight><pre>
    dpkg -l sudo <span class="o">||</span> die <span class="s2">&quot;Sudo is required.  Re-run stack.sh as root ONE TIME ONLY to set up sudo.&quot;</span>

</td><td class=code><div class=highlight><pre>
    sudo grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> | sudo tee -a /etc/sudoers

</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;`whoami` ALL=(root) NOPASSWD:ALL&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/50_stack_sh

</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(root) NOPASSWD: /usr/local/bin/nova-rootwrap&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/nova-rootwrap

</td><td class=code><div class=highlight><pre>
    sudo rm -f /etc/sudoers.d/stack_sh_nova
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">OFFLINE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$OFFLINE</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/nova
<span class="nv">HORIZON_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/horizon
<span class="nv">GLANCE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance
<span class="nv">KEYSTONE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/keystone
<span class="nv">NOVACLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-novaclient
<span class="nv">KEYSTONECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-keystoneclient
<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC
<span class="nv">SWIFT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift
<span class="nv">QUANTUM_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/quantum
<span class="nv">QUANTUM_CLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-quantumclient
<span class="nv">MELANGE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/melange
<span class="nv">MELANGECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-melangeclient

</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PLUGIN</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PLUGIN</span><span class="k">:-</span><span class="nv">openvswitch</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT</span><span class="k">:-</span><span class="nv">9696</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">M_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">M_PORT</span><span class="k">:-</span><span class="nv">9898</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">M_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">M_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">M_MAC_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">M_MAC_RANGE</span><span class="k">:-</span><span class="nv">FE</span><span class="p">-EE-DD-00-00-00/24</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">VOLUME_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_GROUP</span><span class="k">:-</span><span class="nv">nova</span><span class="p">-volumes</span><span class="k">}</span>
<span class="nv">VOLUME_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_NAME_PREFIX</span><span class="k">:-</span><span class="nv">volume</span><span class="p">-</span><span class="k">}</span>
<span class="nv">INSTANCE_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">INSTANCE_NAME_PREFIX</span><span class="k">:-</span><span class="nv">instance</span><span class="p">-</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">VIRT_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">VIRT_DRIVER</span><span class="k">:-</span><span class="nv">libvirt</span><span class="k">}</span>
<span class="nv">LIBVIRT_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_TYPE</span><span class="k">:-</span><span class="nv">kvm</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SCHEDULER</span><span class="o">=</span><span class="k">${</span><span class="nv">SCHEDULER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.scheduler.filter_scheduler.FilterScheduler</span><span class="k">}</span>

<span class="nv">HOST_IP_IFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$HOST_IP&quot;</span> -o <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C /sbin/ifconfig <span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">}</span> | grep -m 1 <span class="s1">&#39;inet addr:&#39;</span>| cut -d: -f2 | awk <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Could not determine host ip address.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Either localrc specified dhcp on ${HOST_IP_IFACE} or defaulted to eth0&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SYSLOG</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$SYSLOG</span><span class="sb">`</span>
<span class="nv">SYSLOG_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SYSLOG_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_PORT</span><span class="k">:-</span><span class="nv">516</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TIMEOUT</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TIMEOUT</span><span class="k">:-</span><span class="nv">60</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>read_password <span class="o">{</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>; <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>

    <span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/localrc

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$localrc</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>touch <span class="nv">$localrc</span>
        <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="nv">$msg</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This value will be written to your localrc file so you don&#39;t have to enter it &quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;again.  Use only alphanumeric characters.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;If you leave this blank, a random default value will be used.&quot;</span>
        <span class="nv">pw</span><span class="o">=</span><span class="s2">&quot; &quot;</span>
        <span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Enter a password now:&quot;</span>
            <span class="nb">read</span> -e <span class="nv">$var</span>
            <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>
            <span class="o">[[</span> <span class="s2">&quot;$pw&quot;</span> <span class="o">=</span> <span class="s2">&quot;`echo $pw | tr -cd [:alnum:]`&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">            echo</span> <span class="s2">&quot;Invalid chars in password.  Try again:&quot;</span>
        <span class="k">done</span>
<span class="k">        if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">pw</span><span class="o">=</span><span class="sb">`</span>openssl rand -hex 10<span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">eval</span> <span class="s2">&quot;$var=$pw&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;$var=$pw&quot;</span> &gt;&gt; <span class="nv">$localrc</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">set</span> -o xtrace
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth3
</td><td class=code><div class=highlight><pre>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span><span class="k">$(</span>grep -o <span class="s1">&#39;flat_network_bridge=[^.]*&#39;</span> /proc/cmdline | cut -d<span class="o">=</span> -f 2<span class="k">)</span>
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth1
<span class="k">else</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
<span class="k">fi</span>

<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">br100</span><span class="k">}</span>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.224/28</span><span class="k">}</span>
<span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">$FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TEST_FLOATING_POOL</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_POOL</span><span class="k">:-</span><span class="nv">test</span><span class="k">}</span>
<span class="nv">TEST_FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_RANGE</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.253.0/29</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MULTI_HOST</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

<span class="c">## FIXME(ja): should/can we check that FLAT_INTERFACE is sane?</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">MYSQL_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
<span class="nv">MYSQL_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_USER</span><span class="k">:-</span><span class="nv">root</span><span class="k">}</span>
read_password MYSQL_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR MYSQL.&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_SQL_CONN</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_SQL_CONN</span><span class="k">:-</span><span class="nv">mysql</span><span class="p">://</span><span class="nv">$MYSQL_USER</span><span class="p">:</span><span class="nv">$MYSQL_PASSWORD</span><span class="p">@</span><span class="nv">$MYSQL_HOST</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
read_password RABBIT_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR RABBIT.&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_HOSTPORT</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_HOSTPORT</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="p">:</span><span class="nv">9292</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_DATA_LOCATION</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">:-${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span><span class="p">/data</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_CONFIG_LOCATION</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">:-${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span><span class="p">/config</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">:-</span><span class="nv">1000000</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">:-</span><span class="nv">9</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_REPLICAS</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">:-</span><span class="nv">3</span><span class="k">}</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
    read_password SWIFT_HASH <span class="s2">&quot;ENTER A RANDOM SWIFT HASH.&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">3333</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
read_password SERVICE_TOKEN <span class="s2">&quot;ENTER A SERVICE_TOKEN TO USE FOR THE SERVICE ADMIN TOKEN.&quot;</span>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_PASSWORD <span class="s2">&quot;ENTER A SERVICE_PASSWORD TO USE FOR THE SERVICE AUTHENTICATION.&quot;</span>
</td><td class=code><div class=highlight><pre>
read_password ADMIN_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR HORIZON AND KEYSTONE (20 CHARS OR LESS).&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TENANT_NAME</span><span class="k">:-</span><span class="nv">service</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">KEYSTONE_API_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_API_PORT</span><span class="k">:-</span><span class="nv">5000</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_PORT</span><span class="k">:-</span><span class="nv">35357</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_PORT</span><span class="k">:-</span><span class="nv">5000</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">APACHE_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_USER</span><span class="k">:-</span><span class="nv">$USER</span><span class="k">}</span>
<span class="nv">APACHE_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_GROUP</span><span class="k">:-</span><span class="nv">$APACHE_USER</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LOGDAYS</span><span class="o">=</span><span class="k">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="k">}</span>
    <span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="k">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="k">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    <span class="nv">LOGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    mkdir -p <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth 1 -name <span class="nv">$LOGNAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>

    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
    <span class="nb">echo</span> <span class="s2">&quot;stack.sh log $LOGFILE&quot;</span>
</td><td class=code><div class=highlight><pre>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth 1 -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
<span class="k">        </span>mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>failed ERR
failed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="o">[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed: full log in $LOGFILE&quot;</span>
    <span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace

</td><td class=code><div class=highlight><pre>
sudo mkdir -p <span class="nv">$DEST</span>
<span class="k">if</span> <span class="o">[</span> ! -w <span class="nv">$DEST</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DEST</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_packages<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">package_dir</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span>file_to_parse
    <span class="nb">local </span>service

    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$package_dir&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;No package directory supplied&quot;</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
<span class="k">    for </span>service in general <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>        <span class="c"># Allow individual services to specify dependencies</span>
        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} $service&quot;</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> n-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ nova <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} nova&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> g-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ glance <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} glance&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> key* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ keystone <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} keystone&quot;</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    done</span>

<span class="k">    for </span>file in <span class="k">${</span><span class="nv">file_to_parse</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">fname</span><span class="o">=</span><span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">file</span><span class="k">}</span>
        <span class="nb">local </span>OIFS line package distros distro
        <span class="o">[[</span> -e <span class="nv">$fname</span> <span class="o">]]</span> <span class="o">||</span> <span class="k">continue</span>

<span class="k">        </span><span class="nv">OIFS</span><span class="o">=</span><span class="nv">$IFS</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
        <span class="k">for </span>line in <span class="k">$(</span>&lt;<span class="k">${</span><span class="nv">fname</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="s2">&quot;NOPRIME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                continue</span>
<span class="k">            fi</span>

<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="o">(</span>.*<span class="o">)</span><span class="c">#.*dist:([^ ]*) ]]; then # We are using BASH regexp matching feature.</span>
                        <span class="nv">package</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="k">}</span>
                        <span class="nv">distros</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[2]</span><span class="k">}</span>
                        <span class="k">for </span>distro in <span class="k">${</span><span class="nv">distros</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>  <span class="c">#In bash ${VAR,,} will lowecase VAR</span>
                            <span class="o">[[</span> <span class="k">${</span><span class="nv">distro</span><span class="p">,,</span><span class="k">}</span> <span class="o">==</span> <span class="k">${</span><span class="nv">DISTRO</span><span class="p">,,</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$package</span>
                        <span class="k">done</span>
<span class="k">                        continue</span>
<span class="k">            fi</span>

<span class="k">            </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">line</span><span class="p">%#*</span><span class="k">}</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">IFS</span><span class="o">=</span><span class="nv">$OIFS</span>
    <span class="k">done</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
apt_get update
apt_get install <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/apts<span class="k">)</span>

</td><td class=code><div class=highlight><pre>
pip_install <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/pips | sort -u<span class="k">)</span>

</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$NOVA_DIR</span> <span class="nv">$NOVA_BRANCH</span>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$KEYSTONECLIENT_REPO</span> <span class="nv">$KEYSTONECLIENT_DIR</span> <span class="nv">$KEYSTONECLIENT_BRANCH</span>
git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$NOVACLIENT_DIR</span> <span class="nv">$NOVACLIENT_BRANCH</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$KEYSTONE_REPO</span> <span class="nv">$KEYSTONE_DIR</span> <span class="nv">$KEYSTONE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SWIFT_REPO</span> <span class="nv">$SWIFT_DIR</span> <span class="nv">$SWIFT_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$GLANCE_REPO</span> <span class="nv">$GLANCE_DIR</span> <span class="nv">$GLANCE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-novnc; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$NOVNC_DIR</span> <span class="nv">$NOVNC_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$HORIZON_REPO</span> <span class="nv">$HORIZON_DIR</span> <span class="nv">$HORIZON_BRANCH</span> <span class="nv">$HORIZON_TAG</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>git_clone <span class="nv">$QUANTUM_CLIENT_REPO</span> <span class="nv">$QUANTUM_CLIENT_DIR</span> <span class="nv">$QUANTUM_CLIENT_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$QUANTUM_REPO</span> <span class="nv">$QUANTUM_DIR</span> <span class="nv">$QUANTUM_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled m-svc; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$MELANGE_REPO</span> <span class="nv">$MELANGE_DIR</span> <span class="nv">$MELANGE_BRANCH</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled melange; <span class="k">then</span>
<span class="k">    </span>git_clone <span class="nv">$MELANGECLIENT_REPO</span> <span class="nv">$MELANGECLIENT_DIR</span> <span class="nv">$MELANGECLIENT_BRANCH</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> <span class="nv">$KEYSTONECLIENT_DIR</span>; sudo python setup.py develop
<span class="nb">cd</span> <span class="nv">$NOVACLIENT_DIR</span>; sudo python setup.py develop
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$KEYSTONE_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$SWIFT_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$GLANCE_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="nb">cd</span> <span class="nv">$NOVA_DIR</span>; sudo python setup.py develop
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$HORIZON_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$QUANTUM_CLIENT_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$QUANTUM_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled m-svc; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$MELANGE_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled melange; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$MELANGECLIENT_DIR</span>; sudo python setup.py develop
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>apt_get install -y rsyslog-relp
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SYSLOG_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-m.conf</span>
<span class="s">\$ModLoad imrelp</span>
<span class="s">\$InputRELPServerRun $SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-m.conf /etc/rsyslog.d
    <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-s.conf</span>
<span class="s">*.*		:omrelp:$SYSLOG_HOST:$SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-s.conf /etc/rsyslog.d
    <span class="k">fi</span>
<span class="k">    </span>sudo /usr/sbin/service rsyslog restart
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">tfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
    apt_get install rabbitmq-server &gt; <span class="s2">&quot;$tfile&quot;</span> 2&gt;&amp;1
    cat <span class="s2">&quot;$tfile&quot;</span>
    rm -f <span class="s2">&quot;$tfile&quot;</span>
</td><td class=code><div class=highlight><pre>
    sudo rabbitmqctl change_password guest <span class="nv">$RABBIT_PASSWORD</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    cat <span class="s">&lt;&lt;MYSQL_PRESEED | sudo debconf-set-selections</span>
<span class="s">mysql-server-5.1 mysql-server/root_password password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/root_password_again password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/start_on_boot boolean true</span>
<span class="s">MYSQL_PRESEED</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$HOME</span>/.my.cnf <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>cat <span class="s">&lt;&lt;EOF &gt;$HOME/.my.cnf</span>
<span class="s">[client]</span>
<span class="s">user=$MYSQL_USER</span>
<span class="s">password=$MYSQL_PASSWORD</span>
<span class="s">host=$MYSQL_HOST</span>
<span class="s">EOF</span>
        chmod 0600 <span class="nv">$HOME</span>/.my.cnf
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    apt_get install mysql-server
</td><td class=code><div class=highlight><pre>
    sudo mysql -uroot -p<span class="nv">$MYSQL_PASSWORD</span> -h127.0.0.1 -e <span class="s2">&quot;GRANT ALL PRIVILEGES ON *.* TO &#39;$MYSQL_USER&#39;@&#39;%&#39; identified by &#39;$MYSQL_PASSWORD&#39;;&quot;</span>

</td><td class=code><div class=highlight><pre>
    sudo sed -i <span class="s1">&#39;s/127.0.0.1/0.0.0.0/g&#39;</span> /etc/mysql/my.cnf
    sudo service mysql restart
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_rc <span class="o">{</span>
    <span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/stack-screenrc
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;sessionname stack&quot;</span> &gt; <span class="nv">$SCREENRC</span>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;hardstatus alwayslastline &quot;%-Lw%{= BW}%50&gt;%n%f* %t%{-}%+Lw%&lt; %= %H&quot;&#39;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t stack bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! grep <span class="nv">$1</span> <span class="nv">$SCREENRC</span> 2&gt;&amp;1 &gt; /dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t $1 bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;stuff \&quot;$2$NL\&quot;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_it <span class="o">{</span>
    <span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
    <span class="k">if </span>is_service_enabled <span class="nv">$1</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        screen_rc <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span>

        screen -S stack -X screen -t <span class="nv">$1</span>
</td><td class=code><div class=highlight><pre>
        sleep 1.5

        <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen -S stack -p <span class="nv">$1</span> -X logfile <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log
            screen -S stack -p <span class="nv">$1</span> -X log on
            ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.log
        <span class="k">fi</span>
<span class="k">        </span>screen -S stack -p <span class="nv">$1</span> -X stuff <span class="s2">&quot;$2$NL&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
screen -d -m -S stack -t stack -s /bin/bash
sleep 1
</td><td class=code><div class=highlight><pre>
screen -r stack -X hardstatus alwayslastline <span class="s2">&quot;%-Lw%{= BW}%50&gt;%n%f* %t%{-}%+Lw%&lt; %= %H&quot;</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    apt_get install apache2 libapache2-mod-wsgi


</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/dashboard_openstack.sqlite3

</td><td class=code><div class=highlight><pre>
    <span class="nv">local_settings</span><span class="o">=</span><span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/local_settings.py
    cp <span class="nv">$FILES</span>/horizon_settings.py <span class="nv">$local_settings</span>

</td><td class=code><div class=highlight><pre>
    <span class="nb">cd</span> <span class="nv">$HORIZON_DIR</span>
    python manage.py syncdb

</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$HORIZON_DIR</span>/.blackhole

    <span class="c">## Configure apache&#39;s 000-default to run horizon</span>
    sudo cp <span class="nv">$FILES</span>/000-default.template /etc/apache2/sites-enabled/000-default
    sudo sed -e <span class="s2">&quot;</span>
<span class="s2">        s,%USER%,$APACHE_USER,g;</span>
<span class="s2">        s,%GROUP%,$APACHE_GROUP,g;</span>
<span class="s2">        s,%HORIZON_DIR%,$HORIZON_DIR,g;</span>
<span class="s2">    &quot;</span> -i /etc/apache2/sites-enabled/000-default
    sudo service apache2 restart
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span><span class="nv">GLANCE_CONF_DIR</span><span class="o">=</span>/etc/glance
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$GLANCE_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$GLANCE_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$GLANCE_CONF_DIR</span>
    <span class="nv">GLANCE_IMAGE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance/images
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$GLANCE_IMAGE_DIR</span>

</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$GLANCE_IMAGE_DIR</span>

</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS glance;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE glance CHARACTER SET utf8;&#39;</span>

    <span class="k">function </span>glance_config <span class="o">{</span>
        sudo sed -e <span class="s2">&quot;</span>
<span class="s2">            s,%KEYSTONE_API_PORT%,$KEYSTONE_API_PORT,g;</span>
<span class="s2">            s,%KEYSTONE_AUTH_HOST%,$KEYSTONE_AUTH_HOST,g;</span>
<span class="s2">            s,%KEYSTONE_AUTH_PORT%,$KEYSTONE_AUTH_PORT,g;</span>
<span class="s2">            s,%KEYSTONE_AUTH_PROTOCOL%,$KEYSTONE_AUTH_PROTOCOL,g;</span>
<span class="s2">            s,%KEYSTONE_SERVICE_HOST%,$KEYSTONE_SERVICE_HOST,g;</span>
<span class="s2">            s,%KEYSTONE_SERVICE_PORT%,$KEYSTONE_SERVICE_PORT,g;</span>
<span class="s2">            s,%KEYSTONE_SERVICE_PROTOCOL%,$KEYSTONE_SERVICE_PROTOCOL,g;</span>
<span class="s2">            s,%SQL_CONN%,$BASE_SQL_CONN/glance?charset=utf8,g;</span>
<span class="s2">            s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">            s,%SERVICE_USERNAME%,glance,g;</span>
<span class="s2">            s,%SERVICE_PASSWORD%,$SERVICE_PASSWORD,g;</span>
<span class="s2">            s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g;</span>
<span class="s2">            s,%DEST%,$DEST,g;</span>
<span class="s2">            s,%SYSLOG%,$SYSLOG,g;</span>
<span class="s2">        &quot;</span> -i <span class="nv">$1</span>
    <span class="o">}</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">GLANCE_REGISTRY_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-registry.conf
    cp <span class="nv">$FILES</span>/glance-registry.conf <span class="nv">$GLANCE_REGISTRY_CONF</span>
    glance_config <span class="nv">$GLANCE_REGISTRY_CONF</span>

    <span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$FILES</span>/glance-registry-paste.ini <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">GLANCE_REGISTRY_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-registry-paste.ini
        cp <span class="nv">$FILES</span>/glance-registry-paste.ini <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span>
        glance_config <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span>
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">GLANCE_API_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-api.conf
    cp <span class="nv">$FILES</span>/glance-api.conf <span class="nv">$GLANCE_API_CONF</span>
    glance_config <span class="nv">$GLANCE_API_CONF</span>

    <span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$FILES</span>/glance-api-paste.ini <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">GLANCE_API_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-api-paste.ini
        cp <span class="nv">$FILES</span>/glance-api-paste.ini <span class="nv">$GLANCE_API_PASTE_INI</span>
        glance_config <span class="nv">$GLANCE_API_PASTE_INI</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span><span class="nv">QUANTUM_CONF_DIR</span><span class="o">=</span>/etc/quantum
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$QUANTUM_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$QUANTUM_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$QUANTUM_CONF_DIR</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="nv">kernel_version</span><span class="o">=</span><span class="sb">`</span>cat /proc/version | cut -d <span class="s2">&quot; &quot;</span> -f3<span class="sb">`</span>
        apt_get install linux-headers-<span class="nv">$kernel_version</span>
        apt_get install openvswitch-switch openvswitch-datapath-dkms
</td><td class=code><div class=highlight><pre>
        <span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">            </span>mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS ovs_quantum;&#39;</span>
            mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE IF NOT EXISTS ovs_quantum CHARACTER SET utf8;&#39;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;mysql must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
            <span class="nb">exit </span>1
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">QUANTUM_PLUGIN_INI_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/plugins.ini
        sudo cp <span class="nv">$QUANTUM_DIR</span>/etc/plugins.ini <span class="nv">$QUANTUM_PLUGIN_INI_FILE</span>
</td><td class=code><div class=highlight><pre>
        sudo sed -i -e <span class="s2">&quot;s/^provider =.*$/provider = quantum.plugins.openvswitch.ovs_quantum_plugin.OVSQuantumPlugin/g&quot;</span> <span class="nv">$QUANTUM_PLUGIN_INI_FILE</span>
    <span class="k">fi</span>
<span class="k">   </span>sudo cp <span class="nv">$QUANTUM_DIR</span>/etc/quantum.conf <span class="nv">$QUANTUM_CONF_DIR</span>/quantum.conf
   screen_it q-svc <span class="s2">&quot;cd $QUANTUM_DIR &amp;&amp; PYTHONPATH=.:$QUANTUM_CLIENT_DIR:$PYTHONPATH python $QUANTUM_DIR/bin/quantum-server $QUANTUM_CONF_DIR/quantum.conf&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="nv">OVS_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_BRIDGE</span><span class="k">:-</span><span class="nv">br</span><span class="p">-int</span><span class="k">}</span>
        sudo ovs-vsctl --no-wait -- --if-exists del-br <span class="nv">$OVS_BRIDGE</span>
        sudo ovs-vsctl --no-wait add-br <span class="nv">$OVS_BRIDGE</span>
        sudo ovs-vsctl --no-wait br-set-external-id <span class="nv">$OVS_BRIDGE</span> bridge-id br-int

</td><td class=code><div class=highlight><pre>
       <span class="nv">QUANTUM_OVS_CONFIG_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/ovs_quantum_plugin.ini
       sudo cp <span class="nv">$QUANTUM_DIR</span>/etc/quantum/plugins/openvswitch/ovs_quantum_plugin.ini <span class="nv">$QUANTUM_OVS_CONFIG_FILE</span>
       sudo sed -i -e <span class="s2">&quot;s/^sql_connection =.*$/sql_connection = mysql:\/\/$MYSQL_USER:$MYSQL_PASSWORD@$MYSQL_HOST\/ovs_quantum?charset=utf8/g&quot;</span> <span class="nv">$QUANTUM_OVS_CONFIG_FILE</span>
       screen_it q-agt <span class="s2">&quot;sleep 4; sudo python $QUANTUM_DIR/quantum/plugins/openvswitch/agent/ovs_quantum_agent.py $QUANTUM_OVS_CONFIG_FILE -v&quot;</span>
    <span class="k">fi</span>

<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled m-svc; <span class="k">then</span>
<span class="k">    if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">        </span>mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS melange;&#39;</span>
        mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE melange CHARACTER SET utf8;&#39;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;mysql must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">    </span><span class="nv">MELANGE_CONFIG_FILE</span><span class="o">=</span><span class="nv">$MELANGE_DIR</span>/etc/melange/melange.conf
    cp <span class="nv">$MELANGE_CONFIG_FILE</span>.sample <span class="nv">$MELANGE_CONFIG_FILE</span>
    sed -i -e <span class="s2">&quot;s/^sql_connection =.*$/sql_connection = mysql:\/\/$MYSQL_USER:$MYSQL_PASSWORD@$MYSQL_HOST\/melange?charset=utf8/g&quot;</span> <span class="nv">$MELANGE_CONFIG_FILE</span>
    <span class="nb">cd</span> <span class="nv">$MELANGE_DIR</span> <span class="o">&amp;&amp;</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>.:<span class="nv">$PYTHONPATH</span> python <span class="nv">$MELANGE_DIR</span>/bin/melange-manage --config-file<span class="o">=</span><span class="nv">$MELANGE_CONFIG_FILE</span> db_sync
    screen_it m-svc <span class="s2">&quot;cd $MELANGE_DIR &amp;&amp; PYTHONPATH=.:$PYTHONPATH python $MELANGE_DIR/bin/melange-server --config-file=$MELANGE_CONFIG_FILE&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for melange to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:9898; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;melange-server did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">    </span>melange mac_address_range create <span class="nv">cidr</span><span class="o">=</span><span class="nv">$M_MAC_RANGE</span>
<span class="k">fi</span>



</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_CONF_DIR</span><span class="o">=</span>/etc/nova
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$NOVA_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>sudo mkdir -p <span class="nv">$NOVA_CONF_DIR</span>
<span class="k">fi</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_CONF_DIR</span>

<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
    <span class="nv">API_RATE_LIMIT</span><span class="o">=</span><span class="k">${</span><span class="nv">API_RATE_LIMIT</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$NOVA_DIR</span>/bin/nova-api-paste.ini

</td><td class=code><div class=highlight><pre>
    cp <span class="nv">$NOVA_DIR</span>/etc/nova/api-paste.ini <span class="nv">$NOVA_CONF_DIR</span>

</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        /^admin_token/i admin_tenant_name = $SERVICE_TENANT_NAME</span>
<span class="s2">        /admin_tenant_name/s/^.*$/admin_tenant_name = $SERVICE_TENANT_NAME/;</span>
<span class="s2">        /admin_user/s/^.*$/admin_user = nova/;</span>
<span class="s2">        /admin_password/s/^.*$/admin_password = $SERVICE_PASSWORD/;</span>
<span class="s2">        s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">        s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g;</span>
<span class="s2">    &quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/api-paste.ini
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>clean_iptables<span class="o">()</span> <span class="o">{</span>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-A&quot;</span> |  sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-A&quot;</span> | sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-N&quot;</span> |  sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-N&quot;</span> | sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
<span class="o">}</span>

<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    apt_get install libvirt-bin

</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1

</td><td class=code><div class=highlight><pre>
    sudo modprobe nbd <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;kvm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo modprobe kvm <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">if</span> <span class="o">[</span> ! -e /dev/kvm <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Switching to QEMU&quot;</span>
            <span class="nv">LIBVIRT_TYPE</span><span class="o">=</span>qemu
        <span class="k">fi</span>
<span class="k">    fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>apt_get install cgroup-lite
        <span class="k">else</span>
<span class="k">            </span><span class="nv">cgline</span><span class="o">=</span><span class="s2">&quot;none /cgroup cgroup cpuacct,memory,devices,cpu,freezer,blkio 0 0&quot;</span>
            sudo mkdir -p /cgroup
            <span class="k">if</span> ! grep -q cgroup /etc/fstab; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;$cgline&quot;</span> | sudo tee -a /etc/fstab
            <span class="k">fi</span>
<span class="k">            if</span> ! mount -n | grep -q cgroup; <span class="k">then</span>
<span class="k">                </span>sudo mount /cgroup
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

</td><td class=code><div class=highlight><pre>
    sudo usermod -a -G libvirtd <span class="sb">`</span>whoami<span class="sb">`</span>
</td><td class=code><div class=highlight><pre>
    sudo /etc/init.d/libvirt-bin restart


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$NOVA_DIR</span>/instances

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -L /dev/disk/by-label/nova-instances <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> ! mount -n | grep -q <span class="nv">$NOVA_DIR</span>/instances; <span class="k">then</span>
<span class="k">            </span>sudo mount -L nova-instances <span class="nv">$NOVA_DIR</span>/instances
            sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_DIR</span>/instances
        <span class="k">fi</span>
<span class="k">    fi</span>

</td><td class=code><div class=highlight><pre>
    clean_iptables

</td><td class=code><div class=highlight><pre>
    <span class="nv">instances</span><span class="o">=</span><span class="sb">`</span>sudo virsh list --all | grep <span class="nv">$INSTANCE_NAME_PREFIX</span> | sed <span class="s2">&quot;s/.*\($INSTANCE_NAME_PREFIX[0-9a-fA-F]*\).*/\1/g&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$instances&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh destroy <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh undefine <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | xargs sudo iscsiadm --mode node --logout <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | sudo iscsiadm --mode node --op delete <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>
    sudo rm -rf <span class="nv">$NOVA_DIR</span>/instances/*
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-net; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>clean_iptables
    rm -rf <span class="nv">$NOVA_DIR</span>/networks
    mkdir -p <span class="nv">$NOVA_DIR</span>/networks

</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    apt_get install memcached

</td><td class=code><div class=highlight><pre>

    <span class="nv">USER_GROUP</span><span class="o">=</span><span class="k">$(</span>id -g<span class="k">)</span>
    sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives
    sudo chown -R <span class="nv">$USER</span>:<span class="k">${</span><span class="nv">USER_GROUP</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>mkdir -p  <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images
        sudo touch  <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img
        sudo chown <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img

        dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img <span class="se">\</span>
            <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>0 <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">}</span>
        mkfs.xfs -f -i <span class="nv">size</span><span class="o">=</span>1024  <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1
    <span class="k">if</span> ! egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">        </span>sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs<span class="o">=</span>8  <span class="se">\</span>
            <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/images/swift.img <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">        </span>sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1/<span class="nv">$x</span> <span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/<span class="nv">$x</span>; <span class="k">done</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">drive</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/drives/sdb1/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>
            <span class="nv">node</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>/node
            <span class="nv">node_device</span><span class="o">=</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span>/sdb1
            <span class="o">[[</span> -d <span class="nv">$node</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[[</span> -d <span class="nv">$drive</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
<span class="k">            </span>sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$drive</span>
            sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$node_device</span>
            sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">node</span><span class="k">}</span>
    <span class="k">done</span>

<span class="k">   </span>sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/<span class="o">{</span>object,container,account<span class="o">}</span>-server /var/run/swift
   sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span> /var/run/swift

</td><td class=code><div class=highlight><pre>
   sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span> /etc/swift

</td><td class=code><div class=highlight><pre>
   sed -e <span class="s2">&quot;s/%GROUP%/${USER_GROUP}/;s/%USER%/$USER/;s,%SWIFT_DATA_LOCATION%,$SWIFT_DATA_LOCATION,&quot;</span> <span class="nv">$FILES</span>/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
   sudo sed -i <span class="s1">&#39;/^RSYNC_ENABLE=false/ { s/false/true/ }&#39;</span> /etc/default/rsync

</td><td class=code><div class=highlight><pre>
   <span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">       </span><span class="nv">swift_auth_server</span><span class="o">=</span><span class="s2">&quot;s3token authtoken keystone&quot;</span>
   <span class="k">else</span>
<span class="k">       </span><span class="nv">swift_auth_server</span><span class="o">=</span>tempauth
   <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
   sed -e <span class="s2">&quot;</span>
<span class="s2">       s,%SWIFT_CONFIG_LOCATION%,${SWIFT_CONFIG_LOCATION},g;</span>
<span class="s2">       s,%USER%,$USER,g;</span>
<span class="s2">       s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">       s,%SERVICE_USERNAME%,swift,g;</span>
<span class="s2">       s,%SERVICE_PASSWORD%,$SERVICE_PASSWORD,g;</span>
<span class="s2">       s,%KEYSTONE_SERVICE_PROTOCOL%,$KEYSTONE_SERVICE_PROTOCOL,g;</span>
<span class="s2">       s,%SERVICE_TOKEN%,${SERVICE_TOKEN},g;</span>
<span class="s2">       s,%KEYSTONE_SERVICE_PORT%,${KEYSTONE_SERVICE_PORT},g;</span>
<span class="s2">       s,%KEYSTONE_SERVICE_HOST%,${KEYSTONE_SERVICE_HOST},g;</span>
<span class="s2">       s,%KEYSTONE_API_PORT%,${KEYSTONE_API_PORT},g;</span>
<span class="s2">       s,%KEYSTONE_AUTH_HOST%,${KEYSTONE_AUTH_HOST},g;</span>
<span class="s2">       s,%KEYSTONE_AUTH_PORT%,${KEYSTONE_AUTH_PORT},g;</span>
<span class="s2">       s,%KEYSTONE_AUTH_PROTOCOL%,${KEYSTONE_AUTH_PROTOCOL},g;</span>
<span class="s2">       s/%AUTH_SERVER%/${swift_auth_server}/g;</span>
<span class="s2">    &quot;</span> <span class="nv">$FILES</span>/swift/proxy-server.conf | <span class="se">\</span>
       sudo tee  <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/proxy-server.conf

   sed -e <span class="s2">&quot;s/%SWIFT_HASH%/$SWIFT_HASH/&quot;</span> <span class="nv">$FILES</span>/swift/swift.conf &gt; <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/swift.conf

</td><td class=code><div class=highlight><pre>
   <span class="k">function </span>generate_swift_configuration<span class="o">()</span> <span class="o">{</span>
       <span class="nb">local </span><span class="nv">server_type</span><span class="o">=</span><span class="nv">$1</span>
       <span class="nb">local </span><span class="nv">bind_port</span><span class="o">=</span><span class="nv">$2</span>
       <span class="nb">local </span><span class="nv">log_facility</span><span class="o">=</span><span class="nv">$3</span>
       <span class="nb">local </span>node_number

       <span class="k">for </span>node_number in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span><span class="nv">node_path</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>
           sed -e <span class="s2">&quot;s,%SWIFT_CONFIG_LOCATION%,${SWIFT_CONFIG_LOCATION},;s,%USER%,$USER,;s,%NODE_PATH%,${node_path},;s,%BIND_PORT%,${bind_port},;s,%LOG_FACILITY%,${log_facility},&quot;</span> <span class="se">\</span>
               <span class="nv">$FILES</span>/swift/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server.conf &gt; <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span>/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf
           <span class="nv">bind_port</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span> <span class="o">+</span> <span class="m">10</span> <span class="k">))</span>
           <span class="nv">log_facility</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span>
       <span class="k">done</span>
   <span class="o">}</span>
   generate_swift_configuration object 6010 2
   generate_swift_configuration container 6011 2
   generate_swift_configuration account 6012 2


</td><td class=code><div class=highlight><pre>
   <span class="nv">swift_log_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_LOCATION</span><span class="k">}</span>/logs
   rm -rf <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
   mkdir -p <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>/hourly
   sudo chown -R syslog:adm <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
   sed <span class="s2">&quot;s,%SWIFT_LOGDIR%,${swift_log_dir},&quot;</span> <span class="nv">$FILES</span>/swift/rsyslog.conf | sudo <span class="se">\</span>
       tee /etc/rsyslog.d/10-swift.conf
   sudo restart rsyslog

</td><td class=code><div class=highlight><pre>
   <span class="nb">pushd</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_LOCATION</span><span class="k">}</span> &gt;/dev/null <span class="o">&amp;&amp;</span> <span class="o">{</span>

       rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz

       <span class="nv">port_number</span><span class="o">=</span>6010
       swift-ring-builder object.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
       <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span>swift-ring-builder object.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
           <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
       <span class="k">done</span>
<span class="k">       </span>swift-ring-builder object.builder rebalance

       <span class="nv">port_number</span><span class="o">=</span>6011
       swift-ring-builder container.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
       <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span>swift-ring-builder container.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
           <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
       <span class="k">done</span>
<span class="k">       </span>swift-ring-builder container.builder rebalance

       <span class="nv">port_number</span><span class="o">=</span>6012
       swift-ring-builder account.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
       <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">           </span>swift-ring-builder account.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
           <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
       <span class="k">done</span>
<span class="k">       </span>swift-ring-builder account.builder rebalance

   <span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">popd</span> &gt;/dev/null

   sudo chmod +x /usr/local/bin/swift-*

</td><td class=code><div class=highlight><pre>
   sudo /etc/init.d/rsync restart <span class="o">||</span> :

</td><td class=code><div class=highlight><pre>
   swift-init all restart <span class="o">||</span> <span class="nb">true</span>
<span class="nb">   </span>swift-init proxy stop <span class="o">||</span> <span class="nb">true</span>

<span class="nb">   unset </span>s swift_hash swift_auth_server
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
    apt_get install tgt

    <span class="k">if</span> ! sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">VOLUME_BACKING_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_BACKING_FILE</span><span class="k">:-</span><span class="nv">$DEST</span><span class="p">/nova-volumes-backing-file</span><span class="k">}</span>
        <span class="nv">VOLUME_BACKING_FILE_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_BACKING_FILE_SIZE</span><span class="k">:-</span><span class="nv">2052M</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
        <span class="o">[[</span> -f <span class="nv">$VOLUME_BACKING_FILE</span> <span class="o">]]</span> <span class="o">||</span> truncate -s <span class="nv">$VOLUME_BACKING_FILE_SIZE</span> <span class="nv">$VOLUME_BACKING_FILE</span>
        <span class="nv">DEV</span><span class="o">=</span><span class="sb">`</span>sudo losetup -f --show <span class="nv">$VOLUME_BACKING_FILE</span><span class="sb">`</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then </span>sudo vgcreate <span class="nv">$VOLUME_GROUP</span> <span class="nv">$DEV</span>; <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    if </span>sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        sudo tgtadm --op show --mode target | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | grep Target | cut -f3 -d <span class="s1">&#39; &#39;</span> | sudo xargs -n1 tgt-admin --delete <span class="o">||</span> <span class="nb">true</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">for </span>lv in <span class="sb">`</span>sudo lvs --noheadings -o lv_name <span class="nv">$VOLUME_GROUP</span><span class="sb">`</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${lv#$VOLUME_NAME_PREFIX}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$lv&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>sudo lvremove -f <span class="nv">$VOLUME_GROUP</span>/<span class="nv">$lv</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>

</td><td class=code><div class=highlight><pre>
    sudo stop tgt <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo start tgt
<span class="k">fi</span>

<span class="nv">NOVA_CONF</span><span class="o">=</span>nova.conf
<span class="k">function </span>add_nova_opt <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> &gt;&gt; <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_DIR</span>/bin/nova.conf

</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
add_nova_opt <span class="s2">&quot;[DEFAULT]&quot;</span>
add_nova_opt <span class="s2">&quot;verbose=True&quot;</span>
add_nova_opt <span class="s2">&quot;auth_strategy=keystone&quot;</span>
add_nova_opt <span class="s2">&quot;allow_resize_to_same_host=True&quot;</span>
add_nova_opt <span class="s2">&quot;root_helper=sudo /usr/local/bin/nova-rootwrap&quot;</span>
add_nova_opt <span class="s2">&quot;compute_scheduler_driver=$SCHEDULER&quot;</span>
add_nova_opt <span class="s2">&quot;dhcpbridge_flagfile=$NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
add_nova_opt <span class="s2">&quot;fixed_range=$FIXED_RANGE&quot;</span>
add_nova_opt <span class="s2">&quot;s3_host=$SERVICE_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;s3_port=$S3_SERVICE_PORT&quot;</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_manager=nova.network.quantum.manager.QuantumManager&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_connection_host=$Q_HOST&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_connection_port=$Q_PORT&quot;</span>

    <span class="k">if </span>is_service_enabled melange; <span class="k">then</span>
<span class="k">        </span>add_nova_opt <span class="s2">&quot;quantum_ipam_lib=nova.network.quantum.melange_ipam_lib&quot;</span>
        add_nova_opt <span class="s2">&quot;use_melange_mac_generation=True&quot;</span>
        add_nova_opt <span class="s2">&quot;melange_host=$M_HOST&quot;</span>
        add_nova_opt <span class="s2">&quot;melange_port=$M_PORT&quot;</span>
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-svc <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>add_nova_opt <span class="s2">&quot;libvirt_vif_type=ethernet&quot;</span>
        add_nova_opt <span class="s2">&quot;libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtOpenVswitchDriver&quot;</span>
        add_nova_opt <span class="s2">&quot;linuxnet_interface_driver=nova.network.linux_net.LinuxOVSInterfaceDriver&quot;</span>
        add_nova_opt <span class="s2">&quot;quantum_use_dhcp=True&quot;</span>
    <span class="k">fi</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_manager=nova.network.manager.$NET_MAN&quot;</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;volume_group=$VOLUME_GROUP&quot;</span>
    add_nova_opt <span class="s2">&quot;volume_name_template=${VOLUME_NAME_PREFIX}%08x&quot;</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;iscsi_helper=tgtadm&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;osapi_compute_extension=nova.api.openstack.compute.contrib.standard_extensions&quot;</span>
add_nova_opt <span class="s2">&quot;my_ip=$HOST_IP&quot;</span>
add_nova_opt <span class="s2">&quot;public_interface=$PUBLIC_INTERFACE&quot;</span>
add_nova_opt <span class="s2">&quot;vlan_interface=$VLAN_INTERFACE&quot;</span>
add_nova_opt <span class="s2">&quot;flat_network_bridge=$FLAT_NETWORK_BRIDGE&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$FLAT_INTERFACE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;flat_interface=$FLAT_INTERFACE&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;sql_connection=$BASE_SQL_CONN/nova?charset=utf8&quot;</span>
add_nova_opt <span class="s2">&quot;libvirt_type=$LIBVIRT_TYPE&quot;</span>
add_nova_opt <span class="s2">&quot;instance_name_template=${INSTANCE_NAME_PREFIX}%08x&quot;</span>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6080/vnc_auto.html&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;novncproxy_base_url=$NOVNCPROXY_URL&quot;</span>
    <span class="nv">XVPVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XVPVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6081/console&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xvpvncproxy_base_url=$XVPVNCPROXY_URL&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=169.254.0.1</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
<span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">VNCSERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
add_nova_opt <span class="s2">&quot;vncserver_listen=$VNCSERVER_LISTEN&quot;</span>
add_nova_opt <span class="s2">&quot;vncserver_proxyclient_address=$VNCSERVER_PROXYCLIENT_ADDRESS&quot;</span>
add_nova_opt <span class="s2">&quot;api_paste_config=$NOVA_CONF_DIR/api-paste.ini&quot;</span>
add_nova_opt <span class="s2">&quot;image_service=nova.image.glance.GlanceImageService&quot;</span>
add_nova_opt <span class="s2">&quot;ec2_dmz_host=$EC2_DMZ_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;rabbit_host=$RABBIT_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;rabbit_password=$RABBIT_PASSWORD&quot;</span>
add_nova_opt <span class="s2">&quot;glance_api_servers=$GLANCE_HOSTPORT&quot;</span>
add_nova_opt <span class="s2">&quot;force_dhcp_release=True&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$INSTANCES_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;instances_path=$INSTANCES_PATH&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;multi_host=True&quot;</span>
    add_nova_opt <span class="s2">&quot;send_arp_for_ha=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;use_syslog=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$API_RATE_LIMIT&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;api_rate_limit=False&quot;</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$EXTRA_OPTS&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">EXTRA_OPTS</span><span class="o">=</span><span class="nv">$EXTRA_FLAGS</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">for </span>I in <span class="s2">&quot;${EXTRA_OPTS[@]}&quot;</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="k">${</span><span class="nv">I</span><span class="p">//-</span><span class="k">}</span>
<span class="k">done</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>read_password XENAPI_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR XEN.&quot;</span>
    add_nova_opt <span class="s2">&quot;connection_type=xenapi&quot;</span>
    <span class="nv">XENAPI_CONNECTION_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_CONNECTION_URL</span><span class="k">:-</span><span class="s2">&quot;http://169.254.0.1&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_url=$XENAPI_CONNECTION_URL&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_username=root&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_password=$XENAPI_PASSWORD&quot;</span>
    add_nova_opt <span class="s2">&quot;flat_injected=False&quot;</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">XEN_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">XEN_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$XEN_FIREWALL_DRIVER&quot;</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;connection_type=libvirt&quot;</span>
    <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$LIBVIRT_FIREWALL_DRIVER&quot;</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS nova;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE nova;&#39;</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage db sync
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>screen_it g-reg <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-registry --config-file=$GLANCE_CONF_DIR/glance-registry.conf&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-api; <span class="k">then</span>
<span class="k">    </span>screen_it g-api <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-api --config-file=$GLANCE_CONF_DIR/glance-api.conf&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for g-api ($GLANCE_HOSTPORT) to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://$GLANCE_HOSTPORT; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;g-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS keystone;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE keystone CHARACTER SET utf8;&#39;</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">KEYSTONE_CONF</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/etc/keystone.conf
    cp <span class="nv">$FILES</span>/keystone.conf <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SQL_CONN%,$BASE_SQL_CONN/keystone?charset=utf8,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%DEST%,$DEST,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
    sudo sed -e <span class="s2">&quot;s,%KEYSTONE_DIR%,$KEYSTONE_DIR,g&quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>

    <span class="nv">KEYSTONE_CATALOG</span><span class="o">=</span><span class="nv">$KEYSTONE_DIR</span>/etc/default_catalog.templates
    cp <span class="nv">$FILES</span>/default_catalog.templates <span class="nv">$KEYSTONE_CATALOG</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.publicURL = http://%SERVICE_HOST%:8080/v1/AUTH_\$(tenant_id)s&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.adminURL = http://%SERVICE_HOST%:8080/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.internalURL = http://%SERVICE_HOST%:8080/v1/AUTH_\$(tenant_id)s&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.name = Swift Service&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.publicURL = http://%SERVICE_HOST%:9696/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.adminURL = http://%SERVICE_HOST%:9696/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.internalURL = http://%SERVICE_HOST%:9696/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.name = Quantum Service&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
    <span class="k">fi</span>

<span class="k">    </span>sudo sed -e <span class="s2">&quot;s,%SERVICE_HOST%,$SERVICE_HOST,g&quot;</span> -i <span class="nv">$KEYSTONE_CATALOG</span>

    sudo sed -e <span class="s2">&quot;s,%S3_SERVICE_PORT%,$S3_SERVICE_PORT,g&quot;</span> -i <span class="nv">$KEYSTONE_CATALOG</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>cp <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf.sample <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf
        sed -i -e <span class="s1">&#39;/^handlers=devel$/s/=devel/=production/&#39;</span> <span class="se">\</span>
            <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf
        sed -i -e <span class="s2">&quot;/^log_file/s/log_file/\#log_file/&quot;</span> <span class="se">\</span>
            <span class="nv">$KEYSTONE_DIR</span>/etc/keystone.conf
        <span class="nv">KEYSTONE_LOG_CONFIG</span><span class="o">=</span><span class="s2">&quot;--log-config $KEYSTONE_DIR/etc/logging.conf&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span>screen_it key <span class="s2">&quot;cd $KEYSTONE_DIR &amp;&amp; $KEYSTONE_DIR/bin/keystone-all --config-file $KEYSTONE_CONF $KEYSTONE_LOG_CONFIG -d --debug&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for keystone to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;keystone did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="nb">pushd</span> <span class="nv">$KEYSTONE_DIR</span>
    <span class="nv">$KEYSTONE_DIR</span>/bin/keystone-manage db_sync
    <span class="nb">popd</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT</span>/v2.0
    <span class="nv">ADMIN_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span> <span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="nv">$SERVICE_TENANT_NAME</span> <span class="nv">SERVICE_PASSWORD</span><span class="o">=</span><span class="nv">$SERVICE_PASSWORD</span> <span class="nv">SERVICE_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span> <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span> <span class="nv">DEVSTACK_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span> <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="nv">$ENABLED_SERVICES</span> <span class="se">\</span>
        bash <span class="nv">$FILES</span>/keystone_data.sh

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
<span class="k">        </span><span class="nv">CREDS</span><span class="o">=</span><span class="k">$(</span>keystone --os_auth_url<span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span> --os_username<span class="o">=</span>nova --os_password<span class="o">=</span><span class="nv">$SERVICE_PASSWORD</span> --os_tenant_name<span class="o">=</span><span class="nv">$SERVICE_TENANT_NAME</span> ec2-credentials-create<span class="k">)</span>
        <span class="nv">ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ access / { print $4 }&#39;</span><span class="k">)</span>
        <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ secret / { print $4 }&#39;</span><span class="k">)</span>
        add_nova_opt <span class="s2">&quot;s3_access_key=$ACCESS_KEY&quot;</span>
        add_nova_opt <span class="s2">&quot;s3_secret_key=$SECRET_KEY&quot;</span>
        add_nova_opt <span class="s2">&quot;s3_affix_tenant=True&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">    </span>screen_it n-api <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-api&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for nova-api to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:8774; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;nova-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage network create private <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span> <span class="nv">$NETWORK_CREATE_ARGS</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create <span class="nv">$FLOATING_RANGE</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create --ip_range<span class="o">=</span><span class="nv">$TEST_FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$TEST_FLOATING_POOL</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; sg libvirtd $NOVA_DIR/bin/nova-compute&quot;</span>
screen_it n-crt <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-cert&quot;</span>
screen_it n-vol <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-volume&quot;</span>
screen_it n-net <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-network&quot;</span>
screen_it n-sch <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-scheduler&quot;</span>
screen_it n-novnc <span class="s2">&quot;cd $NOVNC_DIR &amp;&amp; ./utils/nova-novncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF --web .&quot;</span>
screen_it n-xvnc <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-xvpvncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
screen_it n-cauth <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-consoleauth&quot;</span>
screen_it horizon <span class="s2">&quot;cd $HORIZON_DIR &amp;&amp; sudo tail -f /var/log/apache2/error.log&quot;</span>
screen_it swift <span class="s2">&quot;cd $SWIFT_DIR &amp;&amp; $SWIFT_DIR/bin/swift-proxy-server ${SWIFT_CONFIG_LOCATION}/proxy-server.conf -v&quot;</span>

</td><td class=code><div class=highlight><pre>
is_service_enabled swift <span class="o">||</span> <span class="se">\</span>
    screen_it n-obj <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-objectstore&quot;</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images

    <span class="nv">ADMIN_USER</span><span class="o">=</span>admin
    <span class="nv">ADMIN_TENANT</span><span class="o">=</span>admin
    <span class="nv">TOKEN</span><span class="o">=</span><span class="sb">`</span>curl -s -d  <span class="s2">&quot;{\&quot;auth\&quot;:{\&quot;passwordCredentials\&quot;: {\&quot;username\&quot;: \&quot;$ADMIN_USER\&quot;, \&quot;password\&quot;: \&quot;$ADMIN_PASSWORD\&quot;}, \&quot;tenantName\&quot;: \&quot;$ADMIN_TENANT\&quot;}}&quot;</span> -H <span class="s2">&quot;Content-type: application/json&quot;</span> http://<span class="nv">$HOST_IP</span>:5000/v2.0/tokens | python -c <span class="s2">&quot;import sys; import json; tok = json.loads(sys.stdin.read()); print tok[&#39;access&#39;][&#39;token&#39;][&#39;id&#39;];&quot;</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$UPLOAD_LEGACY_TTY&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">IMAGE_URLS</span><span class="o">=</span><span class="s2">&quot;${IMAGE_URLS:+${IMAGE_URLS},}http://images.ansolabs.com/tty.tgz&quot;</span>
    <span class="k">fi</span>

<span class="k">    for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
        <span class="nv">IMAGE_FNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$image_url&quot;</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>wget -c <span class="nv">$image_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span>
        <span class="k">fi</span>

<span class="k">        </span><span class="nv">KERNEL</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">RAMDISK</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">DISK_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> in
            *.tar.gz|*.tgz<span class="o">)</span>
</td><td class=code><div class=highlight><pre>
                <span class="o">[</span> <span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                    <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> <span class="o">||</span>
                    <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tgz}&quot;</span>
                <span class="nv">xdir</span><span class="o">=</span><span class="s2">&quot;$FILES/images/$IMAGE_NAME&quot;</span>
                rm -Rf <span class="s2">&quot;$xdir&quot;</span>;
                mkdir <span class="s2">&quot;$xdir&quot;</span>
                tar -zxf <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> -C <span class="s2">&quot;$xdir&quot;</span>
                <span class="nv">KERNEL</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-vmlinuz* <span class="s2">&quot;$xdir/&quot;</span>aki-*/image; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="nv">RAMDISK</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-initrd* <span class="s2">&quot;$xdir/&quot;</span>ari-*/image; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*.img <span class="s2">&quot;$xdir/&quot;</span>ami-*/image; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$IMAGE_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                    </span><span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
                <span class="k">fi</span>
                ;;
            *.img<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/$IMAGE_FNAME&quot;</span>;
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
                <span class="nv">DISK_FORMAT</span><span class="o">=</span>raw
                <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
                ;;
            *.img.gz<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img.gz&quot;</span><span class="k">)</span>
                <span class="nv">DISK_FORMAT</span><span class="o">=</span>raw
                <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
                ;;
            *.qcow2<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.qcow2&quot;</span><span class="k">)</span>
                <span class="nv">DISK_FORMAT</span><span class="o">=</span>qcow2
                <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
                ;;
            *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Do not know what to do with $IMAGE_FNAME&quot;</span>; <span class="nb">false</span>;;
        <span class="k">esac</span>

<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$CONTAINER_FORMAT&quot;</span> <span class="o">=</span> <span class="s2">&quot;bare&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;$IMAGE_NAME&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span><span class="nv">$CONTAINER_FORMAT</span> <span class="nv">disk_format</span><span class="o">=</span><span class="nv">$DISK_FORMAT</span> &lt; &lt;<span class="o">(</span>zcat --force <span class="s2">&quot;${IMAGE}&quot;</span><span class="o">)</span>
        <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
            <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>; <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>;
            <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$KERNEL&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;$IMAGE_NAME-kernel&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>aki <span class="nv">disk_format</span><span class="o">=</span>aki &lt; <span class="s2">&quot;$KERNEL&quot;</span><span class="sb">`</span>
                <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
            <span class="k">fi</span>
<span class="k">            if</span> <span class="o">[</span> -n <span class="s2">&quot;$RAMDISK&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">RVAL</span><span class="o">=</span><span class="sb">`</span>glance add --silent-upload -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;$IMAGE_NAME-ramdisk&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ari <span class="nv">disk_format</span><span class="o">=</span>ari &lt; <span class="s2">&quot;$RAMDISK&quot;</span><span class="sb">`</span>
                <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$RVAL</span> | cut -d<span class="s2">&quot;:&quot;</span> -f2 | tr -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
            <span class="k">fi</span>
<span class="k">            </span>glance add -A <span class="nv">$TOKEN</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;${IMAGE_NAME%.img}&quot;</span> <span class="nv">is_public</span><span class="o">=</span><span class="nb">true </span><span class="nv">container_format</span><span class="o">=</span>ami <span class="nv">disk_format</span><span class="o">=</span>ami <span class="k">${</span><span class="nv">KERNEL_ID</span><span class="p">:+kernel_id=</span><span class="nv">$KERNEL_ID</span><span class="k">}</span> <span class="k">${</span><span class="nv">RAMDISK_ID</span><span class="p">:+ramdisk_id=</span><span class="nv">$RAMDISK_ID</span><span class="k">}</span> &lt; &lt;<span class="o">(</span>zcat --force <span class="s2">&quot;${IMAGE}&quot;</span><span class="o">)</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -x <span class="nv">$TOP_DIR</span>/local.sh <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Running user script $TOP_DIR/local.sh&quot;</span>
    <span class="nv">$TOP_DIR</span>/local.sh
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="nb">set</span> +o xtrace


</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Horizon is now available at http://$SERVICE_HOST/&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Keystone is serving at $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;This is your host ip: $HOST_IP&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: EXTRA_FLAGS is defined and may need to be converted to EXTRA_OPTS&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;stack.sh completed in $SECONDS seconds.&quot;</span>


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
