<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><tt class="docutils literal">stack.sh</tt> is an opinionated OpenStack developer installation.  It
installs and configures various combinations of <strong>Ceilometer</strong>, <strong>Cinder</strong>,
<strong>Glance</strong>, <strong>Heat</strong>, <strong>Horizon</strong>, <strong>Keystone</strong>, <strong>Nova</strong>, <strong>Quantum</strong>
and <strong>Swift</strong></p>
</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div></td></tr><tr><td class=docs>
<p>This script allows you to specify configuration options of what git
repositories to use, enabled services, network configuration and various
passwords.  If you are crafty you can run the script on multiple nodes using
shared settings for common resources (mysql, rabbitmq) and build a multi-node
developer install.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To keep this script simple we assume you are running on a recent <strong>Ubuntu</strong>
(11.10 Oneiric or 12.04 Precise) or <strong>Fedora</strong> (F16 or F17) machine.  It
should work in a VM or physical server.  Additionally we put the list of
<tt class="docutils literal">apt</tt> and <tt class="docutils literal">rpm</tt> dependencies and other configuration files in this repo.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Learn more and get the most recent version at <a class="reference external" href="http://devstack.org">http://devstack.org</a></p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>Keep track of the devstack directory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Import common functions</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/functions

</pre></div></td></tr><tr><td class=docs>
<p>Determine what system we are running on.  This provides <tt class="docutils literal">os_VENDOR</tt>,
<tt class="docutils literal">os_RELEASE</tt>, <tt class="docutils literal">os_UPDATE</tt>, <tt class="docutils literal">os_PACKAGE</tt>, <tt class="docutils literal">os_CODENAME</tt>
and <tt class="docutils literal">DISTRO</tt></p>
</td><td class=code><div class=highlight><pre>
GetDistro


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="settings">
<h1>Settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> is customizable through setting environment variables.  If you
want to override a setting you can set and export it:</p>
<pre class="literal-block">
export MYSQL_PASSWORD=anothersecret
./stack.sh
</pre>
<p>You can also pass options on a single line <tt class="docutils literal">MYSQL_PASSWORD=simple ./stack.sh</tt></p>
<p>Additionally, you can put any local variables into a <tt class="docutils literal">localrc</tt> file:</p>
<pre class="literal-block">
MYSQL_PASSWORD=anothersecret
MYSQL_USER=hellaroot
</pre>
<p>We try to have sensible defaults, so you should be able to run <tt class="docutils literal">./stack.sh</tt>
in most cases.  <tt class="docutils literal">localrc</tt> is not distributed with DevStack and will never
be overwritten by a DevStack update.</p>
<p>DevStack distributes <tt class="docutils literal">stackrc</tt> which contains locations for the OpenStack
repositories and branches to configure.  <tt class="docutils literal">stackrc</tt> sources <tt class="docutils literal">localrc</tt> to
allow you to safely override those settings.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> ! -r <span class="nv">$TOP_DIR</span>/stackrc <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing $TOP_DIR/stackrc - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/stackrc


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="proxy-settings">
<h2>Proxy Settings</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>HTTP and HTTPS proxy servers are supported via the usual environment variables [1]
<tt class="docutils literal">http_proxy</tt>, <tt class="docutils literal">https_proxy</tt> and <tt class="docutils literal">no_proxy</tt>. They can be set in
<tt class="docutils literal">localrc</tt> if necessary or on the command line:</p>
<pre class="literal-block">
[1] http://www.w3.org/Daemon/User/Proxies/ProxyClients.html
</pre>
<blockquote>
http_proxy=http://proxy.example.com:3128/ no_proxy=repo.example.net ./stack.sh</blockquote>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$http_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$https_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$no_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for installation <tt class="docutils literal">DEST</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="sanity-check">
<h1>Sanity Check</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Remove services which were negated in ENABLED_SERVICES
using the &quot;-&quot; prefix (e.g., &quot;-n-vol&quot;) instead of
calling disable_service().</p>
</td><td class=code><div class=highlight><pre>
disable_negated_services

</pre></div></td></tr><tr><td class=docs>
<p>Warn users who aren't on an explicitly supported distro, but allow them to
override check and attempt installation with <tt class="docutils literal">FORCE=yes ./stack</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">DISTRO</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">(</span>oneiric|precise|quantal|f16|f17<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has not been tested on $DISTRO&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Disallow qpid on oneiric</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${DISTRO}&quot;</span> <span class="o">=</span> <span class="s2">&quot;oneiric&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> is_service_enabled qpid ; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Qpid was introduced in precise</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;You must use Ubuntu Precise or newer for Qpid support.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the paths of certain binaries</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVA_ROOTWRAP</span><span class="o">=</span>/usr/local/bin/nova-rootwrap
<span class="k">else</span>
<span class="k">    </span><span class="nv">NOVA_ROOTWRAP</span><span class="o">=</span>/usr/bin/nova-rootwrap
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> keeps function libraries here
Make sure <tt class="docutils literal">$TOP_DIR/lib</tt> directory is present</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$TOP_DIR</span>/lib <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/lib&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> keeps the list of <tt class="docutils literal">apt</tt> and <tt class="docutils literal">rpm</tt> dependencies and config
templates and other useful files in the <tt class="docutils literal">files</tt> subdirectory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/files&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Check to see if we are already running DevStack</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span><span class="nb">type</span> -p screen &gt;/dev/null <span class="o">&amp;&amp;</span> screen -ls | egrep -q <span class="s2">&quot;[0-9].$SCREEN_NAME&quot;</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are already running a stack.sh session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To rejoin this session type &#39;screen -x stack&#39;.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To destroy this session, type &#39;./unstack.sh&#39;.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure we only have one rpc backend enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">rpc_backend_cnt</span><span class="o">=</span>0
<span class="k">for </span>svc in qpid zeromq rabbit; <span class="k">do</span>
<span class="k">    </span>is_service_enabled <span class="nv">$svc</span> <span class="o">&amp;&amp;</span>
        <span class="o">((</span>rpc_backend_cnt++<span class="o">))</span>
<span class="k">done</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$rpc_backend_cnt&quot;</span> -gt 1 <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: only one rpc backend may be enabled,&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;       set only one of &#39;rabbit&#39;, &#39;qpid&#39;, &#39;zeromq&#39;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;       via ENABLED_SERVICES.&quot;</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$rpc_backend_cnt&quot;</span> <span class="o">==</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: at least one rpc backend must be enabled,&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;       set one of &#39;rabbit&#39;, &#39;qpid&#39;, &#39;zeromq&#39;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;       via ENABLED_SERVICES.&quot;</span>
<span class="k">fi</span>
<span class="nb">unset </span>rpc_backend_cnt

</pre></div></td></tr><tr><td class=docs>
<p>Make sure we only have one volume service enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled cinder <span class="o">&amp;&amp;</span> is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: n-vol and cinder must not be enabled at the same time&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging level</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VERBOSE</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$VERBOSE</span><span class="k">)</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="root-access">
<h2>root Access</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack is designed to be run as a non-root user; Horizon will fail to run
as <strong>root</strong> since Apache will not serve content from <strong>root</strong> user).  If
<tt class="docutils literal">stack.sh</tt> is run as <strong>root</strong>, it automatically creates a <strong>stack</strong> user with
sudo privileges and runs as that user.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">ROOTSLEEP</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOTSLEEP</span><span class="k">:-</span><span class="nv">10</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;In $ROOTSLEEP seconds, we will create a user &#39;stack&#39; and run as that user&quot;</span>
    sleep <span class="nv">$ROOTSLEEP</span>

</pre></div></td></tr><tr><td class=docs>
<p>Give the non-root user the ability to run as <strong>root</strong> via <tt class="docutils literal">sudo</tt></p>
</td><td class=code><div class=highlight><pre>
    is_package_installed sudo <span class="o">||</span> install_package sudo
    <span class="k">if</span> ! getent group stack &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a group called stack&quot;</span>
        groupadd stack
    <span class="k">fi</span>
<span class="k">    if</span> ! getent passwd stack &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a user called stack&quot;</span>
        useradd -g stack -s /bin/bash -d <span class="nv">$DEST</span> -m stack
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Giving stack user passwordless sudo privileges&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>UEC images <tt class="docutils literal">/etc/sudoers</tt> does not have a <tt class="docutils literal">#includedir</tt>, add one</p>
</td><td class=code><div class=highlight><pre>
    grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> &gt;&gt; /etc/sudoers
    <span class="o">(</span> <span class="nb">umask </span>226 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="se">\</span>
        &gt; /etc/sudoers.d/50_stack_sh <span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&quot;Copying files to stack user&quot;</span>
    <span class="nv">STACK_DIR</span><span class="o">=</span><span class="s2">&quot;$DEST/${PWD##*/}&quot;</span>
    cp -r -f -T <span class="s2">&quot;$PWD&quot;</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    chown -R stack <span class="s2">&quot;$STACK_DIR&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SHELL_AFTER_RUN&quot;</span> !<span class="o">=</span> <span class="s2">&quot;no&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh; bash&quot;</span> stack
    <span class="k">else</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh&quot;</span> stack
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>1
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>We're not <strong>root</strong>, make sure <tt class="docutils literal">sudo</tt> is available</p>
</td><td class=code><div class=highlight><pre>
    is_package_installed sudo <span class="o">||</span> die <span class="s2">&quot;Sudo is required.  Re-run stack.sh as root ONE TIME ONLY to set up sudo.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>UEC images <tt class="docutils literal">/etc/sudoers</tt> does not have a <tt class="docutils literal">#includedir</tt>, add one</p>
</td><td class=code><div class=highlight><pre>
    sudo grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> | sudo tee -a /etc/sudoers

</pre></div></td></tr><tr><td class=docs>
<p>Set up devstack sudoers</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;`whoami` ALL=(root) NOPASSWD:ALL&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
</pre></div></td></tr><tr><td class=docs>
<p>Some binaries might be under /sbin or /usr/sbin, so make sure sudo will
see them by forcing PATH</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;Defaults:`whoami` secure_path=/sbin:/usr/sbin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin&quot;</span> &gt;&gt; <span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/50_stack_sh

</pre></div></td></tr><tr><td class=docs>
<p>Remove old file</p>
</td><td class=code><div class=highlight><pre>
    sudo rm -f /etc/sudoers.d/stack_sh_nova
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create the destination directory and ensure it is writable by the user</p>
</td><td class=code><div class=highlight><pre>
sudo mkdir -p <span class="nv">$DEST</span>
<span class="k">if</span> <span class="o">[</span> ! -w <span class="nv">$DEST</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DEST</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">OFFLINE</tt> to <tt class="docutils literal">True</tt> to configure <tt class="docutils literal">stack.sh</tt> to run cleanly without
Internet access. <tt class="docutils literal">stack.sh</tt> must have been previously run with Internet
access to install prerequisites and fetch repositories.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OFFLINE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$OFFLINE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">ERROR_ON_CLONE</tt> to <tt class="docutils literal">True</tt> to configure <tt class="docutils literal">stack.sh</tt> to exit if
the destination git repository does not exist during the <tt class="docutils literal">git_clone</tt>
operation.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ERROR_ON_CLONE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$ERROR_ON_CLONE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for service data</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/data</span><span class="k">}</span>
sudo mkdir -p <span class="nv">$DATA_DIR</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DATA_DIR</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="common-configuration">
<h1>Common Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set fixed and floating range here so we can make sure not to use addresses
from either range when attempting to guess the IP to use for the host.
Note that setting FIXED_RANGE may be necessary when running DevStack
in an OpenStack cloud that uses either of these address ranges internally.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.224/28</span><span class="k">}</span>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>
<span class="nv">NETWORK_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK_GATEWAY</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.1</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Find the interface used for the default route</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">HOST_IP_IFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">:-$(</span>ip route | sed -n <span class="s1">&#39;/^default/{ s/.*dev \(\w\+\)\s\+.*/\1/; p; }&#39;</span><span class="k">)}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Search for an IP unless an explicit is set by <tt class="docutils literal">HOST_IP</tt> environment variable</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$HOST_IP&quot;</span> -o <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">HOST_IPS</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C ip -f inet addr show <span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">}</span> | awk <span class="s1">&#39;/inet/ {split($2,parts,&quot;/&quot;);  print parts[1]}&#39;</span><span class="sb">`</span>
    <span class="k">for </span>IP in <span class="nv">$HOST_IPS</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to filter out IP addresses that are part of the fixed and
floating range. Note that this method only works if the <tt class="docutils literal">netaddr</tt>
python library is installed. If it is not installed, an error
will be printed and the first IP from the interface will be used.
If that is not correct set <tt class="docutils literal">HOST_IP</tt> in <tt class="docutils literal">localrc</tt> to the correct
address.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! <span class="o">(</span>address_in_net <span class="nv">$IP</span> <span class="nv">$FIXED_RANGE</span> <span class="o">||</span> address_in_net <span class="nv">$IP</span> <span class="nv">$FLOATING_RANGE</span><span class="o">)</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="nv">$IP</span>
            <span class="nb">break</span>;
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Could not determine host ip address.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Either localrc specified dhcp on ${HOST_IP_IFACE} or defaulted&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Allow the use of an alternate hostname (such as localhost/127.0.0.1) for service endpoints.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure services to use syslog instead of writing to individual log files</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SYSLOG</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$SYSLOG</span><span class="sb">`</span>
<span class="nv">SYSLOG_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SYSLOG_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_PORT</span><span class="k">:-</span><span class="nv">516</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use color for logging output (only available if syslog is not used)</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LOG_COLOR</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$LOG_COLOR</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service startup timeout</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TIMEOUT</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TIMEOUT</span><span class="k">:-</span><span class="nv">60</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-projects">
<h1>Configure Projects</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Get project function libraries</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/keystone
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/cinder
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/n-vol
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/ceilometer
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/heat
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/quantum

</pre></div></td></tr><tr><td class=docs>
<p>Set the destination directories for OpenStack projects</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">HORIZON_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/horizon
<span class="nv">OPENSTACKCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-openstackclient
<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC
<span class="nv">SWIFT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift
<span class="nv">SWIFT3_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift3
<span class="nv">SWIFTCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-swiftclient
<span class="nv">QUANTUM_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/quantum
<span class="nv">QUANTUM_CLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-quantumclient

</pre></div></td></tr><tr><td class=docs>
<p>Nova defaults</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/nova
<span class="nv">NOVACLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-novaclient
<span class="nv">NOVA_STATE_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="p">:=</span><span class="nv">$DATA_DIR</span><span class="p">/nova</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>INSTANCES_PATH is the previous name for this</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_INSTANCES_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_INSTANCES_PATH</span><span class="p">:=</span><span class="k">${</span><span class="nv">INSTANCES_PATH</span><span class="p">:=</span><span class="nv">$NOVA_STATE_PATH</span><span class="p">/instances</span><span class="k">}}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Support entry points installation of console scripts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NOVA_DIR</span>/bin <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVA_BIN_DIR</span><span class="o">=</span><span class="nv">$NOVA_DIR</span>/bin
<span class="k">else</span>
<span class="k">    </span><span class="nv">NOVA_BIN_DIR</span><span class="o">=</span>/usr/local/bin
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Glance defaults</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance
<span class="nv">GLANCECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-glanceclient
<span class="nv">GLANCE_CACHE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_CACHE_DIR</span><span class="p">:=</span><span class="nv">$DATA_DIR</span><span class="p">/glance/cache</span><span class="k">}</span>
<span class="nv">GLANCE_IMAGE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_IMAGE_DIR</span><span class="p">:=</span><span class="nv">$DATA_DIR</span><span class="p">/glance/images</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Support entry points installation of console scripts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$GLANCE_DIR</span>/bin <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">GLANCE_BIN_DIR</span><span class="o">=</span><span class="nv">$GLANCE_DIR</span>/bin
<span class="k">else</span>
<span class="k">    </span><span class="nv">GLANCE_BIN_DIR</span><span class="o">=</span>/usr/local/bin
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Plugin</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PLUGIN</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PLUGIN</span><span class="k">:-</span><span class="nv">openvswitch</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Port</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT</span><span class="k">:-</span><span class="nv">9696</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Host</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Which Quantum API nova should use
Default admin username</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ADMIN_USERNAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ADMIN_USERNAME</span><span class="k">:-</span><span class="nv">quantum</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default auth strategy</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_AUTH_STRATEGY</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_AUTH_STRATEGY</span><span class="k">:-</span><span class="nv">keystone</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use namespace or not</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_USE_NAMESPACE</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_NAMESPACE</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Meta data IP</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_META_DATA_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_META_DATA_IP</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Name of the LVM volume group to use/create for iscsi volumes</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VOLUME_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_GROUP</span><span class="k">:-</span><span class="nv">stack</span><span class="p">-volumes</span><span class="k">}</span>
<span class="nv">VOLUME_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_NAME_PREFIX</span><span class="k">:-</span><span class="nv">volume</span><span class="p">-</span><span class="k">}</span>
<span class="nv">INSTANCE_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">INSTANCE_NAME_PREFIX</span><span class="k">:-</span><span class="nv">instance</span><span class="p">-</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Nova supports pluggable schedulers.  The default <tt class="docutils literal">FilterScheduler</tt>
should work in most cases.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SCHEDULER</span><span class="o">=</span><span class="k">${</span><span class="nv">SCHEDULER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.scheduler.filter_scheduler.FilterScheduler</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Generic helper to configure passwords</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>read_password <span class="o">{</span>
    <span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>; <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>

    <span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/localrc

</pre></div></td></tr><tr><td class=docs>
<p>If the password is not defined yet, proceed to prompt user for a password.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If there is no localrc file, create one</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$localrc</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>touch <span class="nv">$localrc</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Presumably if we got this far it can only be that our localrc is missing
the required password.  Prompt user for a password and write to localrc.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="nv">$msg</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This value will be written to your localrc file so you don&#39;t have to enter it &quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;again.  Use only alphanumeric characters.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;If you leave this blank, a random default value will be used.&quot;</span>
        <span class="nv">pw</span><span class="o">=</span><span class="s2">&quot; &quot;</span>
        <span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Enter a password now:&quot;</span>
            <span class="nb">read</span> -e <span class="nv">$var</span>
            <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>
            <span class="o">[[</span> <span class="s2">&quot;$pw&quot;</span> <span class="o">=</span> <span class="s2">&quot;`echo $pw | tr -cd [:alnum:]`&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">            echo</span> <span class="s2">&quot;Invalid chars in password.  Try again:&quot;</span>
        <span class="k">done</span>
<span class="k">        if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">pw</span><span class="o">=</span><span class="sb">`</span>openssl rand -hex 10<span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">eval</span> <span class="s2">&quot;$var=$pw&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;$var=$pw&quot;</span> &gt;&gt; <span class="nv">$localrc</span>
    <span class="k">fi</span>
    <span class="nv">$XTRACE</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="nova-network-configuration">
<h2>Nova Network Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>FIXME: more documentation about why these are important options.  Also
we should make sure we use the same variable names as the option names.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth3
</pre></div></td></tr><tr><td class=docs>
<p>Allow <tt class="docutils literal">build_domU.sh</tt> to specify the flat network bridge via kernel args</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span><span class="k">$(</span>grep -o <span class="s1">&#39;flat_network_bridge=[[:alnum:]]*&#39;</span> /proc/cmdline | cut -d<span class="o">=</span> -f 2 | sort -u<span class="k">)</span>
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth1
<span class="k">else</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
<span class="k">fi</span>

<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">$FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Test floating pool and range are used for testing.  They are defined
here until the admin APIs can replace nova-manage</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TEST_FLOATING_POOL</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_POOL</span><span class="k">:-</span><span class="nv">test</span><span class="k">}</span>
<span class="nv">TEST_FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_RANGE</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.253.0/29</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">MULTI_HOST</tt> is a mode where each compute node runs its own network node.  This
allows network operations and routing for a VM to occur on the server that is
running the VM - removing a SPOF and bandwidth bottleneck.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$MULTI_HOST</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you are using the FlatDHCP network mode on multiple hosts, set the
<tt class="docutils literal">FLAT_INTERFACE</tt> variable but make sure that the interface doesn't already
have an IP or you risk breaking things.</p>
<p><strong>DHCP Warning</strong>:  If your flat interface device uses DHCP, there will be a
hiccup while the network is moved from the flat interface to the flat network
bridge.  This will happen when you launch your first instance.  Upon launch
you will lose all connectivity to the node, and the VM launch will probably
fail.</p>
<p>If you are running on a single node and don't need to access the VMs from
devices other than that node, you can set FLAT_INTERFACE=
This will stop nova from bridging any interfaces into FLAT_NETWORK_BRIDGE.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="p">-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

<span class="c">## FIXME(ja): should/can we check that FLAT_INTERFACE is sane?</span>

</pre></div></td></tr><tr><td class=docs>
<p>Using Quantum networking:</p>
<p>Make sure that quantum is enabled in ENABLED_SERVICES.  If you want
to run Quantum on this host, make sure that q-svc is also in
ENABLED_SERVICES.</p>
<p>If you're planning to use the Quantum openvswitch plugin, set
Q_PLUGIN to &quot;openvswitch&quot; and make sure the q-agt service is enabled
in ENABLED_SERVICES.  If you're planning to use the Quantum
linuxbridge plugin, set Q_PLUGIN to &quot;linuxbridge&quot; and make sure the
q-agt service is enabled in ENABLED_SERVICES.</p>
<p>See &quot;Quantum Network Configuration&quot; below for additional variables
that must be set in localrc for connectivity across hosts with
Quantum.</p>
<p>With Quantum networking the NET_MAN variable is ignored.</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="mysql-rabbitmq-or-qpid">
<h2>MySQL &amp; (RabbitMQ or Qpid)</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>We configure Nova, Horizon, Glance and Keystone to use MySQL as their
database server.  While they share a single server, each has their own
database and tables.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>By default this script will install and configure MySQL.  If you want to
use an existing server, you can pass in the user/password/host parameters.
You will need to send the same <tt class="docutils literal">MYSQL_PASSWORD</tt> to every host if you are doing
a multi-node DevStack installation.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MYSQL_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
<span class="nv">MYSQL_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_USER</span><span class="k">:-</span><span class="nv">root</span><span class="k">}</span>
read_password MYSQL_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR MYSQL.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>NOTE: Don't specify <tt class="docutils literal">/db</tt> in this string so we can use it for multiple services</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_SQL_CONN</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_SQL_CONN</span><span class="k">:-</span><span class="nv">mysql</span><span class="p">://</span><span class="nv">$MYSQL_USER</span><span class="p">:</span><span class="nv">$MYSQL_PASSWORD</span><span class="p">@</span><span class="nv">$MYSQL_HOST</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Rabbit connection info</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
<span class="k">    </span><span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
    read_password RABBIT_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR RABBIT.&quot;</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="glance">
<h2>Glance</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Glance connection info.  Note the port must be specified.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_HOSTPORT</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_HOSTPORT</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="p">:</span><span class="nv">9292</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="swift">
<h2>Swift</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>TODO: add logging to different location.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">SWIFT_DATA_DIR</tt> to the location of swift drives and objects.
Default is the common DevStack data directory.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/data/swift</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">SWIFT_CONFIG_DIR</tt> to the location of the configuration files.
Default is <tt class="docutils literal">/etc/swift</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_CONFIG_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">:-</span><span class="p">/etc/swift</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>DevStack will create a loop-back disk formatted as XFS to store the
swift data. Set <tt class="docutils literal">SWIFT_LOOPBACK_DISK_SIZE</tt> to the disk size in bytes.
Default is 1 gigabyte.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">:-</span><span class="nv">1000000</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>The ring uses a configurable number of bits from a path’s MD5 hash as
a partition index that designates a device. The number of bits kept
from the hash is known as the partition power, and 2 to the partition
power indicates the partition count. Partitioning the full MD5 hash
ring allows other parts of the cluster to work in batches of items at
once which ends up either more efficient or at least less complex than
working with each item separately or the entire cluster all at once.
By default we define 9 for the partition count (which mean 512).</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">:-</span><span class="nv">9</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">SWIFT_REPLICAS</tt> to configure how many replicas are to be
configured for your Swift cluster.  By default the three replicas would need a
bit of IO and Memory on a VM you may want to lower that to 1 if you want to do
only some quick testing.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_REPLICAS</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">:-</span><span class="nv">3</span><span class="k">}</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If we are using swift3, we can default the s3 port to swift instead
of nova-objectstore</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift3;then
        <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>We only ask for Swift Hash if we have enabled swift service.
SWIFT_HASH is a random unique string for a swift cluster that
can never change.</p>
</td><td class=code><div class=highlight><pre>
    read_password SWIFT_HASH <span class="s2">&quot;ENTER A RANDOM SWIFT HASH.&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set default port for nova-objectstore</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">3333</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="keystone">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>The <tt class="docutils literal">SERVICE_TOKEN</tt> is used to bootstrap the Keystone database.  It is
just a string and is not a 'real' Keystone token.</p>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_TOKEN <span class="s2">&quot;ENTER A SERVICE_TOKEN TO USE FOR THE SERVICE ADMIN TOKEN.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Services authenticate to Identity with servicename/SERVICE_PASSWORD</p>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_PASSWORD <span class="s2">&quot;ENTER A SERVICE_PASSWORD TO USE FOR THE SERVICE AUTHENTICATION.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Horizon currently truncates usernames and passwords at 20 characters</p>
</td><td class=code><div class=highlight><pre>
read_password ADMIN_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR HORIZON AND KEYSTONE (20 CHARS OR LESS).&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the tenant for service accounts in Keystone</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TENANT_NAME</span><span class="k">:-</span><span class="nv">service</span><span class="k">}</span>



</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="horizon">
<h2>Horizon</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Allow overriding the default Apache user and group, default both to
current user.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">APACHE_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_USER</span><span class="k">:-</span><span class="nv">$USER</span><span class="k">}</span>
<span class="nv">APACHE_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_GROUP</span><span class="k">:-</span><span class="nv">$APACHE_USER</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="log-files">
<h2>Log files</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Echo text to the log file, summary log file and stdout
echo_summary &quot;something to say&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>echo_summary<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&amp;6
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo text only to stdout, no log files
echo_nolog &quot;something not for the logs&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>echo_nolog<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&amp;3
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging for <tt class="docutils literal">stack.sh</tt>
Set <tt class="docutils literal">LOGFILE</tt> to turn on logging
Append '.xxxxxxxx' to the given name to maintain history
where 'xxxxxxxx' is a representation of the date the file was created</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LOGDAYS</span><span class="o">=</span><span class="k">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="k">}</span>
    <span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="k">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="k">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>First clean up old log files.  Use the user-specified <tt class="docutils literal">LOGFILE</tt>
as the template to search for, appending '.*' to match the date
we added on earlier runs.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    <span class="nv">LOGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    mkdir -p <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth 1 -name <span class="nv">$LOGNAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>
    <span class="nv">SUMFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.summary

</pre></div></td></tr><tr><td class=docs>
<p>Redirect output according to config
Copy stdout to fd 3</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>3&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VERBOSE&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Redirect stdout/stderr to tee to write the log file</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
</pre></div></td></tr><tr><td class=docs>
<p>Set up a second fd for output</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${SUMFILE}&quot;</span> <span class="o">)</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 1 and 2 to primary logfile</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt; <span class="s2">&quot;${LOGFILE}&quot;</span> 2&gt;&amp;1
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 6 to summary logfile and stdout</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${SUMFILE}&quot;</span> /dev/fd/3 <span class="o">)</span>
    <span class="k">fi</span>

<span class="k">    </span>echo_summary <span class="s2">&quot;stack.sh log $LOGFILE&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specified logfile name always links to the most recent log</p>
</td><td class=code><div class=highlight><pre>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>
    ln -sf <span class="nv">$SUMFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>.summary
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set up output redirection without log files
Copy stdout to fd 3</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>3&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Throw away stdout and stderr</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt;/dev/null 2&gt;&amp;1
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Always send summary fd to original stdout</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>6&gt;&amp;3
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging of screen windows
Set <tt class="docutils literal">SCREEN_LOGDIR</tt> to turn on logging of screen windows to the
directory specified in <tt class="docutils literal">SCREEN_LOGDIR</tt>, we will log to the the file
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME-$TIMESTAMP.log</span></tt> in that dir and have a link
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME.log</span></tt> to the latest log file.
Logs are kept for as long specified in <tt class="docutils literal">LOGDAYS</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>We make sure the directory is created.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We cleanup the old logs</p>
</td><td class=code><div class=highlight><pre>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth 1 -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
<span class="k">        </span>mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="set-up-script-execution">
<h2>Set Up Script Execution</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Exit on any errors so that errors don't compound</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>failed ERR
failed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="o">[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed: full log in $LOGFILE&quot;</span>
    <span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Print the commands being run so that we can see the command that triggers
an error.  It is also useful for following along as the install occurs.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="install-packages">
<h1>Install Packages</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack uses a fair number of other projects.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Install package requirements</p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;Installing package prerequisites&quot;</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/apts<span class="k">)</span>
<span class="k">else</span>
<span class="k">    </span>install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/rpms<span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>install_package rsyslog-relp
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install rabbitmq-server
the temp file is necessary due to LP: #878600</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">tfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
    install_package rabbitmq-server &gt; <span class="s2">&quot;$tfile&quot;</span> 2&gt;&amp;1
    cat <span class="s2">&quot;$tfile&quot;</span>
    rm -f <span class="s2">&quot;$tfile&quot;</span>
<span class="k">elif </span>is_service_enabled qpid; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>install_package qpid-cpp-server-daemon
    <span class="k">else</span>
<span class="k">        </span>install_package qpidd
    <span class="k">fi</span>
<span class="k">elif </span>is_service_enabled zeromq; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>install_package zeromq python-zmq
    <span class="k">else</span>
<span class="k">        </span>install_package libzmq1 python-zmq
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Seed configuration with mysql password so that apt-get install doesn't
prompt us for a password upon install.</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;MYSQL_PRESEED | sudo debconf-set-selections</span>
<span class="s">mysql-server-5.1 mysql-server/root_password password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/root_password_again password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/start_on_boot boolean true</span>
<span class="s">MYSQL_PRESEED</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>while <tt class="docutils literal">.my.cnf</tt> is not needed for OpenStack to function, it is useful
as it allows you to access the mysql databases via <tt class="docutils literal">mysql nova</tt> instead
of having to specify the username/password each time.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$HOME</span>/.my.cnf <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>cat <span class="s">&lt;&lt;EOF &gt;$HOME/.my.cnf</span>
<span class="s">[client]</span>
<span class="s">user=$MYSQL_USER</span>
<span class="s">password=$MYSQL_PASSWORD</span>
<span class="s">host=$MYSQL_HOST</span>
<span class="s">EOF</span>
        chmod 0600 <span class="nv">$HOME</span>/.my.cnf
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install mysql-server</p>
</td><td class=code><div class=highlight><pre>
    install_package mysql-server
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install apache2, which is NOPRIME'd</p>
</td><td class=code><div class=highlight><pre>
        install_package apache2 libapache2-mod-wsgi
    <span class="k">else</span>
<span class="k">        </span>sudo rm -f /etc/httpd/conf.d/000-*
        install_package httpd mod_wsgi
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install deps
FIXME add to files/apts/quantum, but don't install if not needed!</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">kernel_version</span><span class="o">=</span><span class="sb">`</span>cat /proc/version | cut -d <span class="s2">&quot; &quot;</span> -f3<span class="sb">`</span>
            install_package make fakeroot dkms openvswitch-switch openvswitch-datapath-dkms linux-headers-<span class="nv">$kernel_version</span>
        <span class="k">else</span>
            <span class="c">### FIXME(dtroyer): Find RPMs for OpenVSwitch</span>
            <span class="nb">echo</span> <span class="s2">&quot;OpenVSwitch packages need to be located&quot;</span>
        <span class="k">fi</span>
<span class="k">    elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">       </span>install_package bridge-utils
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">LIBVIRT_PKG_NAME</span><span class="o">=</span>libvirt-bin
    <span class="k">else</span>
<span class="k">        </span><span class="nv">LIBVIRT_PKG_NAME</span><span class="o">=</span>libvirt
    <span class="k">fi</span>
<span class="k">    </span>install_package <span class="nv">$LIBVIRT_PKG_NAME</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install and configure <strong>LXC</strong> if specified.  LXC is another approach to
splitting a system into many smaller parts.  LXC uses cgroups and chroot
to simulate multiple systems.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>install_package cgroup-lite
            <span class="k">fi</span>
<span class="k">        else</span>
            <span class="c">### FIXME(dtroyer): figure this out</span>
            <span class="nb">echo</span> <span class="s2">&quot;RPM-based cgroup not implemented yet&quot;</span>
            yum_install libcgroup-tools
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install memcached for swift.</p>
</td><td class=code><div class=highlight><pre>
    install_package memcached
<span class="k">fi</span>

<span class="nv">TRACK_DEPENDS</span><span class="o">=</span><span class="k">${</span><span class="nv">TRACK_DEPENDS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install python packages into a virtualenv so that we can track them</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Installing Python packages into a virtualenv $DEST/.venv&quot;</span>
    install_package python-virtualenv

    rm -rf <span class="nv">$DEST</span>/.venv
    virtualenv --system-site-packages <span class="nv">$DEST</span>/.venv
    <span class="nb">source</span> <span class="nv">$DEST</span>/.venv/bin/activate
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-pre-pip
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install python requirements</p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;Installing Python prerequisites&quot;</span>
pip_install <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/pips | sort -u<span class="k">)</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="check-out-source">
<h2>Check Out Source</h2>
</td><td class=code><div class=highlight><pre>

echo_summary <span class="s2">&quot;Installing OpenStack project source&quot;</span>

install_keystoneclient

git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$NOVA_DIR</span> <span class="nv">$NOVA_BRANCH</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check out the client libs that are used most</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$NOVACLIENT_DIR</span> <span class="nv">$NOVACLIENT_BRANCH</span>
git_clone <span class="nv">$OPENSTACKCLIENT_REPO</span> <span class="nv">$OPENSTACKCLIENT_DIR</span> <span class="nv">$OPENSTACKCLIENT_BRANCH</span>
git_clone <span class="nv">$GLANCECLIENT_REPO</span> <span class="nv">$GLANCECLIENT_DIR</span> <span class="nv">$GLANCECLIENT_BRANCH</span>

</pre></div></td></tr><tr><td class=docs>
<p>glance, swift middleware and nova api needs keystone middleware</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>unified auth system (manages accounts/tokens)</p>
</td><td class=code><div class=highlight><pre>
    install_keystone
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>storage service</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SWIFT_REPO</span> <span class="nv">$SWIFT_DIR</span> <span class="nv">$SWIFT_BRANCH</span>
</pre></div></td></tr><tr><td class=docs>
<p>storage service client and and Library</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SWIFTCLIENT_REPO</span> <span class="nv">$SWIFTCLIENT_DIR</span> <span class="nv">$SWIFTCLIENT_BRANCH</span>
    <span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>swift3 middleware to provide S3 emulation to Swift</p>
</td><td class=code><div class=highlight><pre>
        git_clone <span class="nv">$SWIFT3_REPO</span> <span class="nv">$SWIFT3_DIR</span> <span class="nv">$SWIFT3_BRANCH</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>image catalog service</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$GLANCE_REPO</span> <span class="nv">$GLANCE_DIR</span> <span class="nv">$GLANCE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-novnc; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>a websockets/html5 or flash powered VNC console for vm instances</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$NOVNC_DIR</span> <span class="nv">$NOVNC_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>django powered web control panel for openstack</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$HORIZON_REPO</span> <span class="nv">$HORIZON_DIR</span> <span class="nv">$HORIZON_BRANCH</span> <span class="nv">$HORIZON_TAG</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>git_clone <span class="nv">$QUANTUM_CLIENT_REPO</span> <span class="nv">$QUANTUM_CLIENT_DIR</span> <span class="nv">$QUANTUM_CLIENT_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>quantum</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$QUANTUM_REPO</span> <span class="nv">$QUANTUM_DIR</span> <span class="nv">$QUANTUM_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>install_heat
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>install_cinder
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">    </span>install_ceilometer
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="initialization">
<h1>Initialization</h1>
</td><td class=code><div class=highlight><pre>

echo_summary <span class="s2">&quot;Configuring OpenStack projects&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up our checkouts so they are installed into python path
allowing <tt class="docutils literal">import nova</tt> or <tt class="docutils literal">import glance.client</tt></p>
</td><td class=code><div class=highlight><pre>
configure_keystoneclient
setup_develop <span class="nv">$NOVACLIENT_DIR</span>
setup_develop <span class="nv">$OPENSTACKCLIENT_DIR</span>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
<span class="k">    </span>configure_keystone
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$SWIFT_DIR</span>
    setup_develop <span class="nv">$SWIFTCLIENT_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$SWIFT3_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$GLANCE_DIR</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Do this _after_ glance is installed to override the old binary
TODO(dtroyer): figure out when this is no longer necessary</p>
</td><td class=code><div class=highlight><pre>
setup_develop <span class="nv">$GLANCECLIENT_DIR</span>

setup_develop <span class="nv">$NOVA_DIR</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$HORIZON_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$QUANTUM_CLIENT_DIR</span>
    setup_develop <span class="nv">$QUANTUM_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>configure_heat
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>configure_cinder
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-post-pip
    <span class="k">if</span> ! diff -Nru <span class="nv">$DEST</span>/requires-pre-pip <span class="nv">$DEST</span>/requires-post-pip &gt; <span class="nv">$DEST</span>/requires.diff ; <span class="k">then</span>
<span class="k">        </span>cat <span class="nv">$DEST</span>/requires.diff
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Ran stack.sh in depend tracking mode, bailing out now&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="syslog">
<h2>Syslog</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$SYSLOG_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Configure the master host to receive</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-m.conf</span>
<span class="s">\$ModLoad imrelp</span>
<span class="s">\$InputRELPServerRun $SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-m.conf /etc/rsyslog.d
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set rsyslog to send to remote host</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-s.conf</span>
<span class="s">*.*		:omrelp:$SYSLOG_HOST:$SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-s.conf /etc/rsyslog.d
    <span class="k">fi</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting rsyslog&quot;</span>
    restart_service rsyslog
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="finalize-queue-installation">
<h2>Finalize queue installation</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start rabbitmq-server</p>
</td><td class=code><div class=highlight><pre>
    echo_summary <span class="s2">&quot;Starting RabbitMQ&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>RPM doesn't start the service</p>
</td><td class=code><div class=highlight><pre>
        restart_service rabbitmq-server
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>change the rabbit password since the default is &quot;guest&quot;</p>
</td><td class=code><div class=highlight><pre>
    sudo rabbitmqctl change_password guest <span class="nv">$RABBIT_PASSWORD</span>
<span class="k">elif </span>is_service_enabled qpid; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting qpid&quot;</span>
    restart_service qpidd
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="mysql">
<h2>Mysql</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring and starting MySQL&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start mysql-server</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>RPM doesn't start the service</p>
</td><td class=code><div class=highlight><pre>
        start_service mysqld
</pre></div></td></tr><tr><td class=docs>
<p>Set the root password - only works the first time</p>
</td><td class=code><div class=highlight><pre>
        sudo mysqladmin -u root password <span class="nv">$MYSQL_PASSWORD</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Update the DB to give user ‘$MYSQL_USER’&#64;’%’ full control of the all databases:</p>
</td><td class=code><div class=highlight><pre>
    sudo mysql -uroot -p<span class="nv">$MYSQL_PASSWORD</span> -h127.0.0.1 -e <span class="s2">&quot;GRANT ALL PRIVILEGES ON *.* TO &#39;$MYSQL_USER&#39;@&#39;%&#39; identified by &#39;$MYSQL_PASSWORD&#39;;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Update <tt class="docutils literal">my.cnf</tt> for some local needs and restart the mysql service</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">MY_CONF</span><span class="o">=</span>/etc/mysql/my.cnf
        <span class="nv">MYSQL</span><span class="o">=</span>mysql
    <span class="k">else</span>
<span class="k">        </span><span class="nv">MY_CONF</span><span class="o">=</span>/etc/my.cnf
        <span class="nv">MYSQL</span><span class="o">=</span>mysqld
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Change ‘bind-address’ from localhost (127.0.0.1) to any (0.0.0.0)</p>
</td><td class=code><div class=highlight><pre>
    sudo sed -i <span class="s1">&#39;/^bind-address/s/127.0.0.1/0.0.0.0/g&#39;</span> <span class="nv">$MY_CONF</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set default db type to InnoDB</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>sudo grep -q <span class="s2">&quot;default-storage-engine&quot;</span> <span class="nv">$MY_CONF</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Change it</p>
</td><td class=code><div class=highlight><pre>
        sudo bash -c <span class="s2">&quot;source $TOP_DIR/functions; iniset $MY_CONF mysqld default-storage-engine InnoDB&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add it</p>
</td><td class=code><div class=highlight><pre>
        sudo sed -i -e <span class="s2">&quot;/^\[mysqld\]/ a \</span>
<span class="s2">default-storage-engine = InnoDB&quot;</span> <span class="nv">$MY_CONF</span>
    <span class="k">fi</span>

<span class="k">    </span>restart_service <span class="nv">$MYSQL</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">SCREEN_HARDSTATUS</span><span class="o">=</span><span class="s1">&#39;%{= .} %-Lw%{= .}%&gt; %n%f %t*%{= .}%+Lw%&lt; %-=%{g}(%{d}%H/%l%{g})&#39;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a new named screen to run processes in</p>
</td><td class=code><div class=highlight><pre>
screen -d -m -S <span class="nv">$SCREEN_NAME</span> -t shell -s /bin/bash
sleep 1
</pre></div></td></tr><tr><td class=docs>
<p>Set a reasonable status bar</p>
</td><td class=code><div class=highlight><pre>
screen -r <span class="nv">$SCREEN_NAME</span> -X hardstatus alwayslastline <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id1">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Keystone&quot;</span>
    configure_keystone
    init_keystone
    start_keystone
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for keystone to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= curl -s $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/ &gt;/dev/null; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;keystone did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">keystone_data.sh</tt> creates services, admin and demo users, and roles.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT</span>/v2.0

    <span class="nv">ADMIN_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span> <span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="nv">$SERVICE_TENANT_NAME</span> <span class="nv">SERVICE_PASSWORD</span><span class="o">=</span><span class="nv">$SERVICE_PASSWORD</span> <span class="se">\</span>
    <span class="nv">SERVICE_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span> <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span> <span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="nv">$SERVICE_HOST</span> <span class="se">\</span>
    <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="nv">$S3_SERVICE_PORT</span> <span class="nv">KEYSTONE_CATALOG_BACKEND</span><span class="o">=</span><span class="nv">$KEYSTONE_CATALOG_BACKEND</span> <span class="se">\</span>
    <span class="nv">DEVSTACK_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span> <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="nv">$ENABLED_SERVICES</span> <span class="nv">HEAT_API_CFN_PORT</span><span class="o">=</span><span class="nv">$HEAT_API_CFN_PORT</span> <span class="se">\</span>
        bash -x <span class="nv">$FILES</span>/keystone_data.sh

</pre></div></td></tr><tr><td class=docs>
<p>Set up auth creds now that keystone is bootstrapped</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">export </span><span class="nv">OS_AUTH_URL</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span>
    <span class="nb">export </span><span class="nv">OS_TENANT_NAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_USERNAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id2">
<h2>Horizon</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the django horizon application to serve via apache/wsgi</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring and starting Horizon&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Remove stale session database.</p>
</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/dashboard_openstack.sqlite3

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">local_settings.py</tt> is used to override horizon default settings.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">local_settings</span><span class="o">=</span><span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/local_settings.py
    cp <span class="nv">$FILES</span>/horizon_settings.py <span class="nv">$local_settings</span>

</pre></div></td></tr><tr><td class=docs>
<p>Initialize the horizon database (it stores sessions and notices shown to
users).  The user system is external (keystone).</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">cd</span> <span class="nv">$HORIZON_DIR</span>
    python manage.py syncdb --noinput
    <span class="nb">cd</span> <span class="nv">$TOP_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create an empty directory that apache uses as docroot</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$HORIZON_DIR</span>/.blackhole

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">APACHE_NAME</span><span class="o">=</span>apache2
        <span class="nv">APACHE_CONF</span><span class="o">=</span>sites-available/horizon
</pre></div></td></tr><tr><td class=docs>
<p>Clean up the old config name</p>
</td><td class=code><div class=highlight><pre>
        sudo rm -f /etc/apache2/sites-enabled/000-default
</pre></div></td></tr><tr><td class=docs>
<p>Be a good citizen and use the distro tools here</p>
</td><td class=code><div class=highlight><pre>
        sudo touch /etc/<span class="nv">$APACHE_NAME</span>/<span class="nv">$APACHE_CONF</span>
        sudo a2ensite horizon
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Install httpd, which is NOPRIME'd</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">APACHE_NAME</span><span class="o">=</span>httpd
        <span class="nv">APACHE_CONF</span><span class="o">=</span>conf.d/horizon.conf
        sudo sed <span class="s1">&#39;/^Listen/s/^.*$/Listen 0.0.0.0:80/&#39;</span> -i /etc/httpd/conf/httpd.conf
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure apache to run horizon</p>
</td><td class=code><div class=highlight><pre>
    sudo sh -c <span class="s2">&quot;sed -e \&quot;</span>
<span class="s2">        s,%USER%,$APACHE_USER,g;</span>
<span class="s2">        s,%GROUP%,$APACHE_GROUP,g;</span>
<span class="s2">        s,%HORIZON_DIR%,$HORIZON_DIR,g;</span>
<span class="s2">        s,%APACHE_NAME%,$APACHE_NAME,g;</span>
<span class="s2">        s,%DEST%,$DEST,g;</span>
<span class="s2">    \&quot; $FILES/apache-horizon.template &gt;/etc/$APACHE_NAME/$APACHE_CONF&quot;</span>

    restart_service <span class="nv">$APACHE_NAME</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id3">
<h2>Glance</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Glance&quot;</span>

    <span class="nv">GLANCE_CONF_DIR</span><span class="o">=</span>/etc/glance
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$GLANCE_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$GLANCE_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$GLANCE_CONF_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Delete existing images</p>
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$GLANCE_IMAGE_DIR</span>
    mkdir -p <span class="nv">$GLANCE_IMAGE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Delete existing cache</p>
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$GLANCE_CACHE_DIR</span>
    mkdir -p <span class="nv">$GLANCE_CACHE_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>(re)create glance database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS glance;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE glance CHARACTER SET utf8;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Copy over our glance configurations and update them</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">GLANCE_REGISTRY_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-registry.conf
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-registry.conf <span class="nv">$GLANCE_REGISTRY_CONF</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT debug True
    inicomment <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT log_file
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT sql_connection <span class="nv">$BASE_SQL_CONN</span>/glance?charset<span class="o">=</span>utf8
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT use_syslog <span class="nv">$SYSLOG</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> paste_deploy flavor keystone
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken auth_uri <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken admin_user glance
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> keystone_authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

    <span class="nv">GLANCE_API_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-api.conf
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-api.conf <span class="nv">$GLANCE_API_CONF</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT debug True
    inicomment <span class="nv">$GLANCE_API_CONF</span> DEFAULT log_file
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT sql_connection <span class="nv">$BASE_SQL_CONN</span>/glance?charset<span class="o">=</span>utf8
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT use_syslog <span class="nv">$SYSLOG</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT filesystem_store_datadir <span class="nv">$GLANCE_IMAGE_DIR</span>/
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT image_cache_dir <span class="nv">$GLANCE_CACHE_DIR</span>/
    iniset <span class="nv">$GLANCE_API_CONF</span> paste_deploy flavor keystone+cachemanagement
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken auth_uri <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken admin_user glance
    iniset <span class="nv">$GLANCE_API_CONF</span> keystone_authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

</pre></div></td></tr><tr><td class=docs>
<p>Store the images in swift if enabled.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT default_store swift
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_auth_address <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/v2.0/
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_user <span class="nv">$SERVICE_TENANT_NAME</span>:glance
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_key <span class="nv">$SERVICE_PASSWORD</span>
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_create_container_on_put True
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">GLANCE_REGISTRY_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-registry-paste.ini
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-registry-paste.ini <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span>

    <span class="nv">GLANCE_API_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-api-paste.ini
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-api-paste.ini <span class="nv">$GLANCE_API_PASTE_INI</span>

    <span class="nv">GLANCE_CACHE_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-cache.conf
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-cache.conf <span class="nv">$GLANCE_CACHE_CONF</span>
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT debug True
    inicomment <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT log_file
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT use_syslog <span class="nv">$SYSLOG</span>
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT filesystem_store_datadir <span class="nv">$GLANCE_IMAGE_DIR</span>/
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT image_cache_dir <span class="nv">$GLANCE_CACHE_DIR</span>/
    iniuncomment <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT auth_url
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT auth_url <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT</span>/v2.0
    iniuncomment <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT auth_tenant_name
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniuncomment <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT auth_user
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT admin_user glance
    iniuncomment <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT auth_password
    iniset <span class="nv">$GLANCE_CACHE_CONF</span> DEFAULT admin_password <span class="nv">$SERVICE_PASSWORD</span>


    <span class="nv">GLANCE_POLICY_JSON</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/policy.json
    cp <span class="nv">$GLANCE_DIR</span>/etc/policy.json <span class="nv">$GLANCE_POLICY_JSON</span>

    <span class="nv">$GLANCE_BIN_DIR</span>/glance-manage db_sync

<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="quantum">
<h2>Quantum</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Quantum&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Quantum Network Configuration</p>
<p>The following variables control the Quantum openvswitch and
linuxbridge plugins' allocation of tenant networks and
availability of provider networks. If these are not configured
in localrc, tenant networks will be local to the host (with no
remote connectivity), and no physical resources will be
available for the allocation of provider networks.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To use GRE tunnels for tenant networks, set to True in
localrc. GRE tunnels are only supported by the openvswitch
plugin, and currently only on Ubuntu.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ENABLE_TENANT_TUNNELS</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLE_TENANT_TUNNELS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using GRE tunnels for tenant networks, specify the range of
tunnel IDs from which tenant networks are allocated. Can be
overriden in localrc in necesssary.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TENANT_TUNNEL_RANGES</span><span class="o">=</span><span class="k">${</span><span class="nv">TENANT_TUNNEL_RANGE</span><span class="k">:-</span><span class="nv">1</span><span class="p">:</span><span class="nv">1000</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>To use VLANs for tenant networks, set to True in localrc. VLANs
are supported by the openvswitch and linuxbridge plugins, each
requiring additional configuration described below.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ENABLE_TENANT_VLANS</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLE_TENANT_VLANS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using VLANs for tenant networks, set in localrc to specify
the range of VLAN VIDs from which tenant networks are
allocated. An external network switch must be configured to
trunk these VLANs between hosts for multi-host connectivity.</p>
<p>Example: TENANT_VLAN_RANGE=1000:1999</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TENANT_VLAN_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TENANT_VLAN_RANGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using VLANs for tenant networks, or if using flat or VLAN
provider networks, set in localrc to the name of the physical
network, and also configure OVS_PHYSICAL_BRIDGE for the
openvswitch agent or LB_PHYSICAL_INTERFACE for the linuxbridge
agent, as described below.</p>
<p>Example: PHYSICAL_NETWORK=default</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">PHYSICAL_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">PHYSICAL_NETWORK</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the openvswitch plugin, if using VLANs for tenant networks,
or if using flat or VLAN provider networks, set in localrc to
the name of the OVS bridge to use for the physical network. The
bridge will be created if it does not already exist, but a
physical interface must be manually added to the bridge as a
port for external connectivity.</p>
<p>Example: OVS_PHYSICAL_BRIDGE=br-eth1</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">OVS_PHYSICAL_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_PHYSICAL_BRIDGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the linuxbridge plugin, if using VLANs for tenant networks,
or if using flat or VLAN provider networks, set in localrc to
the name of the network interface to use for the physical
network.</p>
<p>Example: LB_PHYSICAL_INTERFACE=eth1</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LB_PHYSICAL_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">LB_PHYSICAL_INTERFACE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the openvswitch plugin, set to True in localrc to enable
provider GRE tunnels when ENABLE_TENANT_TUNNELS is False.</p>
<p>Example: OVS_ENABLE_TUNNELING=True</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">OVS_ENABLE_TUNNELING</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_ENABLE_TUNNELING</span><span class="k">:-</span><span class="nv">$ENABLE_TENANT_TUNNELS</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Put config files in <tt class="docutils literal">/etc/quantum</tt> for everyone to find</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -d /etc/quantum <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p /etc/quantum
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> /etc/quantum

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_PLUGIN_CONF_PATH</span><span class="o">=</span>etc/quantum/plugins/openvswitch
        <span class="nv">Q_PLUGIN_CONF_FILENAME</span><span class="o">=</span>ovs_quantum_plugin.ini
        <span class="nv">Q_DB_NAME</span><span class="o">=</span><span class="s2">&quot;ovs_quantum&quot;</span>
        <span class="nv">Q_PLUGIN_CLASS</span><span class="o">=</span><span class="s2">&quot;quantum.plugins.openvswitch.ovs_quantum_plugin.OVSQuantumPluginV2&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_PLUGIN_CONF_PATH</span><span class="o">=</span>etc/quantum/plugins/linuxbridge
        <span class="nv">Q_PLUGIN_CONF_FILENAME</span><span class="o">=</span>linuxbridge_conf.ini
        <span class="nv">Q_DB_NAME</span><span class="o">=</span><span class="s2">&quot;quantum_linux_bridge&quot;</span>
        <span class="nv">Q_PLUGIN_CLASS</span><span class="o">=</span><span class="s2">&quot;quantum.plugins.linuxbridge.lb_quantum_plugin.LinuxBridgePluginV2&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Unknown Quantum plugin &#39;$Q_PLUGIN&#39;.. exiting&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If needed, move config file from <tt class="docutils literal">$QUANTUM_DIR/etc/quantum</tt> to <tt class="docutils literal">/etc/quantum</tt></p>
</td><td class=code><div class=highlight><pre>
    mkdir -p /<span class="nv">$Q_PLUGIN_CONF_PATH</span>
    <span class="nv">Q_PLUGIN_CONF_FILE</span><span class="o">=</span><span class="nv">$Q_PLUGIN_CONF_PATH</span>/<span class="nv">$Q_PLUGIN_CONF_FILENAME</span>
    cp <span class="nv">$QUANTUM_DIR</span>/<span class="nv">$Q_PLUGIN_CONF_FILE</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>

    iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> DATABASE sql_connection mysql:<span class="se">\/\/</span><span class="nv">$MYSQL_USER</span>:<span class="nv">$MYSQL_PASSWORD</span>@<span class="nv">$MYSQL_HOST</span><span class="se">\/</span><span class="nv">$Q_DB_NAME</span>?charset<span class="o">=</span>utf8

    <span class="nv">Q_CONF_FILE</span><span class="o">=</span>/etc/quantum/quantum.conf
    cp <span class="nv">$QUANTUM_DIR</span>/etc/quantum.conf <span class="nv">$Q_CONF_FILE</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum service (for controller node)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_API_PASTE_FILE</span><span class="o">=</span>/etc/quantum/api-paste.ini
    <span class="nv">Q_POLICY_FILE</span><span class="o">=</span>/etc/quantum/policy.json

    cp <span class="nv">$QUANTUM_DIR</span>/etc/api-paste.ini <span class="nv">$Q_API_PASTE_FILE</span>
    cp <span class="nv">$QUANTUM_DIR</span>/etc/policy.json <span class="nv">$Q_POLICY_FILE</span>

    <span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">            </span>mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s2">&quot;DROP DATABASE IF EXISTS $Q_DB_NAME;&quot;</span>
            mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s2">&quot;CREATE DATABASE IF NOT EXISTS $Q_DB_NAME CHARACTER SET utf8;&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;mysql must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
            <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Update either configuration file with plugin</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT core_plugin <span class="nv">$Q_PLUGIN_CLASS</span>

    iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT auth_strategy <span class="nv">$Q_AUTH_STRATEGY</span>
    quantum_setup_keystone <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken

</pre></div></td></tr><tr><td class=docs>
<p>Configure plugin</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLE_TENANT_TUNNELS&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS tenant_network_type gre
            iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS tunnel_id_ranges <span class="nv">$TENANT_TUNNEL_RANGES</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLE_TENANT_VLANS&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS tenant_network_type vlan
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING - The openvswitch plugin is using local tenant networks, with no connectivity between hosts.&quot;</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Override OVS_VLAN_RANGES and OVS_BRIDGE_MAPPINGS in localrc
for more complex physical network configurations.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$OVS_VLAN_RANGES&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$PHYSICAL_NETWORK&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">OVS_VLAN_RANGES</span><span class="o">=</span><span class="nv">$PHYSICAL_NETWORK</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$TENANT_VLAN_RANGE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">OVS_VLAN_RANGES</span><span class="o">=</span><span class="nv">$OVS_VLAN_RANGES</span>:<span class="nv">$TENANT_VLAN_RANGE</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$OVS_VLAN_RANGES&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS network_vlan_ranges <span class="nv">$OVS_VLAN_RANGES</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Enable tunnel networks if selected</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$OVS_ENABLE_TUNNELING</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS enable_tunneling True
        <span class="k">fi</span>
<span class="k">    elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLE_TENANT_VLANS&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> VLANS tenant_network_type vlan
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING - The linuxbridge plugin is using local tenant networks, with no connectivity between hosts.&quot;</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Override LB_VLAN_RANGES and LB_INTERFACE_MAPPINGS in localrc
for more complex physical network configurations.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LB_VLAN_RANGES&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$PHYSICAL_NETWORK&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">LB_VLAN_RANGES</span><span class="o">=</span><span class="nv">$PHYSICAL_NETWORK</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$TENANT_VLAN_RANGE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">LB_VLAN_RANGES</span><span class="o">=</span><span class="nv">$LB_VLAN_RANGES</span>:<span class="nv">$TENANT_VLAN_RANGE</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$LB_VLAN_RANGES&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> VLANS network_vlan_ranges <span class="nv">$LB_VLAN_RANGES</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum agent (for compute nodes)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Configure agent for plugin</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Setup integration bridge</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">OVS_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_BRIDGE</span><span class="k">:-</span><span class="nv">br</span><span class="p">-int</span><span class="k">}</span>
        quantum_setup_ovs_bridge <span class="nv">$OVS_BRIDGE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Setup agent for tunneling</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$OVS_ENABLE_TUNNELING&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Verify tunnels are supported
REVISIT - also check kernel module support for GRE and patch ports</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">OVS_VERSION</span><span class="o">=</span><span class="sb">`</span>ovs-vsctl --version | head -n 1 | awk <span class="s1">&#39;{print $4;}&#39;</span><span class="sb">`</span>
            <span class="k">if</span> <span class="o">[</span> <span class="nv">$OVS_VERSION</span> <span class="se">\&lt;</span> <span class="s2">&quot;1.4&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> ! is_service_enabled q-svc ; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;You are running OVS version $OVS_VERSION.&quot;</span>
                <span class="nb">echo</span> <span class="s2">&quot;OVS 1.4+ is required for tunneling between multiple hosts.&quot;</span>
                <span class="nb">exit </span>1
            <span class="k">fi</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS enable_tunneling True
            iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS local_ip <span class="nv">$HOST_IP</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Setup physical network bridge mappings.  Override
OVS_VLAN_RANGES and OVS_BRIDGE_MAPPINGS in localrc for more
complex physical network configurations.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$OVS_BRIDGE_MAPPINGS&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$PHYSICAL_NETWORK&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$OVS_PHYSICAL_BRIDGE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">OVS_BRIDGE_MAPPINGS</span><span class="o">=</span><span class="nv">$PHYSICAL_NETWORK</span>:<span class="nv">$OVS_PHYSICAL_BRIDGE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure bridge manually with physical interface as port for multi-node</p>
</td><td class=code><div class=highlight><pre>
            sudo ovs-vsctl --no-wait -- --may-exist add-br <span class="nv">$OVS_PHYSICAL_BRIDGE</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$OVS_BRIDGE_MAPPINGS&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> OVS bridge_mappings <span class="nv">$OVS_BRIDGE_MAPPINGS</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">AGENT_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-openvswitch-agent&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Setup physical network interface mappings.  Override
LB_VLAN_RANGES and LB_INTERFACE_MAPPINGS in localrc for more
complex physical network configurations.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LB_INTERFACE_MAPPINGS&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$PHYSICAL_NETWORK&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$LB_PHYSICAL_INTERFACE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">LB_INTERFACE_MAPPINGS</span><span class="o">=</span><span class="nv">$PHYSICAL_NETWORK</span>:<span class="nv">$LB_PHYSICAL_INTERFACE</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$LB_INTERFACE_MAPPINGS&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> LINUX_BRIDGE physical_interface_mappings <span class="nv">$LB_INTERFACE_MAPPINGS</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">AGENT_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-linuxbridge-agent&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum DHCP</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-dhcp; <span class="k">then</span>
<span class="k">    </span><span class="nv">AGENT_DHCP_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-dhcp-agent&quot;</span>

    <span class="nv">Q_DHCP_CONF_FILE</span><span class="o">=</span>/etc/quantum/dhcp_agent.ini

    cp <span class="nv">$QUANTUM_DIR</span>/etc/dhcp_agent.ini <span class="nv">$Q_DHCP_CONF_FILE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set verbose</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT verbose True
</pre></div></td></tr><tr><td class=docs>
<p>Set debug</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT debug True
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>

    quantum_setup_keystone <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT set_auth_url

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT interface_driver quantum.agent.linux.interface.OVSInterfaceDriver
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT interface_driver quantum.agent.linux.interface.BridgeInterfaceDriver
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum L3</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-l3; <span class="k">then</span>
<span class="k">    </span><span class="nv">AGENT_L3_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-l3-agent&quot;</span>
    <span class="nv">PUBLIC_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_BRIDGE</span><span class="k">:-</span><span class="nv">br</span><span class="p">-ex</span><span class="k">}</span>
    <span class="nv">Q_L3_CONF_FILE</span><span class="o">=</span>/etc/quantum/l3_agent.ini

    cp <span class="nv">$QUANTUM_DIR</span>/etc/l3_agent.ini <span class="nv">$Q_L3_CONF_FILE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set verbose</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT verbose True
</pre></div></td></tr><tr><td class=docs>
<p>Set debug</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT debug True

    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT metadata_ip <span class="nv">$Q_META_DATA_IP</span>
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>

    quantum_setup_keystone <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT set_auth_url
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">==</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT interface_driver quantum.agent.linux.interface.OVSInterfaceDriver
        iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT external_network_bridge <span class="nv">$PUBLIC_BRIDGE</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set up external bridge
Create it if it does not exist</p>
</td><td class=code><div class=highlight><pre>
        sudo ovs-vsctl --no-wait -- --may-exist add-br <span class="nv">$PUBLIC_BRIDGE</span>
</pre></div></td></tr><tr><td class=docs>
<p>remove internal ports</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">for </span>PORT in <span class="sb">`</span>sudo ovs-vsctl --no-wait list-ports <span class="nv">$PUBLIC_BRIDGE</span><span class="sb">`</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">TYPE</span><span class="o">=</span><span class="k">$(</span>sudo ovs-vsctl get interface <span class="nv">$PORT</span> <span class="nb">type</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;internal&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="sb">`</span>sudo ip link delete <span class="nv">$PORT</span><span class="sb">`</span> &gt; /dev/null
                sudo ovs-vsctl --no-wait del-port <span class="nv">$bridge</span> <span class="nv">$PORT</span>
            <span class="k">fi</span>
<span class="k">        done</span>
</pre></div></td></tr><tr><td class=docs>
<p>ensure no IP is configured on the public bridge</p>
</td><td class=code><div class=highlight><pre>
        sudo ip addr flush dev <span class="nv">$PUBLIC_BRIDGE</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT interface_driver quantum.agent.linux.interface.BridgeInterfaceDriver
        iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT external_network_bridge <span class="s1">&#39;&#39;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum RPC support - must be updated prior to starting any of the services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT control_exchange quantum
    <span class="k">if </span>is_service_enabled qpid ; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rpc_backend quantum.openstack.common.rpc.impl_qpid
    <span class="k">elif </span>is_service_enabled zeromq; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rpc_backend quantum.openstack.common.rpc.impl_zmq
    <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_HOST&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>  <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_PASSWORD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rabbit_host <span class="nv">$RABBIT_HOST</span>
        iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rabbit_password <span class="nv">$RABBIT_PASSWORD</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova">
<h2>Nova</h2>
</td><td class=code><div class=highlight><pre>

echo_summary <span class="s2">&quot;Configuring Nova&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Put config files in <tt class="docutils literal">/etc/nova</tt> for everyone to find</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_CONF_DIR</span><span class="o">=</span>/etc/nova
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$NOVA_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>sudo mkdir -p <span class="nv">$NOVA_CONF_DIR</span>
<span class="k">fi</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_CONF_DIR</span>

cp -p <span class="nv">$NOVA_DIR</span>/etc/nova/policy.json <span class="nv">$NOVA_CONF_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Deploy new rootwrap filters files (owned by root).
Wipe any existing rootwrap.d files first</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>sudo rm -rf <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
<span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy filters to /etc/nova/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
sudo mkdir -m 755 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
sudo cp <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.d/*.filters <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
sudo chown -R root:root <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
sudo chmod 644 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d/*
</pre></div></td></tr><tr><td class=docs>
<p>Set up rootwrap.conf, pointing to /etc/nova/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
sudo cp <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.conf <span class="nv">$NOVA_CONF_DIR</span>/
sudo sed -e <span class="s2">&quot;s:^filters_path=.*$:filters_path=$NOVA_CONF_DIR/rootwrap.d:&quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
sudo chown root:root <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
sudo chmod 0644 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
</pre></div></td></tr><tr><td class=docs>
<p>Specify rootwrap.conf as first parameter to nova-rootwrap</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ROOTWRAP_SUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$NOVA_ROOTWRAP $NOVA_CONF_DIR/rootwrap.conf *&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the rootwrap sudoers for nova</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(root) NOPASSWD: $ROOTWRAP_SUDOER_CMD&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
chmod 0440 <span class="nv">$TEMPFILE</span>
sudo chown root:root <span class="nv">$TEMPFILE</span>
sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/nova-rootwrap

<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use the sample http middleware configuration supplied in the
Nova sources.  This paste config adds the configuration required
for Nova to validate Keystone tokens.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Allow rate limiting to be turned off for testing, like for Tempest
NOTE: Set API_RATE_LIMIT=&quot;False&quot; to turn OFF rate limiting</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">API_RATE_LIMIT</span><span class="o">=</span><span class="k">${</span><span class="nv">API_RATE_LIMIT</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Remove legacy paste config if present</p>
</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$NOVA_DIR</span>/bin/nova-api-paste.ini

</pre></div></td></tr><tr><td class=docs>
<p>Get the sample configuration file in place</p>
</td><td class=code><div class=highlight><pre>
    cp <span class="nv">$NOVA_DIR</span>/etc/nova/api-paste.ini <span class="nv">$NOVA_CONF_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Rewrite the authtoken configuration for our Keystone service.
This is a bit defensive to allow the sample file some variance.</p>
</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        /^admin_token/i admin_tenant_name = $SERVICE_TENANT_NAME</span>
<span class="s2">        /admin_tenant_name/s/^.*$/admin_tenant_name = $SERVICE_TENANT_NAME/;</span>
<span class="s2">        /admin_user/s/^.*$/admin_user = nova/;</span>
<span class="s2">        /admin_password/s/^.*$/admin_password = $SERVICE_PASSWORD/;</span>
<span class="s2">        s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">        s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g;</span>
<span class="s2">    &quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/api-paste.ini
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Helper to clean iptables rules</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>clean_iptables<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete rules</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-A&quot;</span> |  sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete nat rules</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-A&quot;</span> | sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete chains</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-N&quot;</span> |  sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</pre></div></td></tr><tr><td class=docs>
<p>Delete nat chains</p>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-N&quot;</span> | sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
<span class="o">}</span>

<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just on case</p>
</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1

</pre></div></td></tr><tr><td class=docs>
<p>Attempt to load modules: network block device - used to manage qcow images</p>
</td><td class=code><div class=highlight><pre>
    sudo modprobe nbd <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check for kvm (hardware based virtualization).  If unable to initialize
kvm, we drop back to the slower emulation mode (qemu).  Note: many systems
come with hardware virtualization disabled in BIOS.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;kvm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo modprobe kvm <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">if</span> <span class="o">[</span> ! -e /dev/kvm <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Switching to QEMU&quot;</span>
            <span class="nv">LIBVIRT_TYPE</span><span class="o">=</span>qemu
            <span class="k">if </span>which selinuxenabled 2&gt;&amp;1 &gt; /dev/null <span class="o">&amp;&amp;</span> selinuxenabled; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p><a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=753589">https://bugzilla.redhat.com/show_bug.cgi?id=753589</a></p>
</td><td class=code><div class=highlight><pre>
                sudo setsebool virt_use_execmem on
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install and configure <strong>LXC</strong> if specified.  LXC is another approach to
splitting a system into many smaller parts.  LXC uses cgroups and chroot
to simulate multiple systems.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">cgline</span><span class="o">=</span><span class="s2">&quot;none /cgroup cgroup cpuacct,memory,devices,cpu,freezer,blkio 0 0&quot;</span>
                sudo mkdir -p /cgroup
                <span class="k">if</span> ! grep -q cgroup /etc/fstab; <span class="k">then</span>
<span class="k">                    </span><span class="nb">echo</span> <span class="s2">&quot;$cgline&quot;</span> | sudo tee -a /etc/fstab
                <span class="k">fi</span>
<span class="k">                if</span> ! mount -n | grep -q cgroup; <span class="k">then</span>
<span class="k">                    </span>sudo mount /cgroup
                <span class="k">fi</span>
<span class="k">            fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

<span class="k">    </span><span class="nv">QEMU_CONF</span><span class="o">=</span>/etc/libvirt/qemu.conf
    <span class="k">if </span>is_service_enabled quantum <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="nv">$Q_PLUGIN</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> ! sudo grep -q <span class="s1">&#39;^cgroup_device_acl&#39;</span> <span class="nv">$QEMU_CONF</span> ; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add /dev/net/tun to cgroup_device_acls, needed for type=ethernet interfaces</p>
</td><td class=code><div class=highlight><pre>
        sudo chmod 666 <span class="nv">$QEMU_CONF</span>
        sudo cat <span class="s">&lt;&lt;EOF &gt;&gt; /etc/libvirt/qemu.conf</span>
<span class="s">cgroup_device_acl = [</span>
<span class="s">    &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;,</span>
<span class="s">    &quot;/dev/random&quot;, &quot;/dev/urandom&quot;,</span>
<span class="s">    &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;,</span>
<span class="s">    &quot;/dev/rtc&quot;, &quot;/dev/hpet&quot;,&quot;/dev/net/tun&quot;,</span>
<span class="s">]</span>
<span class="s">EOF</span>
        sudo chmod 644 <span class="nv">$QEMU_CONF</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">LIBVIRT_DAEMON</span><span class="o">=</span>libvirt-bin
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p><a class="reference external" href="http://wiki.libvirt.org/page/SSHPolicyKitSetup">http://wiki.libvirt.org/page/SSHPolicyKitSetup</a></p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! grep ^libvirtd: /etc/group &gt;/dev/null; <span class="k">then</span>
<span class="k">            </span>sudo groupadd libvirtd
        <span class="k">fi</span>
<span class="k">        </span>sudo bash -c <span class="s1">&#39;cat &lt;&lt;EOF &gt;/etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span>
<span class="s1">[libvirt Management Access]</span>
<span class="s1">Identity=unix-group:libvirtd</span>
<span class="s1">Action=org.libvirt.unix.manage</span>
<span class="s1">ResultAny=yes</span>
<span class="s1">ResultInactive=yes</span>
<span class="s1">ResultActive=yes</span>
<span class="s1">EOF&#39;</span>
        <span class="nv">LIBVIRT_DAEMON</span><span class="o">=</span>libvirtd
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>The user that nova runs as needs to be member of <strong>libvirtd</strong> group otherwise
nova-compute will be unable to use libvirt.</p>
</td><td class=code><div class=highlight><pre>
    sudo usermod -a -G libvirtd <span class="sb">`</span>whoami<span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>libvirt detects various settings on startup, as we potentially changed
the system configuration (modules, filesystems), we need to restart
libvirt to detect those changes.</p>
</td><td class=code><div class=highlight><pre>
    restart_service <span class="nv">$LIBVIRT_DAEMON</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="instance-storage">
<h3>Instance Storage</h3>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Nova stores each instance in its own directory.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$NOVA_INSTANCES_PATH</span>

</pre></div></td></tr><tr><td class=docs>
<p>You can specify a different disk to be mounted and used for backing the
virtual machines.  If there is a partition labeled nova-instances we
mount it (ext filesystems can be labeled via e2label).</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -L /dev/disk/by-label/nova-instances <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> ! mount -n | grep -q <span class="nv">$NOVA_INSTANCES_PATH</span>; <span class="k">then</span>
<span class="k">            </span>sudo mount -L nova-instances <span class="nv">$NOVA_INSTANCES_PATH</span>
            sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_INSTANCES_PATH</span>
        <span class="k">fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clean iptables from previous runs</p>
</td><td class=code><div class=highlight><pre>
    clean_iptables

</pre></div></td></tr><tr><td class=docs>
<p>Destroy old instances</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">instances</span><span class="o">=</span><span class="sb">`</span>sudo virsh list --all | grep <span class="nv">$INSTANCE_NAME_PREFIX</span> | sed <span class="s2">&quot;s/.*\($INSTANCE_NAME_PREFIX[0-9a-fA-F]*\).*/\1/g&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$instances&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh destroy <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh undefine <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Logout and delete iscsi sessions</p>
</td><td class=code><div class=highlight><pre>
    sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | xargs sudo iscsiadm --mode node --logout <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | sudo iscsiadm --mode node --op delete <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clean out the instances directory.</p>
</td><td class=code><div class=highlight><pre>
    sudo rm -rf <span class="nv">$NOVA_INSTANCES_PATH</span>/*
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-net q-dhcp; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete traces of nova networks from prior runs</p>
</td><td class=code><div class=highlight><pre>
    sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>clean_iptables
    rm -rf <span class="nv">$NOVA_STATE_PATH</span>/networks
    mkdir -p <span class="nv">$NOVA_STATE_PATH</span>/networks

</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just on case</p>
</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="storage-service">
<h2>Storage Service</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Swift&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure to kill all swift processes first</p>
</td><td class=code><div class=highlight><pre>
    swift-init all stop <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>First do a bit of setup by creating the directories and
changing the permissions so we can run it as our user.</p>
</td><td class=code><div class=highlight><pre>

    <span class="nv">USER_GROUP</span><span class="o">=</span><span class="k">$(</span>id -g<span class="k">)</span>
    sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives
    sudo chown -R <span class="nv">$USER</span>:<span class="k">${</span><span class="nv">USER_GROUP</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a loopback disk and format it to XFS.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if </span>egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">            </span>sudo umount <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
        <span class="k">fi</span>
<span class="k">    else</span>
<span class="k">        </span>mkdir -p  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images
        sudo touch  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img
        sudo chown <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img

        dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="se">\</span>
            <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>0 <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">}</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make a fresh XFS filesystem</p>
</td><td class=code><div class=highlight><pre>
    mkfs.xfs -f -i <span class="nv">size</span><span class="o">=</span>1024  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img

</pre></div></td></tr><tr><td class=docs>
<p>Mount the disk with mount options to make it as efficient as possible</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
    <span class="k">if</span> ! egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">        </span>sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs<span class="o">=</span>8  <span class="se">\</span>
            <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a link to the above mount</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">        </span>sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1/<span class="nv">$x</span> <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="nv">$x</span>; <span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create all of the directories needed to emulate a few different servers</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">drive</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>
            <span class="nv">node</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>/node
            <span class="nv">node_device</span><span class="o">=</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span>/sdb1
            <span class="o">[[</span> -d <span class="nv">$node</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[[</span> -d <span class="nv">$drive</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
<span class="k">            </span>sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$drive</span>
            sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$node_device</span>
            sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">node</span><span class="k">}</span>
    <span class="k">done</span>

<span class="k">   </span>sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/<span class="o">{</span>object,container,account<span class="o">}</span>-server /var/run/swift
   sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> /var/run/swift

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SWIFT_CONFIG_DIR&quot;</span> !<span class="o">=</span> <span class="s2">&quot;/etc/swift&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Some swift tools are hard-coded to use <tt class="docutils literal">/etc/swift</tt> and are apparently not going to be fixed.
Create a symlink if the config dir is moved</p>
</td><td class=code><div class=highlight><pre>
        sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> /etc/swift
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Swift use rsync to synchronize between all the different
partitions (which make more sense when you have a multi-node
setup) we configure it with our version of rsync.</p>
</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        s/%GROUP%/${USER_GROUP}/;</span>
<span class="s2">        s/%USER%/$USER/;</span>
<span class="s2">        s,%SWIFT_DATA_DIR%,$SWIFT_DATA_DIR,;</span>
<span class="s2">    &quot;</span> <span class="nv">$FILES</span>/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo sed -i <span class="s1">&#39;/^RSYNC_ENABLE=false/ { s/false/true/ }&#39;</span> /etc/default/rsync
    <span class="k">else</span>
<span class="k">        </span>sudo sed -i <span class="s1">&#39;/disable *= *yes/ { s/yes/no/ }&#39;</span> /etc/xinetd.d/rsync
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled swift3;then
        <span class="nv">swift_auth_server</span><span class="o">=</span><span class="s2">&quot;s3token &quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>By default Swift will be installed with the tempauth middleware
which has some default username and password if you have
configured keystone it will checkout the directory.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">        </span>swift_auth_server+<span class="o">=</span><span class="s2">&quot;authtoken keystoneauth&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">swift_auth_server</span><span class="o">=</span>tempauth
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/proxy-server.conf
    cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/proxy-server.conf-sample <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT user
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT user <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT swift_dir
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT swift_dir <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT workers
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT workers 1

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT log_level
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT log_level DEBUG

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT bind_port
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT bind_port <span class="k">${</span><span class="nv">SWIFT_DEFAULT_BIND_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Only enable Swift3 if we have it enabled in ENABLED_SERVICES</p>
</td><td class=code><div class=highlight><pre>
    is_service_enabled swift3 <span class="o">&amp;&amp;</span> <span class="nv">swift3</span><span class="o">=</span>swift3 <span class="o">||</span> <span class="nv">swift3</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> pipeline:main pipeline <span class="s2">&quot;catch_errors healthcheck cache ratelimit ${swift3} ${swift_auth_server} proxy-logging proxy-server&quot;</span>

    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> app:proxy-server account_autocreate <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure Keystone</p>
</td><td class=code><div class=highlight><pre>
    sed -i <span class="s1">&#39;/^# \[filter:authtoken\]/,/^# \[filter:keystoneauth\]$/ s/^#[ \t]*//&#39;</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken auth_uri <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken admin_user swift
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:keystoneauth use
    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:keystoneauth operator_roles
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> filter:keystoneauth operator_roles <span class="s2">&quot;Member, admin&quot;</span>

    <span class="k">if </span>is_service_enabled swift3;then
        cat <span class="s">&lt;&lt;EOF&gt;&gt;${SWIFT_CONFIG_PROXY_SERVER}</span>
<span class="s"># DIVIDER</span>
<span class="s">[filter:s3token]</span>
<span class="s">paste.filter_factory = keystone.middleware.s3_token:filter_factory</span>
<span class="s">auth_port = ${KEYSTONE_AUTH_PORT}</span>
<span class="s">auth_host = ${KEYSTONE_AUTH_HOST}</span>
<span class="s">auth_protocol = ${KEYSTONE_AUTH_PROTOCOL}</span>
<span class="s">auth_token = ${SERVICE_TOKEN}</span>
<span class="s">admin_token = ${SERVICE_TOKEN}</span>

<span class="s">[filter:swift3]</span>
<span class="s">use = egg:swift3#swift3</span>
<span class="s">EOF</span>
    <span class="k">fi</span>

<span class="k">    </span>cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/swift.conf-sample <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/swift.conf
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/swift.conf swift-hash swift_hash_path_suffix <span class="k">${</span><span class="nv">SWIFT_HASH</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>NOTE(chmou): s3token middleware is not updated yet to use only
username and password.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">function </span>generate_swift_configuration<span class="o">()</span> <span class="o">{</span>
        <span class="nb">local </span><span class="nv">server_type</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local </span><span class="nv">bind_port</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">local </span><span class="nv">log_facility</span><span class="o">=</span><span class="nv">$3</span>
        <span class="nb">local </span>node_number
        <span class="nb">local </span>swift_node_config

        <span class="k">for </span>node_number in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">node_path</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>
            <span class="nv">swift_node_config</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf

            cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server.conf-sample <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT user
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT user <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT bind_port
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT bind_port <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT swift_dir
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT swift_dir <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT devices
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT devices <span class="k">${</span><span class="nv">node_path</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT log_facility
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT log_facility LOG_LOCAL<span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT mount_check
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT mount_check <span class="nb">false</span>

<span class="nb">            </span>iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-replicator vm_test_mode
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-replicator vm_test_mode yes

            <span class="nv">bind_port</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span> <span class="o">+</span> <span class="m">10</span> <span class="k">))</span>
            <span class="nv">log_facility</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span>
        <span class="k">done</span>
    <span class="o">}</span>
    generate_swift_configuration object 6010 2
    generate_swift_configuration container 6011 2
    generate_swift_configuration account 6012 2

</pre></div></td></tr><tr><td class=docs>
<p>This function generates an object/account/proxy configuration
emulating 4 nodes on different ports</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">swift_log_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/logs
    rm -rf <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
    mkdir -p <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>/hourly
    sudo chown -R <span class="nv">$USER</span>:adm <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
    sed <span class="s2">&quot;s,%SWIFT_LOGDIR%,${swift_log_dir},&quot;</span> <span class="nv">$FILES</span>/swift/rsyslog.conf | sudo <span class="se">\</span>
        tee /etc/rsyslog.d/10-swift.conf
    restart_service rsyslog

</pre></div></td></tr><tr><td class=docs>
<p>Specific configuration for swift for rsyslog. See
<tt class="docutils literal"><span class="pre">/etc/rsyslog.d/10-swift.conf</span></tt> for more info.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">pushd</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> &gt;/dev/null <span class="o">&amp;&amp;</span> <span class="o">{</span>

        rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz

        <span class="nv">port_number</span><span class="o">=</span>6010
        swift-ring-builder object.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder object.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
            <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder object.builder rebalance

        <span class="nv">port_number</span><span class="o">=</span>6011
        swift-ring-builder container.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder container.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
            <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder container.builder rebalance

        <span class="nv">port_number</span><span class="o">=</span>6012
        swift-ring-builder account.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder account.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
            <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder account.builder rebalance

    <span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">popd</span> &gt;/dev/null

</pre></div></td></tr><tr><td class=docs>
<p>This is where we create three different rings for swift with
different object servers binding on different ports.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo /etc/init.d/rsync restart <span class="o">||</span> :
    <span class="k">else</span>
<span class="k">        </span>sudo systemctl start xinetd.service
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start rsync</p>
</td><td class=code><div class=highlight><pre>
   swift-init all restart <span class="o">||</span> <span class="nb">true</span>
<span class="nb">   </span>swift-init proxy stop <span class="o">||</span> <span class="nb">true</span>

<span class="nb">   unset </span>s swift_hash swift_auth_server
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>First spawn all the swift services then kill the
proxy service so we can run it in foreground in screen.
<tt class="docutils literal"><span class="pre">swift-init</span> ... {stop|restart}</tt> exits with '1' if no servers are running,
ignore it just in case</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Cinder&quot;</span>
    init_cinder
<span class="k">elif </span>is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Nova volumes&quot;</span>
    init_nvol
<span class="k">fi</span>

<span class="nv">NOVA_CONF</span><span class="o">=</span>nova.conf
<span class="k">function </span>add_nova_opt <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> &gt;&gt; <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="volume-service">
<h2>Volume Service</h2>
</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_DIR</span>/bin/nova.conf

</pre></div></td></tr><tr><td class=docs>
<p>Remove legacy <tt class="docutils literal">nova.conf</tt></p>
</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
add_nova_opt <span class="s2">&quot;[DEFAULT]&quot;</span>
add_nova_opt <span class="s2">&quot;verbose=True&quot;</span>
add_nova_opt <span class="s2">&quot;auth_strategy=keystone&quot;</span>
add_nova_opt <span class="s2">&quot;allow_resize_to_same_host=True&quot;</span>
add_nova_opt <span class="s2">&quot;rootwrap_config=$NOVA_CONF_DIR/rootwrap.conf&quot;</span>
add_nova_opt <span class="s2">&quot;compute_scheduler_driver=$SCHEDULER&quot;</span>
add_nova_opt <span class="s2">&quot;dhcpbridge_flagfile=$NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
add_nova_opt <span class="s2">&quot;fixed_range=$FIXED_RANGE&quot;</span>
add_nova_opt <span class="s2">&quot;s3_host=$SERVICE_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;s3_port=$S3_SERVICE_PORT&quot;</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_api_class=nova.network.quantumv2.api.API&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_username=$Q_ADMIN_USERNAME&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_password=$SERVICE_PASSWORD&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_auth_url=$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_SERVICE_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_auth_strategy=$Q_AUTH_STRATEGY&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_tenant_name=$SERVICE_TENANT_NAME&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_url=http://$Q_HOST:$Q_PORT&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_VIF_DRIVER</span><span class="o">=</span><span class="s2">&quot;nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_VIF_DRIVER</span><span class="o">=</span><span class="s2">&quot;nova.virt.libvirt.vif.QuantumLinuxBridgeVIFDriver&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;libvirt_vif_driver=$NOVA_VIF_DRIVER&quot;</span>
    add_nova_opt <span class="s2">&quot;linuxnet_interface_driver=$LINUXNET_VIF_DRIVER&quot;</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_manager=nova.network.manager.$NET_MAN&quot;</span>
    add_nova_opt <span class="s2">&quot;public_interface=$PUBLIC_INTERFACE&quot;</span>
    add_nova_opt <span class="s2">&quot;vlan_interface=$VLAN_INTERFACE&quot;</span>
    add_nova_opt <span class="s2">&quot;flat_network_bridge=$FLAT_NETWORK_BRIDGE&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$FLAT_INTERFACE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>add_nova_opt <span class="s2">&quot;flat_interface=$FLAT_INTERFACE&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;volume_group=$VOLUME_GROUP&quot;</span>
    add_nova_opt <span class="s2">&quot;volume_name_template=${VOLUME_NAME_PREFIX}%s&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>(Re)create <tt class="docutils literal">nova.conf</tt></p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;iscsi_helper=tgtadm&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;osapi_compute_extension=nova.api.openstack.compute.contrib.standard_extensions&quot;</span>
add_nova_opt <span class="s2">&quot;my_ip=$HOST_IP&quot;</span>
add_nova_opt <span class="s2">&quot;sql_connection=$BASE_SQL_CONN/nova?charset=utf8&quot;</span>
add_nova_opt <span class="s2">&quot;libvirt_type=$LIBVIRT_TYPE&quot;</span>
add_nova_opt <span class="s2">&quot;libvirt_cpu_mode=none&quot;</span>
add_nova_opt <span class="s2">&quot;instance_name_template=${INSTANCE_NAME_PREFIX}%08x&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>oneiric no longer supports ietadm</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6080/vnc_auto.html&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;novncproxy_base_url=$NOVNCPROXY_URL&quot;</span>
    <span class="nv">XVPVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XVPVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6081/console&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xvpvncproxy_base_url=$XVPVNCPROXY_URL&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=169.254.0.1</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
<span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>All nova-compute workers need to know the vnc configuration options
These settings don't hurt anything if n-xvnc and n-novnc are disabled</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VNCSERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
add_nova_opt <span class="s2">&quot;vncserver_listen=$VNCSERVER_LISTEN&quot;</span>
add_nova_opt <span class="s2">&quot;vncserver_proxyclient_address=$VNCSERVER_PROXYCLIENT_ADDRESS&quot;</span>
add_nova_opt <span class="s2">&quot;api_paste_config=$NOVA_CONF_DIR/api-paste.ini&quot;</span>
add_nova_opt <span class="s2">&quot;image_service=nova.image.glance.GlanceImageService&quot;</span>
add_nova_opt <span class="s2">&quot;ec2_dmz_host=$EC2_DMZ_HOST&quot;</span>
<span class="k">if </span>is_service_enabled zeromq; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;rpc_backend=nova.openstack.common.rpc.impl_zmq&quot;</span>
<span class="k">elif </span>is_service_enabled qpid; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;rpc_backend=nova.rpc.impl_qpid&quot;</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_HOST&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>  <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_PASSWORD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;rabbit_host=$RABBIT_HOST&quot;</span>
    add_nova_opt <span class="s2">&quot;rabbit_password=$RABBIT_PASSWORD&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;glance_api_servers=$GLANCE_HOSTPORT&quot;</span>
add_nova_opt <span class="s2">&quot;force_dhcp_release=True&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$NOVA_STATE_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;state_path=$NOVA_STATE_PATH&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$NOVA_INSTANCES_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;instances_path=$NOVA_INSTANCES_PATH&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;multi_host=True&quot;</span>
    add_nova_opt <span class="s2">&quot;send_arp_for_ha=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;use_syslog=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$API_RATE_LIMIT&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;api_rate_limit=False&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$LOG_COLOR&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Address on which instance vncservers will listen on compute hosts.
For multi-host, this should be the management ip of the compute host.</p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;logging_context_format_string=%(asctime)s %(color)s%(levelname)s %(name)s [[01;36m%(request_id)s [00;36m%(user_name)s %(project_name)s%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
    add_nova_opt <span class="s2">&quot;logging_default_format_string=%(asctime)s %(color)s%(levelname)s %(name)s [[00;36m-%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
    add_nova_opt <span class="s2">&quot;logging_debug_format_suffix=[00;33mfrom (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d[00m&quot;</span>
    add_nova_opt <span class="s2">&quot;logging_exception_prefix=%(color)s%(asctime)s TRACE %(name)s [01;35m%(instance)s[00m&quot;</span>
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add color to logging output</p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;logging_context_format_string=%(asctime)s %(levelname)s %(name)s [%(request_id)s %(user_name)s %(project_name)s] %(instance)s%(message)s&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Show user_name and project_name instead of user_id and project_id</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;volume_api_class=nova.volume.cinder.API&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If cinder is enabled, use the cinder volume driver</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$EXTRA_OPTS&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">EXTRA_OPTS</span><span class="o">=</span><span class="nv">$EXTRA_FLAGS</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Provide some transition from <tt class="docutils literal">EXTRA_FLAGS</tt> to <tt class="docutils literal">EXTRA_OPTS</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">for </span>I in <span class="s2">&quot;${EXTRA_OPTS[@]}&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Define extra nova conf flags by defining the array <tt class="docutils literal">EXTRA_OPTS</tt>.
For Example: <tt class="docutils literal"><span class="pre">EXTRA_OPTS=(foo=true</span> bar=2)</tt></p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="k">${</span><span class="nv">I</span><span class="p">//--</span><span class="k">}</span>
<span class="k">done</span>


</pre></div></td></tr><tr><td class=docs>
<p>Attempt to convert flags to options</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Using XenServer virtualization driver&quot;</span>
    read_password XENAPI_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR XEN.&quot;</span>
    add_nova_opt <span class="s2">&quot;compute_driver=xenapi.XenAPIDriver&quot;</span>
    <span class="nv">XENAPI_CONNECTION_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_CONNECTION_URL</span><span class="k">:-</span><span class="s2">&quot;http://169.254.0.1&quot;</span><span class="k">}</span>
    <span class="nv">XENAPI_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_USER</span><span class="k">:-</span><span class="s2">&quot;root&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_url=$XENAPI_CONNECTION_URL&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_username=$XENAPI_USER&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_password=$XENAPI_PASSWORD&quot;</span>
    add_nova_opt <span class="s2">&quot;flat_injected=False&quot;</span>
</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="xenserver">
<h2>XenServer</h2>
</td><td class=code><div class=highlight><pre>
    <span class="nv">XEN_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">XEN_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$XEN_FIREWALL_DRIVER&quot;</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;openvz&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Using OpenVZ virtualization driver&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Need to avoid crash due to new firewall support</p>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;connection_type=openvz&quot;</span>
    <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$LIBVIRT_FIREWALL_DRIVER&quot;</span>
<span class="k">else</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Using libvirt virtualization driver&quot;</span>
    add_nova_opt <span class="s2">&quot;compute_driver=libvirt.LibvirtDriver&quot;</span>
    <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$LIBVIRT_FIREWALL_DRIVER&quot;</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<dl class="docutils">
<dt>TODO(deva): OpenVZ driver does not yet work if compute_driver is set here.</dt>
<dd>Replace connection_type when this is fixed.
add_nova_opt &quot;compute_driver=openvz.connection.OpenVzConnection&quot;</dd>
</dl>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova-database">
<h2>Nova Database</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>All nova components talk to a central database.  We will need to do this step
only once for an entire cluster.</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS nova;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>(Re)create nova database</p>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE nova CHARACTER SET latin1;&#39;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Explicitly use latin1: to avoid lp#829209, nova expects the database to
use latin1 by default, and then upgrades the database to utf8 (see the
082_essex.py in nova)</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage db sync
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>(Re)create nova database</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Heat&quot;</span>
    init_heat
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="heat">
<h2>Heat</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="launch-services">
<h1>Launch Services</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Nova api crashes if we start it with a regular screen command,
so send the start command by forcing text into the window.
Only run the services specified in <tt class="docutils literal">ENABLED_SERVICES</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Glance&quot;</span>
    screen_it g-reg <span class="s2">&quot;cd $GLANCE_DIR; $GLANCE_BIN_DIR/glance-registry --config-file=$GLANCE_CONF_DIR/glance-registry.conf&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Launch the glance registry service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-api; <span class="k">then</span>
<span class="k">    </span>screen_it g-api <span class="s2">&quot;cd $GLANCE_DIR; $GLANCE_BIN_DIR/glance-api --config-file=$GLANCE_CONF_DIR/glance-api.conf&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for g-api ($GLANCE_HOSTPORT) to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://$GLANCE_HOSTPORT; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;g-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Launch the glance api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key <span class="o">&amp;&amp;</span> is_service_enabled swift3 <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVA_USER_ID</span><span class="o">=</span><span class="k">$(</span>keystone user-list | grep <span class="s1">&#39; nova &#39;</span> | get_field 1<span class="k">)</span>
    <span class="nv">NOVA_TENANT_ID</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | grep <span class="s2">&quot; $SERVICE_TENANT_NAME &quot;</span> | get_field 1<span class="k">)</span>
    <span class="nv">CREDS</span><span class="o">=</span><span class="k">$(</span>keystone ec2-credentials-create --user_id <span class="nv">$NOVA_USER_ID</span> --tenant_id <span class="nv">$NOVA_TENANT_ID</span><span class="k">)</span>
    <span class="nv">ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ access / { print $4 }&#39;</span><span class="k">)</span>
    <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ secret / { print $4 }&#39;</span><span class="k">)</span>
    add_nova_opt <span class="s2">&quot;s3_access_key=$ACCESS_KEY&quot;</span>
    add_nova_opt <span class="s2">&quot;s3_secret_key=$SECRET_KEY&quot;</span>
    add_nova_opt <span class="s2">&quot;s3_affix_tenant=True&quot;</span>
<span class="k">fi</span>

screen_it zeromq <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-rpc-zmq-receiver&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create an access key and secret key for nova ec2 register image</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Nova API&quot;</span>
    add_nova_opt <span class="s2">&quot;enabled_apis=$NOVA_ENABLED_APIS&quot;</span>
    screen_it n-api <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-api&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for nova-api to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:8774; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;nova-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Quantum&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Launch the nova-api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
    screen_it q-svc <span class="s2">&quot;cd $QUANTUM_DIR &amp;&amp; python $QUANTUM_DIR/bin/quantum-server --config-file $Q_CONF_FILE --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for Quantum to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:9696; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;Quantum did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start the Quantum service</p>
</td><td class=code><div class=highlight><pre>

    <span class="nv">TENANT_ID</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | grep <span class="s2">&quot; demo &quot;</span> | get_field 1<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure Quantum elements
Configure internal network &amp; subnet</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">NET_ID</span><span class="o">=</span><span class="k">$(</span>quantum net-create --tenant_id <span class="nv">$TENANT_ID</span> net1 | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    <span class="nv">SUBNET_ID</span><span class="o">=</span><span class="k">$(</span>quantum subnet-create --tenant_id <span class="nv">$TENANT_ID</span> --ip_version 4 --gateway <span class="nv">$NETWORK_GATEWAY</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    <span class="k">if </span>is_service_enabled q-l3; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a small network
Since quantum command is executed in admin context at this point,
<tt class="docutils literal"><span class="pre">--tenant_id</span></tt> needs to be specified.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">ROUTER_ID</span><span class="o">=</span><span class="k">$(</span>quantum router-create --tenant_id <span class="nv">$TENANT_ID</span> router1 | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        quantum router-interface-add <span class="nv">$ROUTER_ID</span> <span class="nv">$SUBNET_ID</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a router, and add the private subnet as one of its interfaces</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">EXT_NET_ID</span><span class="o">=</span><span class="k">$(</span>quantum net-create ext_net -- --router:external<span class="o">=</span>True | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="nv">EXT_GW_IP</span><span class="o">=</span><span class="k">$(</span>quantum subnet-create --ip_version 4 <span class="nv">$EXT_NET_ID</span> <span class="nv">$FLOATING_RANGE</span> -- --enable_dhcp<span class="o">=</span>False | grep <span class="s1">&#39;gateway_ip&#39;</span> | get_field 2<span class="k">)</span>
        quantum router-gateway-set <span class="nv">$ROUTER_ID</span> <span class="nv">$EXT_NET_ID</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">CIDR_LEN</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="p">#*/</span><span class="k">}</span>
            sudo ip addr add <span class="nv">$EXT_GW_IP</span>/<span class="nv">$CIDR_LEN</span> dev <span class="nv">$PUBLIC_BRIDGE</span>
            sudo ip link <span class="nb">set</span> <span class="nv">$PUBLIC_BRIDGE</span> up
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_NAMESPACE&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create an external network, and a subnet. Configure the external network as router gw</p>
</td><td class=code><div class=highlight><pre>
            iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT router_id <span class="nv">$ROUTER_ID</span>
        <span class="k">fi</span>
<span class="k">   fi</span>

<span class="k">elif </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Explicitly set router id in l3 agent configuration</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage network create private <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span> <span class="nv">$NETWORK_CREATE_ARGS</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a small network</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage floating create <span class="nv">$FLOATING_RANGE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create some floating ips</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage floating create --ip_range<span class="o">=</span><span class="nv">$TEST_FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$TEST_FLOATING_POOL</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a second pool</p>
</td><td class=code><div class=highlight><pre>
screen_it q-agt <span class="s2">&quot;sudo python $AGENT_BINARY --config-file $Q_CONF_FILE --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>
screen_it q-dhcp <span class="s2">&quot;sudo python $AGENT_DHCP_BINARY --config-file $Q_CONF_FILE --config-file=$Q_DHCP_CONF_FILE&quot;</span>
screen_it q-l3 <span class="s2">&quot;sudo python $AGENT_L3_BINARY --config-file $Q_CONF_FILE --config-file=$Q_L3_CONF_FILE&quot;</span>

echo_summary <span class="s2">&quot;Starting Nova&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start up the quantum agents if enabled</p>
</td><td class=code><div class=highlight><pre>
screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; sg libvirtd $NOVA_BIN_DIR/nova-compute&quot;</span>
screen_it n-crt <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-cert&quot;</span>
screen_it n-net <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-network&quot;</span>
screen_it n-sch <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-scheduler&quot;</span>
screen_it n-novnc <span class="s2">&quot;cd $NOVNC_DIR &amp;&amp; ./utils/nova-novncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF --web .&quot;</span>
screen_it n-xvnc <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-xvpvncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
screen_it n-cauth <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-consoleauth&quot;</span>
<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Nova volumes&quot;</span>
    start_nvol
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Cinder&quot;</span>
    start_cinder
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Ceilometer&quot;</span>
    configure_ceilometer
    start_ceilometer
<span class="k">fi</span>
screen_it horizon <span class="s2">&quot;cd $HORIZON_DIR &amp;&amp; sudo tail -f /var/log/$APACHE_NAME/horizon_error.log&quot;</span>
screen_it swift <span class="s2">&quot;cd $SWIFT_DIR &amp;&amp; $SWIFT_DIR/bin/swift-proxy-server ${SWIFT_CONFIG_DIR}/proxy-server.conf -v&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>The group <strong>libvirtd</strong> is added to the current user in this script.
Use 'sg' to execute nova-compute as a member of the <strong>libvirtd</strong> group.
<tt class="docutils literal">screen_it</tt> checks <tt class="docutils literal">is_service_enabled</tt>, it is not needed here</p>
</td><td class=code><div class=highlight><pre>
is_service_enabled swift3 <span class="o">||</span> <span class="se">\</span>
    screen_it n-obj <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-objectstore&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Starting the nova-objectstore only if swift3 service is not enabled.
Swift will act as s3 objectstore.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Heat&quot;</span>
    start_heat
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>launch heat engine, api and metadata</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="install-images">
<h1>Install Images</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Uploading images&quot;</span>
    <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>keystone  token-get | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Upload an image to glance.</p>
<p>The default image is cirros, a small testing image which lets you login as <strong>root</strong>
cirros also uses <tt class="docutils literal"><span class="pre">cloud-init</span></tt>, supporting login via keypair and sending scripts as
userdata.  See <a class="reference external" href="https://help.ubuntu.com/community/CloudInit">https://help.ubuntu.com/community/CloudInit</a> for more on cloud-init</p>
<dl class="docutils">
<dt>Override <tt class="docutils literal">IMAGE_URLS</tt> with a comma-separated list of UEC images.</dt>
<dd><ul class="first last simple">
<li><strong>oneiric</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz</a></li>
<li><strong>precise</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64.tar.gz</a></li>
</ul>
</dd>
</dl>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$UPLOAD_LEGACY_TTY&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">IMAGE_URLS</span><span class="o">=</span><span class="s2">&quot;${IMAGE_URLS:+${IMAGE_URLS},}http://images.ansolabs.com/tty.tgz&quot;</span>
    <span class="k">fi</span>

<span class="k">    for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span>upload_image <span class="nv">$image_url</span> <span class="nv">$TOKEN</span>
    <span class="k">done</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Option to upload legacy ami-tty, which works with xenserver</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="run-local-script">
<h1>Run local script</h1>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -x <span class="nv">$TOP_DIR</span>/local.sh <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Running user script $TOP_DIR/local.sh&quot;</span>
    <span class="nv">$TOP_DIR</span>/local.sh
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Run <tt class="docutils literal">local.sh</tt> if it exists to perform user-managed tasks</p>
</td><td class=code><div class=highlight><pre>

<span class="nb">set</span> +o xtrace

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">exec </span>1&gt;&amp;3
</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="fin">
<h1>Fin</h1>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Force all output to stdout and logs now</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt;&amp;3
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Force all output to stdout now</p>
</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="using-the-cloud">
<h2>Using the cloud</h2>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Horizon is now available at http://$SERVICE_HOST/&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you installed Horizon on this server you should be able
to access the site using your browser.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Keystone is serving at $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If Keystone is present you can point <tt class="docutils literal">nova</tt> cli to this server</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;This is your host ip: $HOST_IP&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo <tt class="docutils literal">HOST_IP</tt> - useful for <tt class="docutils literal">build_uec.sh</tt>, which uses dhcp to give the instance an address</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;WARNING: EXTRA_FLAGS is defined and may need to be converted to EXTRA_OPTS&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Warn that <tt class="docutils literal">EXTRA_FLAGS</tt> needs to be converted to <tt class="docutils literal">EXTRA_OPTS</tt></p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;stack.sh completed in $SECONDS seconds.&quot;</span>


</pre></div></td></tr><tr><td class=docs>
<p>Indicate how long this took to run (bash maintained variable <tt class="docutils literal">SECONDS</tt>)</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
