<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><tt class="docutils literal">stack.sh</tt> is an opinionated OpenStack developer installation.  It
installs and configures various combinations of <strong>Ceilometer</strong>, <strong>Cinder</strong>,
<strong>Glance</strong>, <strong>Heat</strong>, <strong>Horizon</strong>, <strong>Keystone</strong>, <strong>Nova</strong>, <strong>Quantum</strong>
and <strong>Swift</strong></p>
</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div></td></tr><tr><td class=docs>
<p>This script allows you to specify configuration options of what git
repositories to use, enabled services, network configuration and various
passwords.  If you are crafty you can run the script on multiple nodes using
shared settings for common resources (mysql, rabbitmq) and build a multi-node
developer install.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To keep this script simple we assume you are running on a recent <strong>Ubuntu</strong>
(11.10 Oneiric or newer) or <strong>Fedora</strong> (F16 or newer) machine.  It
should work in a VM or physical server.  Additionally we put the list of
<tt class="docutils literal">apt</tt> and <tt class="docutils literal">rpm</tt> dependencies and other configuration files in this repo.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Learn more and get the most recent version at <a class="reference external" href="http://devstack.org">http://devstack.org</a></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Keep track of the devstack directory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Import common functions</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/functions

</pre></div></td></tr><tr><td class=docs>
<p>Determine what system we are running on.  This provides <tt class="docutils literal">os_VENDOR</tt>,
<tt class="docutils literal">os_RELEASE</tt>, <tt class="docutils literal">os_UPDATE</tt>, <tt class="docutils literal">os_PACKAGE</tt>, <tt class="docutils literal">os_CODENAME</tt>
and <tt class="docutils literal">DISTRO</tt></p>
</td><td class=code><div class=highlight><pre>
GetDistro



</pre></div></td></tr><tr><td class=docs>
<div class="section" id="settings">
<h1>Settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> is customizable through setting environment variables.  If you
want to override a setting you can set and export it:</p>
<pre class="literal-block">
export DATABASE_PASSWORD=anothersecret
./stack.sh
</pre>
<p>You can also pass options on a single line <tt class="docutils literal">DATABASE_PASSWORD=simple ./stack.sh</tt></p>
<p>Additionally, you can put any local variables into a <tt class="docutils literal">localrc</tt> file:</p>
<pre class="literal-block">
DATABASE_PASSWORD=anothersecret
DATABASE_USER=hellaroot
</pre>
<p>We try to have sensible defaults, so you should be able to run <tt class="docutils literal">./stack.sh</tt>
in most cases.  <tt class="docutils literal">localrc</tt> is not distributed with DevStack and will never
be overwritten by a DevStack update.</p>
<p>DevStack distributes <tt class="docutils literal">stackrc</tt> which contains locations for the OpenStack
repositories and branches to configure.  <tt class="docutils literal">stackrc</tt> sources <tt class="docutils literal">localrc</tt> to
allow you to safely override those settings.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> ! -r <span class="nv">$TOP_DIR</span>/stackrc <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing $TOP_DIR/stackrc - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/stackrc


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="proxy-settings">
<h2>Proxy Settings</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>HTTP and HTTPS proxy servers are supported via the usual environment variables [1]
<tt class="docutils literal">http_proxy</tt>, <tt class="docutils literal">https_proxy</tt> and <tt class="docutils literal">no_proxy</tt>. They can be set in
<tt class="docutils literal">localrc</tt> if necessary or on the command line:</p>
<pre class="literal-block">
[1] http://www.w3.org/Daemon/User/Proxies/ProxyClients.html
</pre>
<blockquote>
http_proxy=http://proxy.example.com:3128/ no_proxy=repo.example.net ./stack.sh</blockquote>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$http_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$https_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$no_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for installation <tt class="docutils literal">DEST</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="sanity-check">
<h1>Sanity Check</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Clean up last environment var cache</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$TOP_DIR</span>/.stackenv <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>rm <span class="nv">$TOP_DIR</span>/.stackenv
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Import common services (database, message queue) configuration</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/database
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/rpc_backend

</pre></div></td></tr><tr><td class=docs>
<p>Validate database selection
Since DATABASE_BACKENDS is now set, this also gets ENABLED_SERVICES
properly configured for the database selection.</p>
</td><td class=code><div class=highlight><pre>
use_database <span class="nv">$DATABASE_TYPE</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Invalid database &#39;$DATABASE_TYPE&#39;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Remove services which were negated in ENABLED_SERVICES
using the &quot;-&quot; prefix (e.g., &quot;-rabbit&quot;) instead of
calling disable_service().</p>
</td><td class=code><div class=highlight><pre>
disable_negated_services

</pre></div></td></tr><tr><td class=docs>
<p>Warn users who aren't on an explicitly supported distro, but allow them to
override check and attempt installation with <tt class="docutils literal">FORCE=yes ./stack</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">DISTRO</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">(</span>oneiric|precise|quantal|raring|f16|f17|f18|opensuse-12.2<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has not been tested on $DISTRO&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure we only have one rpc backend enabled,
and the specified rpc backend is available on your platform.</p>
</td><td class=code><div class=highlight><pre>
check_rpc_backend

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> keeps function libraries here
Make sure <tt class="docutils literal">$TOP_DIR/lib</tt> directory is present</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$TOP_DIR</span>/lib <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/lib&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> keeps the list of <tt class="docutils literal">apt</tt> and <tt class="docutils literal">rpm</tt> dependencies and config
templates and other useful files in the <tt class="docutils literal">files</tt> subdirectory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/files&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Check to see if we are already running DevStack</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span><span class="nb">type</span> -p screen &gt;/dev/null <span class="o">&amp;&amp;</span> screen -ls | egrep -q <span class="s2">&quot;[0-9].$SCREEN_NAME&quot;</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are already running a stack.sh session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To rejoin this session type &#39;screen -x stack&#39;.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To destroy this session, type &#39;./unstack.sh&#39;.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging level</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VERBOSE</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$VERBOSE</span><span class="k">)</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="root-access">
<h2>root Access</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack is designed to be run as a non-root user; Horizon will fail to run
as <strong>root</strong> since Apache will not serve content from <strong>root</strong> user).  If
<tt class="docutils literal">stack.sh</tt> is run as <strong>root</strong>, it automatically creates a <strong>stack</strong> user with
sudo privileges and runs as that user.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">ROOTSLEEP</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOTSLEEP</span><span class="k">:-</span><span class="nv">10</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;In $ROOTSLEEP seconds, we will create a user &#39;$STACK_USER&#39; and run as that user&quot;</span>
    sleep <span class="nv">$ROOTSLEEP</span>

</pre></div></td></tr><tr><td class=docs>
<p>Give the non-root user the ability to run as <strong>root</strong> via <tt class="docutils literal">sudo</tt></p>
</td><td class=code><div class=highlight><pre>
    is_package_installed sudo <span class="o">||</span> install_package sudo
    <span class="k">if</span> ! getent group <span class="nv">$STACK_USER</span> &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a group called $STACK_USER&quot;</span>
        groupadd <span class="nv">$STACK_USER</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! getent passwd <span class="nv">$STACK_USER</span> &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a user called $STACK_USER&quot;</span>
        useradd -g <span class="nv">$STACK_USER</span> -s /bin/bash -d <span class="nv">$DEST</span> -m <span class="nv">$STACK_USER</span>
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Giving stack user passwordless sudo privileges&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>UEC images <tt class="docutils literal">/etc/sudoers</tt> does not have a <tt class="docutils literal">#includedir</tt>, add one</p>
</td><td class=code><div class=highlight><pre>
    grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> &gt;&gt; /etc/sudoers
    <span class="o">(</span> <span class="nb">umask </span>226 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$STACK_USER ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="se">\</span>
        &gt; /etc/sudoers.d/50_stack_sh <span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&quot;Copying files to $STACK_USER user&quot;</span>
    <span class="nv">STACK_DIR</span><span class="o">=</span><span class="s2">&quot;$DEST/${TOP_DIR##*/}&quot;</span>
    cp -r -f -T <span class="s2">&quot;$TOP_DIR&quot;</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    chown -R <span class="nv">$STACK_USER</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    <span class="nb">cd</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SHELL_AFTER_RUN&quot;</span> !<span class="o">=</span> <span class="s2">&quot;no&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>sudo -u <span class="nv">$STACK_USER</span>  bash -l -c <span class="s2">&quot;set -e; bash stack.sh; bash&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">exec </span>sudo -u <span class="nv">$STACK_USER</span> bash -l -c <span class="s2">&quot;set -e; source stack.sh&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>1
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>We're not <strong>root</strong>, make sure <tt class="docutils literal">sudo</tt> is available</p>
</td><td class=code><div class=highlight><pre>
    is_package_installed sudo <span class="o">||</span> die <span class="s2">&quot;Sudo is required.  Re-run stack.sh as root ONE TIME ONLY to set up sudo.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>UEC images <tt class="docutils literal">/etc/sudoers</tt> does not have a <tt class="docutils literal">#includedir</tt>, add one</p>
</td><td class=code><div class=highlight><pre>
    sudo grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> | sudo tee -a /etc/sudoers

</pre></div></td></tr><tr><td class=docs>
<p>Set up devstack sudoers</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$STACK_USER ALL=(root) NOPASSWD:ALL&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
</pre></div></td></tr><tr><td class=docs>
<p>Some binaries might be under /sbin or /usr/sbin, so make sure sudo will
see them by forcing PATH</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;Defaults:$STACK_USER secure_path=/sbin:/usr/sbin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin&quot;</span> &gt;&gt; <span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/50_stack_sh

</pre></div></td></tr><tr><td class=docs>
<p>Remove old file</p>
</td><td class=code><div class=highlight><pre>
    sudo rm -f /etc/sudoers.d/stack_sh_nova
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create the destination directory and ensure it is writable by the user</p>
</td><td class=code><div class=highlight><pre>
sudo mkdir -p <span class="nv">$DEST</span>
<span class="k">if</span> <span class="o">[</span> ! -w <span class="nv">$DEST</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$DEST</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">OFFLINE</tt> to <tt class="docutils literal">True</tt> to configure <tt class="docutils literal">stack.sh</tt> to run cleanly without
Internet access. <tt class="docutils literal">stack.sh</tt> must have been previously run with Internet
access to install prerequisites and fetch repositories.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OFFLINE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$OFFLINE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">ERROR_ON_CLONE</tt> to <tt class="docutils literal">True</tt> to configure <tt class="docutils literal">stack.sh</tt> to exit if
the destination git repository does not exist during the <tt class="docutils literal">git_clone</tt>
operation.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ERROR_ON_CLONE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$ERROR_ON_CLONE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for service data</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/data</span><span class="k">}</span>
sudo mkdir -p <span class="nv">$DATA_DIR</span>
sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$DATA_DIR</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="common-configuration">
<h1>Common Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set fixed and floating range here so we can make sure not to use addresses
from either range when attempting to guess the IP to use for the host.
Note that setting FIXED_RANGE may be necessary when running DevStack
in an OpenStack cloud that uses either of these address ranges internally.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.224/28</span><span class="k">}</span>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>
<span class="nv">NETWORK_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK_GATEWAY</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.1</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Find the interface used for the default route</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">HOST_IP_IFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">:-$(</span>ip route | sed -n <span class="s1">&#39;/^default/{ s/.*dev \(\w\+\)\s\+.*/\1/; p; }&#39;</span><span class="k">)}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Search for an IP unless an explicit is set by <tt class="docutils literal">HOST_IP</tt> environment variable</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$HOST_IP&quot;</span> -o <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">HOST_IPS</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C ip -f inet addr show <span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">}</span> | awk <span class="s1">&#39;/inet/ {split($2,parts,&quot;/&quot;);  print parts[1]}&#39;</span><span class="sb">`</span>
    <span class="k">for </span>IP in <span class="nv">$HOST_IPS</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to filter out IP addresses that are part of the fixed and
floating range. Note that this method only works if the <tt class="docutils literal">netaddr</tt>
python library is installed. If it is not installed, an error
will be printed and the first IP from the interface will be used.
If that is not correct set <tt class="docutils literal">HOST_IP</tt> in <tt class="docutils literal">localrc</tt> to the correct
address.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! <span class="o">(</span>address_in_net <span class="nv">$IP</span> <span class="nv">$FIXED_RANGE</span> <span class="o">||</span> address_in_net <span class="nv">$IP</span> <span class="nv">$FLOATING_RANGE</span><span class="o">)</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="nv">$IP</span>
            <span class="nb">break</span>;
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Could not determine host ip address.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Either localrc specified dhcp on ${HOST_IP_IFACE} or defaulted&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Allow the use of an alternate hostname (such as localhost/127.0.0.1) for service endpoints.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SERVICE_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure services to use syslog instead of writing to individual log files</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SYSLOG</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$SYSLOG</span><span class="sb">`</span>
<span class="nv">SYSLOG_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SYSLOG_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_PORT</span><span class="k">:-</span><span class="nv">516</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use color for logging output (only available if syslog is not used)</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LOG_COLOR</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$LOG_COLOR</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service startup timeout</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TIMEOUT</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TIMEOUT</span><span class="k">:-</span><span class="nv">60</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-projects">
<h1>Configure Projects</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Get project function libraries</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/tls
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/horizon
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/keystone
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/glance
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/nova
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/cinder
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/swift
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/ceilometer
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/heat
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/quantum
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/baremetal

</pre></div></td></tr><tr><td class=docs>
<p>Set the destination directories for OpenStack projects</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">HORIZON_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/horizon
<span class="nv">OPENSTACKCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-openstackclient
<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC
<span class="nv">SPICE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/spice-html5
<span class="nv">SWIFT3_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift3

</pre></div></td></tr><tr><td class=docs>
<p>Should cinder perform secure deletion of volumes?
Defaults to true, can be set to False to avoid this bug when testing:
<a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1023755">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1023755</a></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_SECURE_DELETE</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$CINDER_SECURE_DELETE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Name of the LVM volume group to use/create for iscsi volumes</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VOLUME_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_GROUP</span><span class="k">:-</span><span class="nv">stack</span><span class="p">-volumes</span><span class="k">}</span>
<span class="nv">VOLUME_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_NAME_PREFIX</span><span class="k">:-</span><span class="nv">volume</span><span class="p">-</span><span class="k">}</span>
<span class="nv">INSTANCE_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">INSTANCE_NAME_PREFIX</span><span class="k">:-</span><span class="nv">instance</span><span class="p">-</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Generic helper to configure passwords</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>read_password <span class="o">{</span>
    <span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>; <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>

    <span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/localrc

</pre></div></td></tr><tr><td class=docs>
<p>If the password is not defined yet, proceed to prompt user for a password.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If there is no localrc file, create one</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$localrc</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>touch <span class="nv">$localrc</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Presumably if we got this far it can only be that our localrc is missing
the required password.  Prompt user for a password and write to localrc.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="nv">$msg</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This value will be written to your localrc file so you don&#39;t have to enter it &quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;again.  Use only alphanumeric characters.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;If you leave this blank, a random default value will be used.&quot;</span>
        <span class="nv">pw</span><span class="o">=</span><span class="s2">&quot; &quot;</span>
        <span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Enter a password now:&quot;</span>
            <span class="nb">read</span> -e <span class="nv">$var</span>
            <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>
            <span class="o">[[</span> <span class="s2">&quot;$pw&quot;</span> <span class="o">=</span> <span class="s2">&quot;`echo $pw | tr -cd [:alnum:]`&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">            echo</span> <span class="s2">&quot;Invalid chars in password.  Try again:&quot;</span>
        <span class="k">done</span>
<span class="k">        if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">pw</span><span class="o">=</span><span class="sb">`</span>openssl rand -hex 10<span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">eval</span> <span class="s2">&quot;$var=$pw&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;$var=$pw&quot;</span> &gt;&gt; <span class="nv">$localrc</span>
    <span class="k">fi</span>
    <span class="nv">$XTRACE</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="nova-network-configuration">
<h2>Nova Network Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>FIXME: more documentation about why these are important options.  Also
we should make sure we use the same variable names as the option names.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth3
</pre></div></td></tr><tr><td class=docs>
<p>Allow <tt class="docutils literal">build_domU.sh</tt> to specify the flat network bridge via kernel args</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span><span class="k">$(</span>grep -o <span class="s1">&#39;flat_network_bridge=[[:alnum:]]*&#39;</span> /proc/cmdline | cut -d<span class="o">=</span> -f 2 | sort -u<span class="k">)</span>
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth1
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;baremetal&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>
    <span class="nv">FORCE_DHCP_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">FORCE_DHCP_RELEASE</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
    <span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatManager</span><span class="k">}</span>
    <span class="nv">STUB_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">STUB_NETWORK</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
<span class="k">fi</span>

<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">$FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">FORCE_DHCP_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">FORCE_DHCP_RELEASE</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Test floating pool and range are used for testing.  They are defined
here until the admin APIs can replace nova-manage</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TEST_FLOATING_POOL</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_POOL</span><span class="k">:-</span><span class="nv">test</span><span class="k">}</span>
<span class="nv">TEST_FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_RANGE</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.253.0/29</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">MULTI_HOST</tt> is a mode where each compute node runs its own network node.  This
allows network operations and routing for a VM to occur on the server that is
running the VM - removing a SPOF and bandwidth bottleneck.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$MULTI_HOST</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you are using the FlatDHCP network mode on multiple hosts, set the
<tt class="docutils literal">FLAT_INTERFACE</tt> variable but make sure that the interface doesn't already
have an IP or you risk breaking things.</p>
<p><strong>DHCP Warning</strong>:  If your flat interface device uses DHCP, there will be a
hiccup while the network is moved from the flat interface to the flat network
bridge.  This will happen when you launch your first instance.  Upon launch
you will lose all connectivity to the node, and the VM launch will probably
fail.</p>
<p>If you are running on a single node and don't need to access the VMs from
devices other than that node, you can set <tt class="docutils literal">FLAT_INTERFACE=</tt>
This will stop nova from bridging any interfaces into <tt class="docutils literal">FLAT_NETWORK_BRIDGE</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="p">-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

<span class="c">## FIXME(ja): should/can we check that FLAT_INTERFACE is sane?</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="database-configuration">
<h2>Database Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To select between database backends, add a line to localrc like:</p>
<blockquote>
use_database postgresql</blockquote>
<p>The available database backends are defined in the <tt class="docutils literal">DATABASE_BACKENDS</tt>
variable defined in stackrc. By default, MySQL is enabled as the database
backend.</p>
</td><td class=code><div class=highlight><pre>

initialize_database_backends <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Using $DATABASE_TYPE database backend&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;No database enabled&quot;</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="rabbitmq-or-qpid">
<h2>RabbitMQ or Qpid</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Rabbit connection info</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
<span class="k">    </span><span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
    read_password RABBIT_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR RABBIT.&quot;</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If we are using swift3, we can default the s3 port to swift instead
of nova-objectstore</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift3;then
        <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>We only ask for Swift Hash if we have enabled swift service.
<tt class="docutils literal">SWIFT_HASH</tt> is a random unique string for a swift cluster that
can never change.</p>
</td><td class=code><div class=highlight><pre>
    read_password SWIFT_HASH <span class="s2">&quot;ENTER A RANDOM SWIFT HASH.&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set default port for nova-objectstore</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">3333</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="keystone">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>The <tt class="docutils literal">SERVICE_TOKEN</tt> is used to bootstrap the Keystone database.  It is
just a string and is not a 'real' Keystone token.</p>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_TOKEN <span class="s2">&quot;ENTER A SERVICE_TOKEN TO USE FOR THE SERVICE ADMIN TOKEN.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Services authenticate to Identity with servicename/<tt class="docutils literal">SERVICE_PASSWORD</tt></p>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_PASSWORD <span class="s2">&quot;ENTER A SERVICE_PASSWORD TO USE FOR THE SERVICE AUTHENTICATION.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Horizon currently truncates usernames and passwords at 20 characters</p>
</td><td class=code><div class=highlight><pre>
read_password ADMIN_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR HORIZON AND KEYSTONE (20 CHARS OR LESS).&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the tenant for service accounts in Keystone</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TENANT_NAME</span><span class="k">:-</span><span class="nv">service</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="log-files">
<h2>Log files</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Draw a spinner so the user knows something is happening</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>spinner<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">delay</span><span class="o">=</span>0.75
    <span class="nb">local </span><span class="nv">spinstr</span><span class="o">=</span><span class="s1">&#39;/-\|&#39;</span>
    <span class="nb">printf</span> <span class="s2">&quot;...&quot;</span> &gt;&amp;3
    <span class="k">while</span> <span class="o">[</span> <span class="nb">true</span> <span class="o">]</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">temp</span><span class="o">=</span><span class="k">${</span><span class="nv">spinstr</span><span class="p">#?</span><span class="k">}</span>
        <span class="nb">printf</span> <span class="s2">&quot;[%c]&quot;</span> <span class="s2">&quot;$spinstr&quot;</span> &gt;&amp;3
        <span class="nb">local </span><span class="nv">spinstr</span><span class="o">=</span><span class="nv">$temp</span><span class="k">${</span><span class="nv">spinstr</span><span class="p">%</span><span class="s2">&quot;$temp&quot;</span><span class="k">}</span>
        sleep <span class="nv">$delay</span>
        <span class="nb">printf</span> <span class="s2">&quot;\b\b\b&quot;</span> &gt;&amp;3
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo text to the log file, summary log file and stdout
echo_summary &quot;something to say&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>echo_summary<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -t 3 <span class="o">&amp;&amp;</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">kill</span> &gt;/dev/null 2&gt;&amp;1 <span class="nv">$LAST_SPINNER_PID</span>
        <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;$LAST_SPINNER_PID&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">printf</span> <span class="s2">&quot;\b\b\bdone\n&quot;</span> &gt;&amp;3
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">echo</span> -n <span class="nv">$@</span> &gt;&amp;6
        spinner &amp;
        <span class="nv">LAST_SPINNER_PID</span><span class="o">=</span><span class="nv">$!</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$@</span> &gt;&amp;6
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo text only to stdout, no log files
echo_nolog &quot;something not for the logs&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>echo_nolog<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&amp;3
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging for <tt class="docutils literal">stack.sh</tt>
Set <tt class="docutils literal">LOGFILE</tt> to turn on logging
Append '.xxxxxxxx' to the given name to maintain history
where 'xxxxxxxx' is a representation of the date the file was created</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="k">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LOGDAYS</span><span class="o">=</span><span class="k">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="k">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>First clean up old log files.  Use the user-specified <tt class="docutils literal">LOGFILE</tt>
as the template to search for, appending '.*' to match the date
we added on earlier runs.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    <span class="nv">LOGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    mkdir -p <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth 1 -name <span class="nv">$LOGNAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>
    <span class="nv">SUMFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.summary

</pre></div></td></tr><tr><td class=docs>
<p>Redirect output according to config</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Copy stdout to fd 3</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>3&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VERBOSE&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Redirect stdout/stderr to tee to write the log file</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> awk <span class="s1">&#39;</span>
<span class="s1">                {</span>
<span class="s1">                    cmd =&quot;date +\&quot;%Y-%m-%d %H:%M:%S \&quot;&quot;</span>
<span class="s1">                    cmd | getline now</span>
<span class="s1">                    close(&quot;date +\&quot;%Y-%m-%d %H:%M:%S \&quot;&quot;)</span>
<span class="s1">                    sub(/^/, now)</span>
<span class="s1">                    print</span>
<span class="s1">                    fflush()</span>
<span class="s1">                }&#39;</span> | tee <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
</pre></div></td></tr><tr><td class=docs>
<p>Set up a second fd for output</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${SUMFILE}&quot;</span> <span class="o">)</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 1 and 2 to primary logfile</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt; <span class="s2">&quot;${LOGFILE}&quot;</span> 2&gt;&amp;1
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 6 to summary logfile and stdout</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${SUMFILE}&quot;</span> /dev/fd/3 <span class="o">)</span>
    <span class="k">fi</span>

<span class="k">    </span>echo_summary <span class="s2">&quot;stack.sh log $LOGFILE&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specified logfile name always links to the most recent log</p>
</td><td class=code><div class=highlight><pre>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>
    ln -sf <span class="nv">$SUMFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>.summary
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set up output redirection without log files
Copy stdout to fd 3</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>3&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Throw away stdout and stderr</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt;/dev/null 2&gt;&amp;1
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Always send summary fd to original stdout</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>6&gt;&amp;3
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging of screen windows
Set <tt class="docutils literal">SCREEN_LOGDIR</tt> to turn on logging of screen windows to the
directory specified in <tt class="docutils literal">SCREEN_LOGDIR</tt>, we will log to the the file
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME-$TIMESTAMP.log</span></tt> in that dir and have a link
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME.log</span></tt> to the latest log file.
Logs are kept for as long specified in <tt class="docutils literal">LOGDAYS</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>We make sure the directory is created.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We cleanup the old logs</p>
</td><td class=code><div class=highlight><pre>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth 1 -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
<span class="k">        </span>mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="set-up-script-execution">
<h2>Set Up Script Execution</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Kill background processes on exit</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>clean EXIT
clean<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">kill</span> &gt;/dev/null 2&gt;&amp;1 <span class="k">$(</span><span class="nb">jobs</span> -p<span class="k">)</span>
    <span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Exit on any errors so that errors don't compound</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>failed ERR
failed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">kill</span> &gt;/dev/null 2&gt;&amp;1 <span class="k">$(</span><span class="nb">jobs</span> -p<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="o">[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed: full log in $LOGFILE&quot;</span>
    <span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Print the commands being run so that we can see the command that triggers
an error.  It is also useful for following along as the install occurs.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="install-packages">
<h1>Install Packages</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack uses a fair number of other projects.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Install package requirements</p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;Installing package prerequisites&quot;</span>
<span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">    </span>install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/apts<span class="k">)</span>
<span class="k">elif </span>is_fedora; <span class="k">then</span>
<span class="k">    </span>install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/rpms<span class="k">)</span>
<span class="k">elif </span>is_suse; <span class="k">then</span>
<span class="k">    </span>install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/rpms-suse<span class="k">)</span>
<span class="k">else</span>
<span class="k">    </span>exit_distro_not_supported <span class="s2">&quot;list of packages&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    if </span>is_ubuntu <span class="o">||</span> is_fedora; <span class="k">then</span>
<span class="k">        </span>install_package rsyslog-relp
    <span class="k">elif </span>is_suse; <span class="k">then</span>
<span class="k">        </span>install_package rsyslog-module-relp
    <span class="k">else</span>
<span class="k">        </span>exit_distro_not_supported <span class="s2">&quot;rsyslog-relp installation&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

install_rpc_backend

<span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span>; <span class="k">then</span>
<span class="k">    </span>install_database
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">    </span>install_quantum_agent_packages
<span class="k">fi</span>

<span class="nv">TRACK_DEPENDS</span><span class="o">=</span><span class="k">${</span><span class="nv">TRACK_DEPENDS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install python packages into a virtualenv so that we can track them</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Installing Python packages into a virtualenv $DEST/.venv&quot;</span>
    install_package python-virtualenv

    rm -rf <span class="nv">$DEST</span>/.venv
    virtualenv --system-site-packages <span class="nv">$DEST</span>/.venv
    <span class="nb">source</span> <span class="nv">$DEST</span>/.venv/bin/activate
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-pre-pip
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="check-out-source">
<h2>Check Out Source</h2>
</td><td class=code><div class=highlight><pre>

echo_summary <span class="s2">&quot;Installing OpenStack project source&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Grab clients first</p>
</td><td class=code><div class=highlight><pre>
install_keystoneclient
install_glanceclient
install_novaclient
</pre></div></td></tr><tr><td class=docs>
<p>Check out the client libs that are used most</p>
</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$OPENSTACKCLIENT_REPO</span> <span class="nv">$OPENSTACKCLIENT_DIR</span> <span class="nv">$OPENSTACKCLIENT_BRANCH</span>

</pre></div></td></tr><tr><td class=docs>
<p>glance, swift middleware and nova api needs keystone middleware</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>unified auth system (manages accounts/tokens)</p>
</td><td class=code><div class=highlight><pre>
    install_keystone
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>install_swiftclient
    install_swift
    <span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>swift3 middleware to provide S3 emulation to Swift</p>
</td><td class=code><div class=highlight><pre>
        git_clone <span class="nv">$SWIFT3_REPO</span> <span class="nv">$SWIFT3_DIR</span> <span class="nv">$SWIFT3_BRANCH</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>image catalog service</p>
</td><td class=code><div class=highlight><pre>
    install_glance
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>compute service</p>
</td><td class=code><div class=highlight><pre>
    install_nova
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-novnc; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>a websockets/html5 or flash powered VNC console for vm instances</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$NOVNC_DIR</span> <span class="nv">$NOVNC_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-spice; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>a websockets/html5 or flash powered SPICE console for vm instances</p>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SPICE_REPO</span> <span class="nv">$SPICE_DIR</span> <span class="nv">$SPICE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>dashboard</p>
</td><td class=code><div class=highlight><pre>
    install_horizon
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>install_quantum
    install_quantumclient
    install_quantum_third_party
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>install_heat
    install_heatclient
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>install_cinder
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">    </span>install_ceilometerclient
    install_ceilometer
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="initialization">
<h1>Initialization</h1>
</td><td class=code><div class=highlight><pre>

echo_summary <span class="s2">&quot;Configuring OpenStack projects&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up our checkouts so they are installed into python path
allowing <tt class="docutils literal">import nova</tt> or <tt class="docutils literal">import glance.client</tt></p>
</td><td class=code><div class=highlight><pre>
configure_keystoneclient
configure_novaclient
setup_develop <span class="nv">$OPENSTACKCLIENT_DIR</span>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
<span class="k">    </span>configure_keystone
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>configure_swift
    configure_swiftclient
    <span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
<span class="k">        </span>setup_develop <span class="nv">$SWIFT3_DIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
<span class="k">    </span>configure_glance
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Do this _after_ glance is installed to override the old binary
TODO(dtroyer): figure out when this is no longer necessary</p>
</td><td class=code><div class=highlight><pre>
configure_glanceclient

<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>configure_nova
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span>configure_horizon
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>setup_quantumclient
    setup_quantum
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>configure_heat
    configure_heatclient
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>configure_cinder
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-post-pip
    <span class="k">if</span> ! diff -Nru <span class="nv">$DEST</span>/requires-pre-pip <span class="nv">$DEST</span>/requires-post-pip &gt; <span class="nv">$DEST</span>/requires.diff ; <span class="k">then</span>
<span class="k">        </span>cat <span class="nv">$DEST</span>/requires.diff
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Ran stack.sh in depend tracking mode, bailing out now&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">    </span>configure_CA
    init_CA
    init_cert
</pre></div></td></tr><tr><td class=docs>
<p>Add name to /etc/hosts
don't be naive and add to existing line!</p>
</td><td class=code><div class=highlight><pre>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="syslog">
<h2>Syslog</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$SYSLOG_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Configure the master host to receive</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-m.conf</span>
<span class="s">\$ModLoad imrelp</span>
<span class="s">\$InputRELPServerRun $SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-m.conf /etc/rsyslog.d
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set rsyslog to send to remote host</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-s.conf</span>
<span class="s">*.*		:omrelp:$SYSLOG_HOST:$SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-s.conf /etc/rsyslog.d
    <span class="k">fi</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting rsyslog&quot;</span>
    restart_service rsyslog
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="finalize-queue-installation">
<h2>Finalize queue installation</h2>
</td><td class=code><div class=highlight><pre>
restart_rpc_backend


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-database">
<h2>Configure database</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span>; <span class="k">then</span>
<span class="k">    </span>configure_database
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-screen">
<h2>Configure screen</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">SCREEN_HARDSTATUS</span><span class="o">=</span><span class="s1">&#39;%{= .} %-Lw%{= .}%&gt; %n%f %t*%{= .}%+Lw%&lt; %-=%{g}(%{d}%H/%l%{g})&#39;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clear screen rc file</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/<span class="nv">$SCREEN_NAME</span>-screenrc
<span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> -n &gt; <span class="nv">$SCREENRC</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a new named screen to run processes in</p>
</td><td class=code><div class=highlight><pre>
screen -d -m -S <span class="nv">$SCREEN_NAME</span> -t shell -s /bin/bash
sleep 1

</pre></div></td></tr><tr><td class=docs>
<p>Set a reasonable status bar</p>
</td><td class=code><div class=highlight><pre>
screen -r <span class="nv">$SCREEN_NAME</span> -X hardstatus alwayslastline <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Initialize the directory for service status check</p>
</td><td class=code><div class=highlight><pre>
init_service_check

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id1">
<h2>Keystone</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Keystone&quot;</span>
    init_keystone
    start_keystone

</pre></div></td></tr><tr><td class=docs>
<p>Set up a temporary admin URI for Keystone</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT</span>/v2.0

    <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span><span class="nb">export </span><span class="nv">OS_CACERT</span><span class="o">=</span><span class="nv">$INT_CA_DIR</span>/ca-chain.pem
</pre></div></td></tr><tr><td class=docs>
<p>Until the client support is fixed, just use the internal endpoint</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span>http://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT_INT</span>/v2.0
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Do the keystone-specific bits from keystone_data.sh</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">export </span><span class="nv">OS_SERVICE_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span>
    <span class="nb">export </span><span class="nv">OS_SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span>
    create_keystone_accounts
    create_nova_accounts
    create_cinder_accounts
    create_quantum_accounts

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">keystone_data.sh</tt> creates services, admin and demo users, and roles.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ADMIN_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span> <span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="nv">$SERVICE_TENANT_NAME</span> <span class="nv">SERVICE_PASSWORD</span><span class="o">=</span><span class="nv">$SERVICE_PASSWORD</span> <span class="se">\</span>
    <span class="nv">SERVICE_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span> <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span> <span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="nv">$SERVICE_HOST</span> <span class="se">\</span>
    <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="nv">$S3_SERVICE_PORT</span> <span class="nv">KEYSTONE_CATALOG_BACKEND</span><span class="o">=</span><span class="nv">$KEYSTONE_CATALOG_BACKEND</span> <span class="se">\</span>
    <span class="nv">DEVSTACK_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span> <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="nv">$ENABLED_SERVICES</span> <span class="nv">HEAT_API_CFN_PORT</span><span class="o">=</span><span class="nv">$HEAT_API_CFN_PORT</span> <span class="se">\</span>
    <span class="nv">HEAT_API_PORT</span><span class="o">=</span><span class="nv">$HEAT_API_PORT</span> <span class="se">\</span>
        bash -x <span class="nv">$FILES</span>/keystone_data.sh

</pre></div></td></tr><tr><td class=docs>
<p>Set up auth creds now that keystone is bootstrapped</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">export </span><span class="nv">OS_AUTH_URL</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span>
    <span class="nb">export </span><span class="nv">OS_TENANT_NAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_USERNAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span>
    <span class="nb">unset </span>OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="horizon">
<h2>Horizon</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the django horizon application to serve via apache/wsgi</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring and starting Horizon&quot;</span>
    init_horizon
    start_horizon
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="glance">
<h2>Glance</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Glance&quot;</span>

    init_glance

</pre></div></td></tr><tr><td class=docs>
<p>Store the images in swift if enabled.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT default_store swift
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_auth_address <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/v2.0/
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_user <span class="nv">$SERVICE_TENANT_NAME</span>:glance
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_key <span class="nv">$SERVICE_PASSWORD</span>
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_create_container_on_put True
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="quantum">
<h2>Quantum</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Quantum&quot;</span>

    configure_quantum
    init_quantum
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Some Quantum plugins require network controllers which are not
a part of the OpenStack project. Configure and start them.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>configure_quantum_third_party
    init_quantum_third_party
    start_quantum_third_party
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova">
<h2>Nova</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Nova&quot;</span>
    configure_nova
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-net q-dhcp; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete traces of nova networks from prior runs
Do not kill any dnsmasq instance spawned by NetworkManager</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">netman_pid</span><span class="o">=</span><span class="k">$(</span>pidof NetworkManager <span class="o">||</span> <span class="nb">true</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$netman_pid&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">else</span>
<span class="k">        </span>sudo ps h -o pid,ppid -C dnsmasq | grep -v <span class="nv">$netman_pid</span> | awk <span class="s1">&#39;{print $1}&#39;</span> | sudo xargs <span class="nb">kill</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    </span>clean_iptables
    rm -rf <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/networks
    sudo mkdir -p <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/networks
    sudo chown -R <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/networks
</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just on case</p>
</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="storage-service">
<h2>Storage Service</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Swift&quot;</span>
    init_swift
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="volume-service">
<h2>Volume Service</h2>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Cinder&quot;</span>
    init_cinder
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Nova&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Rebuild the config file from scratch</p>
</td><td class=code><div class=highlight><pre>
    create_nova_conf
    init_nova

</pre></div></td></tr><tr><td class=docs>
<p>Additional Nova configuration that is dependent on other services</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">        </span>create_nova_conf_quantum
    <span class="k">elif </span>is_service_enabled n-net; <span class="k">then</span>
<span class="k">        </span>create_nova_conf_nova_network
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>All nova-compute workers need to know the vnc configuration options
These settings don't hurt anything if n-xvnc and n-novnc are disabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6080/vnc_auto.html&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT novncproxy_base_url <span class="s2">&quot;$NOVNCPROXY_URL&quot;</span>
        <span class="nv">XVPVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XVPVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6081/console&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT xvpvncproxy_base_url <span class="s2">&quot;$XVPVNCPROXY_URL&quot;</span>
        <span class="nv">SPICEHTML5PROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">SPICEHTML5PROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6082/spice_auto.html&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> spice html5proxy_base_url <span class="s2">&quot;$SPICEHTML5PROXY_URL&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=169.254.0.1</span><span class="k">}</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled n-novnc <span class="o">||</span> is_service_enabled n-xvnc ; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Address on which instance vncservers will listen on compute hosts.
For multi-host, this should be the management ip of the compute host.</p>
</td><td class=code><div class=highlight><pre>
      <span class="nv">VNCSERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
      iniset <span class="nv">$NOVA_CONF</span> DEFAULT vnc_enabled <span class="nb">true</span>
<span class="nb">      </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT vncserver_listen <span class="s2">&quot;$VNCSERVER_LISTEN&quot;</span>
      iniset <span class="nv">$NOVA_CONF</span> DEFAULT vncserver_proxyclient_address <span class="s2">&quot;$VNCSERVER_PROXYCLIENT_ADDRESS&quot;</span>
    <span class="k">else</span>
<span class="k">      </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT vnc_enabled <span class="nb">false</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    if </span>is_service_enabled n-spice; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Address on which instance spiceservers will listen on compute hosts.
For multi-host, this should be the management ip of the compute host.</p>
</td><td class=code><div class=highlight><pre>
      <span class="nv">SPICESERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">SPICESERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
      <span class="nv">SPICESERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">SPICESERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
      iniset <span class="nv">$NOVA_CONF</span> spice enabled <span class="nb">true</span>
<span class="nb">      </span>iniset <span class="nv">$NOVA_CONF</span> spice server_listen <span class="s2">&quot;$SPICESERVER_LISTEN&quot;</span>
      iniset <span class="nv">$NOVA_CONF</span> spice server_proxyclient_address <span class="s2">&quot;$SPICESERVER_PROXYCLIENT_ADDRESS&quot;</span>
    <span class="k">else</span>
<span class="k">      </span>iniset <span class="nv">$NOVA_CONF</span> spice enabled <span class="nb">false</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT ec2_dmz_host <span class="s2">&quot;$EC2_DMZ_HOST&quot;</span>
    iniset_rpc_backend nova <span class="nv">$NOVA_CONF</span> DEFAULT
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT glance_api_servers <span class="s2">&quot;$GLANCE_HOSTPORT&quot;</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="xenserver">
<h2>XenServer</h2>
</td><td class=code><div class=highlight><pre>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Using XenServer virtualization driver&quot;</span>
        read_password XENAPI_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR XEN.&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT compute_driver <span class="s2">&quot;xenapi.XenAPIDriver&quot;</span>
        <span class="nv">XENAPI_CONNECTION_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_CONNECTION_URL</span><span class="k">:-</span><span class="s2">&quot;http://169.254.0.1&quot;</span><span class="k">}</span>
        <span class="nv">XENAPI_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_USER</span><span class="k">:-</span><span class="s2">&quot;root&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT xenapi_connection_url <span class="s2">&quot;$XENAPI_CONNECTION_URL&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT xenapi_connection_username <span class="s2">&quot;$XENAPI_USER&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT xenapi_connection_password <span class="s2">&quot;$XENAPI_PASSWORD&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT flat_injected <span class="s2">&quot;False&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Need to avoid crash due to new firewall support</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">XEN_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">XEN_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT firewall_driver <span class="s2">&quot;$XEN_FIREWALL_DRIVER&quot;</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="openvz">
<h2>OpenVZ</h2>
</td><td class=code><div class=highlight><pre>

    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;openvz&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Using OpenVZ virtualization driver&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<dl class="docutils">
<dt>TODO(deva): OpenVZ driver does not yet work if compute_driver is set here.</dt>
<dd>Replace connection_type when this is fixed.
iniset $NOVA_CONF DEFAULT compute_driver &quot;openvz.connection.OpenVzConnection&quot;</dd>
</dl>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT connection_type <span class="s2">&quot;openvz&quot;</span>
        <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT firewall_driver <span class="s2">&quot;$LIBVIRT_FIREWALL_DRIVER&quot;</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="bare-metal">
<h2>Bare Metal</h2>
</td><td class=code><div class=highlight><pre>

    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;baremetal&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Using BareMetal driver&quot;</span>
        <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.firewall.NoopFirewallDriver&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT compute_driver nova.virt.baremetal.driver.BareMetalDriver
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT firewall_driver <span class="nv">$LIBVIRT_FIREWALL_DRIVER</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT scheduler_host_manager nova.scheduler.baremetal_host_manager.BaremetalHostManager
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT scheduler_default_filters AllHostsFilter
        iniset <span class="nv">$NOVA_CONF</span> baremetal driver <span class="nv">$BM_DRIVER</span>
        iniset <span class="nv">$NOVA_CONF</span> baremetal instance_type_extra_specs cpu_arch:<span class="nv">$BM_CPU_ARCH</span>
        iniset <span class="nv">$NOVA_CONF</span> baremetal power_manager <span class="nv">$BM_POWER_MANAGER</span>
        iniset <span class="nv">$NOVA_CONF</span> baremetal tftp_root /tftpboot

</pre></div></td></tr><tr><td class=docs>
<p>Define extra baremetal nova conf flags by defining the array <tt class="docutils literal">EXTRA_BAREMETAL_OPTS</tt>.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">for </span>I in <span class="s2">&quot;${EXTRA_BAREMETAL_OPTS[@]}&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to convert flags to options</p>
</td><td class=code><div class=highlight><pre>
           iniset <span class="nv">$NOVA_CONF</span> baremetal <span class="k">${</span><span class="nv">I</span><span class="p">//=/ </span><span class="k">}</span>
        <span class="k">done</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="default">
<h2>Default</h2>
</td><td class=code><div class=highlight><pre>

    <span class="k">else</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Using libvirt virtualization driver&quot;</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT compute_driver <span class="s2">&quot;libvirt.LibvirtDriver&quot;</span>
        <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT firewall_driver <span class="s2">&quot;$LIBVIRT_FIREWALL_DRIVER&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Extra things to prepare nova for baremetal, before nova starts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled nova <span class="o">&amp;&amp;</span> is_baremetal; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Preparing for nova baremetal&quot;</span>
    prepare_baremetal_toolchain
    configure_baremetal_nova_dirs
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$BM_USE_FAKE_ENV&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">       </span>create_fake_baremetal_env
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="launch-services">
<h1>Launch Services</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Only run the services specified in <tt class="docutils literal">ENABLED_SERVICES</tt></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Launch Swift Services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Swift&quot;</span>
    start_swift
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Launch the Glance services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-api g-reg; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Glance&quot;</span>
    start_glance
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create an access key and secret key for nova ec2 register image</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key <span class="o">&amp;&amp;</span> is_service_enabled swift3 <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVA_USER_ID</span><span class="o">=</span><span class="k">$(</span>keystone user-list | grep <span class="s1">&#39; nova &#39;</span> | get_field 1<span class="k">)</span>
    <span class="nv">NOVA_TENANT_ID</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | grep <span class="s2">&quot; $SERVICE_TENANT_NAME &quot;</span> | get_field 1<span class="k">)</span>
    <span class="nv">CREDS</span><span class="o">=</span><span class="k">$(</span>keystone ec2-credentials-create --user_id <span class="nv">$NOVA_USER_ID</span> --tenant_id <span class="nv">$NOVA_TENANT_ID</span><span class="k">)</span>
    <span class="nv">ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ access / { print $4 }&#39;</span><span class="k">)</span>
    <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ secret / { print $4 }&#39;</span><span class="k">)</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_access_key <span class="s2">&quot;$ACCESS_KEY&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_secret_key <span class="s2">&quot;$SECRET_KEY&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_affix_tenant <span class="s2">&quot;True&quot;</span>
<span class="k">fi</span>

screen_it zeromq <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-rpc-zmq-receiver&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Launch the nova-api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Nova API&quot;</span>
    start_nova_api
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Quantum&quot;</span>

    start_quantum_service_and_check
    create_quantum_initial_network
    setup_quantum_debug
<span class="k">elif </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span> <span class="o">&amp;&amp;</span> is_service_enabled n-net; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a small network</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage network create <span class="s2">&quot;$PRIVATE_NETWORK_NAME&quot;</span> <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span> <span class="nv">$NETWORK_CREATE_ARGS</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create some floating ips</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage floating create <span class="nv">$FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$PUBLIC_NETWORK_NAME</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a second pool</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage floating create --ip_range<span class="o">=</span><span class="nv">$TEST_FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$TEST_FLOATING_POOL</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>start_quantum_agents
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Nova&quot;</span>
    start_nova
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Cinder&quot;</span>
    start_cinder
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Ceilometer&quot;</span>
    configure_ceilometer
    configure_ceilometerclient
    echo_summary <span class="s2">&quot;Starting Ceilometer&quot;</span>
    init_ceilometer
    start_ceilometer
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Starting the nova-objectstore only if swift3 service is not enabled.
Swift will act as s3 objectstore.</p>
</td><td class=code><div class=highlight><pre>
is_service_enabled swift3 <span class="o">||</span> <span class="se">\</span>
    screen_it n-obj <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_BIN_DIR/nova-objectstore&quot;</span>


</pre></div></td></tr><tr><td class=docs>
<p>Configure and launch heat engine, api and metadata</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Initialize heat, including replacing nova flavors</p>
</td><td class=code><div class=highlight><pre>
    echo_summary <span class="s2">&quot;Configuring Heat&quot;</span>
    init_heat
    echo_summary <span class="s2">&quot;Starting Heat&quot;</span>
    start_heat
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="create-account-rc-files">
<h1>Create account rc files</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Creates source able script files for easier user switching.
This step also creates certificates for tenants and users,
which is helpful in image bundle steps.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled nova <span class="o">&amp;&amp;</span> is_service_enabled key; <span class="k">then</span>
    <span class="nv">$TOP_DIR</span>/tools/create_userrc.sh -PA --target-dir <span class="nv">$TOP_DIR</span>/accrc
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="install-images">
<h1>Install Images</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Upload an image to glance.</p>
<p>The default image is cirros, a small testing image which lets you login as <strong>root</strong>
cirros also uses <tt class="docutils literal"><span class="pre">cloud-init</span></tt>, supporting login via keypair and sending scripts as
userdata.  See <a class="reference external" href="https://help.ubuntu.com/community/CloudInit">https://help.ubuntu.com/community/CloudInit</a> for more on cloud-init</p>
<dl class="docutils">
<dt>Override <tt class="docutils literal">IMAGE_URLS</tt> with a comma-separated list of UEC images.</dt>
<dd><ul class="first last simple">
<li><strong>oneiric</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/oneiric/current/oneiric-server-cloudimg-amd64.tar.gz</a></li>
<li><strong>precise</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64.tar.gz</a></li>
</ul>
</dd>
</dl>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span><span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>keystone token-get | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>

    <span class="k">if </span>is_baremetal; <span class="k">then</span>
<span class="k">       </span>echo_summary <span class="s2">&quot;Creating and uploading baremetal images&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>build and upload separate deploy kernel &amp; ramdisk</p>
</td><td class=code><div class=highlight><pre>
       upload_baremetal_deploy <span class="nv">$TOKEN</span>

</pre></div></td></tr><tr><td class=docs>
<p>upload images, separating out the kernel &amp; ramdisk for PXE boot</p>
</td><td class=code><div class=highlight><pre>
       <span class="k">for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">           </span>upload_baremetal_image <span class="nv">$image_url</span> <span class="nv">$TOKEN</span>
       <span class="k">done</span>
<span class="k">    else</span>
<span class="k">       </span>echo_summary <span class="s2">&quot;Uploading images&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Option to upload legacy ami-tty, which works with xenserver</p>
</td><td class=code><div class=highlight><pre>
       <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$UPLOAD_LEGACY_TTY&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">           </span><span class="nv">IMAGE_URLS</span><span class="o">=</span><span class="s2">&quot;${IMAGE_URLS:+${IMAGE_URLS},}https://github.com/downloads/citrix-openstack/warehouse/tty.tgz&quot;</span>
       <span class="k">fi</span>

<span class="k">       for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">           </span>upload_image <span class="nv">$image_url</span> <span class="nv">$TOKEN</span>
       <span class="k">done</span>
<span class="k">    fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If we are running nova with baremetal driver, there are a few
last-mile configuration bits to attend to, which must happen
after n-api and n-sch have started.
Also, creating the baremetal flavor must happen after images
are loaded into glance, though just knowing the IDs is sufficient here</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled nova <span class="o">&amp;&amp;</span> is_baremetal; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>create special flavor for baremetal if we know what images to associate</p>
</td><td class=code><div class=highlight><pre>
    <span class="o">[[</span> -n <span class="s2">&quot;$BM_DEPLOY_KERNEL_ID&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$BM_DEPLOY_RAMDISK_ID&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
       create_baremetal_flavor <span class="nv">$BM_DEPLOY_KERNEL_ID</span> <span class="nv">$BM_DEPLOY_RAMDISK_ID</span>

</pre></div></td></tr><tr><td class=docs>
<p>otherwise user can manually add it later by calling nova-baremetal-manage
otherwise user can manually add it later by calling nova-baremetal-manage</p>
</td><td class=code><div class=highlight><pre>
    <span class="o">[[</span> -n <span class="s2">&quot;$BM_FIRST_MAC&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> add_baremetal_node

</pre></div></td></tr><tr><td class=docs>
<p>NOTE: we do this here to ensure that our copy of dnsmasq is running</p>
</td><td class=code><div class=highlight><pre>
    sudo pkill dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo dnsmasq --conf-file<span class="o">=</span> --port<span class="o">=</span>0 --enable-tftp --tftp-root<span class="o">=</span>/tftpboot <span class="se">\</span>
        --dhcp-boot<span class="o">=</span>pxelinux.0 --bind-interfaces --pid-file<span class="o">=</span>/var/run/dnsmasq.pid <span class="se">\</span>
        --interface<span class="o">=</span><span class="nv">$BM_DNSMASQ_IFACE</span> --dhcp-range<span class="o">=</span><span class="nv">$BM_DNSMASQ_RANGE</span>

</pre></div></td></tr><tr><td class=docs>
<p>ensure callback daemon is running</p>
</td><td class=code><div class=highlight><pre>
    sudo pkill nova-baremetal-deploy-helper <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>screen_it baremetal <span class="s2">&quot;nova-baremetal-deploy-helper&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Save some values we generated for later use</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CURRENT_RUN_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">&quot;# $CURRENT_RUN_TIME&quot;</span> &gt;<span class="nv">$TOP_DIR</span>/.stackenv
<span class="k">for </span>i in BASE_SQL_CONN ENABLED_SERVICES HOST_IP LOGFILE <span class="se">\</span>
  SERVICE_HOST SERVICE_PROTOCOL STACK_USER TLS_IP; <span class="k">do</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$i</span><span class="o">=</span><span class="k">${</span><span class="p">!i</span><span class="k">}</span> &gt;&gt;<span class="nv">$TOP_DIR</span>/.stackenv
<span class="k">done</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="run-extras">
<h1>Run extras</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$TOP_DIR</span>/extras.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>i in <span class="nv">$TOP_DIR</span>/extras.d/*.sh; <span class="k">do</span>
        <span class="o">[[</span> -r <span class="nv">$i</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span> stack
    <span class="k">done</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="run-local-script">
<h1>Run local script</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Run <tt class="docutils literal">local.sh</tt> if it exists to perform user-managed tasks</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -x <span class="nv">$TOP_DIR</span>/local.sh <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Running user script $TOP_DIR/local.sh&quot;</span>
    <span class="nv">$TOP_DIR</span>/local.sh
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check the status of running services</p>
</td><td class=code><div class=highlight><pre>
service_check

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="fin">
<h1>Fin</h1>
</td><td class=code><div class=highlight><pre>

<span class="nb">set</span> +o xtrace

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">exec </span>1&gt;&amp;3
</pre></div></td></tr><tr><td class=docs>
<p>Force all output to stdout and logs now</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee -a <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Force all output to stdout now</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt;&amp;3
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="using-the-cloud">
<h2>Using the cloud</h2>
</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you installed Horizon on this server you should be able
to access the site using your browser.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Horizon is now available at http://$SERVICE_HOST/&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Warn that the default flavors have been changed by Heat</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Heat has replaced the default flavors. View by running: nova flavor-list&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If Keystone is present you can point <tt class="docutils literal">nova</tt> cli to this server</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Keystone is serving at $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_SERVICE_PORT/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo <tt class="docutils literal">HOST_IP</tt> - useful for <tt class="docutils literal">build_uec.sh</tt>, which uses dhcp to give the instance an address</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;This is your host ip: $HOST_IP&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Warn that <tt class="docutils literal">EXTRA_FLAGS</tt> needs to be converted to <tt class="docutils literal">EXTRA_OPTS</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;WARNING: EXTRA_FLAGS is defined and may need to be converted to EXTRA_OPTS&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Indicate how long this took to run (bash maintained variable <tt class="docutils literal">SECONDS</tt>)</p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;stack.sh completed in $SECONDS seconds.&quot;</span>


</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
