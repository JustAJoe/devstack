<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/functions

</td><td class=code><div class=highlight><pre>
GetDistro


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> ! -r <span class="nv">$TOP_DIR</span>/stackrc <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing $TOP_DIR/stackrc - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/stackrc

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$http_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$https_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$no_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
disable_negated_services

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">DISTRO</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">(</span>oneiric|precise|quantal|f16|f17<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has not been tested on $DISTRO&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${DISTRO}&quot;</span> <span class="o">=</span> <span class="s2">&quot;oneiric&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> is_service_enabled qpid ; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;You must use Ubuntu Precise or newer for Qpid support.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVA_ROOTWRAP</span><span class="o">=</span>/usr/local/bin/nova-rootwrap
<span class="k">else</span>
<span class="k">    </span><span class="nv">NOVA_ROOTWRAP</span><span class="o">=</span>/usr/bin/nova-rootwrap
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$TOP_DIR</span>/lib <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/lib - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: missing devstack/files - did you grab more than just stack.sh?&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span><span class="nb">type</span> -p screen &gt;/dev/null <span class="o">&amp;&amp;</span> screen -ls | egrep -q <span class="s2">&quot;[0-9].stack&quot;</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are already running a stack.sh session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To rejoin this session type &#39;screen -x stack&#39;.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To destroy this session, kill the running screen.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled cinder <span class="o">&amp;&amp;</span> is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;ERROR: n-vol and cinder must not be enabled at the same time&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">ROOTSLEEP</span><span class="o">=</span><span class="k">${</span><span class="nv">ROOTSLEEP</span><span class="k">:-</span><span class="nv">10</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;In $ROOTSLEEP seconds, we will create a user &#39;stack&#39; and run as that user&quot;</span>
    sleep <span class="nv">$ROOTSLEEP</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>dpkg -l sudo <span class="o">||</span> apt_get update <span class="o">&amp;&amp;</span> install_package sudo
    <span class="k">else</span>
<span class="k">        </span>rpm -qa | grep sudo <span class="o">||</span> install_package sudo
    <span class="k">fi</span>
<span class="k">    if</span> ! getent group stack &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a group called stack&quot;</span>
        groupadd stack
    <span class="k">fi</span>
<span class="k">    if</span> ! getent passwd stack &gt;/dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Creating a user called stack&quot;</span>
        useradd -g stack -s /bin/bash -d <span class="nv">$DEST</span> -m stack
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Giving stack user passwordless sudo priviledges&quot;</span>
</td><td class=code><div class=highlight><pre>
    grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> &gt;&gt; /etc/sudoers
    <span class="o">(</span> <span class="nb">umask </span>226 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="se">\</span>
        &gt; /etc/sudoers.d/50_stack_sh <span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&quot;Copying files to stack user&quot;</span>
    <span class="nv">STACK_DIR</span><span class="o">=</span><span class="s2">&quot;$DEST/${PWD##*/}&quot;</span>
    cp -r -f -T <span class="s2">&quot;$PWD&quot;</span> <span class="s2">&quot;$STACK_DIR&quot;</span>
    chown -R stack <span class="s2">&quot;$STACK_DIR&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SHELL_AFTER_RUN&quot;</span> !<span class="o">=</span> <span class="s2">&quot;no&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh; bash&quot;</span> stack
    <span class="k">else</span>
<span class="k">        </span><span class="nb">exec </span>su -c <span class="s2">&quot;set -e; cd $STACK_DIR; bash stack.sh&quot;</span> stack
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>1
<span class="k">else</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">CHECK_SUDO_CMD</span><span class="o">=</span><span class="s2">&quot;dpkg -l sudo&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">CHECK_SUDO_CMD</span><span class="o">=</span><span class="s2">&quot;rpm -q sudo&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$CHECK_SUDO_CMD</span> <span class="o">||</span> die <span class="s2">&quot;Sudo is required.  Re-run stack.sh as root ONE TIME ONLY to set up sudo.&quot;</span>

</td><td class=code><div class=highlight><pre>
    sudo grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
        <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> | sudo tee -a /etc/sudoers

</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;`whoami` ALL=(root) NOPASSWD:ALL&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;Defaults:`whoami` secure_path=/sbin:/usr/sbin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin&quot;</span> &gt;&gt; <span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/50_stack_sh

</td><td class=code><div class=highlight><pre>
    sudo rm -f /etc/sudoers.d/stack_sh_nova
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
sudo mkdir -p <span class="nv">$DEST</span>
<span class="k">if</span> <span class="o">[</span> ! -w <span class="nv">$DEST</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DEST</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">OFFLINE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$OFFLINE</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">ERROR_ON_CLONE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$ERROR_ON_CLONE</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/data</span><span class="k">}</span>
sudo mkdir -p <span class="nv">$DATA_DIR</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$DATA_DIR</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/cinder

</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/nova
<span class="nv">HORIZON_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/horizon
<span class="nv">GLANCE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance
<span class="nv">GLANCECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-glanceclient
<span class="nv">KEYSTONE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/keystone
<span class="nv">NOVACLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-novaclient
<span class="nv">KEYSTONECLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-keystoneclient
<span class="nv">OPENSTACKCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-openstackclient
<span class="nv">NOVNC_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/noVNC
<span class="nv">SWIFT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift
<span class="nv">SWIFT3_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/swift3
<span class="nv">SWIFTCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-swiftclient
<span class="nv">QUANTUM_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/quantum
<span class="nv">QUANTUM_CLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-quantumclient

</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PLUGIN</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PLUGIN</span><span class="k">:-</span><span class="nv">openvswitch</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT</span><span class="k">:-</span><span class="nv">9696</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ADMIN_USERNAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ADMIN_USERNAME</span><span class="k">:-</span><span class="nv">quantum</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_AUTH_STRATEGY</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_AUTH_STRATEGY</span><span class="k">:-</span><span class="nv">keystone</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>
<span class="nv">VOLUME_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_GROUP</span><span class="k">:-</span><span class="nv">stack</span><span class="p">-volumes</span><span class="k">}</span>
<span class="nv">VOLUME_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_NAME_PREFIX</span><span class="k">:-</span><span class="nv">volume</span><span class="p">-</span><span class="k">}</span>
<span class="nv">INSTANCE_NAME_PREFIX</span><span class="o">=</span><span class="k">${</span><span class="nv">INSTANCE_NAME_PREFIX</span><span class="k">:-</span><span class="nv">instance</span><span class="p">-</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SCHEDULER</span><span class="o">=</span><span class="k">${</span><span class="nv">SCHEDULER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.scheduler.filter_scheduler.FilterScheduler</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.224/28</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">HOST_IP_IFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">:-$(</span>ip route | sed -n <span class="s1">&#39;/^default/{ s/.*dev \(\w\+\)\s\+.*/\1/; p; }&#39;</span><span class="k">)}</span>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$HOST_IP&quot;</span> -o <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">HOST_IPS</span><span class="o">=</span><span class="sb">`</span><span class="nv">LC_ALL</span><span class="o">=</span>C ip -f inet addr show <span class="k">${</span><span class="nv">HOST_IP_IFACE</span><span class="k">}</span> | awk <span class="s1">&#39;/inet/ {split($2,parts,&quot;/&quot;);  print parts[1]}&#39;</span><span class="sb">`</span>
    <span class="k">for </span>IP in <span class="nv">$HOST_IPS</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! <span class="o">(</span>address_in_net <span class="nv">$IP</span> <span class="nv">$FIXED_RANGE</span> <span class="o">||</span> address_in_net <span class="nv">$IP</span> <span class="nv">$FLOATING_RANGE</span><span class="o">)</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">HOST_IP</span><span class="o">=</span><span class="nv">$IP</span>
            <span class="nb">break</span>;
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Could not determine host ip address.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Either localrc specified dhcp on ${HOST_IP_IFACE} or defaulted&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SYSLOG</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$SYSLOG</span><span class="sb">`</span>
<span class="nv">SYSLOG_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SYSLOG_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_PORT</span><span class="k">:-</span><span class="nv">516</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">LOG_COLOR</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$LOG_COLOR</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TIMEOUT</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TIMEOUT</span><span class="k">:-</span><span class="nv">60</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>read_password <span class="o">{</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>; <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>

    <span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/localrc

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$localrc</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>touch <span class="nv">$localrc</span>
        <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="nv">$msg</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This value will be written to your localrc file so you don&#39;t have to enter it &quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;again.  Use only alphanumeric characters.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;If you leave this blank, a random default value will be used.&quot;</span>
        <span class="nv">pw</span><span class="o">=</span><span class="s2">&quot; &quot;</span>
        <span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Enter a password now:&quot;</span>
            <span class="nb">read</span> -e <span class="nv">$var</span>
            <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>
            <span class="o">[[</span> <span class="s2">&quot;$pw&quot;</span> <span class="o">=</span> <span class="s2">&quot;`echo $pw | tr -cd [:alnum:]`&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">            echo</span> <span class="s2">&quot;Invalid chars in password.  Try again:&quot;</span>
        <span class="k">done</span>
<span class="k">        if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">pw</span><span class="o">=</span><span class="sb">`</span>openssl rand -hex 10<span class="sb">`</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">eval</span> <span class="s2">&quot;$var=$pw&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;$var=$pw&quot;</span> &gt;&gt; <span class="nv">$localrc</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">set</span> -o xtrace
<span class="o">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>eth3
</td><td class=code><div class=highlight><pre>
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span><span class="k">$(</span>grep -o <span class="s1">&#39;flat_network_bridge=[[:alnum:]]*&#39;</span> /proc/cmdline | cut -d<span class="o">=</span> -f 2 | sort -u<span class="k">)</span>
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth1
<span class="k">else</span>
<span class="k">    </span><span class="nv">PUBLIC_INTERFACE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="o">=</span>br100
    <span class="nv">GUEST_INTERFACE_DEFAULT</span><span class="o">=</span>eth0
<span class="k">fi</span>

<span class="nv">PUBLIC_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_INTERFACE</span><span class="k">:-</span><span class="nv">$PUBLIC_INTERFACE_DEFAULT</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>
<span class="nv">NETWORK_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK_GATEWAY</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.1</span><span class="k">}</span>
<span class="nv">NET_MAN</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_MAN</span><span class="k">:-</span><span class="nv">FlatDHCPManager</span><span class="k">}</span>
<span class="nv">EC2_DMZ_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">EC2_DMZ_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">FLAT_NETWORK_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_NETWORK_BRIDGE</span><span class="k">:-</span><span class="nv">$FLAT_NETWORK_BRIDGE_DEFAULT</span><span class="k">}</span>
<span class="nv">VLAN_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">VLAN_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TEST_FLOATING_POOL</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_POOL</span><span class="k">:-</span><span class="nv">test</span><span class="k">}</span>
<span class="nv">TEST_FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TEST_FLOATING_RANGE</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.253.0/29</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">MULTI_HOST</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$MULTI_HOST</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">FLAT_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLAT_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>

<span class="c">## FIXME(ja): should/can we check that FLAT_INTERFACE is sane?</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">MYSQL_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
<span class="nv">MYSQL_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">MYSQL_USER</span><span class="k">:-</span><span class="nv">root</span><span class="k">}</span>
read_password MYSQL_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR MYSQL.&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_SQL_CONN</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_SQL_CONN</span><span class="k">:-</span><span class="nv">mysql</span><span class="p">://</span><span class="nv">$MYSQL_USER</span><span class="p">:</span><span class="nv">$MYSQL_PASSWORD</span><span class="p">@</span><span class="nv">$MYSQL_HOST</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
<span class="k">    </span><span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">localhost</span><span class="k">}</span>
    read_password RABBIT_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR RABBIT.&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">GLANCE_HOSTPORT</span><span class="o">=</span><span class="k">${</span><span class="nv">GLANCE_HOSTPORT</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="p">:</span><span class="nv">9292</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/data/swift</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_CONFIG_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">:-</span><span class="p">/etc/swift</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">:-</span><span class="nv">1000000</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">:-</span><span class="nv">9</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SWIFT_REPLICAS</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">:-</span><span class="nv">3</span><span class="k">}</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift3;then
        <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    read_password SWIFT_HASH <span class="s2">&quot;ENTER A RANDOM SWIFT HASH.&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">S3_SERVICE_PORT</span><span class="k">:-</span><span class="nv">3333</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
read_password SERVICE_TOKEN <span class="s2">&quot;ENTER A SERVICE_TOKEN TO USE FOR THE SERVICE ADMIN TOKEN.&quot;</span>
</td><td class=code><div class=highlight><pre>
read_password SERVICE_PASSWORD <span class="s2">&quot;ENTER A SERVICE_PASSWORD TO USE FOR THE SERVICE AUTHENTICATION.&quot;</span>
</td><td class=code><div class=highlight><pre>
read_password ADMIN_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR HORIZON AND KEYSTONE (20 CHARS OR LESS).&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_TENANT_NAME</span><span class="k">:-</span><span class="nv">service</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">KEYSTONE_API_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_API_PORT</span><span class="k">:-</span><span class="nv">5000</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_PORT</span><span class="k">:-</span><span class="nv">35357</span><span class="k">}</span>
<span class="nv">KEYSTONE_AUTH_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_AUTH_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_PORT</span><span class="k">:-</span><span class="nv">5000</span><span class="k">}</span>
<span class="nv">KEYSTONE_SERVICE_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_SERVICE_PROTOCOL</span><span class="k">:-</span><span class="nv">http</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">APACHE_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_USER</span><span class="k">:-</span><span class="nv">$USER</span><span class="k">}</span>
<span class="nv">APACHE_GROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">APACHE_GROUP</span><span class="k">:-</span><span class="nv">$APACHE_USER</span><span class="k">}</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LOGDAYS</span><span class="o">=</span><span class="k">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="k">}</span>
    <span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="k">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="k">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    <span class="nv">LOGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    mkdir -p <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth 1 -name <span class="nv">$LOGNAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>

    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
    <span class="nb">echo</span> <span class="s2">&quot;stack.sh log $LOGFILE&quot;</span>
</td><td class=code><div class=highlight><pre>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth 1 -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
<span class="k">        </span>mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>failed ERR
failed<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="o">[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed: full log in $LOGFILE&quot;</span>
    <span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>apt_get update
    install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/apts<span class="k">)</span>
<span class="k">else</span>
<span class="k">    </span>install_package <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/rpms<span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>install_package rsyslog-relp
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">tfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
    install_package rabbitmq-server &gt; <span class="s2">&quot;$tfile&quot;</span> 2&gt;&amp;1
    cat <span class="s2">&quot;$tfile&quot;</span>
    rm -f <span class="s2">&quot;$tfile&quot;</span>
<span class="k">elif </span>is_service_enabled qpid; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>install_package qpid-cpp-server
    <span class="k">else</span>
<span class="k">        </span>install_package qpidd
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;MYSQL_PRESEED | sudo debconf-set-selections</span>
<span class="s">mysql-server-5.1 mysql-server/root_password password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/root_password_again password $MYSQL_PASSWORD</span>
<span class="s">mysql-server-5.1 mysql-server/start_on_boot boolean true</span>
<span class="s">MYSQL_PRESEED</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$HOME</span>/.my.cnf <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>cat <span class="s">&lt;&lt;EOF &gt;$HOME/.my.cnf</span>
<span class="s">[client]</span>
<span class="s">user=$MYSQL_USER</span>
<span class="s">password=$MYSQL_PASSWORD</span>
<span class="s">host=$MYSQL_HOST</span>
<span class="s">EOF</span>
        chmod 0600 <span class="nv">$HOME</span>/.my.cnf
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    install_package mysql-server
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        install_package python-configobj
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        install_package apache2 libapache2-mod-wsgi
    <span class="k">else</span>
<span class="k">        </span>sudo rm -f /etc/httpd/conf.d/000-*
        install_package httpd mod_wsgi
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">kernel_version</span><span class="o">=</span><span class="sb">`</span>cat /proc/version | cut -d <span class="s2">&quot; &quot;</span> -f3<span class="sb">`</span>
            install_package make fakeroot dkms openvswitch-switch openvswitch-datapath-dkms linux-headers-<span class="nv">$kernel_version</span>
        <span class="k">else</span>
            <span class="c">### FIXME(dtroyer): Find RPMs for OpenVSwitch</span>
            <span class="nb">echo</span> <span class="s2">&quot;OpenVSwitch packages need to be located&quot;</span>
        <span class="k">fi</span>
<span class="k">    elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">       </span>install_package bridge-utils
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">LIBVIRT_PKG_NAME</span><span class="o">=</span>libvirt-bin
    <span class="k">else</span>
<span class="k">        </span><span class="nv">LIBVIRT_PKG_NAME</span><span class="o">=</span>libvirt
    <span class="k">fi</span>
<span class="k">    </span>install_package <span class="nv">$LIBVIRT_PKG_NAME</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>install_package cgroup-lite
            <span class="k">fi</span>
<span class="k">        else</span>
            <span class="c">### FIXME(dtroyer): figure this out</span>
            <span class="nb">echo</span> <span class="s2">&quot;RPM-based cgroup not implemented yet&quot;</span>
            yum_install libcgroup-tools
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    install_package memcached
<span class="k">fi</span>

<span class="nv">TRACK_DEPENDS</span><span class="o">=</span><span class="k">${</span><span class="nv">TRACK_DEPENDS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
<span class="k">    </span>install_package python-virtualenv

    rm -rf <span class="nv">$DEST</span>/.venv
    virtualenv --system-site-packages <span class="nv">$DEST</span>/.venv
    <span class="nb">source</span> <span class="nv">$DEST</span>/.venv/bin/activate
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-pre-pip
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
pip_install <span class="k">$(</span>get_packages <span class="nv">$FILES</span>/pips | sort -u<span class="k">)</span>

</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$NOVA_DIR</span> <span class="nv">$NOVA_BRANCH</span>

</td><td class=code><div class=highlight><pre>
git_clone <span class="nv">$KEYSTONECLIENT_REPO</span> <span class="nv">$KEYSTONECLIENT_DIR</span> <span class="nv">$KEYSTONECLIENT_BRANCH</span>
git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$NOVACLIENT_DIR</span> <span class="nv">$NOVACLIENT_BRANCH</span>
git_clone <span class="nv">$OPENSTACKCLIENT_REPO</span> <span class="nv">$OPENSTACKCLIENT_DIR</span> <span class="nv">$OPENSTACKCLIENT_BRANCH</span>
git_clone <span class="nv">$GLANCECLIENT_REPO</span> <span class="nv">$GLANCECLIENT_DIR</span> <span class="nv">$GLANCECLIENT_BRANCH</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$KEYSTONE_REPO</span> <span class="nv">$KEYSTONE_DIR</span> <span class="nv">$KEYSTONE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SWIFT_REPO</span> <span class="nv">$SWIFT_DIR</span> <span class="nv">$SWIFT_BRANCH</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$SWIFTCLIENT_REPO</span> <span class="nv">$SWIFTCLIENT_DIR</span> <span class="nv">$SWIFTCLIENT_BRANCH</span>
    <span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        git_clone <span class="nv">$SWIFT3_REPO</span> <span class="nv">$SWIFT3_DIR</span> <span class="nv">$SWIFT3_BRANCH</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$GLANCE_REPO</span> <span class="nv">$GLANCE_DIR</span> <span class="nv">$GLANCE_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-novnc; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$NOVNC_DIR</span> <span class="nv">$NOVNC_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$HORIZON_REPO</span> <span class="nv">$HORIZON_DIR</span> <span class="nv">$HORIZON_BRANCH</span> <span class="nv">$HORIZON_TAG</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>git_clone <span class="nv">$QUANTUM_CLIENT_REPO</span> <span class="nv">$QUANTUM_CLIENT_DIR</span> <span class="nv">$QUANTUM_CLIENT_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    git_clone <span class="nv">$QUANTUM_REPO</span> <span class="nv">$QUANTUM_DIR</span> <span class="nv">$QUANTUM_BRANCH</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>install_cinder
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
setup_develop <span class="nv">$KEYSTONECLIENT_DIR</span>
setup_develop <span class="nv">$NOVACLIENT_DIR</span>
setup_develop <span class="nv">$OPENSTACKCLIENT_DIR</span>
<span class="k">if </span>is_service_enabled key g-api n-api swift; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$KEYSTONE_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$SWIFT_DIR</span>
    setup_develop <span class="nv">$SWIFTCLIENT_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$SWIFT3_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$GLANCE_DIR</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
setup_develop <span class="nv">$GLANCECLIENT_DIR</span>

setup_develop <span class="nv">$NOVA_DIR</span>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$HORIZON_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>setup_develop <span class="nv">$QUANTUM_CLIENT_DIR</span>
    setup_develop <span class="nv">$QUANTUM_DIR</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>configure_cinder
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span> ; <span class="k">then</span>
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-post-pip
    <span class="k">if</span> ! diff -Nru <span class="nv">$DEST</span>/requires-pre-pip <span class="nv">$DEST</span>/requires-post-pip &gt; <span class="nv">$DEST</span>/requires.diff ; <span class="k">then</span>
<span class="k">        </span>cat <span class="nv">$DEST</span>/requires.diff
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Ran stack.sh in depend tracking mode, bailing out now&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$SYSLOG_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-m.conf</span>
<span class="s">\$ModLoad imrelp</span>
<span class="s">\$InputRELPServerRun $SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-m.conf /etc/rsyslog.d
    <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-s.conf</span>
<span class="s">*.*		:omrelp:$SYSLOG_HOST:$SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-s.conf /etc/rsyslog.d
    <span class="k">fi</span>
<span class="k">    </span>restart_service rsyslog
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        restart_service rabbitmq-server
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    sudo rabbitmqctl change_password guest <span class="nv">$RABBIT_PASSWORD</span>
<span class="k">elif </span>is_service_enabled qpid; <span class="k">then</span>
<span class="k">    </span>restart_service qpidd
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>


<span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>

    <span class="c">#start mysql-server</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        start_service mysqld
</td><td class=code><div class=highlight><pre>
        sudo mysqladmin -u root password <span class="nv">$MYSQL_PASSWORD</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    sudo mysql -uroot -p<span class="nv">$MYSQL_PASSWORD</span> -h127.0.0.1 -e <span class="s2">&quot;GRANT ALL PRIVILEGES ON *.* TO &#39;$MYSQL_USER&#39;@&#39;%&#39; identified by &#39;$MYSQL_PASSWORD&#39;;&quot;</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">MY_CONF</span><span class="o">=</span>/etc/mysql/my.cnf
        <span class="nv">MYSQL</span><span class="o">=</span>mysql
    <span class="k">else</span>
<span class="k">        </span><span class="nv">MY_CONF</span><span class="o">=</span>/etc/my.cnf
        <span class="nv">MYSQL</span><span class="o">=</span>mysqld
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    sudo sed -i <span class="s1">&#39;/^bind-address/s/127.0.0.1/0.0.0.0/g&#39;</span> <span class="nv">$MY_CONF</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>sudo grep -q <span class="s2">&quot;default-storage-engine&quot;</span> <span class="nv">$MY_CONF</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        sudo bash -c <span class="s2">&quot;source $TOP_DIR/functions; iniset $MY_CONF mysqld default-storage-engine InnoDB&quot;</span>
    <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
        sudo sed -i -e <span class="s2">&quot;/^\[mysqld\]/ a \</span>
<span class="s2">default-storage-engine = InnoDB&quot;</span> <span class="nv">$MY_CONF</span>
    <span class="k">fi</span>

<span class="k">    </span>restart_service <span class="nv">$MYSQL</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">SCREEN_HARDSTATUS</span><span class="o">=</span><span class="s1">&#39;%{= .} %-Lw%{= .}%&gt; %n%f %t*%{= .}%+Lw%&lt; %-=%{g}(%{d}%H/%l%{g})&#39;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_rc <span class="o">{</span>
    <span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/stack-screenrc
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;sessionname stack&quot;</span> &gt; <span class="nv">$SCREENRC</span>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;hardstatus alwayslastline &#39;$SCREEN_HARDSTATUS&#39;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t stack bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! grep <span class="nv">$1</span> <span class="nv">$SCREENRC</span> 2&gt;&amp;1 &gt; /dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t $1 bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;stuff \&quot;$2$NL\&quot;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_it <span class="o">{</span>
    <span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
    <span class="k">if </span>is_service_enabled <span class="nv">$1</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        screen_rc <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span>

        screen -S stack -X screen -t <span class="nv">$1</span>
</td><td class=code><div class=highlight><pre>
        sleep 1.5

        <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen -S stack -p <span class="nv">$1</span> -X logfile <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log
            screen -S stack -p <span class="nv">$1</span> -X log on
            ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.log
        <span class="k">fi</span>
<span class="k">        </span>screen -S stack -p <span class="nv">$1</span> -X stuff <span class="s2">&quot;$2$NL&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
screen -d -m -S stack -t stack -s /bin/bash
sleep 1
</td><td class=code><div class=highlight><pre>
screen -r stack -X hardstatus alwayslastline <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/dashboard_openstack.sqlite3

</td><td class=code><div class=highlight><pre>
    <span class="nv">local_settings</span><span class="o">=</span><span class="nv">$HORIZON_DIR</span>/openstack_dashboard/local/local_settings.py
    cp <span class="nv">$FILES</span>/horizon_settings.py <span class="nv">$local_settings</span>

</td><td class=code><div class=highlight><pre>
    <span class="nb">cd</span> <span class="nv">$HORIZON_DIR</span>
    python manage.py syncdb --noinput
    <span class="nb">cd</span> <span class="nv">$TOP_DIR</span>

</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$HORIZON_DIR</span>/.blackhole

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">APACHE_NAME</span><span class="o">=</span>apache2
        <span class="nv">APACHE_CONF</span><span class="o">=</span>sites-available/horizon
</td><td class=code><div class=highlight><pre>
        sudo rm -f /etc/apache2/sites-enabled/000-default
</td><td class=code><div class=highlight><pre>
        sudo touch /etc/<span class="nv">$APACHE_NAME</span>/<span class="nv">$APACHE_CONF</span>
        sudo a2ensite horizon
    <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
        <span class="nv">APACHE_NAME</span><span class="o">=</span>httpd
        <span class="nv">APACHE_CONF</span><span class="o">=</span>conf.d/horizon.conf
        sudo sed <span class="s1">&#39;/^Listen/s/^.*$/Listen 0.0.0.0:80/&#39;</span> -i /etc/httpd/conf/httpd.conf
    <span class="k">fi</span>
    <span class="c">## Configure apache to run horizon</span>
    sudo sh -c <span class="s2">&quot;sed -e \&quot;</span>
<span class="s2">        s,%USER%,$APACHE_USER,g;</span>
<span class="s2">        s,%GROUP%,$APACHE_GROUP,g;</span>
<span class="s2">        s,%HORIZON_DIR%,$HORIZON_DIR,g;</span>
<span class="s2">        s,%APACHE_NAME%,$APACHE_NAME,g;</span>
<span class="s2">        s,%DEST%,$DEST,g;</span>
<span class="s2">    \&quot; $FILES/apache-horizon.template &gt;/etc/$APACHE_NAME/$APACHE_CONF&quot;</span>
    restart_service <span class="nv">$APACHE_NAME</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span><span class="nv">GLANCE_CONF_DIR</span><span class="o">=</span>/etc/glance
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$GLANCE_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$GLANCE_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$GLANCE_CONF_DIR</span>
    <span class="nv">GLANCE_IMAGE_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/glance/images
</td><td class=code><div class=highlight><pre>
    rm -rf <span class="nv">$GLANCE_IMAGE_DIR</span>

</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$GLANCE_IMAGE_DIR</span>

</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS glance;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE glance CHARACTER SET utf8;&#39;</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">GLANCE_REGISTRY_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-registry.conf
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-registry.conf <span class="nv">$GLANCE_REGISTRY_CONF</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT debug True
    inicomment <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT log_file
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT sql_connection <span class="nv">$BASE_SQL_CONN</span>/glance?charset<span class="o">=</span>utf8
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> DEFAULT use_syslog <span class="nv">$SYSLOG</span>
    iniset <span class="nv">$GLANCE_REGISTRY_CONF</span> paste_deploy flavor keystone

    <span class="nv">GLANCE_REGISTRY_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-registry-paste.ini
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-registry-paste.ini <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span>
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken auth_uri <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken admin_user glance
    iniset <span class="nv">$GLANCE_REGISTRY_PASTE_INI</span> filter:authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

    <span class="nv">GLANCE_API_CONF</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-api.conf
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-api.conf <span class="nv">$GLANCE_API_CONF</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT debug True
    inicomment <span class="nv">$GLANCE_API_CONF</span> DEFAULT log_file
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT sql_connection <span class="nv">$BASE_SQL_CONN</span>/glance?charset<span class="o">=</span>utf8
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT use_syslog <span class="nv">$SYSLOG</span>
    iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT filesystem_store_datadir <span class="nv">$GLANCE_IMAGE_DIR</span>/
    iniset <span class="nv">$GLANCE_API_CONF</span> paste_deploy flavor keystone

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT default_store swift
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_auth_address <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/v2.0/
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_user <span class="nv">$SERVICE_TENANT_NAME</span>:glance
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_key <span class="nv">$SERVICE_PASSWORD</span>
        iniset <span class="nv">$GLANCE_API_CONF</span> DEFAULT swift_store_create_container_on_put True
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">GLANCE_API_PASTE_INI</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/glance-api-paste.ini
    cp <span class="nv">$GLANCE_DIR</span>/etc/glance-api-paste.ini <span class="nv">$GLANCE_API_PASTE_INI</span>
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken auth_host <span class="nv">$KEYSTONE_AUTH_HOST</span>
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken auth_protocol <span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken auth_uri <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>://<span class="nv">$KEYSTONE_SERVICE_HOST</span>:<span class="nv">$KEYSTONE_SERVICE_PORT</span>/
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken admin_user glance
    iniset <span class="nv">$GLANCE_API_PASTE_INI</span> filter:authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

    <span class="nv">GLANCE_POLICY_JSON</span><span class="o">=</span><span class="nv">$GLANCE_CONF_DIR</span>/policy.json
    cp <span class="nv">$GLANCE_DIR</span>/etc/policy.json <span class="nv">$GLANCE_POLICY_JSON</span>

    <span class="nv">$GLANCE_DIR</span>/bin/glance-manage db_sync

<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -d /etc/quantum <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p /etc/quantum
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> /etc/quantum

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_PLUGIN_CONF_PATH</span><span class="o">=</span>etc/quantum/plugins/openvswitch
        <span class="nv">Q_PLUGIN_CONF_FILENAME</span><span class="o">=</span>ovs_quantum_plugin.ini
        <span class="nv">Q_DB_NAME</span><span class="o">=</span><span class="s2">&quot;ovs_quantum&quot;</span>
        <span class="nv">Q_PLUGIN_CLASS</span><span class="o">=</span><span class="s2">&quot;quantum.plugins.openvswitch.ovs_quantum_plugin.OVSQuantumPluginV2&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_PLUGIN_CONF_PATH</span><span class="o">=</span>etc/quantum/plugins/linuxbridge
        <span class="nv">Q_PLUGIN_CONF_FILENAME</span><span class="o">=</span>linuxbridge_conf.ini
        <span class="nv">Q_DB_NAME</span><span class="o">=</span><span class="s2">&quot;quantum_linux_bridge&quot;</span>
        <span class="nv">Q_PLUGIN_CLASS</span><span class="o">=</span><span class="s2">&quot;quantum.plugins.linuxbridge.lb_quantum_plugin.LinuxBridgePluginV2&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Unknown Quantum plugin &#39;$Q_PLUGIN&#39;.. exiting&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    mkdir -p /<span class="nv">$Q_PLUGIN_CONF_PATH</span>
    <span class="nv">Q_PLUGIN_CONF_FILE</span><span class="o">=</span><span class="nv">$Q_PLUGIN_CONF_PATH</span>/<span class="nv">$Q_PLUGIN_CONF_FILENAME</span>
    cp <span class="nv">$QUANTUM_DIR</span>/<span class="nv">$Q_PLUGIN_CONF_FILE</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>

    sudo sed -i -e <span class="s2">&quot;s/^sql_connection =.*$/sql_connection = mysql:\/\/$MYSQL_USER:$MYSQL_PASSWORD@$MYSQL_HOST\/$Q_DB_NAME?charset=utf8/g&quot;</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>

    <span class="nv">OVS_ENABLE_TUNNELING</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_ENABLE_TUNNELING</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$OVS_ENABLE_TUNNELING</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">OVS_VERSION</span><span class="o">=</span><span class="sb">`</span>ovs-vsctl --version | head -n 1 | awk <span class="s1">&#39;{print $4;}&#39;</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$OVS_VERSION</span> <span class="se">\&lt;</span> <span class="s2">&quot;1.4&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> ! is_service_enabled q-svc ; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;You are running OVS version $OVS_VERSION.&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;OVS 1.4+ is required for tunneling between multiple hosts.&quot;</span>
            <span class="nb">exit </span>1
        <span class="k">fi</span>
<span class="k">        </span>sudo sed -i -e <span class="s2">&quot;s/.*enable_tunneling = .*$/enable_tunneling = $OVS_ENABLE_TUNNELING/g&quot;</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">Q_CONF_FILE</span><span class="o">=</span>/etc/quantum/quantum.conf
    cp <span class="nv">$QUANTUM_DIR</span>/etc/quantum.conf <span class="nv">$Q_CONF_FILE</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_API_PASTE_FILE</span><span class="o">=</span>/etc/quantum/api-paste.ini
    <span class="nv">Q_POLICY_FILE</span><span class="o">=</span>/etc/quantum/policy.json

    cp <span class="nv">$QUANTUM_DIR</span>/etc/api-paste.ini <span class="nv">$Q_API_PASTE_FILE</span>
    cp <span class="nv">$QUANTUM_DIR</span>/etc/policy.json <span class="nv">$Q_POLICY_FILE</span>

    <span class="k">if </span>is_service_enabled mysql; <span class="k">then</span>
<span class="k">            </span>mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s2">&quot;DROP DATABASE IF EXISTS $Q_DB_NAME;&quot;</span>
            mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s2">&quot;CREATE DATABASE IF NOT EXISTS $Q_DB_NAME CHARACTER SET utf8;&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;mysql must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
            <span class="nb">exit </span>1
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT core_plugin <span class="nv">$Q_PLUGIN_CLASS</span>

    iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT auth_strategy <span class="nv">$Q_AUTH_STRATEGY</span>
    iniset <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken auth_host <span class="nv">$KEYSTONE_SERVICE_HOST</span>
    iniset <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
    iniset <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken auth_protocol <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>
    iniset <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken admin_user <span class="nv">$Q_ADMIN_USERNAME</span>
    iniset <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        <span class="nv">OVS_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_BRIDGE</span><span class="k">:-</span><span class="nv">br</span><span class="p">-int</span><span class="k">}</span>
        <span class="k">for </span>PORT in <span class="sb">`</span>sudo ovs-vsctl --no-wait list-ports <span class="nv">$OVS_BRIDGE</span><span class="sb">`</span>; <span class="k">do</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="s2">&quot;$PORT&quot;</span> <span class="o">=</span>~ tap* <span class="o">]]</span>; <span class="k">then </span><span class="nb">echo</span> <span class="sb">`</span>sudo ip link delete <span class="nv">$PORT</span><span class="sb">`</span> &gt; /dev/null; <span class="k">fi</span>
<span class="k">            </span>sudo ovs-vsctl --no-wait del-port <span class="nv">$OVS_BRIDGE</span> <span class="nv">$PORT</span>
        <span class="k">done</span>
<span class="k">        </span>sudo ovs-vsctl --no-wait -- --if-exists del-br <span class="nv">$OVS_BRIDGE</span>
        sudo ovs-vsctl --no-wait add-br <span class="nv">$OVS_BRIDGE</span>
        sudo ovs-vsctl --no-wait br-set-external-id <span class="nv">$OVS_BRIDGE</span> bridge-id br-int
        sudo sed -i -e <span class="s2">&quot;s/.*local_ip = .*/local_ip = $HOST_IP/g&quot;</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>
        <span class="nv">AGENT_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/quantum/plugins/openvswitch/agent/ovs_quantum_agent.py&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
       <span class="nv">QUANTUM_LB_PRIVATE_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">QUANTUM_LB_PRIVATE_INTERFACE</span><span class="k">:-</span><span class="nv">$GUEST_INTERFACE_DEFAULT</span><span class="k">}</span>
       iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> LINUX_BRIDGE physical_interface_mappings default:<span class="nv">$QUANTUM_LB_PRIVATE_INTERFACE</span>
       <span class="nv">AGENT_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/quantum/plugins/linuxbridge/agent/linuxbridge_quantum_agent.py&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-dhcp; <span class="k">then</span>
<span class="k">    </span><span class="nv">AGENT_DHCP_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-dhcp-agent&quot;</span>

    <span class="nv">Q_DHCP_CONF_FILE</span><span class="o">=</span>/etc/quantum/dhcp_agent.ini

    cp <span class="nv">$QUANTUM_DIR</span>/etc/dhcp_agent.ini <span class="nv">$Q_DHCP_CONF_FILE</span>

</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT verbose True
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT debug True

</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT db_connection <span class="s2">&quot;mysql:\/\/$MYSQL_USER:$MYSQL_PASSWORD@$MYSQL_HOST\/$Q_DB_NAME?charset=utf8&quot;</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT auth_url <span class="s2">&quot;$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_AUTH_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT admin_user <span class="nv">$Q_ADMIN_USERNAME</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT admin_password <span class="nv">$SERVICE_PASSWORD</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT interface_driver quantum.agent.linux.interface.OVSInterfaceDriver
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT interface_driver quantum.agent.linux.interface.BridgeInterfaceDriver
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT control_exchange quantum
    <span class="k">if </span>is_service_enabled qpid ; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rpc_backend quantum.openstack.common.rpc.impl_qpid
    <span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_HOST&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>  <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_PASSWORD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rabbit_host <span class="nv">$RABBIT_HOST</span>
        iniset <span class="nv">$Q_CONF_FILE</span> DEFAULT rabbit_password <span class="nv">$RABBIT_PASSWORD</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
screen_it q-svc <span class="s2">&quot;cd $QUANTUM_DIR &amp;&amp; python $QUANTUM_DIR/bin/quantum-server --config-file $Q_CONF_FILE --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>

</td><td class=code><div class=highlight><pre>
screen_it q-agt <span class="s2">&quot;sudo python $AGENT_BINARY --config-file $Q_CONF_FILE --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>

</td><td class=code><div class=highlight><pre>
screen_it q-dhcp <span class="s2">&quot;sudo python $AGENT_DHCP_BINARY --config-file=$Q_DHCP_CONF_FILE&quot;</span>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_CONF_DIR</span><span class="o">=</span>/etc/nova
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$NOVA_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>sudo mkdir -p <span class="nv">$NOVA_CONF_DIR</span>
<span class="k">fi</span>
sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_CONF_DIR</span>

cp -p <span class="nv">$NOVA_DIR</span>/etc/nova/policy.json <span class="nv">$NOVA_CONF_DIR</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">ROOTWRAP_SUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$NOVA_ROOTWRAP&quot;</span>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.d <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo rm -rf <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -m 755 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    sudo cp <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.d/*.filters <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    sudo chown -R root:root <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d
    sudo chmod 644 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.d/*
</td><td class=code><div class=highlight><pre>
    sudo cp <span class="nv">$NOVA_DIR</span>/etc/nova/rootwrap.conf <span class="nv">$NOVA_CONF_DIR</span>/
    sudo sed -e <span class="s2">&quot;s:^filters_path=.*$:filters_path=$NOVA_CONF_DIR/rootwrap.d:&quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
    sudo chown root:root <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
    sudo chmod 0644 <span class="nv">$NOVA_CONF_DIR</span>/rootwrap.conf
</td><td class=code><div class=highlight><pre>
    <span class="nv">NOVA_ROOTWRAP</span><span class="o">=</span><span class="s2">&quot;$NOVA_ROOTWRAP $NOVA_CONF_DIR/rootwrap.conf&quot;</span>
    <span class="nv">ROOTWRAP_SUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$NOVA_ROOTWRAP *&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(root) NOPASSWD: $ROOTWRAP_SUDOER_CMD&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
chmod 0440 <span class="nv">$TEMPFILE</span>
sudo chown root:root <span class="nv">$TEMPFILE</span>
sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/nova-rootwrap

<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
    <span class="nv">API_RATE_LIMIT</span><span class="o">=</span><span class="k">${</span><span class="nv">API_RATE_LIMIT</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
    rm -f <span class="nv">$NOVA_DIR</span>/bin/nova-api-paste.ini

</td><td class=code><div class=highlight><pre>
    cp <span class="nv">$NOVA_DIR</span>/etc/nova/api-paste.ini <span class="nv">$NOVA_CONF_DIR</span>

</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        /^admin_token/i admin_tenant_name = $SERVICE_TENANT_NAME</span>
<span class="s2">        /admin_tenant_name/s/^.*$/admin_tenant_name = $SERVICE_TENANT_NAME/;</span>
<span class="s2">        /admin_user/s/^.*$/admin_user = nova/;</span>
<span class="s2">        /admin_password/s/^.*$/admin_password = $SERVICE_PASSWORD/;</span>
<span class="s2">        s,%SERVICE_TENANT_NAME%,$SERVICE_TENANT_NAME,g;</span>
<span class="s2">        s,%SERVICE_TOKEN%,$SERVICE_TOKEN,g;</span>
<span class="s2">    &quot;</span> -i <span class="nv">$NOVA_CONF_DIR</span>/api-paste.ini
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>clean_iptables<span class="o">()</span> <span class="o">{</span>
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-A&quot;</span> |  sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-A&quot;</span> | sed <span class="s2">&quot;s/-A/-D/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> | grep <span class="s2">&quot;\-N&quot;</span> |  sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables&quot;,$0}&#39;</span> | bash
</td><td class=code><div class=highlight><pre>
    sudo iptables -S -v -t nat | sed <span class="s2">&quot;s/-c [0-9]* [0-9]* //g&quot;</span> | grep <span class="s2">&quot;nova&quot;</span> |  grep <span class="s2">&quot;\-N&quot;</span> | sed <span class="s2">&quot;s/-N/-X/g&quot;</span> | awk <span class="s1">&#39;{print &quot;sudo iptables -t nat&quot;,$0}&#39;</span> | bash
<span class="o">}</span>

<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1

</td><td class=code><div class=highlight><pre>
    sudo modprobe nbd <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;kvm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo modprobe kvm <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span><span class="k">if</span> <span class="o">[</span> ! -e /dev/kvm <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: Switching to QEMU&quot;</span>
            <span class="nv">LIBVIRT_TYPE</span><span class="o">=</span>qemu
        <span class="k">fi</span>
<span class="k">    fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$LIBVIRT_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;lxc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="s2">&quot;$DISTRO&quot;</span> &gt; natty <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">cgline</span><span class="o">=</span><span class="s2">&quot;none /cgroup cgroup cpuacct,memory,devices,cpu,freezer,blkio 0 0&quot;</span>
                sudo mkdir -p /cgroup
                <span class="k">if</span> ! grep -q cgroup /etc/fstab; <span class="k">then</span>
<span class="k">                    </span><span class="nb">echo</span> <span class="s2">&quot;$cgline&quot;</span> | sudo tee -a /etc/fstab
                <span class="k">fi</span>
<span class="k">                if</span> ! mount -n | grep -q cgroup; <span class="k">then</span>
<span class="k">                    </span>sudo mount /cgroup
                <span class="k">fi</span>
<span class="k">            fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

<span class="k">    </span><span class="nv">QEMU_CONF</span><span class="o">=</span>/etc/libvirt/qemu.conf
    <span class="k">if </span>is_service_enabled quantum <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="nv">$Q_PLUGIN</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> ! sudo grep -q <span class="s1">&#39;^cgroup_device_acl&#39;</span> <span class="nv">$QEMU_CONF</span> ; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        sudo chmod 666 <span class="nv">$QEMU_CONF</span>
        sudo cat <span class="s">&lt;&lt;EOF &gt;&gt; /etc/libvirt/qemu.conf</span>
<span class="s">cgroup_device_acl = [</span>
<span class="s">    &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;,</span>
<span class="s">    &quot;/dev/random&quot;, &quot;/dev/urandom&quot;,</span>
<span class="s">    &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;,</span>
<span class="s">    &quot;/dev/rtc&quot;, &quot;/dev/hpet&quot;,&quot;/dev/net/tun&quot;,</span>
<span class="s">]</span>
<span class="s">EOF</span>
        sudo chmod 644 <span class="nv">$QEMU_CONF</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">LIBVIRT_DAEMON</span><span class="o">=</span>libvirt-bin
    <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! grep ^libvirtd: /etc/group &gt;/dev/null; <span class="k">then</span>
<span class="k">            </span>sudo groupadd libvirtd
        <span class="k">fi</span>
<span class="k">        </span>sudo bash -c <span class="s1">&#39;cat &lt;&lt;EOF &gt;/etc/polkit-1/localauthority/50-local.d/50-libvirt-remote-access.pkla</span>
<span class="s1">[libvirt Management Access]</span>
<span class="s1">Identity=unix-group:libvirtd</span>
<span class="s1">Action=org.libvirt.unix.manage</span>
<span class="s1">ResultAny=yes</span>
<span class="s1">ResultInactive=yes</span>
<span class="s1">ResultActive=yes</span>
<span class="s1">EOF&#39;</span>
        <span class="nv">LIBVIRT_DAEMON</span><span class="o">=</span>libvirtd
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    sudo usermod -a -G libvirtd <span class="sb">`</span>whoami<span class="sb">`</span>
</td><td class=code><div class=highlight><pre>
    restart_service <span class="nv">$LIBVIRT_DAEMON</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$NOVA_DIR</span>/instances

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -L /dev/disk/by-label/nova-instances <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> ! mount -n | grep -q <span class="nv">$NOVA_DIR</span>/instances; <span class="k">then</span>
<span class="k">            </span>sudo mount -L nova-instances <span class="nv">$NOVA_DIR</span>/instances
            sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$NOVA_DIR</span>/instances
        <span class="k">fi</span>
<span class="k">    fi</span>

</td><td class=code><div class=highlight><pre>
    clean_iptables

</td><td class=code><div class=highlight><pre>
    <span class="nv">instances</span><span class="o">=</span><span class="sb">`</span>sudo virsh list --all | grep <span class="nv">$INSTANCE_NAME_PREFIX</span> | sed <span class="s2">&quot;s/.*\($INSTANCE_NAME_PREFIX[0-9a-fA-F]*\).*/\1/g&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$instances&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh destroy <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        echo</span> <span class="nv">$instances</span> | xargs -n1 sudo virsh undefine <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | xargs sudo iscsiadm --mode node --logout <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>sudo iscsiadm --mode node | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | cut -d <span class="s2">&quot; &quot;</span> -f2 | sudo iscsiadm --mode node --op delete <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>
    sudo rm -rf <span class="nv">$NOVA_DIR</span>/instances/*
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled n-net q-dhcp; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>clean_iptables
    rm -rf <span class="nv">$NOVA_DIR</span>/networks
    mkdir -p <span class="nv">$NOVA_DIR</span>/networks

</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled swift; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
    swift-init all stop <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>

    <span class="nv">USER_GROUP</span><span class="o">=</span><span class="k">$(</span>id -g<span class="k">)</span>
    sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives
    sudo chown -R <span class="nv">$USER</span>:<span class="k">${</span><span class="nv">USER_GROUP</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if </span>egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">            </span>sudo umount <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
        <span class="k">fi</span>
<span class="k">    else</span>
<span class="k">        </span>mkdir -p  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images
        sudo touch  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img
        sudo chown <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img

        dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="se">\</span>
            <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>0 <span class="nv">seek</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_LOOPBACK_DISK_SIZE</span><span class="k">}</span>
    <span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
    mkfs.xfs -f -i <span class="nv">size</span><span class="o">=</span>1024  <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img

</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
    <span class="k">if</span> ! egrep -q <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1 /proc/mounts; <span class="k">then</span>
<span class="k">        </span>sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs<span class="o">=</span>8  <span class="se">\</span>
            <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/images/swift.img <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">        </span>sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1/<span class="nv">$x</span> <span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="nv">$x</span>; <span class="k">done</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">drive</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/drives/sdb1/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>
            <span class="nv">node</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">x</span><span class="k">}</span>/node
            <span class="nv">node_device</span><span class="o">=</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span>/sdb1
            <span class="o">[[</span> -d <span class="nv">$node</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
            <span class="o">[[</span> -d <span class="nv">$drive</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
<span class="k">            </span>sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$drive</span>
            sudo install -o <span class="k">${</span><span class="nv">USER</span><span class="k">}</span> -g <span class="nv">$USER_GROUP</span> -d <span class="nv">$node_device</span>
            sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">node</span><span class="k">}</span>
    <span class="k">done</span>

<span class="k">   </span>sudo mkdir -p <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/<span class="o">{</span>object,container,account<span class="o">}</span>-server /var/run/swift
   sudo chown -R <span class="nv">$USER</span>: <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> /var/run/swift

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$SWIFT_CONFIG_DIR&quot;</span> !<span class="o">=</span> <span class="s2">&quot;/etc/swift&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        sudo ln -sf <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> /etc/swift
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        s/%GROUP%/${USER_GROUP}/;</span>
<span class="s2">        s/%USER%/$USER/;</span>
<span class="s2">        s,%SWIFT_DATA_DIR%,$SWIFT_DATA_DIR,;</span>
<span class="s2">    &quot;</span> <span class="nv">$FILES</span>/swift/rsyncd.conf | sudo tee /etc/rsyncd.conf
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo sed -i <span class="s1">&#39;/^RSYNC_ENABLE=false/ { s/false/true/ }&#39;</span> /etc/default/rsync
    <span class="k">else</span>
<span class="k">        </span>sudo sed -i <span class="s1">&#39;/disable *= *yes/ { s/yes/no/ }&#39;</span> /etc/xinetd.d/rsync
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled swift3;then
        <span class="nv">swift_auth_server</span><span class="o">=</span><span class="s2">&quot;s3token &quot;</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">        </span>swift_auth_server+<span class="o">=</span><span class="s2">&quot;authtoken keystone&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">swift_auth_server</span><span class="o">=</span>tempauth
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/proxy-server.conf
    cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/proxy-server.conf-sample <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT user
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT user <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT swift_dir
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT swift_dir <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT workers
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT workers 1

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT log_level
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT log_level DEBUG

    iniuncomment <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT bind_port
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> DEFAULT bind_port <span class="k">${</span><span class="nv">SWIFT_DEFAULT_BIND_PORT</span><span class="k">:-</span><span class="nv">8080</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
    is_service_enabled swift3 <span class="o">&amp;&amp;</span> <span class="nv">swift3</span><span class="o">=</span>swift3 <span class="o">||</span> <span class="nv">swift3</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> pipeline:main pipeline <span class="s2">&quot;catch_errors healthcheck cache ratelimit ${swift3} ${swift_auth_server} proxy-logging proxy-server&quot;</span>

    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_PROXY_SERVER</span><span class="k">}</span> app:proxy-server account_autocreate <span class="nb">true</span>

<span class="nb">    </span>cat <span class="s">&lt;&lt;EOF&gt;&gt;${SWIFT_CONFIG_PROXY_SERVER}</span>

<span class="s">[filter:keystone]</span>
<span class="s">paste.filter_factory = keystone.middleware.swift_auth:filter_factory</span>
<span class="s">operator_roles = Member,admin</span>

<span class="s">[filter:authtoken]</span>
<span class="s">paste.filter_factory = keystone.middleware.auth_token:filter_factory</span>
<span class="s">auth_host = ${KEYSTONE_AUTH_HOST}</span>
<span class="s">auth_port = ${KEYSTONE_AUTH_PORT}</span>
<span class="s">auth_protocol = ${KEYSTONE_AUTH_PROTOCOL}</span>
<span class="s">auth_uri = ${KEYSTONE_SERVICE_PROTOCOL}://${KEYSTONE_SERVICE_HOST}:${KEYSTONE_SERVICE_PORT}/</span>
<span class="s">admin_tenant_name = ${SERVICE_TENANT_NAME}</span>
<span class="s">admin_user = swift</span>
<span class="s">admin_password = ${SERVICE_PASSWORD}</span>
<span class="s">delay_auth_decision = 1</span>
<span class="s">EOF</span>
    <span class="k">if </span>is_service_enabled swift3;then
        cat <span class="s">&lt;&lt;EOF&gt;&gt;${SWIFT_CONFIG_PROXY_SERVER}</span>
<span class="s"># DIVIDER</span>
<span class="s">[filter:s3token]</span>
<span class="s">paste.filter_factory = keystone.middleware.s3_token:filter_factory</span>
<span class="s">auth_port = ${KEYSTONE_AUTH_PORT}</span>
<span class="s">auth_host = ${KEYSTONE_AUTH_HOST}</span>
<span class="s">auth_protocol = ${KEYSTONE_AUTH_PROTOCOL}</span>
<span class="s">auth_token = ${SERVICE_TOKEN}</span>
<span class="s">admin_token = ${SERVICE_TOKEN}</span>

<span class="s">[filter:swift3]</span>
<span class="s">use = egg:swift3#swift3</span>
<span class="s">EOF</span>
    <span class="k">fi</span>

<span class="k">    </span>cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/swift.conf-sample <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/swift.conf
    iniset <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/swift.conf swift-hash swift_hash_path_suffix <span class="k">${</span><span class="nv">SWIFT_HASH</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">function </span>generate_swift_configuration<span class="o">()</span> <span class="o">{</span>
        <span class="nb">local </span><span class="nv">server_type</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">local </span><span class="nv">bind_port</span><span class="o">=</span><span class="nv">$2</span>
        <span class="nb">local </span><span class="nv">log_facility</span><span class="o">=</span><span class="nv">$3</span>
        <span class="nb">local </span>node_number
        <span class="nb">local </span>swift_node_config

        <span class="k">for </span>node_number in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">node_path</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>
            <span class="nv">swift_node_config</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server/<span class="k">${</span><span class="nv">node_number</span><span class="k">}</span>.conf

            cp <span class="k">${</span><span class="nv">SWIFT_DIR</span><span class="k">}</span>/etc/<span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-server.conf-sample <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT user
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT user <span class="k">${</span><span class="nv">USER</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT bind_port
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT bind_port <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT swift_dir
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT swift_dir <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT devices
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT devices <span class="k">${</span><span class="nv">node_path</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT log_facility
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT log_facility LOG_LOCAL<span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span>

            iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT mount_check
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> DEFAULT mount_check <span class="nb">false</span>

<span class="nb">            </span>iniuncomment <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-replicator vm_test_mode
            iniset <span class="k">${</span><span class="nv">swift_node_config</span><span class="k">}</span> <span class="k">${</span><span class="nv">server_type</span><span class="k">}</span>-replicator vm_test_mode yes

            <span class="nv">bind_port</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">bind_port</span><span class="k">}</span> <span class="o">+</span> <span class="m">10</span> <span class="k">))</span>
            <span class="nv">log_facility</span><span class="o">=</span><span class="k">$((</span> <span class="k">${</span><span class="nv">log_facility</span><span class="k">}</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span>
        <span class="k">done</span>
    <span class="o">}</span>
    generate_swift_configuration object 6010 2
    generate_swift_configuration container 6011 2
    generate_swift_configuration account 6012 2

</td><td class=code><div class=highlight><pre>
    <span class="nv">swift_log_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">SWIFT_DATA_DIR</span><span class="k">}</span>/logs
    rm -rf <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
    mkdir -p <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>/hourly
    sudo chown -R <span class="nv">$USER</span>:adm <span class="k">${</span><span class="nv">swift_log_dir</span><span class="k">}</span>
    sed <span class="s2">&quot;s,%SWIFT_LOGDIR%,${swift_log_dir},&quot;</span> <span class="nv">$FILES</span>/swift/rsyslog.conf | sudo <span class="se">\</span>
        tee /etc/rsyslog.d/10-swift.conf
    restart_service rsyslog

</td><td class=code><div class=highlight><pre>
    <span class="nb">pushd</span> <span class="k">${</span><span class="nv">SWIFT_CONFIG_DIR</span><span class="k">}</span> &gt;/dev/null <span class="o">&amp;&amp;</span> <span class="o">{</span>

        rm -f *.builder *.ring.gz backups/*.builder backups/*.ring.gz

        <span class="nv">port_number</span><span class="o">=</span>6010
        swift-ring-builder object.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder object.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
            <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder object.builder rebalance

        <span class="nv">port_number</span><span class="o">=</span>6011
        swift-ring-builder container.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder container.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
            <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder container.builder rebalance

        <span class="nv">port_number</span><span class="o">=</span>6012
        swift-ring-builder account.builder create <span class="k">${</span><span class="nv">SWIFT_PARTITION_POWER_SIZE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">}</span> 1
        <span class="k">for </span>x in <span class="k">$(</span>seq <span class="k">${</span><span class="nv">SWIFT_REPLICAS</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            </span>swift-ring-builder account.builder add z<span class="k">${</span><span class="nv">x</span><span class="k">}</span>-127.0.0.1:<span class="k">${</span><span class="nv">port_number</span><span class="k">}</span>/sdb1 1
            <span class="nv">port_number</span><span class="o">=</span><span class="nv">$[</span>port_number + 10<span class="o">]</span>
        <span class="k">done</span>
<span class="k">        </span>swift-ring-builder account.builder rebalance

    <span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">popd</span> &gt;/dev/null

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo /etc/init.d/rsync restart <span class="o">||</span> :
    <span class="k">else</span>
<span class="k">        </span>sudo systemctl start xinetd.service
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
   swift-init all restart <span class="o">||</span> <span class="nb">true</span>
<span class="nb">   </span>swift-init proxy stop <span class="o">||</span> <span class="nb">true</span>

<span class="nb">   unset </span>s swift_hash swift_auth_server
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>init_cinder
<span class="k">elif </span>is_service_enabled n-vol; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>

    <span class="k">if</span> ! sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">VOLUME_BACKING_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">VOLUME_BACKING_FILE</span><span class="k">:-</span><span class="nv">$DATA_DIR</span><span class="p">/</span><span class="k">${</span><span class="nv">VOLUME_GROUP</span><span class="k">}</span><span class="p">-backing-file</span><span class="k">}</span>
</td><td class=code><div class=highlight><pre>
        <span class="o">[[</span> -f <span class="nv">$VOLUME_BACKING_FILE</span> <span class="o">]]</span> <span class="o">||</span> truncate -s <span class="nv">$VOLUME_BACKING_FILE_SIZE</span> <span class="nv">$VOLUME_BACKING_FILE</span>
        <span class="nv">DEV</span><span class="o">=</span><span class="sb">`</span>sudo losetup -f --show <span class="nv">$VOLUME_BACKING_FILE</span><span class="sb">`</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> ! sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then </span>sudo vgcreate <span class="nv">$VOLUME_GROUP</span> <span class="nv">$DEV</span>; <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    if </span>sudo vgs <span class="nv">$VOLUME_GROUP</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
            start_service tgtd
        <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
        mkdir -p <span class="nv">$NOVA_DIR</span>/volumes

</td><td class=code><div class=highlight><pre>
        sudo tgtadm --op show --mode target | grep <span class="nv">$VOLUME_NAME_PREFIX</span> | grep Target | cut -f3 -d <span class="s1">&#39; &#39;</span> | sudo xargs -n1 tgt-admin --delete <span class="o">||</span> <span class="nb">true</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">for </span>lv in <span class="sb">`</span>sudo lvs --noheadings -o lv_name <span class="nv">$VOLUME_GROUP</span><span class="sb">`</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${lv#$VOLUME_NAME_PREFIX}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$lv&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>sudo lvremove -f <span class="nv">$VOLUME_GROUP</span>/<span class="nv">$lv</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> ! -f /etc/tgt/conf.d/nova.conf <span class="o">]]</span>; <span class="k">then</span>
<span class="k">           </span><span class="nb">echo</span> <span class="s2">&quot;include $NOVA_DIR/volumes/*&quot;</span> | sudo tee /etc/tgt/conf.d/nova.conf
        <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
        sudo stop tgt <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span>sudo start tgt
    <span class="k">else</span>
<span class="k">        </span>restart_service tgtd
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="nv">NOVA_CONF</span><span class="o">=</span>nova.conf
<span class="k">function </span>add_nova_opt <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> &gt;&gt; <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_DIR</span>/bin/nova.conf

</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$NOVA_CONF_DIR</span>/<span class="nv">$NOVA_CONF</span>
add_nova_opt <span class="s2">&quot;[DEFAULT]&quot;</span>
add_nova_opt <span class="s2">&quot;verbose=True&quot;</span>
add_nova_opt <span class="s2">&quot;auth_strategy=keystone&quot;</span>
add_nova_opt <span class="s2">&quot;allow_resize_to_same_host=True&quot;</span>
add_nova_opt <span class="s2">&quot;root_helper=sudo $NOVA_ROOTWRAP&quot;</span>
add_nova_opt <span class="s2">&quot;compute_scheduler_driver=$SCHEDULER&quot;</span>
add_nova_opt <span class="s2">&quot;dhcpbridge_flagfile=$NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
add_nova_opt <span class="s2">&quot;fixed_range=$FIXED_RANGE&quot;</span>
add_nova_opt <span class="s2">&quot;s3_host=$SERVICE_HOST&quot;</span>
add_nova_opt <span class="s2">&quot;s3_port=$S3_SERVICE_PORT&quot;</span>
<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_api_class=nova.network.quantumv2.api.API&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_username=$Q_ADMIN_USERNAME&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_password=$SERVICE_PASSWORD&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_auth_url=$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_SERVICE_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_auth_strategy=$Q_AUTH_STRATEGY&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_admin_tenant_name=$SERVICE_TENANT_NAME&quot;</span>
    add_nova_opt <span class="s2">&quot;quantum_url=http://$Q_HOST:$Q_PORT&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;openvswitch&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_VIF_DRIVER</span><span class="o">=</span><span class="s2">&quot;nova.virt.libvirt.vif.LibvirtOpenVswitchDriver&quot;</span>
        <span class="nv">LINUXNET_VIF_DRIVER</span><span class="o">=</span><span class="s2">&quot;nova.network.linux_net.LinuxOVSInterfaceDriver&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN&quot;</span> <span class="o">=</span> <span class="s2">&quot;linuxbridge&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_VIF_DRIVER</span><span class="o">=</span><span class="s2">&quot;nova.virt.libvirt.vif.QuantumLinuxBridgeVIFDriver&quot;</span>
        <span class="nv">LINUXNET_VIF_DRIVER</span><span class="o">=</span><span class="s2">&quot;nova.network.linux_net.QuantumLinuxBridgeInterfaceDriver&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;libvirt_vif_type=ethernet&quot;</span>
    add_nova_opt <span class="s2">&quot;libvirt_vif_driver=$NOVA_VIF_DRIVER&quot;</span>
    add_nova_opt <span class="s2">&quot;linuxnet_interface_driver=$LINUXNET_VIF_DRIVER&quot;</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;network_manager=nova.network.manager.$NET_MAN&quot;</span>
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled n-vol; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;volume_group=$VOLUME_GROUP&quot;</span>
    add_nova_opt <span class="s2">&quot;volume_name_template=${VOLUME_NAME_PREFIX}%s&quot;</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;iscsi_helper=tgtadm&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;osapi_compute_extension=nova.api.openstack.compute.contrib.standard_extensions&quot;</span>
add_nova_opt <span class="s2">&quot;my_ip=$HOST_IP&quot;</span>
add_nova_opt <span class="s2">&quot;public_interface=$PUBLIC_INTERFACE&quot;</span>
add_nova_opt <span class="s2">&quot;vlan_interface=$VLAN_INTERFACE&quot;</span>
add_nova_opt <span class="s2">&quot;flat_network_bridge=$FLAT_NETWORK_BRIDGE&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$FLAT_INTERFACE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;flat_interface=$FLAT_INTERFACE&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;sql_connection=$BASE_SQL_CONN/nova?charset=utf8&quot;</span>
add_nova_opt <span class="s2">&quot;libvirt_type=$LIBVIRT_TYPE&quot;</span>
add_nova_opt <span class="s2">&quot;libvirt_cpu_mode=none&quot;</span>
add_nova_opt <span class="s2">&quot;instance_name_template=${INSTANCE_NAME_PREFIX}%08x&quot;</span>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-cpu; <span class="k">then</span>
<span class="k">    </span><span class="nv">NOVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6080/vnc_auto.html&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;novncproxy_base_url=$NOVNCPROXY_URL&quot;</span>
    <span class="nv">XVPVNCPROXY_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XVPVNCPROXY_URL</span><span class="k">:-</span><span class="s2">&quot;http://$SERVICE_HOST:6081/console&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xvpvncproxy_base_url=$XVPVNCPROXY_URL&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=169.254.0.1</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_PROXYCLIENT_ADDRESS</span><span class="p">=127.0.0.1</span><span class="k">}</span>
<span class="k">fi</span>
</td><td class=code><div class=highlight><pre>
<span class="nv">VNCSERVER_LISTEN</span><span class="o">=</span><span class="k">${</span><span class="nv">VNCSERVER_LISTEN</span><span class="p">=127.0.0.1</span><span class="k">}</span>
add_nova_opt <span class="s2">&quot;vncserver_listen=$VNCSERVER_LISTEN&quot;</span>
add_nova_opt <span class="s2">&quot;vncserver_proxyclient_address=$VNCSERVER_PROXYCLIENT_ADDRESS&quot;</span>
add_nova_opt <span class="s2">&quot;api_paste_config=$NOVA_CONF_DIR/api-paste.ini&quot;</span>
add_nova_opt <span class="s2">&quot;image_service=nova.image.glance.GlanceImageService&quot;</span>
add_nova_opt <span class="s2">&quot;ec2_dmz_host=$EC2_DMZ_HOST&quot;</span>
<span class="k">if </span>is_service_enabled qpid ; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;rpc_backend=nova.rpc.impl_qpid&quot;</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_HOST&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>  <span class="o">[</span> -n <span class="s2">&quot;$RABBIT_PASSWORD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;rabbit_host=$RABBIT_HOST&quot;</span>
    add_nova_opt <span class="s2">&quot;rabbit_password=$RABBIT_PASSWORD&quot;</span>
<span class="k">fi</span>
add_nova_opt <span class="s2">&quot;glance_api_servers=$GLANCE_HOSTPORT&quot;</span>
add_nova_opt <span class="s2">&quot;force_dhcp_release=True&quot;</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$INSTANCES_PATH&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;instances_path=$INSTANCES_PATH&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;multi_host=True&quot;</span>
    add_nova_opt <span class="s2">&quot;send_arp_for_ha=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;use_syslog=True&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$API_RATE_LIMIT&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;api_rate_limit=False&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$LOG_COLOR&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;logging_context_format_string=%(asctime)s %(color)s%(levelname)s %(name)s [[01;36m%(request_id)s [00;36m%(user_name)s %(project_name)s%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
    add_nova_opt <span class="s2">&quot;logging_default_format_string=%(asctime)s %(color)s%(levelname)s %(name)s [[00;36m-%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
    add_nova_opt <span class="s2">&quot;logging_debug_format_suffix=[00;33mfrom (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d[00m&quot;</span>
    add_nova_opt <span class="s2">&quot;logging_exception_prefix=%(color)s%(asctime)s TRACE %(name)s [01;35m%(instance)s[00m&quot;</span>
<span class="k">else</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;logging_context_format_string=%(asctime)s %(levelname)s %(name)s [%(request_id)s %(user_name)s %(project_name)s] %(instance)s%(message)s&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;volume_api_class=nova.volume.cinder.API&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$EXTRA_OPTS&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">EXTRA_OPTS</span><span class="o">=</span><span class="nv">$EXTRA_FLAGS</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">for </span>I in <span class="s2">&quot;${EXTRA_OPTS[@]}&quot;</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="k">${</span><span class="nv">I</span><span class="p">//--</span><span class="k">}</span>
<span class="k">done</span>


</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>read_password XENAPI_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR XEN.&quot;</span>
    add_nova_opt <span class="s2">&quot;compute_driver=xenapi.XenAPIDriver&quot;</span>
    <span class="nv">XENAPI_CONNECTION_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_CONNECTION_URL</span><span class="k">:-</span><span class="s2">&quot;http://169.254.0.1&quot;</span><span class="k">}</span>
    <span class="nv">XENAPI_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">XENAPI_USER</span><span class="k">:-</span><span class="s2">&quot;root&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_url=$XENAPI_CONNECTION_URL&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_username=$XENAPI_USER&quot;</span>
    add_nova_opt <span class="s2">&quot;xenapi_connection_password=$XENAPI_PASSWORD&quot;</span>
    add_nova_opt <span class="s2">&quot;flat_injected=False&quot;</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">XEN_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">XEN_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$XEN_FIREWALL_DRIVER&quot;</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;openvz&#39;</span> <span class="o">]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    add_nova_opt <span class="s2">&quot;connection_type=openvz&quot;</span>
    <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$LIBVIRT_FIREWALL_DRIVER&quot;</span>
<span class="k">else</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;compute_driver=libvirt.LibvirtDriver&quot;</span>
    <span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.firewall.IptablesFirewallDriver&quot;</span><span class="k">}</span>
    add_nova_opt <span class="s2">&quot;firewall_driver=$LIBVIRT_FIREWALL_DRIVER&quot;</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS nova;&#39;</span>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE nova CHARACTER SET latin1;&#39;</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage db sync
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>screen_it g-reg <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-registry --config-file=$GLANCE_CONF_DIR/glance-registry.conf&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled g-api; <span class="k">then</span>
<span class="k">    </span>screen_it g-api <span class="s2">&quot;cd $GLANCE_DIR; bin/glance-api --config-file=$GLANCE_CONF_DIR/glance-api.conf&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for g-api ($GLANCE_HOSTPORT) to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://$GLANCE_HOSTPORT; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;g-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;DROP DATABASE IF EXISTS keystone;&#39;</span>
    mysql -u<span class="nv">$MYSQL_USER</span> -p<span class="nv">$MYSQL_PASSWORD</span> -e <span class="s1">&#39;CREATE DATABASE keystone CHARACTER SET utf8;&#39;</span>

    <span class="nv">KEYSTONE_CONF_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_CONF_DIR</span><span class="k">:-</span><span class="p">/etc/keystone</span><span class="k">}</span>
    <span class="nv">KEYSTONE_CONF</span><span class="o">=</span><span class="nv">$KEYSTONE_CONF_DIR</span>/keystone.conf
    <span class="nv">KEYSTONE_CATALOG_BACKEND</span><span class="o">=</span><span class="k">${</span><span class="nv">KEYSTONE_CATALOG_BACKEND</span><span class="k">:-</span><span class="nv">template</span><span class="k">}</span>

    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$KEYSTONE_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$KEYSTONE_CONF_DIR</span>
        sudo chown <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$KEYSTONE_CONF_DIR</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$KEYSTONE_CONF_DIR&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$KEYSTONE_DIR/etc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>cp -p <span class="nv">$KEYSTONE_DIR</span>/etc/keystone.conf.sample <span class="nv">$KEYSTONE_CONF</span>
        cp -p <span class="nv">$KEYSTONE_DIR</span>/etc/policy.json <span class="nv">$KEYSTONE_CONF_DIR</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$KEYSTONE_CONF</span> DEFAULT admin_token <span class="s2">&quot;$SERVICE_TOKEN&quot;</span>
    iniset <span class="nv">$KEYSTONE_CONF</span> sql connection <span class="s2">&quot;$BASE_SQL_CONN/keystone?charset=utf8&quot;</span>
    iniset <span class="nv">$KEYSTONE_CONF</span> ec2 driver <span class="s2">&quot;keystone.contrib.ec2.backends.sql.Ec2&quot;</span>
    sed -e <span class="s2">&quot;</span>
<span class="s2">        /^pipeline.*ec2_extension crud_/s|ec2_extension crud_extension|ec2_extension s3_extension crud_extension|;</span>
<span class="s2">    &quot;</span> -i <span class="nv">$KEYSTONE_CONF</span>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$KEYSTONE_CONF</span> filter:s3_extension paste.filter_factory <span class="s2">&quot;keystone.contrib.s3:S3Extension.factory&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$KEYSTONE_CATALOG_BACKEND&quot;</span> <span class="o">=</span> <span class="s2">&quot;sql&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$KEYSTONE_CONF</span> catalog driver keystone.catalog.backends.sql.Catalog
        inicomment <span class="nv">$KEYSTONE_CONF</span> catalog template_file
    <span class="k">else</span>
<span class="k">        </span><span class="nv">KEYSTONE_CATALOG</span><span class="o">=</span><span class="nv">$KEYSTONE_CONF_DIR</span>/default_catalog.templates
        cp -p <span class="nv">$FILES</span>/default_catalog.templates <span class="nv">$KEYSTONE_CATALOG</span>
</td><td class=code><div class=highlight><pre>
        <span class="k">if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.publicURL = http://%SERVICE_HOST%:8080/v1/AUTH_\$(tenant_id)s&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
            <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.adminURL = http://%SERVICE_HOST%:8080/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
            <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.internalURL = http://%SERVICE_HOST%:8080/v1/AUTH_\$(tenant_id)s&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
            <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.object_store.name = Swift Service&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
        <span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.publicURL = http://%SERVICE_HOST%:$Q_PORT/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
            <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.adminURL = http://%SERVICE_HOST%:$Q_PORT/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
            <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.internalURL = http://%SERVICE_HOST%:$Q_PORT/&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
            <span class="nb">echo</span> <span class="s2">&quot;catalog.RegionOne.network.name = Quantum Service&quot;</span> &gt;&gt; <span class="nv">$KEYSTONE_CATALOG</span>
        <span class="k">fi</span>

<span class="k">        </span>sudo sed -e <span class="s2">&quot;</span>
<span class="s2">            s,%SERVICE_HOST%,$SERVICE_HOST,g;</span>
<span class="s2">            s,%S3_SERVICE_PORT%,$S3_SERVICE_PORT,g;</span>
<span class="s2">        &quot;</span> -i <span class="nv">$KEYSTONE_CATALOG</span>

</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$KEYSTONE_CONF</span> catalog driver <span class="s2">&quot;keystone.catalog.backends.templated.TemplatedCatalog&quot;</span>
        iniset <span class="nv">$KEYSTONE_CONF</span> catalog template_file <span class="s2">&quot;$KEYSTONE_CATALOG&quot;</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGGING_ROOT</span><span class="o">=</span><span class="s2">&quot;devel&quot;</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">LOGGING_ROOT</span><span class="o">=</span><span class="s2">&quot;$LOGGING_ROOT,production&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nv">KEYSTONE_LOG_CONFIG</span><span class="o">=</span><span class="s2">&quot;--log-config $KEYSTONE_CONF_DIR/logging.conf&quot;</span>
    cp <span class="nv">$KEYSTONE_DIR</span>/etc/logging.conf.sample <span class="nv">$KEYSTONE_CONF_DIR</span>/logging.conf
    iniset <span class="nv">$KEYSTONE_CONF_DIR</span>/logging.conf logger_root level <span class="s2">&quot;DEBUG&quot;</span>
    iniset <span class="nv">$KEYSTONE_CONF_DIR</span>/logging.conf logger_root handlers <span class="s2">&quot;devel,production&quot;</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$KEYSTONE_DIR</span>/bin/keystone-manage db_sync
</td><td class=code><div class=highlight><pre>
    <span class="nv">$KEYSTONE_DIR</span>/bin/keystone-manage pki_setup

</td><td class=code><div class=highlight><pre>
    screen_it key <span class="s2">&quot;cd $KEYSTONE_DIR &amp;&amp; $KEYSTONE_DIR/bin/keystone-all --config-file $KEYSTONE_CONF $KEYSTONE_LOG_CONFIG -d --debug&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for keystone to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= curl -s $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/ &gt;/dev/null; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;keystone did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$KEYSTONE_AUTH_PROTOCOL</span>://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT</span>/v2.0

    <span class="nv">ADMIN_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span> <span class="nv">SERVICE_TENANT_NAME</span><span class="o">=</span><span class="nv">$SERVICE_TENANT_NAME</span> <span class="nv">SERVICE_PASSWORD</span><span class="o">=</span><span class="nv">$SERVICE_PASSWORD</span> <span class="se">\</span>
    <span class="nv">SERVICE_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span> <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span> <span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="nv">$SERVICE_HOST</span> <span class="se">\</span>
    <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span><span class="nv">$S3_SERVICE_PORT</span> <span class="nv">KEYSTONE_CATALOG_BACKEND</span><span class="o">=</span><span class="nv">$KEYSTONE_CATALOG_BACKEND</span> <span class="se">\</span>
    <span class="nv">DEVSTACK_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span> <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="nv">$ENABLED_SERVICES</span> <span class="se">\</span>
        bash -x <span class="nv">$FILES</span>/keystone_data.sh

</td><td class=code><div class=highlight><pre>
    <span class="nb">export </span><span class="nv">OS_AUTH_URL</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span>
    <span class="nb">export </span><span class="nv">OS_TENANT_NAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_USERNAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift3 <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
<span class="k">        </span><span class="nv">NOVA_USER_ID</span><span class="o">=</span><span class="k">$(</span>keystone user-list | grep <span class="s1">&#39; nova &#39;</span> | get_field 1<span class="k">)</span>
        <span class="nv">NOVA_TENANT_ID</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | grep <span class="s2">&quot; $SERVICE_TENANT_NAME &quot;</span> | get_field 1<span class="k">)</span>
        <span class="nv">CREDS</span><span class="o">=</span><span class="k">$(</span>keystone ec2-credentials-create --user_id <span class="nv">$NOVA_USER_ID</span> --tenant_id <span class="nv">$NOVA_TENANT_ID</span><span class="k">)</span>
        <span class="nv">ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ access / { print $4 }&#39;</span><span class="k">)</span>
        <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$CREDS&quot;</span> | awk <span class="s1">&#39;/ secret / { print $4 }&#39;</span><span class="k">)</span>
        add_nova_opt <span class="s2">&quot;s3_access_key=$ACCESS_KEY&quot;</span>
        add_nova_opt <span class="s2">&quot;s3_secret_key=$SECRET_KEY&quot;</span>
        add_nova_opt <span class="s2">&quot;s3_affix_tenant=True&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">    </span>add_nova_opt <span class="s2">&quot;enabled_apis=$NOVA_ENABLED_APIS&quot;</span>
    screen_it n-api <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-api&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for nova-api to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:8774; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;nova-api did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span><span class="nv">TENANT_ID</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | grep <span class="s2">&quot; demo &quot;</span> | get_field 1<span class="k">)</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">NET_ID</span><span class="o">=</span><span class="k">$(</span>quantum net-create --tenant_id <span class="nv">$TENANT_ID</span> net1 | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    quantum subnet-create --tenant_id <span class="nv">$TENANT_ID</span> --ip_version 4 --gateway <span class="nv">$NETWORK_GATEWAY</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE</span>
<span class="k">elif </span>is_service_enabled mysql <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage network create private <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span> <span class="nv">$NETWORK_CREATE_ARGS</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create <span class="nv">$FLOATING_RANGE</span>

</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_DIR</span>/bin/nova-manage floating create --ip_range<span class="o">=</span><span class="nv">$TEST_FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$TEST_FLOATING_POOL</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
screen_it n-cpu <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; sg libvirtd $NOVA_DIR/bin/nova-compute&quot;</span>
screen_it n-crt <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-cert&quot;</span>
screen_it n-vol <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-volume&quot;</span>
screen_it n-net <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-network&quot;</span>
screen_it n-sch <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-scheduler&quot;</span>
screen_it n-novnc <span class="s2">&quot;cd $NOVNC_DIR &amp;&amp; ./utils/nova-novncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF --web .&quot;</span>
screen_it n-xvnc <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-xvpvncproxy --config-file $NOVA_CONF_DIR/$NOVA_CONF&quot;</span>
screen_it n-cauth <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; ./bin/nova-consoleauth&quot;</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>start_cinder
<span class="k">fi</span>
screen_it horizon <span class="s2">&quot;cd $HORIZON_DIR &amp;&amp; sudo tail -f /var/log/$APACHE_NAME/horizon_error.log&quot;</span>
screen_it swift <span class="s2">&quot;cd $SWIFT_DIR &amp;&amp; $SWIFT_DIR/bin/swift-proxy-server ${SWIFT_CONFIG_DIR}/proxy-server.conf -v&quot;</span>

</td><td class=code><div class=highlight><pre>
is_service_enabled swift3 <span class="o">||</span> <span class="se">\</span>
    screen_it n-obj <span class="s2">&quot;cd $NOVA_DIR &amp;&amp; $NOVA_DIR/bin/nova-objectstore&quot;</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images

    <span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>keystone  token-get | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$UPLOAD_LEGACY_TTY&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">IMAGE_URLS</span><span class="o">=</span><span class="s2">&quot;${IMAGE_URLS:+${IMAGE_URLS},}http://images.ansolabs.com/tty.tgz&quot;</span>
    <span class="k">fi</span>

<span class="k">    for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
</td><td class=code><div class=highlight><pre>
        <span class="nv">IMAGE_FNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$image_url&quot;</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> <span class="o">||</span> <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $FILES/$IMAGE_FNAME)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>wget -c <span class="nv">$image_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span>
        <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_url&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;openvz&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
            <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span>
            glance --os-auth-token <span class="nv">$TOKEN</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME&quot;</span> --public --container-format ami --disk-format ami &lt; <span class="s2">&quot;$IMAGE&quot;</span>
            <span class="k">continue</span>
<span class="k">        fi</span>

<span class="k">        </span><span class="nv">KERNEL</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">RAMDISK</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">DISK_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">case</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> in
            *.tar.gz|*.tgz<span class="o">)</span>
</td><td class=code><div class=highlight><pre>
                <span class="o">[</span> <span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                    <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> <span class="o">||</span>
                    <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tgz}&quot;</span>
                <span class="nv">xdir</span><span class="o">=</span><span class="s2">&quot;$FILES/images/$IMAGE_NAME&quot;</span>
                rm -Rf <span class="s2">&quot;$xdir&quot;</span>;
                mkdir <span class="s2">&quot;$xdir&quot;</span>
                tar -zxf <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> -C <span class="s2">&quot;$xdir&quot;</span>
                <span class="nv">KERNEL</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-vmlinuz* <span class="s2">&quot;$xdir/&quot;</span>aki-*/image; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="nv">RAMDISK</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-initrd* <span class="s2">&quot;$xdir/&quot;</span>ari-*/image; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*.img <span class="s2">&quot;$xdir/&quot;</span>ami-*/image; <span class="k">do</span>
                         <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
                <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$IMAGE_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                    </span><span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
                <span class="k">fi</span>
                ;;
            *.img<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/$IMAGE_FNAME&quot;</span>;
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
                <span class="nv">DISK_FORMAT</span><span class="o">=</span>raw
                <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
                ;;
            *.img.gz<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img.gz&quot;</span><span class="k">)</span>
                <span class="nv">DISK_FORMAT</span><span class="o">=</span>raw
                <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
                ;;
            *.qcow2<span class="o">)</span>
                <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.qcow2&quot;</span><span class="k">)</span>
                <span class="nv">DISK_FORMAT</span><span class="o">=</span>qcow2
                <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
                ;;
            *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Do not know what to do with $IMAGE_FNAME&quot;</span>; <span class="nb">false</span>;;
        <span class="k">esac</span>

<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$CONTAINER_FORMAT&quot;</span> <span class="o">=</span> <span class="s2">&quot;bare&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>glance --os-auth-token <span class="nv">$TOKEN</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME&quot;</span> --is-public<span class="o">=</span>True --container-format<span class="o">=</span><span class="nv">$CONTAINER_FORMAT</span> --disk-format <span class="nv">$DISK_FORMAT</span> &lt; &lt;<span class="o">(</span>zcat --force <span class="s2">&quot;${IMAGE}&quot;</span><span class="o">)</span>
        <span class="k">else</span>
</td><td class=code><div class=highlight><pre>
            <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>; <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="s2">&quot;&quot;</span>;
            <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$KERNEL&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">KERNEL_ID</span><span class="o">=</span><span class="k">$(</span>glance --os-auth-token <span class="nv">$TOKEN</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME-kernel&quot;</span> --is-public<span class="o">=</span>True --container-format aki --disk-format aki &lt; <span class="s2">&quot;$KERNEL&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
            <span class="k">fi</span>
<span class="k">            if</span> <span class="o">[</span> -n <span class="s2">&quot;$RAMDISK&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="k">$(</span>glance --os-auth-token <span class="nv">$TOKEN</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;$IMAGE_NAME-ramdisk&quot;</span> --is-public<span class="o">=</span>True --container-format ari --disk-format ari &lt; <span class="s2">&quot;$RAMDISK&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
            <span class="k">fi</span>
<span class="k">            </span>glance --os-auth-token <span class="nv">$TOKEN</span> --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> image-create --name <span class="s2">&quot;${IMAGE_NAME%.img}&quot;</span> --is-public<span class="o">=</span>True --container-format ami --disk-format ami <span class="k">${</span><span class="nv">KERNEL_ID</span><span class="p">:+--property kernel_id=</span><span class="nv">$KERNEL_ID</span><span class="k">}</span> <span class="k">${</span><span class="nv">RAMDISK_ID</span><span class="p">:+--property ramdisk_id=</span><span class="nv">$RAMDISK_ID</span><span class="k">}</span> &lt; <span class="s2">&quot;${IMAGE}&quot;</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -x <span class="nv">$TOP_DIR</span>/local.sh <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Running user script $TOP_DIR/local.sh&quot;</span>
    <span class="nv">$TOP_DIR</span>/local.sh
<span class="k">fi</span>


</td><td class=code><div class=highlight><pre>

<span class="nb">set</span> +o xtrace


</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Horizon is now available at http://$SERVICE_HOST/&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Keystone is serving at $KEYSTONE_AUTH_PROTOCOL://$SERVICE_HOST:$KEYSTONE_API_PORT/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;This is your host ip: $HOST_IP&quot;</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$EXTRA_FLAGS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: EXTRA_FLAGS is defined and may need to be converted to EXTRA_OPTS&quot;</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;stack.sh completed in $SECONDS seconds.&quot;</span>


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
