<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>install_openvpn.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>install_openvpn.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/bash</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> -e localrc <span class="o">]</span>; <span class="k">then</span>
    . localrc
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> -e vpnrc <span class="o">]</span>; <span class="k">then</span>
    . vpnrc
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cidr2netmask<span class="o">()</span> <span class="o">{</span>
    <span class="nb">set</span> -- <span class="k">$((</span> <span class="m">5</span> <span class="o">-</span> <span class="o">(</span><span class="nv">$1</span> <span class="o">/</span> <span class="m">8</span><span class="o">)</span> <span class="k">))</span> 255 255 255 255 <span class="k">$((</span> <span class="o">(</span><span class="m">255</span> &lt;&lt; <span class="o">(</span><span class="m">8</span> <span class="o">-</span> <span class="o">(</span><span class="nv">$1</span> <span class="o">%</span> <span class="m">8</span><span class="k">))</span><span class="o">)</span> &amp; 255 <span class="o">))</span> 0 0 0
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> -gt 1 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">shift</span> <span class="nv">$1</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">shift</span>
<span class="nb">    </span><span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">1</span><span class="p">-0</span><span class="k">}</span>.<span class="k">${</span><span class="nv">2</span><span class="p">-0</span><span class="k">}</span>.<span class="k">${</span><span class="nv">3</span><span class="p">-0</span><span class="k">}</span>.<span class="k">${</span><span class="nv">4</span><span class="p">-0</span><span class="k">}</span>
<span class="o">}</span>

<span class="nv">FIXED_NET</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$FIXED_RANGE</span> | cut -d<span class="s1">&#39;/&#39;</span> -f1<span class="sb">`</span>
<span class="nv">FIXED_CIDR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$FIXED_RANGE</span> | cut -d<span class="s1">&#39;/&#39;</span> -f2<span class="sb">`</span>
<span class="nv">FIXED_MASK</span><span class="o">=</span><span class="sb">`</span>cidr2netmask <span class="nv">$FIXED_CIDR</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">VPN_SERVER</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_SERVER</span><span class="k">:-</span><span class="sb">`</span>ifconfig eth0 | awk <span class="s2">&quot;/inet addr:/ { print \$2 }&quot;</span> | cut -d: -f2<span class="sb">`</span><span class="k">}</span>  <span class="c"># 50.56.12.212</span>
<span class="nv">VPN_PROTO</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_PROTO</span><span class="k">:-</span><span class="nv">tcp</span><span class="k">}</span>
<span class="nv">VPN_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_PORT</span><span class="k">:-</span><span class="nv">6081</span><span class="k">}</span>
<span class="nv">VPN_DEV</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_DEV</span><span class="k">:-</span><span class="nv">tap0</span><span class="k">}</span>
<span class="nv">VPN_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_BRIDGE</span><span class="k">:-</span><span class="nv">br100</span><span class="k">}</span>
<span class="nv">VPN_BRIDGE_IF</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_BRIDGE_IF</span><span class="k">:-</span><span class="nv">$FLAT_INTERFACE</span><span class="k">}</span>
<span class="nv">VPN_CLIENT_NET</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_CLIENT_NET</span><span class="k">:-</span><span class="nv">$FIXED_NET</span><span class="k">}</span>
<span class="nv">VPN_CLIENT_MASK</span><span class="o">=</span><span class="k">${</span><span class="nv">VPN_CLIENT_MASK</span><span class="k">:-</span><span class="nv">$FIXED_MASK</span><span class="k">}</span>
<span class="nv">VPN_CLIENT_DHCP</span><span class="o">=</span><span class="s2">&quot;${VPN_CLIENT_DHCP:-net.1 net.254}&quot;</span>

<span class="nv">VPN_DIR</span><span class="o">=</span>/etc/openvpn
<span class="nv">CA_DIR</span><span class="o">=</span><span class="nv">$VPN_DIR</span>/easy-rsa

usage<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$0 - OpenVPN install and certificate generation&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;$0 --client name&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;$0 --server [name]&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot; --server mode configures the host with a running OpenVPN server instance&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot; --client mode creates a tarball of a client configuration for this server&quot;</span>
    <span class="nb">exit </span>1
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>usage
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">VPN_EXEC</span><span class="o">=</span><span class="sb">`</span>which openvpn<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$VPN_EXEC&quot;</span> -o ! -x <span class="s2">&quot;$VPN_EXEC&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>apt-get install -y openvpn bridge-utils
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$CA_DIR</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>cp -pR /usr/share/doc/openvpn/examples/easy-rsa/2.0/ <span class="nv">$CA_DIR</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TOOLS_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$TOOLS_DIR</span>/.. <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

<span class="nv">WEB_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/../vpn
<span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$WEB_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>mkdir -p <span class="nv">$WEB_DIR</span>
<span class="k">fi</span>
<span class="nv">WEB_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$TOP_DIR</span>/../vpn <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

<span class="nb">cd</span> <span class="nv">$CA_DIR</span>
<span class="nb">source</span> ./vars

</td><td class=code><div class=highlight><pre>
<span class="nb">export </span><span class="nv">KEY_COUNTRY</span><span class="o">=</span><span class="s2">&quot;US&quot;</span>
<span class="nb">export </span><span class="nv">KEY_PROVINCE</span><span class="o">=</span><span class="s2">&quot;TX&quot;</span>
<span class="nb">export </span><span class="nv">KEY_CITY</span><span class="o">=</span><span class="s2">&quot;SanAntonio&quot;</span>
<span class="nb">export </span><span class="nv">KEY_ORG</span><span class="o">=</span><span class="s2">&quot;Cloudbuilders&quot;</span>
<span class="nb">export </span><span class="nv">KEY_EMAIL</span><span class="o">=</span><span class="s2">&quot;rcb@lists.rackspace.com&quot;</span>

<span class="k">if</span> <span class="o">[</span> ! -r <span class="nv">$CA_DIR</span>/keys/dh1024.pem <span class="o">]</span>; <span class="k">then</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$CA_DIR</span>/clean-all
    <span class="nv">$CA_DIR</span>/build-dh
    <span class="nv">$CA_DIR</span>/pkitool --initca
    openvpn --genkey --secret <span class="nv">$CA_DIR</span>/keys/ta.key  <span class="c">## Build a TLS key</span>
<span class="k">fi</span>

do_server<span class="o">()</span> <span class="o">{</span>
    <span class="nv">NAME</span><span class="o">=</span><span class="nv">$1</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$CA_DIR</span>/pkitool --server <span class="nv">$NAME</span>

    <span class="o">(</span><span class="nb">cd</span> <span class="nv">$CA_DIR</span>/keys;
        cp <span class="nv">$NAME</span>.crt <span class="nv">$NAME</span>.key ca.crt dh1024.pem ta.key <span class="nv">$VPN_DIR</span>
    <span class="o">)</span>
    cat &gt;<span class="nv">$VPN_DIR</span>/br-up <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s">BR=&quot;$VPN_BRIDGE&quot;</span>
<span class="s">TAP=&quot;\$1&quot;</span>

<span class="s">if [[ ! -d /sys/class/net/\$BR ]]; then</span>
<span class="s">    brctl addbr \$BR</span>
<span class="s">fi</span>

<span class="s">for t in \$TAP; do</span>
<span class="s">    openvpn --mktun --dev \$t</span>
<span class="s">    brctl addif \$BR \$t</span>
<span class="s">    ifconfig \$t 0.0.0.0 promisc up</span>
<span class="s">done</span>
<span class="s">EOF</span>
    chmod +x <span class="nv">$VPN_DIR</span>/br-up
    cat &gt;<span class="nv">$VPN_DIR</span>/br-down <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>

<span class="s">BR=&quot;$VPN_BRIDGE&quot;</span>
<span class="s">TAP=&quot;\$1&quot;</span>

<span class="s">for i in \$TAP; do</span>
<span class="s">    brctl delif \$BR $t</span>
<span class="s">    openvpn --rmtun --dev \$i</span>
<span class="s">done</span>
<span class="s">EOF</span>
    chmod +x <span class="nv">$VPN_DIR</span>/br-down
    cat &gt;<span class="nv">$VPN_DIR</span>/<span class="nv">$NAME</span>.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">proto $VPN_PROTO</span>
<span class="s">port $VPN_PORT</span>
<span class="s">dev $VPN_DEV</span>
<span class="s">up $VPN_DIR/br-up</span>
<span class="s">down $VPN_DIR/br-down</span>
<span class="s">cert $NAME.crt</span>
<span class="s">key $NAME.key  # This file should be kept secret</span>
<span class="s">ca ca.crt</span>
<span class="s">dh dh1024.pem</span>
<span class="s">duplicate-cn</span>
<span class="s">server-bridge $VPN_CLIENT_NET $VPN_CLIENT_MASK $VPN_CLIENT_DHCP</span>
<span class="s">ifconfig-pool-persist ipp.txt</span>
<span class="s">comp-lzo</span>
<span class="s">user nobody</span>
<span class="s">group nogroup</span>
<span class="s">persist-key</span>
<span class="s">persist-tun</span>
<span class="s">status openvpn-status.log</span>
<span class="s">EOF</span>
    /etc/init.d/openvpn restart
<span class="o">}</span>

do_client<span class="o">()</span> <span class="o">{</span>
    <span class="nv">NAME</span><span class="o">=</span><span class="nv">$1</span>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$CA_DIR</span>/pkitool <span class="nv">$NAME</span>

    <span class="nv">TMP_DIR</span><span class="o">=</span><span class="sb">`</span>mktemp -d<span class="sb">`</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="nv">$CA_DIR</span>/keys;
        cp -p ca.crt ta.key <span class="nv">$NAME</span>.key <span class="nv">$NAME</span>.crt <span class="nv">$TMP_DIR</span>
    <span class="o">)</span>
    <span class="k">if</span> <span class="o">[</span> -r <span class="nv">$VPN_DIR</span>/hostname <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">HOST</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$VPN_DIR</span>/hostname<span class="sb">`</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">HOST</span><span class="o">=</span><span class="sb">`</span>hostname<span class="sb">`</span>
    <span class="k">fi</span>
<span class="k">    </span>cat &gt;<span class="nv">$TMP_DIR</span>/<span class="nv">$HOST</span>.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">proto $VPN_PROTO</span>
<span class="s">port $VPN_PORT</span>
<span class="s">dev $VPN_DEV</span>
<span class="s">cert $NAME.crt</span>
<span class="s">key $NAME.key  # This file should be kept secret</span>
<span class="s">ca ca.crt</span>
<span class="s">client</span>
<span class="s">remote $VPN_SERVER $VPN_PORT</span>
<span class="s">resolv-retry infinite</span>
<span class="s">nobind</span>
<span class="s">user nobody</span>
<span class="s">group nogroup</span>
<span class="s">persist-key</span>
<span class="s">persist-tun</span>
<span class="s">comp-lzo</span>
<span class="s">verb 3</span>
<span class="s">EOF</span>
    <span class="o">(</span><span class="nb">cd</span> <span class="nv">$TMP_DIR</span>; tar cf <span class="nv">$WEB_DIR</span>/<span class="nv">$NAME</span>.tar *<span class="o">)</span>
    rm -rf <span class="nv">$TMP_DIR</span>
    <span class="nb">echo</span> <span class="s2">&quot;Client certificate and configuration is in $WEB_DIR/$NAME.tar&quot;</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">case</span> <span class="nv">$1</span> in
    --client<span class="o">)</span>   <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$2</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                    </span>usage
                <span class="k">fi</span>
<span class="k">                </span>do_client <span class="nv">$2</span>
                ;;
    --server<span class="o">)</span>   <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$2</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                    </span><span class="nv">NAME</span><span class="o">=</span><span class="sb">`</span>hostname<span class="sb">`</span>
                <span class="k">else</span>
<span class="k">                    </span><span class="nv">NAME</span><span class="o">=</span><span class="nv">$2</span>
</td><td class=code><div class=highlight><pre>
                    <span class="nb">echo</span> <span class="nv">$NAME</span> &gt;<span class="nv">$VPN_DIR</span>/hostname
                <span class="k">fi</span>
<span class="k">                </span>do_server <span class="nv">$NAME</span>
                ;;
    --clean<span class="o">)</span>    <span class="nv">$CA_DIR</span>/clean-all
                ;;
    *<span class="o">)</span>          usage
<span class="k">esac</span>


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
