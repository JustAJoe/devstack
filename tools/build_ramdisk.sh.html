<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>build_ramdisk.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>build_ramdisk.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/bash</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o errexit

<span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$#&quot;</span> -eq <span class="s2">&quot;1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$0 builds a gziped Ubuntu OpenStack install&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;usage: $0 dest&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
cleanup<span class="o">()</span> <span class="o">{</span>
    <span class="nb">set</span> +o errexit

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$MNTDIR&quot;</span> -a -d <span class="s2">&quot;$MNTDIR&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>umount <span class="nv">$MNTDIR</span>
        rmdir <span class="nv">$MNTDIR</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$DEV_FILE_TMP&quot;</span> -a -e <span class="s2">&quot;$DEV_FILE_TMP &quot;</span><span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>rm -f <span class="nv">$DEV_FILE_TMP</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$IMG_FILE_TMP&quot;</span> -a -e <span class="s2">&quot;$IMG_FILE_TMP&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>rm -f <span class="nv">$IMG_FILE_TMP</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$NBD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>qemu-nbd -d <span class="nv">$NBD</span>
    <span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
    <span class="nb">trap </span>2; <span class="nb">kill</span> -2 <span class="nv">$$</span>
<span class="o">}</span>

<span class="nb">trap </span>cleanup SIGHUP SIGINT SIGTERM

</td><td class=code><div class=highlight><pre>
modprobe nbd <span class="nv">max_part</span><span class="o">=</span>63

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace

<span class="nv">IMG_FILE</span><span class="o">=</span><span class="nv">$1</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TOOLS_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$TOOLS_DIR</span>/..; <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
. <span class="nv">$TOP_DIR</span>/functions

</td><td class=code><div class=highlight><pre>
<span class="nv">CWD</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>

<span class="nb">cd</span> <span class="nv">$TOP_DIR</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> ./stackrc

<span class="nv">CACHEDIR</span><span class="o">=</span><span class="k">${</span><span class="nv">CACHEDIR</span><span class="k">:-</span><span class="p">/opt/stack/cache</span><span class="k">}</span>

<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">ROOT_PASSWORD</span><span class="o">=</span><span class="k">${</span><span class="nv">ADMIN_PASSWORD</span><span class="k">:-</span><span class="nv">password</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">DIST_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">DIST_NAME</span><span class="k">:-</span><span class="nv">natty</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">STACKSH_PARAMS</span><span class="o">=</span><span class="k">${</span><span class="nv">STACKSH_PARAMS</span><span class="k">:-}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">USE_CURRENT_DEVSTACK</span><span class="o">=</span><span class="k">${</span><span class="nv">USE_CURRENT_DEVSTACK</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -r <span class="nv">$CACHEDIR</span>/<span class="nv">$DIST_NAME</span>-base.img <span class="o">]</span>; <span class="k">then</span>
    <span class="nv">$TOOLS_DIR</span>/get_uec_image.sh <span class="nv">$DIST_NAME</span> <span class="nv">$CACHEDIR</span>/<span class="nv">$DIST_NAME</span>-base.img
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>map_nbd <span class="o">{</span>
    <span class="k">for </span>i in <span class="sb">`</span>seq 0 15<span class="sb">`</span>; <span class="k">do</span>
<span class="k">        if</span> <span class="o">[</span> ! -e /sys/block/nbd<span class="nv">$i</span>/pid <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">NBD</span><span class="o">=</span>/dev/nbd<span class="nv">$i</span>
</td><td class=code><div class=highlight><pre>
            qemu-nbd -c <span class="nv">$NBD</span> <span class="nv">$1</span>
            <span class="k">if</span> ! timeout 60 sh -c <span class="s2">&quot;while ! [ -e ${NBD}p1 ]; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;Couldn&#39;t connect $NBD&quot;</span>
                <span class="nb">exit </span>1
            <span class="k">fi</span>
<span class="k">            </span><span class="nb">break</span>
<span class="nb">        </span><span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    if</span> <span class="o">[</span> -z <span class="s2">&quot;$NBD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;No free NBD slots&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$NBD</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">DEV_FILE</span><span class="o">=</span><span class="nv">$CACHEDIR</span>/<span class="nv">$DIST_NAME</span>-dev.img
<span class="nv">DEV_FILE_TMP</span><span class="o">=</span><span class="sb">`</span>mktemp <span class="nv">$DEV_FILE</span>.XXXXXX<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> ! -r <span class="nv">$DEV_FILE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>cp -p <span class="nv">$CACHEDIR</span>/<span class="nv">$DIST_NAME</span>-base.img <span class="nv">$DEV_FILE_TMP</span>

    <span class="nv">NBD</span><span class="o">=</span><span class="sb">`</span>map_nbd <span class="nv">$DEV_FILE_TMP</span><span class="sb">`</span>
    <span class="nv">MNTDIR</span><span class="o">=</span><span class="sb">`</span>mktemp -d --tmpdir mntXXXXXXXX<span class="sb">`</span>
    mount -t ext4 <span class="k">${</span><span class="nv">NBD</span><span class="k">}</span>p1 <span class="nv">$MNTDIR</span>
    cp -p /etc/resolv.conf <span class="nv">$MNTDIR</span>/etc/resolv.conf

    chroot <span class="nv">$MNTDIR</span> apt-get install -y --download-only <span class="sb">`</span>cat files/apts/* | grep NOPRIME | cut -d<span class="se">\#</span> -f1<span class="sb">`</span>
    chroot <span class="nv">$MNTDIR</span> apt-get install -y --force-yes <span class="sb">`</span>cat files/apts/* | grep -v NOPRIME | cut -d<span class="se">\#</span> -f1<span class="sb">`</span>
    chroot <span class="nv">$MNTDIR</span> pip install <span class="sb">`</span>cat files/pips/*<span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
    chroot <span class="nv">$MNTDIR</span> groupadd libvirtd
    chroot <span class="nv">$MNTDIR</span> useradd stack -s /bin/bash -d <span class="nv">$DEST</span> -G libvirtd
    mkdir -p <span class="nv">$MNTDIR</span>/<span class="nv">$DEST</span>
    chroot <span class="nv">$MNTDIR</span> chown stack <span class="nv">$DEST</span>

</td><td class=code><div class=highlight><pre>
    <span class="nb">echo </span>stack:pass | chroot <span class="nv">$MNTDIR</span> chpasswd
    <span class="nb">echo </span>root:<span class="nv">$ROOT_PASSWORD</span> | chroot <span class="nv">$MNTDIR</span> chpasswd

</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD: ALL&quot;</span> &gt;&gt; <span class="nv">$MNTDIR</span>/etc/sudoers

    umount <span class="nv">$MNTDIR</span>
    rmdir <span class="nv">$MNTDIR</span>
    qemu-nbd -d <span class="nv">$NBD</span>
    <span class="nv">NBD</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    mv <span class="nv">$DEV_FILE_TMP</span> <span class="nv">$DEV_FILE</span>
<span class="k">fi</span>
rm -f <span class="nv">$DEV_FILE_TMP</span>

</td><td class=code><div class=highlight><pre>

<span class="nv">IMG_FILE_TMP</span><span class="o">=</span><span class="sb">`</span>mktemp <span class="nv">$IMG_FILE</span>.XXXXXX<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> ! -r <span class="nv">$IMG_FILE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NBD</span><span class="o">=</span><span class="sb">`</span>map_nbd <span class="nv">$DEV_FILE</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
    dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$IMG_FILE_TMP</span> <span class="nv">bs</span><span class="o">=</span>1 <span class="nv">count</span><span class="o">=</span>1 <span class="nv">seek</span><span class="o">=</span><span class="k">$((</span><span class="m">2</span><span class="o">*</span><span class="m">1024</span><span class="o">*</span><span class="m">1024</span><span class="o">*</span><span class="m">1024</span><span class="k">))</span>
</td><td class=code><div class=highlight><pre>
    dd <span class="k">if</span><span class="o">=</span><span class="k">${</span><span class="nv">NBD</span><span class="k">}</span>p1 <span class="nv">of</span><span class="o">=</span><span class="nv">$IMG_FILE_TMP</span> <span class="nv">bs</span><span class="o">=</span>1M

    qemu-nbd -d <span class="nv">$NBD</span>
    <span class="nv">NBD</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    mv <span class="nv">$IMG_FILE_TMP</span> <span class="nv">$IMG_FILE</span>
<span class="k">fi</span>
rm -f <span class="nv">$IMG_FILE_TMP</span>

<span class="nv">MNTDIR</span><span class="o">=</span><span class="sb">`</span>mktemp -d --tmpdir mntXXXXXXXX<span class="sb">`</span>
mount -t ext4 -o loop <span class="nv">$IMG_FILE</span> <span class="nv">$MNTDIR</span>
cp -p /etc/resolv.conf <span class="nv">$MNTDIR</span>/etc/resolv.conf

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -r <span class="s2">&quot;`ls $MNTDIR/boot/vmlinuz-*-generic | head -1`&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>chroot <span class="nv">$MNTDIR</span> apt-get install -y linux-generic
<span class="k">fi</span>

git_clone <span class="nv">$NOVA_REPO</span> <span class="nv">$DEST</span>/nova <span class="nv">$NOVA_BRANCH</span>
git_clone <span class="nv">$GLANCE_REPO</span> <span class="nv">$DEST</span>/glance <span class="nv">$GLANCE_BRANCH</span>
git_clone <span class="nv">$KEYSTONE_REPO</span> <span class="nv">$DEST</span>/keystone <span class="nv">$KEYSTONE_BRANCH</span>
git_clone <span class="nv">$NOVNC_REPO</span> <span class="nv">$DEST</span>/novnc <span class="nv">$NOVNC_BRANCH</span>
git_clone <span class="nv">$HORIZON_REPO</span> <span class="nv">$DEST</span>/horizon <span class="nv">$HORIZON_BRANCH</span>
git_clone <span class="nv">$NOVACLIENT_REPO</span> <span class="nv">$DEST</span>/python-novaclient <span class="nv">$NOVACLIENT_BRANCH</span>
git_clone <span class="nv">$OPENSTACKX_REPO</span> <span class="nv">$DEST</span>/openstackx <span class="nv">$OPENSTACKX_BRANCH</span>

</td><td class=code><div class=highlight><pre>
rm -rf <span class="nv">$MNTDIR</span>/<span class="nv">$DEST</span>/devstack
cp -pr <span class="nv">$CWD</span> <span class="nv">$MNTDIR</span>/<span class="nv">$DEST</span>/devstack
chroot <span class="nv">$MNTDIR</span> chown -R stack <span class="nv">$DEST</span>/devstack

</td><td class=code><div class=highlight><pre>
mkdir -p <span class="nv">$MNTDIR</span>/etc/network
cat &gt; <span class="nv">$MNTDIR</span>/etc/network/interfaces <span class="s">&lt;&lt;EOF</span>
<span class="s">auto lo</span>
<span class="s">iface lo inet loopback</span>

<span class="s">auto eth0</span>
<span class="s">iface eth0 inet dhcp</span>
<span class="s">EOF</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;ramstack&quot;</span> &gt;<span class="nv">$MNTDIR</span>/etc/hostname
<span class="nb">echo</span> <span class="s2">&quot;127.0.0.1		localhost	ramstack&quot;</span> &gt;<span class="nv">$MNTDIR</span>/etc/hosts

</td><td class=code><div class=highlight><pre>
<span class="nv">RUN_SH</span><span class="o">=</span><span class="nv">$MNTDIR</span>/<span class="nv">$DEST</span>/run.sh
cat &gt; <span class="nv">$RUN_SH</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">#!/usr/bin/env bash</span>

<span class="s"># DIVIDER</span>
<span class="s">set \`ip addr show dev eth0 | grep inet\`</span>
<span class="s">PREFIX=\`echo \$2 | cut -d. -f1,2,3\`</span>
<span class="s">export FLOATING_RANGE=&quot;\$PREFIX.224/27&quot;</span>

<span class="s"># DIVIDER</span>
<span class="s">killall screen</span>

<span class="s"># DIVIDER</span>
<span class="s">cd $DEST/devstack &amp;&amp; \$STACKSH_PARAMS ./stack.sh &gt; $DEST/run.sh.log</span>
<span class="s">echo &gt;&gt; $DEST/run.sh.log</span>
<span class="s">echo &gt;&gt; $DEST/run.sh.log</span>
<span class="s">echo &quot;All done! Time to start clicking.&quot; &gt;&gt; $DEST/run.sh.log</span>
<span class="s">EOF</span>

</td><td class=code><div class=highlight><pre>
chmod 755 <span class="nv">$RUN_SH</span>
chroot <span class="nv">$MNTDIR</span> chown stack <span class="nv">$DEST</span>/run.sh

umount <span class="nv">$MNTDIR</span>
rmdir <span class="nv">$MNTDIR</span>


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
