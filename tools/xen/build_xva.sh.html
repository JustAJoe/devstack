<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>build_xva.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>build_xva.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> ! -e ../../localrc <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You must have a localrc with ALL necessary passwords defined before proceeding.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;See the xen README for required passwords.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">source </span>xenrc

</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace

</td><td class=code><div class=highlight><pre>
<span class="nv">STAGING_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/stage

</td><td class=code><div class=highlight><pre>
<span class="nv">CLEAN</span><span class="o">=</span><span class="k">${</span><span class="nv">CLEAN</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$CLEAN&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>rm -rf <span class="nv">$STAGING_DIR</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_IMAGE_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">BASE_IMAGE_URL</span><span class="k">:-</span><span class="nv">http</span><span class="p">://images.ansolabs.com/xen/stage.tgz</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$STAGING_DIR</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[</span> ! -e /tmp/stage.tgz <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>wget <span class="nv">$BASE_IMAGE_URL</span> -O /tmp/stage.tgz
    <span class="k">fi</span>
<span class="k">    </span>tar xfz /tmp/stage.tgz
    <span class="nb">cd</span> <span class="nv">$TOP_DIR</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
rm -f /tmp/stage.tgz

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$STAGING_DIR</span>/etc <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Stage is not properly set up!&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">FILES_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="nv">TEMPLATES_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/templates

</td><td class=code><div class=highlight><pre>
<span class="nv">SCRIPT_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/scripts

</td><td class=code><div class=highlight><pre>
<span class="nv">UBUNTU_VERSION</span><span class="o">=</span><span class="sb">`</span>cat <span class="nv">$STAGING_DIR</span>/etc/lsb-release | grep <span class="s2">&quot;DISTRIB_CODENAME=&quot;</span> | sed <span class="s2">&quot;s/DISTRIB_CODENAME=//&quot;</span><span class="sb">`</span>
<span class="nv">KERNEL_VERSION</span><span class="o">=</span><span class="sb">`</span>ls <span class="nv">$STAGING_DIR</span>/boot/vmlinuz* | head -1 | sed <span class="s2">&quot;s/.*vmlinuz-//&quot;</span><span class="sb">`</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">XVA_DIR</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/xvas

</td><td class=code><div class=highlight><pre>
mkdir -p <span class="nv">$XVA_DIR</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">XVA</span><span class="o">=</span><span class="nv">$XVA_DIR</span>/<span class="nv">$GUEST_NAME</span>.xva

</td><td class=code><div class=highlight><pre>
rm -rf <span class="nv">$STAGING_DIR</span>/boot/grub/
mkdir -p <span class="nv">$STAGING_DIR</span>/boot/grub/
cp <span class="nv">$TEMPLATES_DIR</span>/menu.lst.in <span class="nv">$STAGING_DIR</span>/boot/grub/menu.lst
sed -e <span class="s2">&quot;s,@KERNEL_VERSION@,$KERNEL_VERSION,g&quot;</span> -i <span class="nv">$STAGING_DIR</span>/boot/grub/menu.lst

</td><td class=code><div class=highlight><pre>
cp <span class="nv">$FILES_DIR</span>/fstab <span class="nv">$STAGING_DIR</span>/etc/fstab
cp <span class="nv">$FILES_DIR</span>/hvc0.conf <span class="nv">$STAGING_DIR</span>/etc/init/

</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$STAGING_DIR</span>/etc/localtime

</td><td class=code><div class=highlight><pre>
cp /etc/resolv.conf <span class="nv">$STAGING_DIR</span>/etc/resolv.conf

</td><td class=code><div class=highlight><pre>
rm -f /tmp/devstack.tar
tar --exclude<span class="o">=</span><span class="s1">&#39;stage&#39;</span> --exclude<span class="o">=</span><span class="s1">&#39;xen/xvas&#39;</span> --exclude<span class="o">=</span><span class="s1">&#39;xen/nova&#39;</span> -cvf /tmp/devstack.tar <span class="nv">$TOP_DIR</span>/../../../devstack
<span class="nb">cd</span> <span class="nv">$STAGING_DIR</span>/opt/stack/
tar xf /tmp/devstack.tar
<span class="nb">cd</span> <span class="nv">$TOP_DIR</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">VDI_SIZE</span><span class="o">=</span><span class="k">$((</span><span class="nv">$VDI_MB</span><span class="o">*</span><span class="m">1024</span><span class="o">*</span><span class="m">1024</span><span class="k">))</span>
<span class="nv">PRODUCT_BRAND</span><span class="o">=</span><span class="k">${</span><span class="nv">PRODUCT_BRAND</span><span class="k">:-</span><span class="nv">openstack</span><span class="k">}</span>
<span class="nv">PRODUCT_VERSION</span><span class="o">=</span><span class="k">${</span><span class="nv">PRODUCT_VERSION</span><span class="k">:-</span><span class="nv">001</span><span class="k">}</span>
<span class="nv">BUILD_NUMBER</span><span class="o">=</span><span class="k">${</span><span class="nv">BUILD_NUMBER</span><span class="k">:-</span><span class="nv">001</span><span class="k">}</span>
<span class="nv">LABEL</span><span class="o">=</span><span class="s2">&quot;$PRODUCT_BRAND $PRODUCT_VERSION-$BUILD_NUMBER&quot;</span>
<span class="nv">OVA</span><span class="o">=</span><span class="nv">$STAGING_DIR</span>/tmp/ova.xml
cp <span class="nv">$TEMPLATES_DIR</span>/ova.xml.in  <span class="nv">$OVA</span>
sed -e <span class="s2">&quot;s,@VDI_SIZE@,$VDI_SIZE,g&quot;</span> -i <span class="nv">$OVA</span>
sed -e <span class="s2">&quot;s,@PRODUCT_BRAND@,$PRODUCT_BRAND,g&quot;</span> -i <span class="nv">$OVA</span>
sed -e <span class="s2">&quot;s,@PRODUCT_VERSION@,$PRODUCT_VERSION,g&quot;</span> -i <span class="nv">$OVA</span>
sed -e <span class="s2">&quot;s,@BUILD_NUMBER@,$BUILD_NUMBER,g&quot;</span> -i <span class="nv">$OVA</span>

</td><td class=code><div class=highlight><pre>
cat <span class="s">&lt;&lt;EOF &gt;$STAGING_DIR/etc/rc.local</span>
<span class="s"># DIVIDER</span>
<span class="s">/etc/init.d/networking restart</span>
<span class="s">GUEST_PASSWORD=$GUEST_PASSWORD STAGING_DIR=/ DO_TGZ=0 bash /opt/stack/devstack/tools/xen/prepare_guest.sh &gt; /opt/stack/prepare_guest.log 2&gt;&amp;1</span>
<span class="s">su -c &quot;/opt/stack/run.sh &gt; /opt/stack/run.sh.log&quot; stack</span>
<span class="s">exit 0</span>
<span class="s">EOF</span>

</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$XVA</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="nv">$GUEST_NAME</span> &gt; <span class="nv">$STAGING_DIR</span>/etc/hostname

</td><td class=code><div class=highlight><pre>
cat <span class="s">&lt;&lt;EOF &gt;$STAGING_DIR/etc/hosts</span>
<span class="s">$MGT_IP $GUEST_NAME</span>
<span class="s">127.0.0.1 localhost localhost.localdomain</span>
<span class="s">EOF</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">INTERFACES</span><span class="o">=</span><span class="nv">$STAGING_DIR</span>/etc/network/interfaces
cp <span class="nv">$TEMPLATES_DIR</span>/interfaces.in  <span class="nv">$INTERFACES</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$VM_IP</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s1">&#39;eth1 on dhcp&#39;</span>
    sed -e <span class="s2">&quot;s,iface eth1 inet static,iface eth1 inet dhcp,g&quot;</span> -i <span class="nv">$INTERFACES</span>
    sed -e <span class="s1">&#39;/@ETH1_/d&#39;</span> -i <span class="nv">$INTERFACES</span>
<span class="k">else</span>
<span class="k">    </span>sed -e <span class="s2">&quot;s,@ETH1_IP@,$VM_IP,g&quot;</span> -i <span class="nv">$INTERFACES</span>
    sed -e <span class="s2">&quot;s,@ETH1_NETMASK@,$VM_NETMASK,g&quot;</span> -i <span class="nv">$INTERFACES</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$MGT_IP</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s1">&#39;eth2 on dhcp&#39;</span>
    sed -e <span class="s2">&quot;s,iface eth2 inet static,iface eth2 inet dhcp,g&quot;</span> -i <span class="nv">$INTERFACES</span>
    sed -e <span class="s1">&#39;/@ETH2_/d&#39;</span> -i <span class="nv">$INTERFACES</span>
<span class="k">else</span>
<span class="k">    </span>sed -e <span class="s2">&quot;s,@ETH2_IP@,$MGT_IP,g&quot;</span> -i <span class="nv">$INTERFACES</span>
    sed -e <span class="s2">&quot;s,@ETH2_NETMASK@,$MGT_NETMASK,g&quot;</span> -i <span class="nv">$INTERFACES</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$PUB_IP</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s1">&#39;eth3 on dhcp&#39;</span>
    sed -e <span class="s2">&quot;s,iface eth3 inet static,iface eth3 inet dhcp,g&quot;</span> -i <span class="nv">$INTERFACES</span>
    sed -e <span class="s1">&#39;/@ETH3_/d&#39;</span> -i <span class="nv">$INTERFACES</span>
<span class="k">else</span>
<span class="k">    </span>sed -e <span class="s2">&quot;s,@ETH3_IP@,$PUB_IP,g&quot;</span> -i <span class="nv">$INTERFACES</span>
    sed -e <span class="s2">&quot;s,@ETH3_NETMASK@,$PUB_NETMASK,g&quot;</span> -i <span class="nv">$INTERFACES</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -h <span class="nv">$STAGING_DIR</span>/sbin/dhclient3 <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>rm -f <span class="nv">$STAGING_DIR</span>/sbin/dhclient3
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cp_it <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -e <span class="nv">$1</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> -d <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>cp -pRL <span class="nv">$1</span> <span class="nv">$2</span>
    <span class="k">fi</span>
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">COPYENV</span><span class="o">=</span><span class="k">${</span><span class="nv">COPYENV</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$COPYENV&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>cp_it ~/.ssh <span class="nv">$STAGING_DIR</span>/opt/stack/.ssh
    cp_it ~/.ssh/id_rsa.pub <span class="nv">$STAGING_DIR</span>/opt/stack/.ssh/authorized_keys
    cp_it ~/.gitconfig <span class="nv">$STAGING_DIR</span>/opt/stack/.gitconfig
    cp_it ~/.vimrc <span class="nv">$STAGING_DIR</span>/opt/stack/.vimrc
    cp_it ~/.bashrc <span class="nv">$STAGING_DIR</span>/opt/stack/.bashrc
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
cat <span class="s">&lt;&lt;EOF &gt;$STAGING_DIR/opt/stack/run.sh</span>
<span class="s">#!/bin/bash</span>
<span class="s">cd /opt/stack/devstack</span>
<span class="s">killall screen</span>
<span class="s">UPLOAD_LEGACY_TTY=yes HOST_IP=$PUB_IP VIRT_DRIVER=xenserver FORCE=yes MULTI_HOST=1 HOST_IP_IFACE=$HOST_IP_IFACE $STACKSH_PARAMS ./stack.sh</span>
<span class="s">EOF</span>
chmod 755 <span class="nv">$STAGING_DIR</span>/opt/stack/run.sh

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$XVA</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>rm -rf /tmp/mkxva*
    <span class="nv">UID</span><span class="o">=</span>0 <span class="nv">$SCRIPT_DIR</span>/mkxva -o <span class="nv">$XVA</span> -t xva -x <span class="nv">$OVA</span> <span class="nv">$STAGING_DIR</span> <span class="nv">$VDI_MB</span> /tmp/
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;Built $(basename $XVA).  If your dom0 is on a different machine, copy this to [devstackdir]/tools/xen/$(basename $XVA)&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Also copy your localrc to [devstackdir]&quot;</span>


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
