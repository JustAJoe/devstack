<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>build_jenkins.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>build_jenkins.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/bash</span>

<span class="nb">set</span> -o xtrace
<span class="nb">set</span> -o errexit

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;This script must be run as root&quot;</span>
   <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">CUR_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;deb http://pkg.jenkins-ci.org/debian binary/&quot;</span> &gt; /etc/apt/sources.list.d/jenkins.list
wget -q -O - http://pkg.jenkins-ci.org/debian/jenkins-ci.org.key | sudo apt-key add -
apt-get update


</td><td class=code><div class=highlight><pre>
<span class="nv">CLEAN_JENKINS</span><span class="o">=</span><span class="k">${</span><span class="nv">CLEAN_JENKINS</span><span class="k">:-</span><span class="nv">no</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$CLEAN_JENKINS&quot;</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>apt-get remove jenkins jenkins-common
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">DEPS</span><span class="o">=</span><span class="s2">&quot;jenkins cloud-utils&quot;</span>
apt-get install -y --force-yes <span class="nv">$DEPS</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -e /var/lib/jenkins <span class="o">]</span>; <span class="k">then</span>
<span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Jenkins installation failed&quot;</span>
   <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -e /var/lib/jenkins/.ssh/id_rsa.pub <span class="o">]</span>; <span class="k">then</span>
<span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Public key for jenkins is missing.  This is used to ssh into your instances.&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;Please run &quot;</span>su -c ssh-keygen jenkins<span class="s2">&quot; before proceeding&quot;</span>
   <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">JENKINS_SUDO</span><span class="o">=</span>/etc/sudoers.d/jenkins
cat &gt; <span class="nv">$JENKINS_SUDO</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">jenkins ALL = NOPASSWD: ALL</span>
<span class="s">EOF</span>
chmod 440 <span class="nv">$JENKINS_SUDO</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">JENKINS_GITCONF</span><span class="o">=</span>/var/lib/jenkins/hudson.plugins.git.GitSCM.xml
cat &gt; <span class="nv">$JENKINS_GITCONF</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;?xml version=&#39;1.0&#39; encoding=&#39;UTF-8&#39;?&gt;</span>
<span class="s">&lt;hudson.plugins.git.GitSCM_-DescriptorImpl&gt;</span>
<span class="s">  &lt;generation&gt;4&lt;/generation&gt;</span>
<span class="s">  &lt;globalConfigName&gt;Jenkins&lt;/globalConfigName&gt;</span>
<span class="s">  &lt;globalConfigEmail&gt;jenkins@rcb.me&lt;/globalConfigEmail&gt;</span>
<span class="s">&lt;/hudson.plugins.git.GitSCM_-DescriptorImpl&gt;</span>
<span class="s">EOF</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">JOBS</span><span class="o">=</span><span class="sb">`</span>ls <span class="nb">jobs</span><span class="sb">`</span>
<span class="k">for </span>job in <span class="k">${</span><span class="nv">JOBS</span><span class="p">// / </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">    if</span> <span class="o">[</span> ! -e <span class="nb">jobs</span>/<span class="nv">$job</span>/nextBuildNumber <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo </span>1 &gt; <span class="nb">jobs</span>/<span class="nv">$job</span>/nextBuildNumber
    <span class="k">fi</span>
<span class="k">done</span>

</td><td class=code><div class=highlight><pre>
chown -R jenkins <span class="nv">$CUR_DIR</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> ! su -c <span class="s2">&quot;ls $CUR_DIR&quot;</span> jenkins; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Your devstack directory is not accessible by jenkins.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;There is a decent chance you are trying to run this from a directory in /root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;If so, try moving devstack elsewhere (eg. /opt/devstack).&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -h /var/lib/jenkins/jobs <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Installing jobs symlink&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -d /var/lib/jenkins/jobs <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>mv /var/lib/jenkins/jobs /var/lib/jenkins/jobs.old
    <span class="k">fi</span>
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
rm -f /var/lib/jenkins/jobs
ln -s <span class="nv">$CUR_DIR</span>/jobs /var/lib/jenkins/jobs

</td><td class=code><div class=highlight><pre>
<span class="nv">PLUGINS</span><span class="o">=</span>http://hudson-ci.org/downloads/plugins/build-timeout/1.6/build-timeout.hpi,http://mirrors.jenkins-ci.org/plugins/git/1.1.12/git.hpi,http://hudson-ci.org/downloads/plugins/global-build-stats/1.2/global-build-stats.hpi,http://hudson-ci.org/downloads/plugins/greenballs/1.10/greenballs.hpi,http://download.hudson-labs.org/plugins/console-column-plugin/1.0/console-column-plugin.hpi

</td><td class=code><div class=highlight><pre>
<span class="k">for </span>plugin in <span class="k">${</span><span class="nv">PLUGINS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">    </span><span class="nv">name</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$plugin</span><span class="sb">`</span>   
    <span class="nv">dest</span><span class="o">=</span>/var/lib/jenkins/plugins/<span class="nv">$name</span>
    <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$dest</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>curl -L <span class="nv">$plugin</span> -o <span class="nv">$dest</span>
    <span class="k">fi</span>
<span class="k">done</span>

</td><td class=code><div class=highlight><pre>
/etc/init.d/jenkins stop <span class="o">||</span> <span class="nb">true</span>
/etc/init.d/jenkins start


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
