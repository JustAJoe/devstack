<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>kvm.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>kvm.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'></td><td class=code><div class=highlight><pre>
<span class="c">#!/bin/bash</span>

<span class="nb">set</span> -o errexit
<span class="nb">set</span> -o xtrace

<span class="nv">EXECUTOR_NUMBER</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">CONFIGURATION</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">ADAPTER</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">RC</span><span class="o">=</span><span class="nv">$4</span>

<span class="k">function </span>usage<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 - Build a test configuration&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;$0 [EXECUTOR_NUMBER] [CONFIGURATION] [ADAPTER] [RC (optional)]&quot;</span>
    <span class="nb">exit </span>1
<span class="o">}</span>

</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$EXECUTOR_NUMBER&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">||</span> <span class="s2">&quot;$CONFIGURATION&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="o">||</span> <span class="s2">&quot;$ADAPTER&quot;</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>usage
<span class="k">fi</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">CUR_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> ../../..
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>

</td><td class=code><div class=highlight><pre>
apt-get install -y --force-yes libvirt-bin <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>
<span class="nv">BASE_NAME</span><span class="o">=</span>executor-<span class="sb">`</span><span class="nb">printf</span> <span class="s2">&quot;%02d&quot;</span> <span class="nv">$EXECUTOR_NUMBER</span><span class="sb">`</span>
<span class="nv">GUEST_NAME</span><span class="o">=</span><span class="nv">$BASE_NAME</span>.<span class="nv">$ADAPTER</span>
virsh list | grep <span class="nv">$BASE_NAME</span> | cut -d <span class="s2">&quot; &quot;</span> -f1 | xargs -n 1 virsh destroy <span class="o">||</span> <span class="nb">true</span>
virsh net-list | grep <span class="nv">$BASE_NAME</span> | cut -d <span class="s2">&quot; &quot;</span> -f1 | xargs -n 1 virsh net-destroy <span class="o">||</span> <span class="nb">true</span>

</td><td class=code><div class=highlight><pre>
cat <span class="s">&lt;&lt;EOF &gt;localrc</span>
<span class="s">RECLONE=yes</span>
<span class="s">GUEST_NETWORK=$EXECUTOR_NUMBER</span>
<span class="s">GUEST_NAME=$GUEST_NAME</span>
<span class="s">FLOATING_RANGE=192.168.$EXECUTOR_NUMBER.128/27</span>
<span class="s">GUEST_CORES=1</span>
<span class="s">GUEST_RAM=12574720</span>
<span class="s">MYSQL_PASSWORD=chicken</span>
<span class="s">RABBIT_PASSWORD=chicken</span>
<span class="s">SERVICE_TOKEN=chicken</span>
<span class="s">SERVICE_PASSWORD=chicken</span>
<span class="s">ADMIN_PASSWORD=chicken</span>
<span class="s">USERNAME=admin</span>
<span class="s">TENANT=admin</span>
<span class="s">NET_NAME=$BASE_NAME</span>
<span class="s">ACTIVE_TIMEOUT=45</span>
<span class="s">BOOT_TIMEOUT=45</span>
<span class="s">$RC</span>
<span class="s">EOF</span>
<span class="nb">cd </span>tools
sudo ./build_uec.sh

</td><td class=code><div class=highlight><pre>
<span class="nb">echo </span><span class="nv">HEAD</span><span class="o">=</span><span class="sb">`</span>cat /var/lib/libvirt/dnsmasq/<span class="nv">$BASE_NAME</span>.leases | cut -d <span class="s2">&quot; &quot;</span> -f3<span class="sb">`</span> &gt; <span class="nv">$TOP_DIR</span>/addresses


</td><td class=code><div class=highlight><pre></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
