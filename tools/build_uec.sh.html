<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>build_uec.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>build_uec.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><strong>build_uec.sh</strong></p>
</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div></td></tr><tr><td class=docs>
<p>Make sure that we have the proper version of ubuntu (only works on oneiric)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> ! egrep -q <span class="s2">&quot;oneiric&quot;</span> /etc/lsb-release; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;This script only works with ubuntu oneiric.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Keep track of the current directory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TOOLS_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$TOOLS_DIR</span>/..; <span class="nb">pwd</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Import common functions</p>
</td><td class=code><div class=highlight><pre>
. <span class="nv">$TOP_DIR</span>/functions

<span class="nb">cd</span> <span class="nv">$TOP_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Source params</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> ./stackrc

</pre></div></td></tr><tr><td class=docs>
<p>Ubuntu distro to install</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DIST_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">DIST_NAME</span><span class="k">:-</span><span class="nv">oneiric</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure how large the VM should be</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">GUEST_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_SIZE</span><span class="k">:-</span><span class="nv">10G</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>exit on error to stop unexpected errors</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o errexit
<span class="nb">set</span> -o xtrace

</pre></div></td></tr><tr><td class=docs>
<p>Abort if localrc is not set</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$TOP_DIR</span>/localrc <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You must have a localrc with ALL necessary passwords defined before proceeding.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;See stack.sh for required passwords.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install deps if needed</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DEPS</span><span class="o">=</span><span class="s2">&quot;kvm libvirt-bin kpartx cloud-utils curl&quot;</span>
apt_get install -y --force-yes <span class="nv">$DEPS</span> <span class="o">||</span> <span class="nb">true</span> <span class="c"># allow this to fail gracefully for concurrent builds</span>

</pre></div></td></tr><tr><td class=docs>
<p>Where to store files and instances</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">WORK_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">WORK_DIR</span><span class="k">:-</span><span class="p">/opt/uecstack</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Where to store images</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">image_dir</span><span class="o">=</span><span class="nv">$WORK_DIR</span>/images/<span class="nv">$DIST_NAME</span>
mkdir -p <span class="nv">$image_dir</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start over with a clean base image, if desired</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$CLEAN_BASE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>rm -f <span class="nv">$image_dir</span>/disk
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Get the base image if it does not yet exist</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$image_dir</span>/disk <span class="o">]</span>; <span class="k">then</span>
    <span class="nv">$TOOLS_DIR</span>/get_uec_image.sh -r <span class="nv">$GUEST_SIZE</span> <span class="nv">$DIST_NAME</span> <span class="nv">$image_dir</span>/disk <span class="nv">$image_dir</span>/kernel
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Copy over dev environment if COPY_ENV is set.
This will also copy over your current devstack.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$COPY_ENV</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$TOOLS_DIR</span>
    ./copy_dev_environment_to_uec.sh <span class="nv">$image_dir</span>/disk
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Option to warm the base image with software requirements.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$WARM_CACHE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">cd</span> <span class="nv">$TOOLS_DIR</span>
    ./warm_apts_for_uec.sh <span class="nv">$image_dir</span>/disk
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Name of our instance, used by libvirt</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">GUEST_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_NAME</span><span class="k">:-</span><span class="nv">devstack</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Mop up after previous runs</p>
</td><td class=code><div class=highlight><pre>
virsh destroy <span class="nv">$GUEST_NAME</span> <span class="o">||</span> <span class="nb">true</span>

</pre></div></td></tr><tr><td class=docs>
<p>Where this vm is stored</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">vm_dir</span><span class="o">=</span><span class="nv">$WORK_DIR</span>/instances/<span class="nv">$GUEST_NAME</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create vm dir and remove old disk</p>
</td><td class=code><div class=highlight><pre>
mkdir -p <span class="nv">$vm_dir</span>
rm -f <span class="nv">$vm_dir</span>/disk

</pre></div></td></tr><tr><td class=docs>
<p>Create a copy of the base image</p>
</td><td class=code><div class=highlight><pre>
qemu-img create -f qcow2 -b <span class="nv">$image_dir</span>/disk <span class="nv">$vm_dir</span>/disk

</pre></div></td></tr><tr><td class=docs>
<p>Back to devstack</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">cd</span> <span class="nv">$TOP_DIR</span>

<span class="nv">GUEST_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_NETWORK</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="nv">GUEST_RECREATE_NET</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_RECREATE_NET</span><span class="k">:-</span><span class="nv">yes</span><span class="k">}</span>
<span class="nv">GUEST_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_IP</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.</span><span class="nv">$GUEST_NETWORK</span><span class="p">.50</span><span class="k">}</span>
<span class="nv">GUEST_CIDR</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_CIDR</span><span class="k">:-</span><span class="nv">$GUEST_IP</span><span class="p">/24</span><span class="k">}</span>
<span class="nv">GUEST_NETMASK</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_NETMASK</span><span class="k">:-</span><span class="nv">255</span><span class="p">.255.255.0</span><span class="k">}</span>
<span class="nv">GUEST_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_GATEWAY</span><span class="k">:-</span><span class="nv">192</span><span class="p">.168.</span><span class="nv">$GUEST_NETWORK</span><span class="p">.1</span><span class="k">}</span>
<span class="nv">GUEST_MAC</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_MAC</span><span class="k">:-</span><span class="s2">&quot;02:16:3e:07:69:`printf &#39;%02X&#39; $GUEST_NETWORK`&quot;</span><span class="k">}</span>
<span class="nv">GUEST_RAM</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_RAM</span><span class="k">:-</span><span class="nv">1524288</span><span class="k">}</span>
<span class="nv">GUEST_CORES</span><span class="o">=</span><span class="k">${</span><span class="nv">GUEST_CORES</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>libvirt.xml configuration</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NET_XML</span><span class="o">=</span><span class="nv">$vm_dir</span>/net.xml
<span class="nv">NET_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">NET_NAME</span><span class="k">:-</span><span class="nv">devstack</span><span class="p">-</span><span class="nv">$GUEST_NETWORK</span><span class="k">}</span>
cat &gt; <span class="nv">$NET_XML</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;network&gt;</span>
<span class="s">  &lt;name&gt;$NET_NAME&lt;/name&gt;</span>
<span class="s">  &lt;bridge name=&quot;stackbr%d&quot; /&gt;</span>
<span class="s">  &lt;forward/&gt;</span>
<span class="s">  &lt;ip address=&quot;$GUEST_GATEWAY&quot; netmask=&quot;$GUEST_NETMASK&quot;&gt;</span>
<span class="s">    &lt;dhcp&gt;</span>
<span class="s">      &lt;range start=&#39;192.168.$GUEST_NETWORK.2&#39; end=&#39;192.168.$GUEST_NETWORK.127&#39; /&gt;</span>
<span class="s">    &lt;/dhcp&gt;</span>
<span class="s">  &lt;/ip&gt;</span>
<span class="s">&lt;/network&gt;</span>
<span class="s">EOF</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$GUEST_RECREATE_NET&quot;</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>virsh net-destroy <span class="nv">$NET_NAME</span> <span class="o">||</span> <span class="nb">true</span>
</pre></div></td></tr><tr><td class=docs>
<p>destroying the network isn't enough to delete the leases</p>
</td><td class=code><div class=highlight><pre>
    rm -f /var/lib/libvirt/dnsmasq/<span class="nv">$NET_NAME</span>.leases
    virsh net-create <span class="nv">$vm_dir</span>/net.xml
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>libvirt.xml configuration</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LIBVIRT_XML</span><span class="o">=</span><span class="nv">$vm_dir</span>/libvirt.xml
cat &gt; <span class="nv">$LIBVIRT_XML</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">&lt;domain type=&#39;kvm&#39;&gt;</span>
<span class="s">  &lt;name&gt;$GUEST_NAME&lt;/name&gt;</span>
<span class="s">  &lt;memory&gt;$GUEST_RAM&lt;/memory&gt;</span>
<span class="s">  &lt;os&gt;</span>
<span class="s">    &lt;type&gt;hvm&lt;/type&gt;</span>
<span class="s">    &lt;kernel&gt;$image_dir/kernel&lt;/kernel&gt;</span>
<span class="s">    &lt;cmdline&gt;root=/dev/vda ro console=ttyS0 init=/usr/lib/cloud-init/uncloud-init ds=nocloud-net;s=http://192.168.$GUEST_NETWORK.1:4567/ ubuntu-pass=ubuntu&lt;/cmdline&gt;</span>
<span class="s">  &lt;/os&gt;</span>
<span class="s">  &lt;features&gt;</span>
<span class="s">    &lt;acpi/&gt;</span>
<span class="s">  &lt;/features&gt;</span>
<span class="s">  &lt;clock offset=&#39;utc&#39;/&gt;</span>
<span class="s">  &lt;vcpu&gt;$GUEST_CORES&lt;/vcpu&gt;</span>
<span class="s">  &lt;devices&gt;</span>
<span class="s">    &lt;disk type=&#39;file&#39;&gt;</span>
<span class="s">      &lt;driver type=&#39;qcow2&#39;/&gt;</span>
<span class="s">      &lt;source file=&#39;$vm_dir/disk&#39;/&gt;</span>
<span class="s">      &lt;target dev=&#39;vda&#39; bus=&#39;virtio&#39;/&gt;</span>
<span class="s">    &lt;/disk&gt;</span>

<span class="s">    &lt;interface type=&#39;network&#39;&gt;</span>
<span class="s">      &lt;source network=&#39;$NET_NAME&#39;/&gt;</span>
<span class="s">    &lt;/interface&gt;</span>

<span class="s">    &lt;!-- The order is significant here.  File must be defined first --&gt;</span>
<span class="s">    &lt;serial type=&quot;file&quot;&gt;</span>
<span class="s">      &lt;source path=&#39;$vm_dir/console.log&#39;/&gt;</span>
<span class="s">      &lt;target port=&#39;1&#39;/&gt;</span>
<span class="s">    &lt;/serial&gt;</span>

<span class="s">    &lt;console type=&#39;pty&#39; tty=&#39;/dev/pts/2&#39;&gt;</span>
<span class="s">      &lt;source path=&#39;/dev/pts/2&#39;/&gt;</span>
<span class="s">      &lt;target port=&#39;0&#39;/&gt;</span>
<span class="s">    &lt;/console&gt;</span>

<span class="s">    &lt;serial type=&#39;pty&#39;&gt;</span>
<span class="s">      &lt;source path=&#39;/dev/pts/2&#39;/&gt;</span>
<span class="s">      &lt;target port=&#39;0&#39;/&gt;</span>
<span class="s">    &lt;/serial&gt;</span>

<span class="s">    &lt;graphics type=&#39;vnc&#39; port=&#39;-1&#39; autoport=&#39;yes&#39; keymap=&#39;en-us&#39; listen=&#39;0.0.0.0&#39;/&gt;</span>
<span class="s">  &lt;/devices&gt;</span>
<span class="s">&lt;/domain&gt;</span>
<span class="s">EOF</span>


rm -rf <span class="nv">$vm_dir</span>/uec
cp -r <span class="nv">$TOOLS_DIR</span>/uec <span class="nv">$vm_dir</span>/uec

</pre></div></td></tr><tr><td class=docs>
<p>set metadata</p>
</td><td class=code><div class=highlight><pre>
cat &gt; <span class="nv">$vm_dir</span>/uec/meta-data<span class="s">&lt;&lt;EOF</span>
<span class="s">hostname: $GUEST_NAME</span>
<span class="s">instance-id: i-hop</span>
<span class="s">instance-type: m1.ignore</span>
<span class="s">local-hostname: $GUEST_NAME.local</span>
<span class="s">EOF</span>

</pre></div></td></tr><tr><td class=docs>
<p>set user-data</p>
</td><td class=code><div class=highlight><pre>
cat &gt; <span class="nv">$vm_dir</span>/uec/user-data<span class="s">&lt;&lt;EOF</span>
<span class="s">#!/bin/bash</span>
<span class="s"># DIVIDER</span>
<span class="s">sed -i &quot;s/127.0.0.1/127.0.0.1 \`hostname\`/&quot; /etc/hosts</span>
<span class="s">apt-get update</span>
<span class="s">apt-get install git sudo -y</span>
<span class="s"># DIVIDER</span>
<span class="s">sudo apt-get remove -y byobu</span>
<span class="s">EOF</span>

</pre></div></td></tr><tr><td class=docs>
<p>hostname needs to resolve for rabbit</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -e ~/.ssh/id_rsa.pub <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PUB_KEY</span><span class="o">=</span><span class="sb">`</span>cat  ~/.ssh/id_rsa.pub<span class="sb">`</span>
    cat &gt;&gt; <span class="nv">$vm_dir</span>/uec/user-data<span class="s">&lt;&lt;EOF</span>
<span class="s">mkdir -p /opt/stack</span>
<span class="s">if [ ! -d /opt/stack/devstack ]; then</span>
<span class="s">    git clone https://github.com/cloudbuilders/devstack.git /opt/stack/devstack</span>
<span class="s">    cd /opt/stack/devstack</span>
<span class="s">    cat &gt; localrc &lt;&lt;LOCAL_EOF</span>
<span class="nv">ROOTSLEEP</span><span class="o">=</span>0
<span class="sb">`</span>cat <span class="nv">$TOP_DIR</span>/localrc<span class="sb">`</span>
LOCAL_EOF
<span class="k">fi</span>
useradd -U -G sudo -s /bin/bash -d /opt/stack -m <span class="nv">$STACK_USER</span>
<span class="nb">echo</span> <span class="nv">$STACK_USER</span>:pass | chpasswd
mkdir -p /opt/stack/.ssh
<span class="nb">echo</span> <span class="s2">&quot;$PUB_KEY&quot;</span> &gt; /opt/stack/.ssh/authorized_keys
chown -R <span class="nv">$STACK_USER</span> /opt/stack
chmod 700 /opt/stack/.ssh
chmod 600 /opt/stack/.ssh/authorized_keys

grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
    <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> &gt;&gt; /etc/sudoers
<span class="o">(</span> <span class="nb">umask </span>226 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;stack ALL=(ALL) NOPASSWD:ALL&quot;</span> <span class="se">\</span>
    &gt; /etc/sudoers.d/50_stack_sh <span class="o">)</span>
EOF
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Disable byobu</p>
</td><td class=code><div class=highlight><pre>
cat &gt;&gt; <span class="nv">$vm_dir</span>/uec/user-data<span class="s">&lt;&lt;EOF</span>
<span class="s">sudo -u $STACK_USER bash -l -c &quot;cd /opt/stack/devstack &amp;&amp; ./stack.sh&quot;</span>
<span class="s">EOF</span>

</pre></div></td></tr><tr><td class=docs>
<p>Setup stack user with our key</p>
</td><td class=code><div class=highlight><pre>
<span class="o">(</span>
  <span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>lsof -iTCP@192.168.<span class="nv">$GUEST_NETWORK</span>.1:4567 -n | awk <span class="s1">&#39;{print $2}&#39;</span> | tail -1<span class="sb">`</span>
  <span class="o">[</span> -z <span class="s2">&quot;$pid&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">kill</span> -9 <span class="nv">$pid</span>
<span class="o">)</span>
<span class="nb">cd</span> <span class="nv">$vm_dir</span>/uec
python meta.py 192.168.<span class="nv">$GUEST_NETWORK</span>.1:4567 &amp;

</pre></div></td></tr><tr><td class=docs>
<p>Run stack.sh</p>
</td><td class=code><div class=highlight><pre>
virsh create <span class="nv">$vm_dir</span>/libvirt.xml

</pre></div></td></tr><tr><td class=docs>
<p>(re)start a metadata service</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">WAIT_TILL_LAUNCH</span><span class="o">=</span><span class="k">${</span><span class="nv">WAIT_TILL_LAUNCH</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$WAIT_TILL_LAUNCH&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">set</span> +o xtrace
</pre></div></td></tr><tr><td class=docs>
<p>Create the instance</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span>
<span class="nb">    echo</span> <span class="s2">&quot;=============================================================&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;                          -- YAY! --&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;=============================================================&quot;</span>
    <span class="nb">echo</span>
<span class="nb">    echo</span> <span class="s2">&quot;We&#39;re done launching the vm, about to start tailing the&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;stack.sh log. It will take a second or two to start.&quot;</span>
    <span class="nb">echo</span>
<span class="nb">    echo</span> <span class="s2">&quot;Just CTRL-C at any time to stop tailing.&quot;</span>
    <span class="nb">echo</span>

<span class="nb">    </span><span class="k">if</span> ! timeout 60 sh -c <span class="s2">&quot;while [ ! -s /var/lib/libvirt/dnsmasq/$NET_NAME.leases ]; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Your instance failed to acquire an IP address&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">ip</span><span class="o">=</span><span class="sb">`</span>cat /var/lib/libvirt/dnsmasq/<span class="nv">$NET_NAME</span>.leases | cut -d <span class="s2">&quot; &quot;</span> -f3<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;#############################################################&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;              -- This is your instance&#39;s IP: --&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;                           $ip&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;#############################################################&quot;</span>

    sleep 2

    <span class="k">while</span> <span class="o">[</span> ! -e <span class="s2">&quot;$vm_dir/console.log&quot;</span> <span class="o">]</span>; <span class="k">do</span>
<span class="k">      </span>sleep 1
    <span class="k">done</span>

<span class="k">    </span>tail -F <span class="nv">$vm_dir</span>/console.log &amp;

    <span class="nv">TAIL_PID</span><span class="o">=</span><span class="nv">$!</span>

    <span class="k">function </span>kill_tail<span class="o">()</span> <span class="o">{</span>
        <span class="nb">kill</span> <span class="nv">$TAIL_PID</span>
        <span class="nb">exit </span>1
    <span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tail the console log till we are done</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">trap </span>kill_tail SIGINT

    <span class="nb">echo</span> <span class="s2">&quot;Waiting stack.sh to finish...&quot;</span>
    <span class="k">while</span> ! egrep -q <span class="s1">&#39;^stack.sh (completed|failed)&#39;</span> <span class="nv">$vm_dir</span>/console.log ; <span class="k">do</span>
<span class="k">        </span>sleep 1
    <span class="k">done</span>

<span class="k">    </span><span class="nb">set</span> -o xtrace

    <span class="nb">kill</span> <span class="nv">$TAIL_PID</span>

    <span class="k">if</span> ! grep -q <span class="s2">&quot;^stack.sh completed in&quot;</span> <span class="nv">$vm_dir</span>/console.log; <span class="k">then</span>
<span class="k">        </span><span class="nb">exit </span>1
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">set</span> +o xtrace
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Finished - Zip-a-dee Doo-dah!&quot;</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Done creating the container, let's tail the log</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Let Ctrl-c kill tail and exit</p>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
