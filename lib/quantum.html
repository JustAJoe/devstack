<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>quantum</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>quantum</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>lib/quantum
functions - funstions specific to quantum
Dependencies:
<tt class="docutils literal">functions</tt> file
<tt class="docutils literal">DEST</tt> must be defined</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> calls the entry points in this order:</p>
<p>install_quantum
install_quantumclient
install_quantum_agent_packages
install_quantum_third_party
setup_quantum
setup_quantumclient
configure_quantum
init_quantum
configure_quantum_third_party
init_quantum_third_party
start_quantum_third_party
create_nova_conf_quantum
start_quantum_service_and_check
create_quantum_initial_network
setup_quantum_debug
start_quantum_agents</p>
<p><tt class="docutils literal">unstack.sh</tt> calls the entry points in this order:</p>
<p>stop_quantum</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Functions in lib/quantum are classified into the following categories:</p>
<ul class="simple">
<li>entry points (called from stack.sh or unstack.sh)</li>
<li>internal functions</li>
<li>quantum exercises</li>
<li>3rd party programs</li>
</ul>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="quantum-networking">
<h1>Quantum Networking</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure that quantum is enabled in <tt class="docutils literal">ENABLED_SERVICES</tt>.  If you want
to run Quantum on this host, make sure that q-svc is also in
<tt class="docutils literal">ENABLED_SERVICES</tt>.</p>
<p>If you're planning to use the Quantum openvswitch plugin, set
<tt class="docutils literal">Q_PLUGIN</tt> to &quot;openvswitch&quot; and make sure the q-agt service is enabled
in <tt class="docutils literal">ENABLED_SERVICES</tt>.  If you're planning to use the Quantum
linuxbridge plugin, set <tt class="docutils literal">Q_PLUGIN</tt> to &quot;linuxbridge&quot; and make sure the
q-agt service is enabled in <tt class="docutils literal">ENABLED_SERVICES</tt>.</p>
<p>See &quot;Quantum Network Configuration&quot; below for additional variables
that must be set in localrc for connectivity across hosts with
Quantum.</p>
<p>With Quantum networking the NET_MAN variable is ignored.</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="quantum-network-configuration">
<h1>Quantum Network Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up default directories</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">QUANTUM_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/quantum
<span class="nv">QUANTUMCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-quantumclient
<span class="nv">QUANTUM_AUTH_CACHE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">QUANTUM_AUTH_CACHE_DIR</span><span class="k">:-</span><span class="p">/var/cache/quantum</span><span class="k">}</span>

<span class="nv">QUANTUM_CONF_DIR</span><span class="o">=</span>/etc/quantum
<span class="nv">QUANTUM_CONF</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/quantum.conf
<span class="nb">export </span><span class="nv">QUANTUM_TEST_CONFIG_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">QUANTUM_TEST_CONFIG_FILE</span><span class="k">:-</span><span class="s2">&quot;$QUANTUM_CONF_DIR/debug.ini&quot;</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Plugin</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PLUGIN</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PLUGIN</span><span class="k">:-</span><span class="nv">openvswitch</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Port</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT</span><span class="k">:-</span><span class="nv">9696</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Quantum Host</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default admin username</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ADMIN_USERNAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ADMIN_USERNAME</span><span class="k">:-</span><span class="nv">quantum</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default auth strategy</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_AUTH_STRATEGY</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_AUTH_STRATEGY</span><span class="k">:-</span><span class="nv">keystone</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use namespace or not</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_USE_NAMESPACE</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_NAMESPACE</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
<span class="nv">Q_USE_ROOTWRAP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_ROOTWRAP</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Meta data IP</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_META_DATA_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_META_DATA_IP</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Allow Overlapping IP among subnets</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ALLOW_OVERLAPPING_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ALLOW_OVERLAPPING_IP</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use quantum-debug command</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_USE_DEBUG_COMMAND</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_DEBUG_COMMAND</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>The name of the default q-l3 router</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ROUTER_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ROUTER_NAME</span><span class="k">:-</span><span class="nv">router1</span><span class="k">}</span>

<span class="k">if </span>is_service_enabled quantum; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_RR_CONF_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/rootwrap.conf
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_ROOTWRAP&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_RR_COMMAND</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">QUANTUM_ROOTWRAP</span><span class="o">=</span><span class="k">$(</span>get_rootwrap_location quantum<span class="k">)</span>
        <span class="nv">Q_RR_COMMAND</span><span class="o">=</span><span class="s2">&quot;sudo $QUANTUM_ROOTWRAP $Q_RR_CONF_FILE&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="provider-network-configurations">
<h1>Provider Network Configurations</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>The following variables control the Quantum openvswitch and
linuxbridge plugins' allocation of tenant networks and
availability of provider networks. If these are not configured
in localrc, tenant networks will be local to the host (with no
remote connectivity), and no physical resources will be
available for the allocation of provider networks.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To use GRE tunnels for tenant networks, set to True in
localrc. GRE tunnels are only supported by the openvswitch
plugin, and currently only on Ubuntu.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ENABLE_TENANT_TUNNELS</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLE_TENANT_TUNNELS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using GRE tunnels for tenant networks, specify the range of
tunnel IDs from which tenant networks are allocated. Can be
overriden in localrc in necesssary.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TENANT_TUNNEL_RANGES</span><span class="o">=</span><span class="k">${</span><span class="nv">TENANT_TUNNEL_RANGE</span><span class="k">:-</span><span class="nv">1</span><span class="p">:</span><span class="nv">1000</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>To use VLANs for tenant networks, set to True in localrc. VLANs
are supported by the openvswitch and linuxbridge plugins, each
requiring additional configuration described below.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ENABLE_TENANT_VLANS</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLE_TENANT_VLANS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using VLANs for tenant networks, set in localrc to specify
the range of VLAN VIDs from which tenant networks are
allocated. An external network switch must be configured to
trunk these VLANs between hosts for multi-host connectivity.</p>
<p>Example: <tt class="docutils literal">TENANT_VLAN_RANGE=1000:1999</tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TENANT_VLAN_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TENANT_VLAN_RANGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using VLANs for tenant networks, or if using flat or VLAN
provider networks, set in localrc to the name of the physical
network, and also configure OVS_PHYSICAL_BRIDGE for the
openvswitch agent or LB_PHYSICAL_INTERFACE for the linuxbridge
agent, as described below.</p>
<p>Example: <tt class="docutils literal">PHYSICAL_NETWORK=default</tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">PHYSICAL_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">PHYSICAL_NETWORK</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the openvswitch plugin, if using VLANs for tenant networks,
or if using flat or VLAN provider networks, set in localrc to
the name of the OVS bridge to use for the physical network. The
bridge will be created if it does not already exist, but a
physical interface must be manually added to the bridge as a
port for external connectivity.</p>
<p>Example: <tt class="docutils literal"><span class="pre">OVS_PHYSICAL_BRIDGE=br-eth1</span></tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">OVS_PHYSICAL_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_PHYSICAL_BRIDGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the linuxbridge plugin, if using VLANs for tenant networks,
or if using flat or VLAN provider networks, set in localrc to
the name of the network interface to use for the physical
network.</p>
<p>Example: <tt class="docutils literal">LB_PHYSICAL_INTERFACE=eth1</tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LB_PHYSICAL_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">LB_PHYSICAL_INTERFACE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the openvswitch plugin, set to True in localrc to enable
provider GRE tunnels when <tt class="docutils literal">ENABLE_TENANT_TUNNELS</tt> is False.</p>
<p>Example: <tt class="docutils literal">OVS_ENABLE_TUNNELING=True</tt></p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">OVS_ENABLE_TUNNELING</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_ENABLE_TUNNELING</span><span class="k">:-</span><span class="nv">$ENABLE_TENANT_TUNNELS</span><span class="k">}</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="quantum-plugin-specific-functions">
<h1>Quantum plugin specific functions</h1>
<p>Please refer to lib/quantum_plugins/README.md for details.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/quantum_plugins/<span class="nv">$Q_PLUGIN</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="entry-points">
<h1>Entry Points</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>configure_quantum()
Set common config for all quantum server and agents.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_quantum<span class="o">()</span> <span class="o">{</span>
    _configure_quantum_common
    iniset_rpc_backend quantum <span class="nv">$QUANTUM_CONF</span> DEFAULT

    <span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">        </span>_configure_quantum_service
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">        </span>_configure_quantum_plugin_agent
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-dhcp; <span class="k">then</span>
<span class="k">        </span>_configure_quantum_dhcp_agent
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-l3; <span class="k">then</span>
<span class="k">        </span>_configure_quantum_l3_agent
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-meta; <span class="k">then</span>
<span class="k">        </span>_configure_quantum_metadata_agent
    <span class="k">fi</span>

<span class="k">    </span>_configure_quantum_debug_command

    _cleanup_quantum
<span class="o">}</span>

<span class="k">function </span>create_nova_conf_quantum<span class="o">()</span> <span class="o">{</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT network_api_class <span class="s2">&quot;nova.network.quantumv2.api.API&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT quantum_admin_username <span class="s2">&quot;$Q_ADMIN_USERNAME&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT quantum_admin_password <span class="s2">&quot;$SERVICE_PASSWORD&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT quantum_admin_auth_url <span class="s2">&quot;$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_SERVICE_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT quantum_auth_strategy <span class="s2">&quot;$Q_AUTH_STRATEGY&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT quantum_admin_tenant_name <span class="s2">&quot;$SERVICE_TENANT_NAME&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT quantum_url <span class="s2">&quot;http://$Q_HOST:$Q_PORT&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>set NOVA_VIF_DRIVER and optionally set options in nova_conf</p>
</td><td class=code><div class=highlight><pre>
    quantum_plugin_create_nova_conf

    iniset <span class="nv">$NOVA_CONF</span> DEFAULT libvirt_vif_driver <span class="s2">&quot;$NOVA_VIF_DRIVER&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT linuxnet_interface_driver <span class="s2">&quot;$LINUXNET_VIF_DRIVER&quot;</span>
    <span class="k">if </span>is_service_enabled q-meta; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT service_quantum_metadata_proxy <span class="s2">&quot;True&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_quantum_accounts() - Set up common required quantum accounts</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="tenant-user-roles">
<h1>Tenant               User       Roles</h1>
<p>service              quantum    admin        # if enabled</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Migrated from keystone_data.sh</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_quantum_accounts<span class="o">()</span> <span class="o">{</span>

    <span class="nv">SERVICE_TENANT</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | awk <span class="s2">&quot;/ $SERVICE_TENANT_NAME / { print \$2 }&quot;</span><span class="k">)</span>
    <span class="nv">ADMIN_ROLE</span><span class="o">=</span><span class="k">$(</span>keystone role-list | awk <span class="s2">&quot;/ admin / { print \$2 }&quot;</span><span class="k">)</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;q-svc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">QUANTUM_USER</span><span class="o">=</span><span class="k">$(</span>keystone user-create <span class="se">\</span>
            --name<span class="o">=</span>quantum <span class="se">\</span>
            --pass<span class="o">=</span><span class="s2">&quot;$SERVICE_PASSWORD&quot;</span> <span class="se">\</span>
            --tenant_id <span class="nv">$SERVICE_TENANT</span> <span class="se">\</span>
            --email<span class="o">=</span>quantum@example.com <span class="se">\</span>
            | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
        keystone user-role-add <span class="se">\</span>
            --tenant_id <span class="nv">$SERVICE_TENANT</span> <span class="se">\</span>
            --user_id <span class="nv">$QUANTUM_USER</span> <span class="se">\</span>
            --role_id <span class="nv">$ADMIN_ROLE</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$KEYSTONE_CATALOG_BACKEND&quot;</span> <span class="o">=</span> <span class="s1">&#39;sql&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">QUANTUM_SERVICE</span><span class="o">=</span><span class="k">$(</span>keystone service-create <span class="se">\</span>
                --name<span class="o">=</span>quantum <span class="se">\</span>
                --type<span class="o">=</span>network <span class="se">\</span>
                --description<span class="o">=</span><span class="s2">&quot;Quantum Service&quot;</span> <span class="se">\</span>
                | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
            keystone endpoint-create <span class="se">\</span>
                --region RegionOne <span class="se">\</span>
                --service_id <span class="nv">$QUANTUM_SERVICE</span> <span class="se">\</span>
                --publicurl <span class="s2">&quot;http://$SERVICE_HOST:9696/&quot;</span> <span class="se">\</span>
                --adminurl <span class="s2">&quot;http://$SERVICE_HOST:9696/&quot;</span> <span class="se">\</span>
                --internalurl <span class="s2">&quot;http://$SERVICE_HOST:9696/&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

<span class="k">function </span>create_quantum_initial_network<span class="o">()</span> <span class="o">{</span>
    <span class="nv">TENANT_ID</span><span class="o">=</span><span class="k">$(</span>keystone tenant-list | grep <span class="s2">&quot; demo &quot;</span> | get_field 1<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a small network
Since quantum command is executed in admin context at this point,
<tt class="docutils literal"><span class="pre">--tenant_id</span></tt> needs to be specified.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">NET_ID</span><span class="o">=</span><span class="k">$(</span>quantum net-create --tenant_id <span class="nv">$TENANT_ID</span> <span class="s2">&quot;$PRIVATE_NETWORK_NAME&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    <span class="nv">SUBNET_ID</span><span class="o">=</span><span class="k">$(</span>quantum subnet-create --tenant_id <span class="nv">$TENANT_ID</span> --ip_version 4 --gateway <span class="nv">$NETWORK_GATEWAY</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>

    <span class="k">if </span>is_service_enabled q-l3; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a router, and add the private subnet as one of its interfaces</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_NAMESPACE&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If namespaces are enabled, create a tenant-owned router.</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">ROUTER_ID</span><span class="o">=</span><span class="k">$(</span>quantum router-create --tenant_id <span class="nv">$TENANT_ID</span> <span class="nv">$Q_ROUTER_NAME</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>If namespaces are disabled, the L3 agent can only target
a single router, which should not be tenant-owned.</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">ROUTER_ID</span><span class="o">=</span><span class="k">$(</span>quantum router-create <span class="nv">$Q_ROUTER_NAME</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        </span>quantum router-interface-add <span class="nv">$ROUTER_ID</span> <span class="nv">$SUBNET_ID</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create an external network, and a subnet. Configure the external network as router gw</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">EXT_NET_ID</span><span class="o">=</span><span class="k">$(</span>quantum net-create <span class="s2">&quot;$PUBLIC_NETWORK_NAME&quot;</span> -- --router:external<span class="o">=</span>True | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="nv">EXT_GW_IP</span><span class="o">=</span><span class="k">$(</span>quantum subnet-create --ip_version 4 <span class="nv">$EXT_NET_ID</span> <span class="nv">$FLOATING_RANGE</span> -- --enable_dhcp<span class="o">=</span>False | grep <span class="s1">&#39;gateway_ip&#39;</span> | get_field 2<span class="k">)</span>
        quantum router-gateway-set <span class="nv">$ROUTER_ID</span> <span class="nv">$EXT_NET_ID</span>

        <span class="k">if </span>is_quantum_ovs_base_plugin <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_NAMESPACE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">CIDR_LEN</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="p">#*/</span><span class="k">}</span>
            sudo ip addr add <span class="nv">$EXT_GW_IP</span>/<span class="nv">$CIDR_LEN</span> dev <span class="nv">$PUBLIC_BRIDGE</span>
            sudo ip link <span class="nb">set</span> <span class="nv">$PUBLIC_BRIDGE</span> up
            <span class="nv">ROUTER_GW_IP</span><span class="o">=</span><span class="sb">`</span>quantum port-list -c fixed_ips -c device_owner | grep router_gateway | awk -F <span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{ print $8; }&#39;</span><span class="sb">`</span>
            sudo route add -net <span class="nv">$FIXED_RANGE</span> gw <span class="nv">$ROUTER_GW_IP</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_NAMESPACE&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Explicitly set router id in l3 agent configuration</p>
</td><td class=code><div class=highlight><pre>
            iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT router_id <span class="nv">$ROUTER_ID</span>
        <span class="k">fi</span>
<span class="k">   fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>init_quantum() - Initialize databases, etc.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_quantum<span class="o">()</span> <span class="o">{</span>
    :
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_quantum() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_quantum<span class="o">()</span> <span class="o">{</span>
    git_clone <span class="nv">$QUANTUM_REPO</span> <span class="nv">$QUANTUM_DIR</span> <span class="nv">$QUANTUM_BRANCH</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_quantumclient() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_quantumclient<span class="o">()</span> <span class="o">{</span>
    git_clone <span class="nv">$QUANTUMCLIENT_REPO</span> <span class="nv">$QUANTUMCLIENT_DIR</span> <span class="nv">$QUANTUMCLIENT_BRANCH</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_quantum_agent_packages() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_quantum_agent_packages<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>install packages that is specific to plugin agent</p>
</td><td class=code><div class=highlight><pre>
    quantum_plugin_install_agent_packages
<span class="o">}</span>

<span class="k">function </span>setup_quantum<span class="o">()</span> <span class="o">{</span>
    setup_develop <span class="nv">$QUANTUM_DIR</span>
<span class="o">}</span>

<span class="k">function </span>setup_quantumclient<span class="o">()</span> <span class="o">{</span>
    setup_develop <span class="nv">$QUANTUMCLIENT_DIR</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_quantum_service_and_check<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start the Quantum service</p>
</td><td class=code><div class=highlight><pre>
    screen_it q-svc <span class="s2">&quot;cd $QUANTUM_DIR &amp;&amp; python $QUANTUM_DIR/bin/quantum-server --config-file $QUANTUM_CONF --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for Quantum to start...&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! http_proxy= wget -q -O- http://127.0.0.1:9696; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;Quantum did not start&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_quantum_agents<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start up the quantum agents if enabled</p>
</td><td class=code><div class=highlight><pre>
    screen_it q-agt <span class="s2">&quot;python $AGENT_BINARY --config-file $QUANTUM_CONF --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>
    screen_it q-dhcp <span class="s2">&quot;python $AGENT_DHCP_BINARY --config-file $QUANTUM_CONF --config-file=$Q_DHCP_CONF_FILE&quot;</span>
    screen_it q-meta <span class="s2">&quot;python $AGENT_META_BINARY --config-file $QUANTUM_CONF --config-file=$Q_META_CONF_FILE&quot;</span>
    screen_it q-l3 <span class="s2">&quot;python $AGENT_L3_BINARY --config-file $QUANTUM_CONF --config-file=$Q_L3_CONF_FILE&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>stop_quantum() - Stop running processes (non-screen)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_quantum<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>is_service_enabled q-dhcp; <span class="k">then</span>
<span class="k">        </span><span class="nv">pid</span><span class="o">=</span><span class="k">$(</span>ps aux | awk <span class="s1">&#39;/[d]nsmasq.+interface=(tap|ns-)/ { print $2 }&#39;</span><span class="k">)</span>
        <span class="o">[</span> ! -z <span class="s2">&quot;$pid&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sudo <span class="nb">kill</span> -9 <span class="nv">$pid</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_cleanup_quantum() - Remove residual data files, anything left over from previous
runs that a clean run would need to clean up</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_cleanup_quantum<span class="o">()</span> <span class="o">{</span>
    :
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_configure_quantum_common()
Set common config for all quantum server and agents.
This MUST be called before other _configure_quantum_* functions.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_quantum_common<span class="o">()</span> <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Put config files in <tt class="docutils literal">QUANTUM_CONF_DIR</tt> for everyone to find</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$QUANTUM_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$QUANTUM_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$QUANTUM_CONF_DIR</span>

    cp <span class="nv">$QUANTUM_DIR</span>/etc/quantum.conf <span class="nv">$QUANTUM_CONF</span>

</pre></div></td></tr><tr><td class=docs>
<p>set plugin-specific variables
Q_PLUGIN_CONF_PATH, Q_PLUGIN_CONF_FILENAME, Q_DB_NAME, Q_PLUGIN_CLASS</p>
</td><td class=code><div class=highlight><pre>
    quantum_plugin_configure_common

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$Q_PLUGIN_CONF_PATH</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nv">$Q_PLUGIN_CONF_FILENAME</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nv">$Q_PLUGIN_CLASS</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Quantum plugin not set.. exiting&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If needed, move config file from <tt class="docutils literal">$QUANTUM_DIR/etc/quantum</tt> to <tt class="docutils literal">QUANTUM_CONF_DIR</tt></p>
</td><td class=code><div class=highlight><pre>
    mkdir -p /<span class="nv">$Q_PLUGIN_CONF_PATH</span>
    <span class="nv">Q_PLUGIN_CONF_FILE</span><span class="o">=</span><span class="nv">$Q_PLUGIN_CONF_PATH</span>/<span class="nv">$Q_PLUGIN_CONF_FILENAME</span>
    cp <span class="nv">$QUANTUM_DIR</span>/<span class="nv">$Q_PLUGIN_CONF_FILE</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>

    database_connection_url dburl <span class="nv">$Q_DB_NAME</span>
    iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> DATABASE sql_connection <span class="nv">$dburl</span>
    <span class="nb">unset </span>dburl

    _quantum_setup_rootwrap
<span class="o">}</span>

<span class="k">function </span>_configure_quantum_debug_command<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_DEBUG_COMMAND&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return</span>
<span class="k">    fi</span>

<span class="k">    </span>cp <span class="nv">$QUANTUM_DIR</span>/etc/l3_agent.ini <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span>

    iniset <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span> DEFAULT verbose False
    iniset <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span> DEFAULT debug False
    iniset <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>
    iniset <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _quantum_setup_keystone <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span> DEFAULT set_auth_url
    _quantum_setup_interface_driver <span class="nv">$QUANTUM_TEST_CONFIG_FILE</span>

    quantum_plugin_configure_debug_command
<span class="o">}</span>

<span class="k">function </span>_configure_quantum_dhcp_agent<span class="o">()</span> <span class="o">{</span>
    <span class="nv">AGENT_DHCP_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-dhcp-agent&quot;</span>
    <span class="nv">Q_DHCP_CONF_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/dhcp_agent.ini

    cp <span class="nv">$QUANTUM_DIR</span>/etc/dhcp_agent.ini <span class="nv">$Q_DHCP_CONF_FILE</span>

    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT verbose True
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT debug True
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT state_path <span class="nv">$DATA_DIR</span>/quantum
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _quantum_setup_keystone <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT set_auth_url
    _quantum_setup_interface_driver <span class="nv">$Q_DHCP_CONF_FILE</span>

    quantum_plugin_configure_dhcp_agent
<span class="o">}</span>

<span class="k">function </span>_configure_quantum_l3_agent<span class="o">()</span> <span class="o">{</span>
    <span class="nv">AGENT_L3_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-l3-agent&quot;</span>
    <span class="nv">PUBLIC_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_BRIDGE</span><span class="k">:-</span><span class="nv">br</span><span class="p">-ex</span><span class="k">}</span>
    <span class="nv">Q_L3_CONF_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/l3_agent.ini

    cp <span class="nv">$QUANTUM_DIR</span>/etc/l3_agent.ini <span class="nv">$Q_L3_CONF_FILE</span>

    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT verbose True
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT debug True
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT state_path <span class="nv">$DATA_DIR</span>/quantum
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _quantum_setup_keystone <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT set_auth_url
    _quantum_setup_interface_driver <span class="nv">$Q_L3_CONF_FILE</span>

    quantum_plugin_configure_l3_agent
<span class="o">}</span>

<span class="k">function </span>_configure_quantum_metadata_agent<span class="o">()</span> <span class="o">{</span>
    <span class="nv">AGENT_META_BINARY</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_DIR/bin/quantum-metadata-agent&quot;</span>
    <span class="nv">Q_META_CONF_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/metadata_agent.ini

    cp <span class="nv">$QUANTUM_DIR</span>/etc/metadata_agent.ini <span class="nv">$Q_META_CONF_FILE</span>

    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT verbose True
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT debug True
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT state_path <span class="nv">$DATA_DIR</span>/quantum
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT nova_metadata_ip <span class="nv">$Q_META_DATA_IP</span>
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _quantum_setup_keystone <span class="nv">$Q_META_CONF_FILE</span> DEFAULT set_auth_url
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_configure_quantum_plugin_agent() - Set config files for quantum plugin agent
It is called when q-agt is enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_quantum_plugin_agent<span class="o">()</span> <span class="o">{</span>

</pre></div></td></tr><tr><td class=docs>
<p>Specify the default root helper prior to agent configuration to
ensure that an agent's configuration can override the default.</p>
</td><td class=code><div class=highlight><pre>
    iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> AGENT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure agent for plugin</p>
</td><td class=code><div class=highlight><pre>
    quantum_plugin_configure_plugin_agent
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_configure_quantum_service() - Set config files for quantum service
It is called when q-svc is enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_quantum_service<span class="o">()</span> <span class="o">{</span>
    <span class="nv">Q_API_PASTE_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/api-paste.ini
    <span class="nv">Q_POLICY_FILE</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/policy.json

    cp <span class="nv">$QUANTUM_DIR</span>/etc/api-paste.ini <span class="nv">$Q_API_PASTE_FILE</span>
    cp <span class="nv">$QUANTUM_DIR</span>/etc/policy.json <span class="nv">$Q_POLICY_FILE</span>

    <span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span>; <span class="k">then</span>
<span class="k">        </span>recreate_database <span class="nv">$Q_DB_NAME</span> utf8
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;A database must be enabled in order to use the $Q_PLUGIN Quantum plugin.&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Update either configuration file with plugin</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$QUANTUM_CONF</span> DEFAULT core_plugin <span class="nv">$Q_PLUGIN_CLASS</span>

    iniset <span class="nv">$QUANTUM_CONF</span> DEFAULT verbose True
    iniset <span class="nv">$QUANTUM_CONF</span> DEFAULT debug True
    iniset <span class="nv">$QUANTUM_CONF</span> DEFAULT allow_overlapping_ips <span class="nv">$Q_ALLOW_OVERLAPPING_IP</span>

    iniset <span class="nv">$QUANTUM_CONF</span> DEFAULT auth_strategy <span class="nv">$Q_AUTH_STRATEGY</span>
    _quantum_setup_keystone <span class="nv">$Q_API_PASTE_FILE</span> filter:authtoken

</pre></div></td></tr><tr><td class=docs>
<p>Configure plugin</p>
</td><td class=code><div class=highlight><pre>
    quantum_plugin_configure_service
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Utility Functions</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#------------------</span>

</pre></div></td></tr><tr><td class=docs>
<p>_quantum_setup_rootwrap() - configure Quantum's rootwrap</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_quantum_setup_rootwrap<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_ROOTWRAP&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return</span>
<span class="k">    fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy new rootwrap filters files (owned by root).
Wipe any existing rootwrap.d files first</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">Q_CONF_ROOTWRAP_D</span><span class="o">=</span><span class="nv">$QUANTUM_CONF_DIR</span>/rootwrap.d
    <span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$Q_CONF_ROOTWRAP_D</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo rm -rf <span class="nv">$Q_CONF_ROOTWRAP_D</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy filters to $QUANTUM_CONF_DIR/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p -m 755 <span class="nv">$Q_CONF_ROOTWRAP_D</span>
    cp -pr <span class="nv">$QUANTUM_DIR</span>/etc/quantum/rootwrap.d/* <span class="nv">$Q_CONF_ROOTWRAP_D</span>/
    sudo chown -R root:root <span class="nv">$Q_CONF_ROOTWRAP_D</span>
    sudo chmod 644 <span class="nv">$Q_CONF_ROOTWRAP_D</span>/*
</pre></div></td></tr><tr><td class=docs>
<p>Set up rootwrap.conf, pointing to $QUANTUM_CONF_DIR/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
    sudo cp -p <span class="nv">$QUANTUM_DIR</span>/etc/rootwrap.conf <span class="nv">$Q_RR_CONF_FILE</span>
    sudo sed -e <span class="s2">&quot;s:^filters_path=.*$:filters_path=$Q_CONF_ROOTWRAP_D:&quot;</span> -i <span class="nv">$Q_RR_CONF_FILE</span>
    sudo chown root:root <span class="nv">$Q_RR_CONF_FILE</span>
    sudo chmod 0644 <span class="nv">$Q_RR_CONF_FILE</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specify rootwrap.conf as first parameter to quantum-rootwrap</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ROOTWRAP_SUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_ROOTWRAP $Q_RR_CONF_FILE *&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the rootwrap sudoers for quantum</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(root) NOPASSWD: $ROOTWRAP_SUDOER_CMD&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/quantum-rootwrap
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configures keystone integration for quantum service and agents</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_quantum_setup_keystone<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">conf_file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">use_auth_url</span><span class="o">=</span><span class="nv">$3</span>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="nv">$use_auth_url</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> auth_url <span class="s2">&quot;$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_AUTH_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> auth_host <span class="nv">$KEYSTONE_SERVICE_HOST</span>
        iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> auth_port <span class="nv">$KEYSTONE_AUTH_PORT</span>
        iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> auth_protocol <span class="nv">$KEYSTONE_SERVICE_PROTOCOL</span>
    <span class="k">fi</span>
<span class="k">    </span>iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> admin_user <span class="nv">$Q_ADMIN_USERNAME</span>
    iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> admin_password <span class="nv">$SERVICE_PASSWORD</span>
    iniset <span class="nv">$conf_file</span> <span class="nv">$section</span> signing_dir <span class="nv">$QUANTUM_AUTH_CACHE_DIR</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create cache dir</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$QUANTUM_AUTH_CACHE_DIR</span>
    sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$QUANTUM_AUTH_CACHE_DIR</span>
    rm -f <span class="nv">$QUANTUM_AUTH_CACHE_DIR</span>/*
<span class="o">}</span>

<span class="k">function </span>_quantum_setup_interface_driver<span class="o">()</span> <span class="o">{</span>
    quantum_plugin_setup_interface_driver <span class="nv">$1</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Functions for Quantum Exercises</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#--------------------------------</span>

<span class="k">function </span>delete_probe<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
    <span class="nv">net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="nv">probe_id</span><span class="o">=</span><span class="sb">`</span>quantum-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-list -c id -c network_id | grep <span class="nv">$net_id</span> | awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
    quantum-debug --os-tenant-name admin --os-username admin probe-delete <span class="nv">$probe_id</span>
<span class="o">}</span>

<span class="k">function </span>setup_quantum_debug<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_DEBUG_COMMAND&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">public_net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$PUBLIC_NETWORK_NAME</span><span class="sb">`</span>
        quantum-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-create <span class="nv">$public_net_id</span>
        <span class="nv">private_net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$PRIVATE_NETWORK_NAME</span><span class="sb">`</span>
        quantum-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-create <span class="nv">$private_net_id</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>teardown_quantum_debug<span class="o">()</span> <span class="o">{</span>
    delete_probe <span class="nv">$PUBLIC_NETWORK_NAME</span>
    delete_probe <span class="nv">$PRIVATE_NETWORK_NAME</span>
<span class="o">}</span>

<span class="k">function </span>_get_net_id<span class="o">()</span> <span class="o">{</span>
    quantum --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> net-list | grep <span class="nv">$1</span> | awk <span class="s1">&#39;{print $2}&#39;</span>
<span class="o">}</span>

<span class="k">function </span>_get_probe_cmd_prefix<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
    <span class="nv">net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="nv">probe_id</span><span class="o">=</span><span class="sb">`</span>quantum-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-list -c id -c network_id | grep <span class="nv">$net_id</span> | awk <span class="s1">&#39;{print $2}&#39;</span> | head -n 1<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$Q_RR_COMMAND ip netns exec qprobe-$probe_id&quot;</span>
<span class="o">}</span>

<span class="k">function </span>_ping_check_quantum<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">timeout_sec</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">expected</span><span class="o">=</span><span class="k">${</span><span class="nv">4</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">probe_cmd</span><span class="o">=</span><span class="sb">`</span>_get_probe_cmd_prefix <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while ! $probe_cmd ping -w 1 -c 1 $ip; do sleep 1; done&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while $probe_cmd ping -w 1 -c 1 $ip; do sleep 1; done&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! timeout <span class="nv">$timeout_sec</span> sh -c <span class="s2">&quot;$check_command&quot;</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;[Fail] Couldn&#39;t ping server&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;[Fail] Could ping server&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ssh check</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_ssh_check_quantum<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">key_file</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">timeout_sec</span><span class="o">=</span><span class="nv">$5</span>
    <span class="nb">local </span><span class="nv">probe_cmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="nv">probe_cmd</span><span class="o">=</span><span class="sb">`</span>_get_probe_cmd_prefix <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="k">if</span> ! timeout <span class="nv">$timeout_sec</span> sh -c <span class="s2">&quot;while ! $probe_cmd ssh -o StrictHostKeyChecking=no -i $key_file ${user}@$ip echo success ; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;server didn&#39;t become ssh-able!&quot;</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quantum 3rd party programs</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#---------------------------</span>
</pre></div></td></tr><tr><td class=docs>
<p>please refer to lib/quantum_thirdparty/README.md for details</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">QUANTUM_THIRD_PARTIES</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">for </span>f in <span class="nv">$TOP_DIR</span>/lib/quantum_thirdparty/*; <span class="k">do</span>
<span class="k">     </span><span class="nv">third_party</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$f</span><span class="k">)</span>
     <span class="k">if </span>is_service_enabled <span class="nv">$third_party</span>; <span class="k">then</span>
<span class="k">         </span><span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/quantum_thirdparty/<span class="nv">$third_party</span>
         <span class="nv">QUANTUM_THIRD_PARTIES</span><span class="o">=</span><span class="s2">&quot;$QUANTUM_THIRD_PARTIES,$third_party&quot;</span>
     <span class="k">fi</span>
<span class="k">done</span>

<span class="k">function </span>_quantum_third_party_do<span class="o">()</span> <span class="o">{</span>
    <span class="k">for </span>third_party in <span class="k">${</span><span class="nv">QUANTUM_THIRD_PARTIES</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
        <span class="k">${</span><span class="nv">1</span><span class="k">}</span>_<span class="k">${</span><span class="nv">third_party</span><span class="k">}</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_quantum_third_party() - Set config files, create data dirs, etc</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_quantum_third_party<span class="o">()</span> <span class="o">{</span>
    _quantum_third_party_do configure
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>init_quantum_third_party() - Initialize databases, etc.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_quantum_third_party<span class="o">()</span> <span class="o">{</span>
    _quantum_third_party_do init
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_quantum_third_party() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_quantum_third_party<span class="o">()</span> <span class="o">{</span>
    _quantum_third_party_do install
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>start_quantum_third_party() - Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_quantum_third_party<span class="o">()</span> <span class="o">{</span>
    _quantum_third_party_do start
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>stop_quantum_third_party - Stop running processes (non-screen)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_quantum_third_party<span class="o">()</span> <span class="o">{</span>
    _quantum_third_party_do stop
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>


</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
